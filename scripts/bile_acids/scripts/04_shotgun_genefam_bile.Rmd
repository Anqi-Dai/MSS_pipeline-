---
title: "Check the current genefamily to KO bile in shotgun"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
```

```{r}
KOs <- c('K01442','K15868','K15869','K15870','K15871','K15872','K15873','K15874',
         'K07007','K22604','K22605','K22606','K22607')
KO_str <- paste(KOs, collapse = '|')
```


```{bash}
# move the FMT gene fams to a sub dir and
humann2_join_tables -s  --input . --file_name genefamilies --output   humann2_genefamilies.tsv
```

```{bash}
# download the table to local cuz can only regroup to uniref90 KO in local
scp daia1@lilac.mskcc.org:~/my_workdir/samples/fmt_genne/humann2_genefamilies.tsv .

# regroup
humann2_regroup_table \
             --input humann2_genefamilies.tsv  \
             --groups uniref90_ko  \
             --output humann2_genefamilies_KO_regroup.tsv
             
             
# renorm
humann2_renorm_table --input humann2_genefamilies_KO_regroup.tsv \
    -u cpm -s n --output  humann2_genefamilies_KO_regroup_cpm.tsv
    
# split
humann2_split_stratified_table --input humann2_genefamilies_KO_regroup_cpm.tsv --output fmt
```

```{r}
# look at the first table: the FMT samples
fmt <- read_tsv('../data/shotgun/fmt/humann2_genefamilies_KO_regroup_cpm_stratified.tsv') %>% 
  rename(genefam = names(.)[1]) %>% 
  rename_all(funs(str_replace(., '_Abundance-RPKs$',''))) %>%
  filter(str_detect(genefam, KO_str)) 
  

# the sg01
sg01 <- read_tsv('../data/shotgun/sg01/out/humann2_genefamilies_KO_regroup_cpm_stratified.tsv') %>% 
  rename(genefam = names(.)[1]) %>% 
  rename_all(funs(str_replace(., '_Abundance-RPKs$',''))) %>%
  filter(str_detect(genefam, KO_str))

# sgother
sgother <- read_tsv('../data/shotgun/sgother/out/humann2_genefamilies_KO_regroup_cpm_stratified.tsv') %>% 
  rename(genefam = names(.)[1]) %>% 
  rename_all(funs(str_replace(., '_Abundance-RPKs$',''))) %>%
  filter(str_detect(genefam, KO_str))

length(intersect(sg01$genefam, sgother$genefam))

all <- fmt %>% 
  full_join(sg01, by  = 'genefam' ) %>% 
  full_join(sgother, by  = 'genefam' )

all_ma <- all %>% 
  column_to_rownames('genefam') %>% 
  as.matrix()

all_ma[is.na(all_ma)] <- 0

ttt <- rowSums(all_ma == 0) 
table(ttt)

ALL <- all_ma %>% 
  as.data.frame() %>% 
  rownames_to_column('genefam')
```

