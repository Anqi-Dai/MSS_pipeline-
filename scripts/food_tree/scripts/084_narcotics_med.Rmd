---
title: "Narcotic"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lubridate)
library(brms)   
library(ggpubr)
library(tidybayes)
ncores <- parallel::detectCores()
axis_text_size <- 10
```

```{r}
dat <- read_rds('/Volumes/vandenbrinklab/deep_sequencing/Clinical Annotation/Abx_data_TsoniIDB_pull_2020_07-06/allo_srx.rds')

ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')

narcotic <- dat %>% 
  filter(is_narcotic == "Y") %>% 
  filter(grepl("PCA", med_name)) %>% 
  mutate(mrn = as.numeric(MRN)) %>% 
  filter(mrn %in% ptb$mrn) %>% 
  select(mrn, start_date, stop_date)

colnames(dat)

narcotic %>% 
  count(mrn, sort = T)

# there is one patient in our cohort that had narcotics in a previous tranplant but not relavant to us right now.
rm_pt <- narcotic %>% 
  mutate(start_year = year(start_date)) %>% 
  filter(start_year == 2016) %>% 
  distinct(mrn) %>% 
  pull(mrn)

narcotic_early_dates <- narcotic %>% 
  filter(mrn != rm_pt) %>% 
  group_by(mrn) %>% 
  arrange(start_date, .by_group = T) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(-stop_date)

narcotic_stop_dates <- narcotic %>% 
  filter(mrn != rm_pt) %>% 
  group_by(mrn) %>% 
  arrange(desc(stop_date), .by_group = T) %>% 
  slice(1) %>% 
  ungroup() %>% 
  select(-start_date)

nar_dates <- narcotic_early_dates %>% 
  full_join(narcotic_stop_dates) %>% 
  inner_join(ptb %>% 
               select(mrn, hct)) %>% 
  mutate(start_drt = start_date - hct,
         stop_drt = stop_date - hct) %>% 
  mutate(start_drt = as.numeric(start_drt),
         stop_drt = as.numeric(stop_drt)) %>% 
  # filter out certain periods that are not close to the current cohort transplant date
  filter(start_drt > -46 & start_drt < 82)

# the diet data is -10:49

# look closely at several patients that have very future stop dates, possibly another transplant or disease
change_stop <- nar_dates %>% 
  filter(stop_drt > 100) %>% 
  pull(mrn)

change_stop_date <- c('2019-08-21','2018-05-05','2017-10-13','2017-11-06','2019-07-26')

change <- tibble(
  mrn = change_stop,
  stop_date = change_stop_date
)

meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')

nar_correct <- nar_dates %>% 
  filter(mrn %in% change_stop) %>% 
  select(mrn, start_date, hct, start_drt) %>% 
  full_join(change) %>% 
  mutate(stop_date = ymd(stop_date),
         stop_drt = stop_date - hct,
         stop_drt = as.numeric(stop_drt))  %>% 
  select(colnames(nar_dates))
  
nar_all <- bind_rows(
  nar_dates %>% 
    filter(!mrn %in% change_stop) ,
  nar_correct
)  %>% 
  mutate(nar_int = interval(start_date, stop_date))

nar_all %>% 
  distinct(mrn)
```

```{r}
# clean the data for the second batch 
df2 <- read_rds('/Volumes/vandenBrinkLab/Angel_Dai/batch2_medication_exposures.rds')
ptb <- read_csv('../data/129_ptb2.csv')


pcas <- df2 %>% 
  filter(str_detect(route0, 'PCA IV') | str_detect(misc.info, 'PCA') | str_detect(drug_name_detail, 'PCA')) %>% 
  mutate(mrn = as.numeric(MRN)) %>% 
  filter(mrn %in% ptb$mrn) %>% 
  select(mrn, start_date, stop_date) %>% 
  inner_join(ptb %>% select(mrn, hct)) %>% 
  mutate(startday = as.numeric(start_date - hct),
         stopday = as.numeric(stop_date - hct)) %>% 
  # filter out certain periods that are not close to the current cohort transplant date
  filter(startday > -46 & startday < 82) %>% 
  mutate(nar_int = interval(start_date, stop_date))


library(vdbR)
connect_database('~/dbConfig.txt')
get_table_from_database('samples_castori_ag')
stb2 <- read_csv('../data/153_combined_META.csv') %>% filter(batch == 'batch2')
# find if two intervals overlap
stb_samp <- samples_castori_ag %>% 
  filter(sampleid %in% stb2$sampleid) %>% 
  select(sampleid, datecollection, mrn) %>% 
  mutate(p1d = datecollection -1,
         p2d = datecollection -2) %>% 
  mutate(p2d_int = interval(p2d, p1d)) %>% 
  inner_join(pcas %>% 
               select(mrn, nar_int) ) %>% 
  mutate(use_nar = int_overlaps(p2d_int, nar_int))

use_pca <- stb_samp %>% filter(use_nar == 'TRUE') %>% distinct(sampleid)
use_pca_pt <- stb_samp %>% filter(use_nar == 'TRUE') %>% distinct(mrn)


```


## decide if a patient was exposed to narcotics painkiller in the two days prior to a stool sample collection

```{r}
library(vdbR)
connect_database('~/dbConfig.txt')
get_table_from_database('samples_castori_ag')

# find if two intervals overlap
stb_samp1 <- samples_castori_ag %>% 
  filter(sampleid %in% meta$sampleid) %>% 
  select(sampleid, datecollection, mrn) %>% 
  mutate(p1d = datecollection -1,
         p2d = datecollection -2) %>% 
  mutate(p2d_int = interval(p2d, p1d)) %>% 
  inner_join(nar_all %>% 
               select(mrn, nar_int) ) %>% 
  mutate(use_nar = int_overlaps(p2d_int, nar_int))

use_nar_samp <- stb_samp1 %>% 
  filter(use_nar == 'TRUE')
# how many samples from how many patients
use_nar_samp %>% 
  count(mrn)

use_nar_samp1 <- use_nar_samp %>% 
  distinct(sampleid) %>% pull(sampleid)


```

```{r}
# the total list of the samples that were exposed to pca 
pca_exposed <- c(use_nar_samp1, use_pca %>% pull(sampleid))
```


```{r}
meta <- read_csv('../data/153_combined_META.csv')
meta_new <- meta %>% 
  mutate(narcotics = if_else(sampleid %in% pca_exposed, T, F))  %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(mrn = factor(mrn)) %>% 
  mutate(fg_egg = fg_egg/100,
         fg_fruit = fg_fruit/100,
         fg_grain = fg_grain/100,
         fg_legume = fg_legume/100,
         fg_meat = fg_meat/100,
         fg_milk = fg_milk/100,
         fg_oils = fg_oils/100,
         fg_sweets = fg_sweets/100,
         fg_veggie = fg_veggie/100)

meta_new %>% count(narcotics)
meta_new %>% filter(narcotics == 'TRUE') %>% distinct(mrn)
```


```{r}
model_nar <- log(simpson_reciprocal)~ 0 +
                fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
               intensity +
               empirical+
                TPN+
                EN+
                narcotics +
               (1 | mrn) +
                (1 | timebin)

priors <- c(# for the food group variables
            prior(normal(0, 1), class = 'b', coef = "fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "fg_veggie"),
            # for the TPN 
            prior(normal(0, 0.1), class = 'b', coef = "TPNTRUE"),
            # for the EN
            prior(normal(0, 0.1), class = 'b', coef = "ENTRUE"),
            # for the empirical 
            prior(normal(0, 0.5), class = 'b', coef = "empiricalTRUE"),
            # for narcotics
            prior(normal(0, 0.1), class = 'b', coef = "narcoticsTRUE"),
            # for the intensity 
            prior(normal(2, 0.1), class = 'b', coef = "intensityreduced"),
            prior(normal(2, 0.1), class = 'b', coef = "intensityablative"),
            prior(normal(2, 0.1), class = 'b', coef = "intensitynonablative"))

model_narcotics <- brm( model_nar,  
              data = meta_new, 
              warmup = 1000, iter = 3000, 
              prior = priors,
              cores = ncores, 
              control = list(adapt_delta = 0.99),
              chains = 2, 
              seed = 123, sample_prior = T) 

post_samples  <- posterior_samples(model_narcotics, '^b_')

post_pca <- suppressWarnings(posterior_samples(model_narcotics)) 

post_pca %>%  write_csv('../data/084_narcotics_PCA_model_post.csv')
```

```{r}
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')

post_samples <- read_csv('../data/084_narcotics_PCA_model_post.csv')

post_coeff <- post_samples %>% 
  select(starts_with('b_fg')) %>% 
  gather('item', 'coeff') %>% 
  mutate(item = str_replace(item, 'b_fg_','')) %>% 
   mutate(fgrp1 = case_when(
    item ==  'milk' ~ '1',
    item == 'meat' ~ '2',
    item ==  'egg' ~ '3',
    item ==  'legume' ~ '4',
    item == 'grain' ~ '5',
    item == 'fruit' ~ '6',
    item == 'veggie' ~ '7',
    item ==  'oils' ~ '8', 
    item ==  'sweets' ~ '9'
  ))  %>% 
  left_join(key) %>% 
  left_join(key %>% select(fgrp1, color, shortname))  

percs <- post_coeff %>% 
  count(shortname, coeff > 0) %>% 
  mutate(perc =round(n/4000*100,1))  %>% select(-n) %>% 
  spread('coeff > 0', 'perc') %>% 
  rename(positive = 'TRUE', negative = 'FALSE') %>% 
  mutate(neg_num = negative) %>% 
  mutate(pos_x = 0.8, neg_x = -0.9) %>% 
  mutate(positive = str_glue('{positive}%'),
         negative = str_glue('{negative}%'))

fg_order <- read_csv('../data/068_fg_sorting_order.csv') %>% pull(shortname)

pca_fg <- post_coeff %>% 
  left_join(percs) %>%
  mutate(shortname = factor(shortname, levels = fg_order)) %>% 
  ggplot(aes(x = coeff, y = shortname, fill = after_stat(x > 0))) +
  stat_pointinterval(.width = c( .95, .95), size = 0.1) + stat_halfeye() + 
  geom_vline(xintercept = 0, col = 'black', linetype = 'dashed') +
  geom_text(data = percs, aes(x = pos_x, y = shortname, label = positive, color = after_stat(x > 0))) +
  geom_text(data = percs, aes(x = neg_x, y = shortname, label = negative, color =after_stat(x > 0))) +
  #scale_fill_manual(values = c("gray80", "skyblue")) +
  labs(x = 'ln(diversity) change per 100g of food',
       y = '', 
       title = 'Diversity') +
  theme_classic() +
  theme(legend.position = 'none') +
  scale_color_manual(values = c( "#00BFC4", "#F8766D")) +
  scale_fill_manual(values = c( "#00BFC4", "#F8766D")) +
  theme(axis.text=element_text(size=axis_text_size, color  = 'black'),
        axis.title=element_text(size=axis_text_size),
        aspect.ratio=1)

```

```{r}
coeff_bi <- post_samples %>% 
  select(starts_with('b_')) %>% 
  select(!starts_with('b_fg')) %>% 
  gather('item', 'coeff') %>% 
  mutate(item_name = case_when(
    item ==  'b_intensitynonablative' ~ 'Intensity: nonablative',
    item == 'b_intensityablative' ~ 'Intensity: ablative',
    item ==  'b_intensityreduced' ~ 'Intensity: reduced',
    item ==  'b_empiricalTRUE' ~ 'Empirical abx exposure',
    item == 'b_TPNTRUE' ~ 'TPN exposure',
    item ==  'b_ENTRUE' ~ 'EN exposure',
    item == 'b_narcoticsTRUE' ~ 'PCA exposure'
  )) %>% 
  mutate(item_name = factor(item_name, levels = c('PCA exposure', 'Intensity: nonablative', 'Intensity: reduced',
                                                  'Intensity: ablative', 'TPN exposure','EN exposure',
                                                  'Empirical abx exposure'))) %>% 
  mutate(grp = if_else(str_detect(item_name, 'Intensity'), 'Patient level', 'Sample level'))


pca_bi <- coeff_bi %>% 
  ggplot(aes(x = coeff, y = item_name)) +
  stat_pointinterval(.width = c(.66, .95)) +
  #scale_color_manual(values = c('#EC0000','#00468B')) +
  geom_vline(xintercept = 0, col = 'black', linetype = 'dashed') +
   facet_wrap(grp~ . , scales = 'free', dir = 'v') +
  labs(x = 'Coefficients',
       y = '',
       title = 'Diversity') +
  theme_classic() +
  theme(legend.position = 'none',
        axis.text=element_text(size=11),
        axis.title=element_text(size=11),
        strip.background = element_blank(),
        strip.text = element_blank(),
        aspect.ratio=1/2) 


```

```{r}
# combine them together to make one supplementary figure
library(cowplot)
title <- ggdraw() + 
  draw_label(
    "Fig S8",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 7)
  )

pca <- cowplot::plot_grid(pca_fg, pca_bi, 
          nrow = 1, 
          align = 'hv',
          #rel_widths =  c(1,1),
          #rel_heights = c(1,1),
          labels = c('A','B'),
          axis = 'tblr') 

combined <- plot_grid(
  title, pca,
  ncol = 1,
  # rel_heights values control vertical title margins
  rel_heights = c(0.1, 1)
)

```


```{r}
ggsave('../data/S8_narcotics_PCA_084.pdf',  
      width = 210, height = 297, units = "mm", device = 'pdf', plot = combined)

```



