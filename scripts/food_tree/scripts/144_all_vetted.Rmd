---
title: "I've got the vetted data back all of them!!!!"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
```

```{r}
# the below data has the vetted calories and the total weight in grams
# (waiting for the fruit smoothies breaking down to different food groups)
vet <- readxl::read_excel('../data/142_batch1_diet_calories_check_peter.xlsx')

# the current dtb1 
# the final expanded table should be the same number 22840
dtb1 <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')

# the table that has the water gram weight for 100 gram total weight of a food code
engy <- readxl::read_excel('../data/source/2015-2016 FNDDS At A Glance - FNDDS Nutrient Values.xlsx', skip = 1, col_types  = 'text') %>% 
  rename_all(funs(str_replace_all(., ' ','_'))) %>% 
  rename_all(funs(str_replace_all(., '\\(|\\)',''))) %>% 
  select(Food_code, Main_food_description, Water_g) %>% 
  mutate(Water_g = as.numeric(Water_g),
         Food_code = as.numeric(Food_code))

# find the unique combinations of all of the portions for (food_nsc + unit)
allcombo <- dtb1 %>% 
  distinct(Food_code, Food_NSC, Por_eaten, Unit) %>% 
  left_join(vet %>% 
              select(Food_NSC, Por_eaten, Unit, Calories_kcal, total_g = weight_grams), by = c("Food_NSC", "Unit", "Por_eaten"))

scale_all_combos <- allcombo %>% 
  split(., list(.$Food_NSC, .$Unit))%>%  
  discard( ~nrow(.) == 0) %>% 
  map(function(df){
    df %>% 
        arrange(Calories_kcal) %>% 
        mutate(ratio = Por_eaten/Por_eaten[1]) %>% 
        mutate(scaled_cal = Calories_kcal[1]*ratio,
               scaled_total_g = total_g[1]*ratio)
  })  %>% 
  bind_rows() %>% 
  left_join(engy, by  = 'Food_code')

scaled <- scale_all_combos %>% 
  select(Food_NSC:Food_code, Calories_kcal = scaled_cal, total_g = scaled_total_g, description = Main_food_description, Water_g) %>% 
  mutate(dehydrated_weight = total_g*(1-Water_g/100))

# now expand all of the unique combos to the whole dtb1
dtb_ <- dtb1 %>% 
  select(mrn:Por_eaten, Food_code:fdrt) %>% 
  left_join(scaled, by = c("Food_NSC", "Unit", "Por_eaten", "Food_code", "description"))
```

