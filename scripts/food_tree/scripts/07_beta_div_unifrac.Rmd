---
title: "Calculate unifrac beta diversity"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(phyloseq)
library(ape)
```

## Beta diversity

The counts table can't have a column that is completely all zeros. Also for the beta diversity, don't need to split to daily records but per patient basis that is fine. 

```{r}
# the feature table
# use the food id instead of the main food description which is a long string
final <- read_csv('../data/finalized/all_patients_record_w_food_code.csv')

food_db <- read_tsv('../data/source/food_database_file.tsv')

food_cts <- final %>% 
  select(mrn, DayRT, Food_NSC, dehydrated_weight) %>% 
  left_join(food_db %>% 
              select(Food_NSC = item1_value_raw_raw,
                     #Main.food.description,
                     FoodID), by  = 'Food_NSC') %>% 
  group_by(mrn, FoodID) %>% 
  summarise(total_de_wt = sum(dehydrated_weight)) %>% 
  spread(key = 'mrn', value = 'total_de_wt', fill = 0)

food_cts %>% 
  write_tsv('../data/finalized/all_patients_food_counts_table_w_maindescrip_featurename.tsv')

```



```{bash}
biom convert -i all_patients_food_counts_table_w_maindescrip_featurename.tsv -o all_patients_food_counts_table_w_maindescrip_featurename.biom --to-hdf5 --table-type="Table"
```

```{bash}
qiime tools import \
  --input-path all_patients_food_counts_table_w_maindescrip_featurename.biom \
  --output-path all_patients_food_counts_table_w_maindescrip_featurename.qza \
  --type 'FeatureTable[Frequency]'
```

Regenerated the food tree newick file with the tip being the food id

Convert the tree from newick to qza

```{bash}
qiime tools import \
  --input-path output_food_tree_datatree.newick \
  --output-path output_food_tree_datatree.qza \
  --type 'Phylogeny[Rooted]'
```


Use qiime and the above two files to calculate the unweighted_unifrac distance 

```{bash}
qiime diversity beta-phylogenetic \
  --i-table all_patients_food_counts_table_w_maindescrip_featurename.qza \
  --i-phylogeny ../source/output_food_tree_datatree.qza \
  --p-metric unweighted_unifrac \
  --o-distance-matrix unweighted_unifrac_distance_matrix.qza
```


Export the qza format to a readable table format

```{bash}
qiime tools export --input-path unweighted_unifrac_distance_matrix.qza --output-path beta_phylo
```

Check the beta distance matrix

```{r}
beta <- read_tsv('../data/finalized/beta_phylo/distance-matrix.tsv')
```

```{r}
# calculate the pcoa
beta_dist <- as.dist(beta %>% column_to_rownames('X1'))
food_pcoa <- pcoa(beta_dist)$vectors
 
# load the pheno info
pheno <- read_csv('../data/finalized/pheno_67.csv') %>% 
  # clean the intensity make them nicely cleaned three types
  mutate(intensity = if_else(str_detect(intensity,  fixed('REDUCE', ignore_case = T)), 'REDUCED',
                             if_else(str_detect(intensity,  fixed('non', ignore_case = T)), 'NONABL', 'ABLATIVE'))) %>% 
  # clean source 
  mutate(source = if_else(str_detect(source, 'Cord' ), 
                             'cord',
                             if_else(str_detect(source, 'SBA|CD34'), 
                                     'TCD',
                                     'unmodified')))

food_pcoa_df <- food_pcoa %>% 
  as.data.frame()  %>% 
  rownames_to_column('mrn') %>% 
  select(mrn, Axis.1:Axis.2) %>% 
  mutate(mrn =  as.numeric(mrn)) %>% 
  full_join(pheno, by = 'mrn')
```


```{r}
food_pcoa_df %>% 
  ggscatter('Axis.1', 'Axis.2', color = 'vital_status', palette = 'lancet',
            title = 'Beta diversity unweighted unifrac distance')
```

