---
title: "Batch 2 new 76 patients"
author: "Angel"
date: "2022-11-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(vdbR)
library(lubridate)
connect_database()
get_table_from_database()
```

```{r}
# the table from John that is the pull of the new patients clinical info
newdtb <- read_csv('../data/127_new_pt.csv')

pts <- read_csv('../data/127_new_pt.csv') %>% 
  distinct(mrn) 

pull <- read_csv('../data/pts_updated_through_june_2022.csv') %>% 
  inner_join(pts, by = c('MRN' = 'mrn')) %>% 
  # convert the hct date to date
  mutate(HCT = dmy(HCT)) %>% 
  arrange(MRN, desc(HCT)) %>%
  # two patients that had two hct, chose the one that is closest to now
  distinct(MRN, .keep_all = T) %>% 
  rename_with(tolower) %>% 
  rename_all(~ gsub(" ", "_", .))

pull %>% write_csv('../data/129_new_76_full_patient_info.csv')
pull %>% distinct(Disease) 
```

```{r}
# Collapse MSKCC messy diseases into broad, simplified categories

disim <- pull %>% 
  mutate(disease.simple = case_when(
    disease == "Leukemia" & sub_hist == "Acute" & sub_sub_hist == "Myelogenous" ~ 'AML',
    disease == "Leukemia" & sub_hist == "Acute" &sub_sub_hist == "Lymphoblastic" ~ "ALL",
    disease == "Leukemia" & sub_hist == "Chronic" & sub_sub_hist == "Myelogenous" ~ "CML",
    disease == "Leukemia" & sub_hist == "Chronic" & sub_sub_hist == "Myelomonocytic" ~ "MDS/MPN",
    disease == "Leukemia (Second Primary)" & sub_hist == "Acute" & sub_sub_hist == "Myelogenous" ~ "AML",
    disease == "Leukemia" & sub_hist == "Acute" & sub_sub_hist == "Monoblastic" | sub_sub_hist == "Monocytic" | sub_sub_hist == "Myelomonocytic" | sub_sub_hist =="Promyelocytic" ~ "AML",
    str_detect(disease, 'Aplastic') ~ "AA",
    str_detect(sub_hist, 'Aplastic') ~ "AA",
    str_detect(disease, 'Myelodysplastic|Myeloproliferative') ~ "MDS/MPN",
    str_detect(disease, 'Non-Hodgkin') ~ "NHL",
    str_detect(disease, 'Myeloma') ~ "Myeloma",
    str_detect(disease, "Hodgkin's Disease") ~ "Hodgkins",
    str_detect(sub_sub_hist, 'CLL') ~ "CLL",
    str_detect(sub_sub_hist, 'Prolymphocytic') ~ "NHL",
    str_detect(sub_sub_hist, 'Biphenotypic|Plasmacytoid Dendritic|Ambiguous|NK-LGL') ~ "other",
    str_detect(disease, 'Non-Malignant Hemat Disorders') ~ "other"
  ))

# the NA ones 
need_clean <- disim %>% 
  filter(is.na(disease.simple))
```

