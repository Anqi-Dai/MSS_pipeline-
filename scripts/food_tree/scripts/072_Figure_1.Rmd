---
title: "The fig1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setting}
library(tidyverse)
library(ggpubr)
library(cowplot)
library(ggimage)
#library(grConvert)


axis_text_size <- 11
axis_title_size <- 11
alpha_val <- 0.05
point_size <- 1.2
scatter_col <- 'gray14'
pick_point_size <- 1
pick_line_size <- 0.5
example_pt_line_size <- 0.3
diet_line_color <- 'darkolivegreen2'
stool_line_color <- 'yellow4'
```


```{r colors}
# the colors for each food group specified and saved here
fpalette <- tribble(
  ~fg1_name, ~color, ~fgrp1,
  #--|--|
  'fg_milk' , '#3498DB', '1',
  'fg_meat' , '#591605', '2',
  'fg_egg' , '#F1C40F', '3',
  'fg_legume' , '#E67E22', '4',
  'fg_grain' , '#D35400', '5',
  'fg_fruit' , '#7D3C98', '6',
  'fg_veggie' , '#229954', '7',
  'fg_oils' , '#707B7C',  '8',
  'fg_sweets' , '#db2589' , '9'
) 

fpalette %>% 
  write_csv('../data/cleaned_diet_data/food_group_color_key.csv')

```

# fig1 bottom 3

The first 2 need to be redo, since the data has been updated.

```{r load_table}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
```


```{r}
# the macronutrients scatter plot
m_all <- dtb %>%  
  select(mrn, fdrt,Protein_g:Sodium_g ) %>% 
  gather('grp','gram', Protein_g:Sodium_g) %>% 
  mutate(grp = str_replace(grp, '_g$','')) %>% 
  group_by(mrn, fdrt, grp) %>% 
  summarise(eachsum = sum(gram)) 

m_pick <- m_all %>% 
  filter(mrn == pick$mrn[1])  %>% 
  split(.$grp)


macro_list <- m_all %>% 
  split(.$grp) %>% 
  imap(function(.x, .y) {
      ggscatter(data = .x ,x = 'fdrt', y = 'eachsum', alpha = 0.02, size = point_size, 
            xlab = 'Day relative to HCT',
            ylab = 'Grams',
            title = str_glue('{.y}'),
            add = "loess", conf.int = TRUE, 
            add.params = list(color = diet_line_color, fill = "darkblue", size = 1))  +
  theme(axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        plot.title = element_text(size=axis_title_size),
        aspect.ratio=1)
  })

macro <- plot_grid(macro_list[[1]],macro_list[[2]],macro_list[[3]],macro_list[[4]],macro_list[[5]],macro_list[[6]],
          nrow = 2, 
          align = 'hv',
          #rel_widths =  c(1,1),
          #rel_heights = c(1,1),
          labels = c('A','B','C', 'D','E','F'),
          axis = 'tblr') 

ggsave('../figs/paper/072_macro_fig1_supp.pdf',
       width = 160,
       height = 120,
         #height = 60,
         units = c("mm"),
         dpi = 400, device = 'pdf')
```


```{r stool_alpha}
# picked patient
pick <- read_csv('../figs/paper/data/patient_pick_d0_diet.csv')

pick_stool <- meta %>% 
  filter(mrn == pick$mrn)

stool_alpha <- meta %>% 
  ggscatter(x = 'sdrt', y = 'simpson_reciprocal', alpha = alpha_val, size = point_size, 
            xlab = 'Day relative to HCT', shape = 'triangle',
            ylab = expression(Microbiome~alpha~diversity),
            title = expression(Microbiome~alpha~diversity),
            add = "loess", conf.int = TRUE, 
            add.params = list(color = stool_line_color, fill = "darkblue", size = 1)) +
  #geom_point(data = pick_stool, aes(x = sdrt, y = simpson_reciprocal), col = stool_line_color, size = example_pt_line_size, shape = 'triangle') +
  #geom_line(data = pick_stool, aes(x = sdrt, y = simpson_reciprocal), linetype = 'solid', size = example_pt_line_size, col = stool_line_color) +
  theme(axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        plot.title = element_text(size=axis_title_size),
        aspect.ratio=1)

```

```{r caloric_intake}
day_calori <- dtb %>% 
  group_by(mrn, fdrt) %>% 
  summarise(daycal = sum(Calories_kcal))

pick_cal <- day_calori %>% 
  filter(mrn == pick$mrn[1]) 

day_cal <- day_calori %>% 
  ggscatter(x = 'fdrt', y = 'daycal', alpha = alpha_val, size = point_size, 
            xlab = 'Day relative to HCT',
            ylab = 'Daily caloric intake',
            title = 'Daily caloric intake',
            color = scatter_col,
             add = "loess", conf.int = TRUE, 
            add.params = list(color = diet_line_color, fill = "darkblue", size = 1)) +  
  #geom_point(data = pick_cal, aes(x = fdrt, y = daycal), col = diet_line_color, size = example_pt_line_size) +
  #geom_line(data = pick_cal, aes(x = fdrt, y = daycal), linetype = 'solid', size = example_pt_line_size, col = diet_line_color) +
  theme(axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        plot.title = element_text(size=axis_title_size),
        aspect.ratio=1)

```

```{r nutrition_alpha}
# this faith pd is recently calculated in 2021-07
faith <- read_tsv('../data/cleaned_diet_data/FINAL_97_faith_pd/alpha-diversity.tsv') %>% 
  separate(...1, into = c('mrn', 'fdrt'), sep = 'd', convert = T)  %>% 
  mutate(mrn = as.numeric(str_replace(mrn, 'P','')))

pick_faith <- faith %>% 
  filter(mrn == pick$mrn[1])

diet_alpha <- faith %>% 
  ggscatter('fdrt', 'faith_pd', 
             alpha = alpha_val,size = point_size, 
            color = scatter_col, 
            ylab = expression(Diet~alpha~diversity), 
            xlab = 'Day relative to HCT',
            title = expression(Diet~alpha~diversity),
             add = "loess", conf.int = TRUE, 
            add.params = list(color = diet_line_color, fill = "darkblue", size = 1)) +
  #geom_point(data = pick_faith, aes(x = fdrt, y = faith_pd), col = diet_line_color, size = example_pt_line_size) +
  #geom_line(data = pick_faith, aes(x = fdrt, y = faith_pd), linetype = 'solid', size = example_pt_line_size, col = diet_line_color) +
  theme(axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        plot.title = element_text(size=axis_title_size),
        #plot.title = element_text(size=11, hjust = 0.5,  face = 'bold')
        ) + 
  theme(aspect.ratio=1)

```

```{r combine_bot3}
bot <- plot_grid(day_cal, diet_alpha, stool_alpha,
          nrow = 1, 
          align = 'hv',
          #rel_widths =  c(1,1),
          #rel_heights = c(1,1),
          labels = c('C','D','E'),
          axis = 'tblr') 

bot

ggsave('../figs/paper/072_bot_fig1.tiff',
       width = 180,
       height = 60,
         #height = 60,
         units = c("mm"),
         dpi = 400, device = 'tiff', plot = bot)
```

# fig1 top 3

```{r}
# the patient that is picked to showcase the timeline in data collection
pick <- read_csv('../figs/paper/data/patient_pick_d0_diet.csv')
pick <- read_csv('../figs/paper/data/patient_pick_d0_diet.csv')
```

```{r timeline_one}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv') %>% 
  group_by(mrn, fdrt) %>% 
  summarise(cal =  sum(Calories_kcal)) %>% 
  ungroup() %>% 
  mutate(food = 1) %>% 
  filter(mrn == pick$mrn) %>% 
  mutate(img = '/Users/daia1/pipeline/scripts/food_tree/figs/paper/pics/forkb.svg')

stb <- read_csv('../data/cleaned_stool/selected_stool_samples_type_abx.csv') %>% 
  mutate(stool = 0) %>% 
  filter(mrn == pick$mrn) %>% 
  mutate(img = '/Users/daia1/pipeline/scripts/food_tree/figs/paper/pics/poopb.svg')

asp_ratio <- 5

fig1_timeline <- dtb %>% 
  ggplot(aes(x = fdrt, y = food )) +
  geom_image(aes(image = img),
              size = 0.03, by = "width", asp = asp_ratio) +
  #geom_point(color = 'darkolivegreen4', size = 1.5) +
  #geom_point(data = stb, aes(x = sdrt, y = stool), color = 'gold4', size = 1.5) +
  geom_image(data = stb, aes(x = sdrt, y = stool, image = img),
             # Set size, and aspect ratio
    size = 0.03, by = "width", asp = asp_ratio) +
  facet_wrap(~mrn, scales = 'free') +
  theme_linedraw() +
  theme(strip.background = element_blank(),strip.text.x = element_blank(),
        axis.title.y=element_blank(), axis.title.x=element_blank(),
        axis.text.y=element_blank(),axis.ticks.y=element_blank(),
        panel.grid.minor=element_blank(),panel.grid.major.y=element_blank(),legend.position = "none") +
  scale_x_continuous(breaks = seq(-6, 21, by = 1), labels = seq(-6, 21, by = 1)) +
  theme(axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        panel.border = element_rect(colour = "black", fill = NA, size = 0.5),
        panel.grid.major.x = element_line(colour = "black", linetype = "dashed"),
        ) +
  labs(x = 'Day relative to transplant') +
  ylim(-0.5, 1.5) 

# ggsave('../figs/paper/fig1_timeline.pdf',
#          width = 170,
#          height = 40,
#          units = c("mm"),
#          dpi = 400,
#        plot = fig1_timeline)

```

```{r umap}
dcoords <- read_csv('../softwares/phylo-umap/taxumap/results/embedding_for_angel.csv')
link <- read_csv('../data/cleaned_diet_data/deidentify_dsample_map.csv')
coord <- dcoords %>% 
  inner_join(link) %>% 
  select(-fid, -pt)

fcts_fg <- read_csv('../data/cleaned_diet_data/summarize_food_groups_pt_daily.csv') 

fcts_fg_dom <- fcts_fg %>%
  group_by(mrn, fdrt) %>% 
  arrange(-grp_frac, .by_group = T) %>% 
  slice(1) %>% 
  ungroup() %>% 
  transmute(fid = str_glue('P{mrn}d{fdrt}'),
            fg1_dom = fg1_name) %>% 
  inner_join(link %>% select(fid, index_column))
   
df <- coord %>% 
  inner_join(fcts_fg_dom) %>% 
  left_join(fpalette %>% select(fg1_dom = fg1_name, color)) %>% 
  add_count(fg1_dom)

color_key <- df %>% 
  distinct(fg1_dom, color) %>% 
  mutate(fg1_dom = factor(fg1_dom)) %>% 
  arrange(fg1_dom) %>% 
  deframe()

fig1_umap <- df %>% 
  arrange(desc(n)) %>% 
  ggscatter(x = 'taxumap-LLLL-1', y = 'taxumap-LLLL-2', color = 'fg1_dom', alpha = alpha_val,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
  scale_color_manual(values = color_key) +
  theme_classic() +
  theme(legend.position = "none",
        axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        aspect.ratio=1) 

fig1_umap

ggsave('../figs/paper/072_fig1_umap.pdf',
       width = 52,
       height = 52,
         #height = 60,
         units = c("mm"),
         dpi = 400, device = 'pdf', plot = fig1_umap)
```
```{r diet_composition_histogram}
# examine that patient's dit pick the day that's most diverse
patient_pick <- read_csv('../figs/paper/data/patient_pick_all_diet.csv')

days <- patient_pick %>% 
  group_by(mrn, fdrt, Food_code) %>% 
  summarise(each = sum(dehydrated_weight)) %>% 
  ungroup() %>% 
  count(fdrt, mrn)

diverse_day <- days %>% 
  arrange(-n) %>% 
  slice(1) %>% 
  pull(fdrt)

# look at the day -5 diet
dm5 <- patient_pick %>% 
  filter(fdrt == diverse_day) %>% 
  select( mrn, fdrt, Food_code, description, dehydrated_weight ) %>% 
  mutate(fgrp1 = str_sub(Food_code, 1, 1)) %>% 
  left_join(fpalette, by = "fgrp1") %>%  
  arrange(fgrp1) %>% 
  add_count(fgrp1) %>% 
  arrange(-n, -dehydrated_weight) %>% 
  mutate(item = c('Baked salmon','Pork sausage','Beef shortribs','Pork bacon','Beef broth','Spinach','String beans','Broccoli','Tomato catsup','Gatorade G','Fruit juice drink','Chocolate cake','Milk shake','Egg omelet'))

fg_factor_level <- dm5 %>% 
  distinct(fg1_name) %>% pull(fg1_name)

daym5 <- dm5 %>%  
  mutate(fg1_name = factor(fg1_name, levels = fg_factor_level)) %>% 
  ggbarplot(x = 'item', y = 'dehydrated_weight', fill = 'fg1_name', color = 'white', xlab = '', ylab = 'Dehydrated weight',
            width = 0.9)  +
  facet_grid(~ fg1_name, space = "free", scales="free_x") +
  scale_fill_manual(values = color_key) +
  scale_y_continuous(expand = c(0, 0)) + 
  theme(strip.background = element_blank(),
        strip.text = element_blank(),
        panel.spacing.x = unit(0, "lines"),
        legend.position = 'none',
        axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        axis.text.x = element_text(angle=45, hjust=1, size = 6),
        axis.ticks.x = element_blank())


daym5
```

```{r tree}
# import the tree from pdf to a ggplot kind of object
p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
tree <- grImport2::pictureGrob( p )
```

```{r midright}
# middle right
midright <- plot_grid( daym5,  fig1_umap,
                  ncol = 1, labels = c('E','F'), rel_heights = c(0.5,0.5))

middle <- plot_grid( tree, midright,
                 nrow = 1,  labels = c('D',''), rel_widths = c(1.8,1))


# assemble all
f1 <-  plot_grid(top,  middle, bot,
                 rel_heights = c(1,2,1),
                 nrow = 3)

ggsave('../figs/paper/bot_fig1.pdf',
       width = 160,
       height = 80,
         #height = 60,
         units = c("mm"),
         dpi = 400,
       device = cairo_pdf , plot = bot)
```
 
```{r}
# wanna create a figure legend with the full food group names and a color palette
nodes <- read_tsv('../data/source/NodeLabels_withcomma.txt', col_types = 'cc') %>% 
  filter(nchar(Level.code) == 1) %>% 
  rename(fgrp1 = Level.code, 
         fdesc = Main.food.description) 

key <- read_csv('../data/cleaned_diet_data/food_group_color_key.csv', col_types = 'ccc')
```
  

```{r}
palette_fg <- nodes %>% 
  full_join(key) %>% 
  mutate(fdesc = str_replace_all(fdesc, '_',' ')) %>% 
  #mutate(fdesc = str_wrap(fdesc, width = 28, indent = 2, exdent = 0)) %>% 
  mutate(fdesc = str_replace(fdesc, 'and','&')) %>% 
  mutate(shortname = str_replace(fg1_name, 'fg_','')) %>% 
  mutate(shortname = str_to_title(shortname))
palette_fg %>% 
  write_csv('../data/cleaned_diet_data/food_group_color_key.csv')
```


```{r}
fg_colors <- palette_fg %>% 
  select(fdesc, color) %>% 
  deframe()

dtb %>% 
  mutate(fgrp1 = str_sub(Food_code, 1 ,1)) %>% 
  group_by(fgrp1) %>% 
  summarise(total = sum(dehydrated_weight)) %>% 
  full_join(palette_fg) %>% 
  ggbarplot(x = 'fdesc', y = 'total', 
            color = 'fdesc', fil = 'fdesc' ) +
  scale_color_manual(values = fg_colors)  +
  scale_fill_manual(values = fg_colors) 

ggsave('../figs/paper/072_fg_color_palette.pdf', dpi = 400, width = 15)
```

