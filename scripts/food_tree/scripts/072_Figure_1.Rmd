---
title: "The fig1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(cowplot)
```

# fig1 bottom 3

The first 2 need to be redo, since the data has been updated.

```{r}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
```
```{r}
alpha_val <- 0.1
```


```{r stool_alpha}
stool_alpha <- meta %>% 
  ggscatter(x = 'sdrt', y = 'simpson_reciprocal', alpha = alpha_val, 
            xlab = 'Day relative to HCT',
            ylab = 'Microbiome alpha diversity',
            add = "loess", color = 'darkgoldenrod3',
            add.params = list(color = "darkgoldenrod4", fill = "darkgray", size = 2), 
            conf.int = TRUE) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10),
        aspect.ratio=1)
stool_alpha
```

```{r caloric_intake}
day_calori <- dtb %>% 
  group_by(mrn, fdrt) %>% 
  summarise(daycal = sum(Calories_kcal))

day_cal <- day_calori %>% 
  ggscatter(x = 'fdrt', y = 'daycal', alpha = alpha_val, 
            xlab = 'Day relative to HCT',
            ylab = 'Daily caloric intake',
            add = "loess", color = 'plum3',
            add.params = list(color = "plum4", fill = "darkgray", size = 2), 
            conf.int = TRUE) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10),
        aspect.ratio=1)
day_cal
```

```{r nutrition_alpha}
# this faith pd is recently calculated in 2021-07
faith <- read_tsv('../data/cleaned_diet_data/FINAL_97_faith_pd/alpha-diversity.tsv') %>% 
  separate(X1, into = c('mrn', 'fdrt'), sep = 'd', convert = T)  %>% 
  mutate(mrn = as.numeric(str_replace(mrn, 'P','')))

diet_alpha <- faith %>% 
  ggscatter('fdrt', 'faith_pd', 
             alpha = alpha_val,
            color = 'mediumseagreen',
            ylab = "Diet alpha diversity", 
            xlab = 'Day relative to HCT',
            #title = 'Nutritional alpha diversity',
            add = "loess", 
            add.params = list(color = "seagreen4", fill = "darkgray", size = 2), 
            conf.int = TRUE) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10),
        #plot.title = element_text(size=11, hjust = 0.5,  face = 'bold')
        ) + 
  theme(aspect.ratio=1)
diet_alpha
```

```{r}
bot <- plot_grid(stool_alpha, day_cal, diet_alpha,
          nrow = 1, 
          align = 'hv',
          #rel_widths =  c(1,1),
          #rel_heights = c(1,1),
          #labels = "AUTO",
          axis = 'tblr') +
  ggsave('../figs/paper/fig1_bottom.pdf',
         width = 160,
         height = 80,
         units = c("mm"),
         dpi = 400)
bot

```

# fig1 top 3

```{r}
# the patient that is picked to showcase the timeline in data collection
pick <- read_csv('../figs/paper/data/patient_pick_d0_diet.csv')
```

```{r timeline_one}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv') %>% 
  group_by(mrn, fdrt) %>% 
  summarise(cal =  sum(Calories_kcal)) %>% 
  ungroup() %>% 
  mutate(food = 1) %>% 
  filter(mrn == pick$mrn)

stb <- read_csv('../data/cleaned_stool/selected_stool_samples_type_abx.csv') %>% 
  mutate(stool = 0) %>% 
  filter(mrn == pick$mrn)

dtb %>% 
  ggplot(aes(x = fdrt, y = food )) +
  geom_point(color = 'darkolivegreen4', size = 1.5) +
  geom_point(data = stb, aes(x = sdrt, y = stool), color = 'gold4', size = 1.5) +
  facet_wrap(~mrn, scales = 'free') +
  theme_linedraw() +
  theme(strip.background = element_blank(),
        strip.text.x = element_blank(),
        axis.title.y=element_blank(),
        axis.title.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.major.y=element_blank(),
        legend.position = "none") +
  scale_x_continuous(breaks = seq(-5, 20, by = 5), labels = seq(-5, 20, by = 5)) +
  theme(axis.text=element_text(size=10),
        axis.title=element_text(size=10),
        #plot.title = element_text(size=11, hjust = 0.5,  face = 'bold')
        ) +
  ylim(-0.5, 1.5) +
  ggsave('../figs/paper/fig1_timeline.pdf',
         width = 70,
         height = 30,
         units = c("mm"),
         dpi = 400)
```

```{r umap}
dcoords <- read_csv('../softwares/phylo-umap/taxumap/results/embedding_for_angel.csv')
link <- read_csv('../data/cleaned_diet_data/deidentify_dsample_map.csv')
coord <- dcoords %>% 
  inner_join(link) %>% 
  select(-fid, -pt)

fcts_fg <- read_csv('../data/cleaned_diet_data/summarize_food_groups_pt_daily.csv') 

fcts_fg_dom <- fcts_fg %>%
  group_by(mrn, fdrt) %>% 
  arrange(-grp_frac, .by_group = T) %>% 
  slice(1) %>% 
  ungroup() %>% 
  transmute(fid = str_glue('P{mrn}d{fdrt}'),
            fg1_dom = fg1_name) %>% 
  inner_join(link %>% select(fid, index_column))
   
df <- coord %>% 
  inner_join(fcts_fg_dom) %>% 
  mutate(color = case_when(
    fg1_dom == 'fg_milk' ~ '#3498DB',
    fg1_dom == 'fg_meat' ~ '#C0392B',
    fg1_dom == 'fg_egg' ~ '#F1C40F',
    fg1_dom == 'fg_legume' ~ '#E67E22',
    fg1_dom == 'fg_grain' ~ '#D35400',
    fg1_dom == 'fg_fruit' ~ '#7D3C98',
    fg1_dom == 'fg_veggie' ~ '#229954',
    fg1_dom == 'fg_oils' ~ '#707B7C', 
    fg1_dom == 'fg_sweets' ~ '#D81B60'
  )) %>% 
  add_count(fg1_dom)

color_df <- df %>% 
  distinct(fg1_dom, color) %>% 
  mutate(fg1_dom = factor(fg1_dom)) %>% 
  arrange(fg1_dom)

values <- df$color

df %>% 
  arrange(desc(n)) %>% 
  ggplot(aes(x = `taxumap-LLLL-1`, y = `taxumap-LLLL-2`))+
  geom_point(aes(colour = factor(fg1_dom)),alpha = 0.4, size = 2 ) +
  scale_color_manual(values = color_df$color) +
  theme_void() +
  theme(legend.position = "none") +
  ggsave('../figs/paper/fig1_umap.pdf', 
         width = 70,
         height = 50,
         units = c("mm"),
         dpi = 400)

```
