---
title: "Taxa association using deseq2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(DESeq2)
library(ggpubr)
```

# the meta table and adjust to the right format

```{r}
# load the data
# to add a column (mrn_N) that distinguishes the mrn nested within an intensity condition
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d.csv')  %>% 
  arrange(sampleid) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(abx = factor(abx, levels = c('non_empirical','empirical')),
         mrn = factor(mrn),
         source = factor(source),
         sex = factor(sex)) %>% 
  mutate(abx_ = as.numeric(abx),
         intensity_ = as.numeric(intensity),
         mrn_ = as.numeric(mrn)) %>% 
  arrange(intensity_, mrn_) %>% 
  split(.$intensity) %>% 
  map_dfr(~ mutate(.data = ., mrn_N = factor(as.numeric(as.factor(mrn_)))))
```

# the counts table (species count)

```{r}
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv') %>% 
  filter(sampleid %in% meta$sampleid) %>% 
  select(sampleid, taxa_genus, cnt) %>% 
  arrange(sampleid)
```

```{r}
# the distribution of the total count of the genera
total_cnt <- cts %>% 
  group_by(taxa_genus) %>% 
  summarise(total = sum(cnt))

quantile(x = total_cnt$total, probs = seq(0,1,0.05))

# total_cnt %>% 
#   gghistogram(x = 'total', bins = 100)

# also see how many samples per patient
# meta %>% 
#   dplyr::count(mrn) %>% 
#   arrange(n)
```

have at least 4 raw count in at least 10% of the samples

```{r}
# filter the count table
cts_ma <- cts %>% 
  spread(key = 'sampleid', value = 'cnt') %>% 
  column_to_rownames('taxa_genus') %>% 
  as.matrix()

num_thre <- floor(ncol(cts_ma) * 0.1)

cts_ma_fil <- cts_ma[rowSums(cts_ma >= 4) >= num_thre, ]
```

The design formular

```{r}
design_f <- model.matrix(~  fg_fruit + 
                            fg_meat + 
                            fg_milk + 
                            fg_oils +  
                            fg_egg + 
                            fg_grain + 
                            fg_sweets + 
                            fg_veggie + 
                            fg_legume+ 
                            abx + 
                            intensity + 
                            intensity : mrn_N +  
                            intensity: sdrt, meta)


all.zero <- apply(design_f, 2, function(x) all(x==0))


idx <- which(all.zero)
design_f <- design_f[,-idx]


df <- as.data.frame(rowSums(cts_ma_fil))
```


```{r}
# the deseq2 part
dds <- DESeqDataSetFromMatrix(countData = cts_ma_fil + 1,# to avoid at least one entry has at least one zero
                              colData = meta,
                              design = design_f)
```

```{r}
dds <- DESeq(dds, test = 'Wald',
             betaPrior = F,
             full = design_f,
             fitType =' local',
             parallel = T) 
```

```{r}
colnames(design_f)[1:10]
```


```{r}
res <- results(dds, name = 'fg_grain')
summary(res)
ttt <- as.data.frame(res)
```

