---
title: "correlate food group and nutrient with stool alpha diversity"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(ggpubr)  
```

```{r}
foods <- read_tsv('../data/finalized/meta_data_67.tsv') %>% 
  select(mrn, Fdrt = foodDayRT, egg_total:Sugars_perc) %>% 
  gather(key = 'type', value = 'value', egg_total:Sugars_perc)
```

## Select a subset patients cohort that each pt has at least 4 pairs(stool and previous 3 days diet

```{r}
# previous 3 days food all types average
fns_all <- list.files(str_glue('../data/finalized/paired/p3day/'), full.names = T)
  
all <- fns_all %>% 
    set_names(fns_all) %>% 
    map(~ read_csv(file = ., col_names = T, col_types = cols(.default = col_character()))) %>% 
    bind_rows() %>% 
    mutate(mrn = as.numeric(mrn))
    
subset_pts <- all %>% 
  count(mrn)  %>% 
  arrange(n) %>% 
  filter(n >= 4) %>% 
  pull(mrn)

all_p3day <- all %>% 
  filter(mrn %in% subset_pts) %>% 
  mutate(ID = str_glue('{mrn}_{sampleid}'))
```

## Get the average of the food group and the nutrients in percentage and in gram weight

```{r}
type_items <-  foods %>% 
  distinct(type) %>% 
  pull(type) 

pair_p3day_food <- apply(all_p3day, 1, function(Row){
    foods %>% 
        filter(mrn == Row[['mrn']]) %>% 
        filter(Fdrt %in% c(Row[['p1dF']], Row[['p2dF']],Row[['p3dF']])) %>% 
        group_by(type) %>% 
        summarise(ave_type = mean(value))
})

names(pair_p3day_food) <- all_p3day$ID

pair_p3day_food_res <- bind_rows(pair_p3day_food, .id = 'ID') %>% 
  separate(ID, into = c('mrn','sampleid'), sep = '_') 

```

## Get the stool alpha diversity from db

```{r}
# get the diversity of those stool samples
source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')
get_table_from_database_predefined_filter('asv_alpha_diversity_ag')

pair_p3day <- pair_p3day_food_res  %>% 
  inner_join(asv_alpha_diversity_ag %>% select(sampleid, simpson_reciprocal, shannon), by = 'sampleid')   
```

## Spearman correlation and plot

```{r}
nutrients <- c('Carbohydrates','Fat','Fibers','Proteing','Sodium','Sugars')

spearman_res <- pair_p3day %>% 
  split(.$type) %>% 
  map_dfr(~ round(cor.test(.$ave_type, 
                           .$simpson_reciprocal, 
                           method = 'spearman', 
                           exact = F)$estimate, 2)) %>% 
  gather(key = 'type', value = 'rho') %>% 
  arrange(rho) %>% 
  separate(type, into = c('item','grp'), sep = '_') %>% 
  mutate(type = if_else(item %in%  nutrients, 'nutrient', 'food_group'))

spearman_res %>% 
  filter(type == 'nutrient') %>% 
  ggbarplot(x = 'item', y = 'rho', fill = 'salmon', label = T, lab.size = 2.5,
            title = 'Spearman cor between ave nutrient metric & stool alpha diversity') +
  facet_grid(grp ~ .) +
  theme_cleveland() 



spearman_res %>% 
  filter(type == 'food_group') %>% 
  ggbarplot(x = 'item', y = 'rho', fill = 'salmon', label = T, lab.size = 2.5,
            title = 'Spearman cor between ave food group metric & stool alpha diversity') +
  facet_grid(grp ~ .) +
  theme_cleveland() 

```

