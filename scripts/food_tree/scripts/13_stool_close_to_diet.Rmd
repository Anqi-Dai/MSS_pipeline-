---
title: "Selecting samples close to the diet data for patient"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)  
```

```{r}
# load the current dtable(diet) and stb(stool)
dtb <- read_tsv('../data/finalized/meta_data_67.tsv')

stb <- read_tsv('../data/pheno/samples_pheno_67.tsv') %>% 
  # remove the duplicates on same day
  arrange(mrn, drt, desc(count_total)) %>% 
  distinct(mrn, drt, .keep_all = T) %>% 
  filter(drt %in% -5:46)
```

# Visualize how the diet data and stool data distribute across the patients  

```{r}
# now I only care about the day relative to transplant in both
dtb_ <- dtb %>% 
  select(mrn, foodDayRT) %>% 
  arrange(foodDayRT) %>% 
  mutate(mrn_Fdrt = str_glue('{mrn}d{foodDayRT}'))

stb_ <- stb %>% 
  select(mrn, drt) %>% 
  arrange(drt) %>% 
  mutate(mrn_drt = str_glue('{mrn}d{drt}'))

# find for each patient the distribution of the stool samples and diet samples 
dtb_stb_join <- stb_ %>% 
  full_join(dtb_ %>% rename(drt = foodDayRT), by  = c('mrn','drt')) %>% 
  mutate(mrn_drt = str_glue('{mrn}d{drt}')) %>% 
  mutate(diet_data = if_else(mrn_drt %in% dtb_$mrn_Fdrt, 5, 0),
         stool_data = if_else(mrn_drt %in% stb_$mrn_drt, 5, 0)) %>% 
  gather(key = 'type', value = 'collectedYN', diet_data:stool_data)
```


```{r}
dtb_stb_join %>% 
  # hide the mrn
  mutate(mrn = as.numeric(as.factor(mrn))) %>% 
  mutate(mrn = str_glue("P{str_pad(mrn, 3, 'left', '0')}")) %>% 
  ggbarplot(x = 'drt', y = 'collectedYN', fill = 'type', palette = 'npg', xlab = 'Day relative to transplant',
            ylab = '', title = 'Sample collection for both diet and stool data' ) +
  facet_grid(mrn~ .) +
  theme_bw() +
  theme(legend.position = 'top',
        axis.text.y = element_blank()) +
  scale_fill_manual(values = c('#469990','#9a6324')) +
  ggsave('../figs/stool_diet_pair_dist.pdf', width = 12, height = 40)
```

