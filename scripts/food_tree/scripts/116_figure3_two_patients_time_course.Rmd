---
title: "Figure 3 two patients timecouse"
author: "Angel"
date: '2022-06-13'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
axis_text_size <- 11
axis_title_size <- 11
plot_ratio <-1.5/2
library(tidyverse)
library(ggpubr)
library(vdbR)
connect_database('~/dbConfig.txt')
get_table_from_database('qpcr_16s_ag')
get_table_from_database('antibiotics_antibacterial_multicenter_ag')

updated_qPCR <- qpcr_16s_ag %>%
  rename(sampleid=sample_id,
         copies_16s_per_g_pre = copies_16s_per_g) %>% 
  mutate(
    g = copy_number_16s/ copies_16s_per_g_pre,
    copies_16s_bounded = ifelse(
      copy_number_16s < 12800, 
      (12800*.5),
      ifelse(
        copy_number_16s > 2e8,
        1.5 * (2e8),
        copy_number_16s
      )
    )
  ) %>% 
  mutate(copies_16s_per_g =  copies_16s_bounded/g) 
```

Now I'm gonna really clean out the scripts that makes the figure 3 timecourse, and also add the egg intake data.

```{r}
klept <- read_csv('../data/095_Klebsiella-patient.csv')
ent_pt <- read_csv('../data/075_entero_pt.csv')
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
# the table that Peter checked for me the real missing days in the timeline of these two patients
missing <- read_csv('../data/114_timeline_2_pt_check_missing_6__PP_check.csv')


# the population data about daily sweets consumption and fruits and eggs comsumption
all9 <- dtb %>%  
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^9')) %>% 
  group_by(mrn, fdrt) %>% 
  summarise(sweetdaily = sum(dehydrated_weight))

s_q25 <- quantile(x = all9$sweetdaily, 0.25)
s_q50 <- quantile(x = all9$sweetdaily, 0.5)
s_q75 <- quantile(x = all9$sweetdaily, 0.75)
highest_daily_sweet_intake <- ceiling( max(all9$sweetdaily))
lowest_daily_sweet_intake <- floor( min(all9$sweetdaily))

# fruits
all6 <- dtb %>%  
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^6')) %>% 
  group_by(mrn, fdrt) %>% 
  summarise(fruitdaily = sum(dehydrated_weight))

f_q25 <- quantile(x = all6$fruitdaily, 0.25)
f_q50 <- quantile(x = all6$fruitdaily, 0.5)
f_q75 <- quantile(x = all6$fruitdaily, 0.75)
highest_daily_fruit_intake <- ceiling( max(all6$fruitdaily))
lowest_daily_fruit_intake <- floor( min(all6$fruitdaily))

# eggs
all3 <- dtb %>%  
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^3')) %>% 
  group_by(mrn, fdrt) %>% 
  summarise(eggdaily = sum(dehydrated_weight))

e_q25 <- quantile(x = all3$eggdaily, 0.25)
e_q50 <- quantile(x = all3$eggdaily, 0.5)
e_q75 <- quantile(x = all3$eggdaily, 0.75)
highest_daily_egg_intake <- ceiling( max(all3$eggdaily))
lowest_daily_egg_intake <- floor( min(all3$eggdaily))
```

# the Enterococcus patient

## the abx p11
```{r}
p11_abx <- antibiotics_antibacterial_multicenter_ag %>% 
  filter(patient_id == ent_pt$mrn ) %>% 
  rename(mrn = patient_id) %>% 
  mutate(mrn = as.numeric(mrn)) %>% 
  left_join(ptb %>% 
              select(mrn, hct)) %>% 
  mutate(startdrt = start - hct,
         stopdrt = stop - hct) %>% 
  # only select the days relevant
  filter(startdrt %in% -5:-2) %>% 
  mutate(drugfull = str_glue('{drug_name_clean} ({route_simple})')) %>% 
  arrange(startdrt, stopdrt) %>% 
  mutate(yval = seq(1, nrow(.))) %>% 
  mutate(startdrt = as.numeric(startdrt) ) %>% 
  mutate(startdrt = if_else(startdrt == -5, -5.1, startdrt))

xmin <- -5.1
xmax = 15

abx_ent <- ggplot(p11_abx, aes(x = startdrt, y = yval, xend = stopdrt, yend = yval, label = drugfull )) +
  geom_segment(
    size = 2, lineend = 'square', alpha = 0.5
  ) +
  geom_text(hjust = 'outside', nudge_y = -0.1, nudge_x = 5, size = 1.3) +
  coord_cartesian(xlim=c(xmin, xmax)) + 
  labs(x = '',
       y = '',
       title = 'Antibiotics') + 
  theme_classic() +
  theme(aspect.ratio=plot_ratio,axis.ticks.y=element_blank(), axis.text.y=element_blank(),line = element_blank(),axis.text=element_blank(),axis.title=element_blank(),plot.title = element_blank(),panel.grid.major.x = element_blank())
```

## the sweets p11
```{r}
missing_days_p11 <- missing %>% 
  filter(mrn == ent_pt$mrn & diet_data_status == 'missing' ) %>% 
  pull(fdrt)

p11_sweets <- dtb %>%  
  filter(mrn == ent_pt$mrn & fdrt %in% -4:15) %>% 
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^9')) %>% 
  group_by(fdrt) %>% 
  summarise(sweetsum = sum(dehydrated_weight)) %>% 
  full_join(tibble(
    fdrt = seq(-2, 12, 1)
  )) %>% 
  mutate(sweetsum = if_else(is.na(sweetsum), 0, sweetsum)) %>% 
  # there are days that are actually missing
  filter(! fdrt %in% missing_days_p11)
```


```{r}
sweets_ent <- p11_sweets %>%    
  ggplot(aes(x = fdrt, y = sweetsum )) +
  annotate('rect', xmin = xmin, xmax = xmax, ymin = s_q25, ymax = s_q75, fill='gray',  alpha=0.3) +
  geom_point(col = 'black') +
  geom_line(aes(x = fdrt, y = sweetsum), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = '',
       y = 'Sweets(g)',
       title = '') +
  theme_classic() + 
  ylim(0, max(p11_sweets$sweetsum))+
  theme(aspect.ratio=plot_ratio,
        axis.ticks.x=element_blank(),
        axis.text.x=element_blank(),
        plot.margin = margin(l=-0.8,unit="cm"),
        axis.text=element_text(size=axis_text_size),
        axis.title=element_text(size=axis_title_size),
        plot.title = element_text(size=axis_title_size),
        panel.grid.major.x = element_line(colour = "grey85"))
sweets_ent
```

