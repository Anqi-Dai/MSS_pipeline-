---
title: "The model re-done with Bayesian"  
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F)
```


```{r}
library(tidyverse)
library(brms)   
library(ggpubr)
library(tidybayes)
library(cowplot)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
theme_set(theme_tidybayes() + panel_border())
ncores <- parallel::detectCores()
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
axis_text_size <- 10
axis_title_size <- 10

dtb %>% 
  distinct(mrn) %>% 
  write_csv('../data/nutrition_patients_97_mrns.csv', col_names = T)
```

## Loading meta data table

```{r load_meta}
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(mrn = factor(mrn)) %>% 
  mutate(fg_egg = fg_egg/100,
         fg_fruit = fg_fruit/100,
         fg_grain = fg_grain/100,
         fg_legume = fg_legume/100,
         fg_meat = fg_meat/100,
         fg_milk = fg_milk/100,
         fg_oils = fg_oils/100,
         fg_sweets = fg_sweets/100,
         fg_veggie = fg_veggie/100) %>% 
  mutate(inten_non = if_else(intensity == 'nonablative', 1, 0),
         inten_ab = if_else(intensity == 'ablative', 1, 0),
         inten_re = if_else(intensity == 'reduced', 1, 0)) 

colnames(meta)


```

## Priors 

```{r get_prior}
# what priors I cann set 
model_formular <- log(simpson_reciprocal)~ 1 +
                fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
               inten_non + inten_ab + inten_re +
               empirical+
                TPN+
                EN+
               (1 | mrn) +
                (1 | timebin)
get_prior( model_formular,  
              data = meta)
```

### Setting priors

```{r set_prior}

priors <- c(# for the food group variables
            prior(normal(0, 1), class = 'b', coef = "fg_egg"),
            prior(normal(0, 1), class = 'b', coef = "fg_fruit"),
            prior(normal(0, 1), class = 'b', coef = "fg_grain"),
            prior(normal(0, 1), class = 'b', coef = "fg_legume"),
            prior(normal(0, 1), class = 'b', coef = "fg_meat"),
            prior(normal(0, 1), class = 'b', coef = "fg_milk"),
            prior(normal(0, 1), class = 'b', coef = "fg_oils"),
            prior(normal(0, 1), class = 'b', coef = "fg_sweets"),
            prior(normal(0, 1), class = 'b', coef = "fg_veggie"),
            # for the TPN 
            prior(normal(0, 0.1), class = 'b', coef = "TPNTRUE"),
            # for the EN
            prior(normal(0, 0.1), class = 'b', coef = "ENTRUE"),
            # for the empirical 
            prior(normal(0, 0.5), class = 'b', coef = "empiricalTRUE"),
            # for the intensity 
            prior(normal(0, 0.1), class = 'b', coef = "inten_re"),
            prior(normal(0, 0.1), class = 'b', coef = "inten_ab"),
            prior(normal(0, 0.1), class = 'b', coef = "inten_non"),
            prior(normal(2, 0.1), class = 'Intercept'))

# samples are drawn solely from the priors ignoring the likelihood
# model_wo_EN  means the usual model that the EN is still a binary variable and not ann inndivicual group
model_div <- brm( model_formular,  
              data = meta, 
              warmup = 1000, iter = 3000, 
              prior = priors,
              cores = ncores, 
              chains = 2, 
              seed = 123, sample_prior = T) 

# actually draw samples from the priors 
samples_prior <- prior_draws(model_div)

```

```{r }
# the mean food group intake from our data 
ave_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(mean)) %>% 
  gather

mean_fg <-  meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(mean))

max_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(max)) 


```


```{r}
# create a df with max and min and ave in 9 groups
# create a df with the corresponding value that the samples prior coeff can multiply
max_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(max_fg_egg = if_else(key == 'fg_egg', max_fg$fg_egg, mean_),
         max_fg_fruit = if_else(key == 'fg_fruit', max_fg$fg_fruit, mean_),
         max_fg_grain = if_else(key == 'fg_grain', max_fg$fg_grain, mean_),
         max_fg_legume = if_else(key == 'fg_legume', max_fg$fg_legume, mean_),
         max_fg_meat = if_else(key == 'fg_meat', max_fg$fg_meat, mean_),
         max_fg_milk = if_else(key == 'fg_milk', max_fg$fg_milk, mean_),
         max_fg_oils = if_else(key == 'fg_oils', max_fg$fg_oils, mean_),
         max_fg_sweets = if_else(key == 'fg_sweets', max_fg$fg_sweets, mean_),
         max_fg_veggie = if_else(key == 'fg_veggie', max_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)



values <- max_ %>%
  select(-key) %>%
  as.list()

values <- values %>%
  map(~ set_names(x = ., max_$key))

# calculate the resulted prior log div
vals <- names(values)
```

```{r}
# calculate the min, 25, 50, 75  quantiles of each of the food groups
min_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(min)) 

q25_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(quantile(., probs = c(0.25)))) 

q50_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(quantile(., probs = c(0.5)))) 

q75_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(quantile(., probs = c( 0.75)))) 

q90_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(quantile(., probs = c( 0.9)))) 

q80_fg <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(quantile(., probs = c( 0.8)))) 

min_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(min_fg_egg = if_else(key == 'fg_egg', min_fg$fg_egg, mean_),
         min_fg_fruit = if_else(key == 'fg_fruit', min_fg$fg_fruit, mean_),
         min_fg_grain = if_else(key == 'fg_grain', min_fg$fg_grain, mean_),
         min_fg_legume = if_else(key == 'fg_legume', min_fg$fg_legume, mean_),
         min_fg_meat = if_else(key == 'fg_meat', min_fg$fg_meat, mean_),
         min_fg_milk = if_else(key == 'fg_milk', min_fg$fg_milk, mean_),
         min_fg_oils = if_else(key == 'fg_oils', min_fg$fg_oils, mean_),
         min_fg_sweets = if_else(key == 'fg_sweets', min_fg$fg_sweets, mean_),
         min_fg_veggie = if_else(key == 'fg_veggie', min_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)

q25_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(q25_fg_egg = if_else(key == 'fg_egg', q25_fg$fg_egg, mean_),
         q25_fg_fruit = if_else(key == 'fg_fruit', q25_fg$fg_fruit, mean_),
         q25_fg_grain = if_else(key == 'fg_grain', q25_fg$fg_grain, mean_),
         q25_fg_legume = if_else(key == 'fg_legume', q25_fg$fg_legume, mean_),
         q25_fg_meat = if_else(key == 'fg_meat', q25_fg$fg_meat, mean_),
         q25_fg_milk = if_else(key == 'fg_milk', q25_fg$fg_milk, mean_),
         q25_fg_oils = if_else(key == 'fg_oils', q25_fg$fg_oils, mean_),
         q25_fg_sweets = if_else(key == 'fg_sweets', q25_fg$fg_sweets, mean_),
         q25_fg_veggie = if_else(key == 'fg_veggie', q25_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)

q50_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(q50_fg_egg = if_else(key == 'fg_egg', q50_fg$fg_egg, mean_),
         q50_fg_fruit = if_else(key == 'fg_fruit', q50_fg$fg_fruit, mean_),
         q50_fg_grain = if_else(key == 'fg_grain', q50_fg$fg_grain, mean_),
         q50_fg_legume = if_else(key == 'fg_legume', q50_fg$fg_legume, mean_),
         q50_fg_meat = if_else(key == 'fg_meat', q50_fg$fg_meat, mean_),
         q50_fg_milk = if_else(key == 'fg_milk', q50_fg$fg_milk, mean_),
         q50_fg_oils = if_else(key == 'fg_oils', q50_fg$fg_oils, mean_),
         q50_fg_sweets = if_else(key == 'fg_sweets', q50_fg$fg_sweets, mean_),
         q50_fg_veggie = if_else(key == 'fg_veggie', q50_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)


q75_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(q75_fg_egg = if_else(key == 'fg_egg', q75_fg$fg_egg, mean_),
         q75_fg_fruit = if_else(key == 'fg_fruit', q75_fg$fg_fruit, mean_),
         q75_fg_grain = if_else(key == 'fg_grain', q75_fg$fg_grain, mean_),
         q75_fg_legume = if_else(key == 'fg_legume', q75_fg$fg_legume, mean_),
         q75_fg_meat = if_else(key == 'fg_meat', q75_fg$fg_meat, mean_),
         q75_fg_milk = if_else(key == 'fg_milk', q75_fg$fg_milk, mean_),
         q75_fg_oils = if_else(key == 'fg_oils', q75_fg$fg_oils, mean_),
         q75_fg_sweets = if_else(key == 'fg_sweets', q75_fg$fg_sweets, mean_),
         q75_fg_veggie = if_else(key == 'fg_veggie', q75_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)


q90_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(q90_fg_egg = if_else(key == 'fg_egg', q90_fg$fg_egg, mean_),
         q90_fg_fruit = if_else(key == 'fg_fruit', q90_fg$fg_fruit, mean_),
         q90_fg_grain = if_else(key == 'fg_grain', q90_fg$fg_grain, mean_),
         q90_fg_legume = if_else(key == 'fg_legume', q90_fg$fg_legume, mean_),
         q90_fg_meat = if_else(key == 'fg_meat', q90_fg$fg_meat, mean_),
         q90_fg_milk = if_else(key == 'fg_milk', q90_fg$fg_milk, mean_),
         q90_fg_oils = if_else(key == 'fg_oils', q90_fg$fg_oils, mean_),
         q90_fg_sweets = if_else(key == 'fg_sweets', q90_fg$fg_sweets, mean_),
         q90_fg_veggie = if_else(key == 'fg_veggie', q90_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)


q80_ <- ave_fg %>%
  rename(mean_ = value) %>%
  mutate(q80_fg_egg = if_else(key == 'fg_egg', q80_fg$fg_egg, mean_),
         q80_fg_fruit = if_else(key == 'fg_fruit', q80_fg$fg_fruit, mean_),
         q80fg_grain = if_else(key == 'fg_grain', q80_fg$fg_grain, mean_),
         q80_fg_legume = if_else(key == 'fg_legume', q80_fg$fg_legume, mean_),
         q80_fg_meat = if_else(key == 'fg_meat', q80_fg$fg_meat, mean_),
         q80_fg_milk = if_else(key == 'fg_milk', q80_fg$fg_milk, mean_),
         q80_fg_oils = if_else(key == 'fg_oils', q80_fg$fg_oils, mean_),
         q80_fg_sweets = if_else(key == 'fg_sweets', q80_fg$fg_sweets, mean_),
         q80_fg_veggie = if_else(key == 'fg_veggie', q80_fg$fg_veggie, mean_)) %>%
  select(-mean_) %>%
  mutate(key = if_else(str_detect(key, '^fg'), str_glue('b_{key}'), key))  %>%
  arrange(key)
```

```{r}
# the calculated ln(diversity) when the others are ave but one group is the min
values_min <- min_ %>%
  select(-key) %>%
  as.list()

values_min <- values_min %>%
  map(~ set_names(x = ., min_$key))

# calculate the resulted prior log div
vals_min <- names(values_min)


min_each_fg_post <- vals_min  %>%  
  set_names(vals_min) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values_min %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```

```{r}
# the calculated ln(diversity) when the others are ave but one group is the q25
values_q25 <- q25_ %>%
  select(-key) %>%
  as.list()

values_q25 <- values_q25 %>%
  map(~ set_names(x = ., q25_$key))

# calculate the resulted prior log div
vals_q25 <- names(values_q25)


q25_each_fg_post <- vals_q25  %>%  
  set_names(vals_q25) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values_q25 %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```


```{r}
# the calculated ln(diversity) when the others are ave but one group is the q50
values_q50 <- q50_ %>%
  select(-key) %>%
  as.list()

values_q50 <- values_q50 %>%
  map(~ set_names(x = ., q50_$key))

# calculate the resulted prior log div
vals_q50 <- names(values_q50)


q50_each_fg_post <- vals_q50  %>%  
  set_names(vals_q50) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values_q50 %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```

```{r}
# the calculated ln(diversity) when the others are ave but one group is the q50
values_q80 <- q80_ %>%
  select(-key) %>%
  as.list()

values_q80 <- values_q80 %>%
  map(~ set_names(x = ., q80_$key))

# calculate the resulted prior log div
vals_q80 <- names(values_q80)


q80_each_fg_post <- vals_q80  %>%  
  set_names(vals_q80) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values_q80 %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```


```{r}
# the calculated ln(diversity) when the others are ave but one group is the q50
values_q90 <- q90_ %>%
  select(-key) %>%
  as.list()

values_q90 <- values_q90 %>%
  map(~ set_names(x = ., q90_$key))

# calculate the resulted prior log div
vals_q90 <- names(values_q90)


q90_each_fg_post <- vals_q90  %>%  
  set_names(vals_q90) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values_q90 %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```


```{r}
# the calculated ln(diversity) when the others are ave but one group is the q75
values_q75 <- q75_ %>%
  select(-key) %>%
  as.list()

values_q75 <- values_q75 %>%
  map(~ set_names(x = ., q75_$key))

# calculate the resulted prior log div
vals_q75 <- names(values_q75)


q75_each_fg_post <- vals_q75  %>%  
  set_names(vals_q75) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values_q75 %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```

```{r}
# calculate the original scale predicted diversity
post_pred_min <- min_each_fg_post %>% 
  as.list() %>% 
  map(function(vec) {
    tibble(
      min_=vec
    ) %>% 
      mutate(
             post_min_pred =  exp(min_))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'min_','')) 

post_pred_q25 <- q25_each_fg_post %>% 
  as.list() %>% 
  map(function(vec) {
    tibble(
      q25_=vec
    ) %>% 
      mutate(
             post_q25_pred =  exp(q25_))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'q25_',''))

post_pred_q50 <- q50_each_fg_post %>% 
  as.list() %>% 
  map(function(vec) {
    tibble(
      q50_=vec
    ) %>% 
      mutate(
             post_q50_pred =  exp(q50_))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'q50_',''))

post_pred_q80 <- q80_each_fg_post %>% 
  as.list() %>% 
  map(function(vec) {
    tibble(
      q80_=vec
    ) %>% 
      mutate(
             post_q80_pred =  exp(q80_))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'q80_',''))

post_pred_q90 <- q90_each_fg_post %>% 
  as.list() %>% 
  map(function(vec) {
    tibble(
      q90_=vec
    ) %>% 
      mutate(
             post_q90_pred =  exp(q90_))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'q90_',''))


post_pred_q75 <- q75_each_fg_post %>% 
  as.list() %>% 
  map(function(vec) {
    tibble(
      q75_=vec
    ) %>% 
      mutate(
             post_q75_pred =  exp(q75_))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'q75_',''))

all_pred <- bind_rows(
  post_pred_min %>% 
    filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie')) %>% 
    rename(pred_div = post_min_pred) %>% 
    mutate(type = 'min')%>% 
    select(term, pred_div,type ),
  post_pred_q25 %>% 
    filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie')) %>% 
    rename(pred_div = post_q25_pred) %>% 
    mutate(type = '25%')%>% 
    select(term, pred_div,type ),
  post_pred_q50 %>% 
    filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie')) %>% 
    rename(pred_div = post_q50_pred) %>% 
    mutate(type = '50%')%>% 
    select(term, pred_div,type ),
  post_pred_q80 %>% 
    filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie')) %>% 
    rename(pred_div = post_q80_pred) %>% 
    mutate(type = '80%')%>% 
    select(term, pred_div,type ),
  post_pred_q90 %>% 
    filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie')) %>% 
    rename(pred_div = post_q90_pred) %>% 
    mutate(type = '90%')%>% 
    select(term, pred_div,type ),
  post_pred_q75 %>% 
    filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie')) %>% 
    rename(pred_div = post_q75_pred) %>% 
    mutate(type = '75%') %>% 
    select(term, pred_div,type ),
  
  only3 %>% 
    select(post_max_pred, term) %>% 
    rename(pred_div = post_max_pred) %>% 
    mutate(type = 'max') %>% 
    select(term, pred_div,type ),
  only3 %>% 
    select(post_ave_pred, term) %>% 
    rename(pred_div = post_ave_pred) %>% 
    mutate(type = 'ave') %>% 
    select(term, pred_div,type )
) 
```

```{r}
# plotting
all_pred %>% 
  mutate(feature = str_glue('{term} {type}')) %>% 
  split(.$term) %>% 
  map(~ ggboxplot( data = ., x = 'type', y = 'pred_div') +
        coord_flip())
```

```{r}
fg_val_summary <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(quantile(., probs = c(0.25, 0.5, 0.75, 0.8, 0.9)))) %>% 
  mutate(grp = c('25%','50%','75%', '80%', '90%'))

fg_val_max <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(max))  %>% 
  mutate(grp = 'max')

fg_val_min <- meta %>% 
  select(starts_with('fg')) %>% 
  summarise_all(funs(min))  %>% 
  mutate(grp = 'min')

fg_val_summary_all <- bind_rows(fg_val_summary, fg_val_max, fg_val_min) %>%
  gather('fg', 'value', fg_egg:fg_veggie) %>% 
  mutate(ori_value = value*100) %>% 
  select(-value) %>% 
  rename(term = fg, type = grp) %>% 
  mutate(ori_value = round(ori_value))
  
fg_val_summary_all
```


```{r}
all_pred %>% 
  left_join(key %>% rename(term = fg1_name) %>% select(term, shortname)) %>% 
  inner_join(fg_val_summary_all) %>% 
  filter(type != 'ave') %>% 
  mutate(type = factor(type, levels = c('min','25%','50%','75%','80%','90%', 'max'))) %>% 
  mutate(xtext = str_glue('{shortname} {type}: {ori_value}g')) %>% 
  arrange(shortname, ori_value) %>% 
  ggboxplot( data = ., x = 'xtext', y = 'pred_div', fill = 'term',
             xlab = '', ylab = 'Predicted alpha diversity') +
  facet_grid(term ~ ., scales = 'free') +
  scale_fill_manual(values = c('#7D3C98','#db2589','#229954')) +
        coord_flip() +
  theme_classic() +
  theme(legend.position = 'none',
        strip.background = element_blank(),
        strip.text = element_blank()) 
```

```{r}
# 
# max_each_fg <- vals  %>% 
#   set_names(vals) %>% 
#   map(function(val) {
#     res = prior_coeffs$b_empiF$prior_coeff  +
#    prior_coeffs$b_enF$prior_coeff  +
#    prior_coeffs$b_fg_egg$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_egg') +
#    prior_coeffs$b_fg_fruit$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_fruit') +
#    prior_coeffs$b_fg_grain$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_grain') +
#    prior_coeffs$b_fg_legume$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_legume') +
#    prior_coeffs$b_fg_meat$prior_coeff * values %>% pluck(val) %>% pluck('b_fg_meat') +
#    prior_coeffs$b_fg_milk$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_milk') +
#    prior_coeffs$b_fg_oils$prior_coeff * values %>% pluck(val) %>% pluck('b_fg_oils') +
#    prior_coeffs$b_fg_sweets$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_sweets') +
#    prior_coeffs$b_fg_veggie$prior_coeff  * values %>% pluck(val) %>% pluck('b_fg_veggie') +
#    prior_coeffs$b_inten_re$prior_coeff  +
#    prior_coeffs$b_tpnF$prior_coeff +
#    prior_coeffs$Intercept$prior_coeff 
#   }) %>% 
#   bind_rows(.id = 'grp') %>% 
#   gather('grp', 'prior_res')
```


```{r plot_prior}
# combine the max and min and ave together and plot
# ave_each_fg <- samples_prior %>% 
#   mutate(mean_fg = Intercept + 
#           b_fg_fruit *mean_fg$fg_fruit+
#            b_fg_meat *mean_fg$fg_meat+ 
#            b_fg_milk *mean_fg$fg_milk+ 
#            b_fg_oils * mean_fg$fg_oils+ 
#            b_fg_egg * mean_fg$fg_egg+ 
#            b_fg_grain* mean_fg$fg_grain +
#            b_fg_sweets * mean_fg$fg_sweets+
#            b_fg_legume * mean_fg$fg_legume+
#            b_fg_veggie* mean_fg$fg_veggie +
#            b_inten_re +
#            b_empiF +
#            b_tpnF +
#            b_enF) %>% 
#   select(mean_fg) %>% 
#   mutate(grp = 'ave_each') %>% 
#   rename(prior_res = mean_fg) %>% 
#   select(grp, prior_res)
# 
# prior_all <- bind_rows(ave_each_fg, max_each_fg) 
# 
# prior_all %>%  write_csv('../figs/paper/data/prior_ave_max_min_res_68.csv')
# 
# grps <- prior_all %>% 
#   distinct(grp)
# 
# fg_cha <- meta %>% 
#   select(starts_with('fg')) %>% 
#   colnames()
```

## Posterior

### Extract the posterior samples 

```{r}
# the full table of the posterior results
full_post <- posterior_samples(model_div, '^b_|^r_')

# make a table with the median , thinner interval two sides, thicker interval two sides, the r hat value of the columns
mrn_part <- full_post %>% 
  gather() %>% 
  filter(str_detect(key, 'mrn')) %>% 
  mutate(mrn = str_extract(key, '\\[.+,'),
         mrn = str_replace(mrn, '\\[', ''),
         mrn = str_replace(mrn, ',', ''),
         patient = as.numeric(factor(mrn)),
         pid = str_glue('P{as.character(patient)}'),
         key = str_glue('r_mrn[{pid},Intercept]')) 


revised_post <- bind_rows(
  full_post %>% 
    gather() %>% 
    filter(!str_detect(key, 'mrn')),
  mrn_part
) %>% 
  select(key, value) %>% 
  group_by(key) %>% 
  summarise(q2.5 = quantile(value, probs = 0.025),
            q97.5 = quantile(value, probs = 0.975),
            q17 = quantile(value, probs = 0.17),
            q83 = quantile(value, probs = 0.83),
            q50 = quantile(value, probs = 0.5)) %>% 
  filter(str_detect(key, '^r')) %>% 
  select(key, q2.5,q17, q50, q83,  q97.5)

library(kableExtra) 

kbl(revised_post) %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  save_kable(file = "../figs/paper/T2_main_model_random_effects.pdf")
```


```{r post_sample}
# extract posterior samples for the coeff
post_samples  <- posterior_samples(model_div, '^b_')

# save it out for the forest plot of the coeff
post_fg_coeff <- post_samples %>% 
  select(starts_with('b_fg')) %>% 
  gather('item', 'value')

post_fg_coeff_mean <- post_fg_coeff  %>% 
  group_by(item) %>% 
  summarise(meanperitem = mean(value))

out <- post_fg_coeff %>% 
  left_join(post_fg_coeff_mean, by = "item")

out %>% write_csv('../data/brms_model_var_res_updated.csv') 
```

```{r post_coeff_forest}
# make the forest plot of the post coeff 
# like the one on the ash abstract

post_coeff <- post_samples %>% 
  select(starts_with('b_fg')) %>% 
  gather('item', 'coeff') %>% 
  mutate(item = str_replace(item, 'b_fg_','')) %>% 
   mutate(fgrp1 = case_when(
    item ==  'milk' ~ '1',
    item == 'meat' ~ '2',
    item ==  'egg' ~ '3',
    item ==  'legume' ~ '4',
    item == 'grain' ~ '5',
    item == 'fruit' ~ '6',
    item == 'veggie' ~ '7',
    item ==  'oils' ~ '8', 
    item ==  'sweets' ~ '9'
  ))  %>% 
  left_join(key %>% select(fgrp1, color, shortname))  %>% 
  mutate(shortname = fct_reorder(shortname, coeff, .fun=median, .desc = F)) 

fg_labels <- levels(post_coeff$shortname)


cross0 <- post_coeff %>%
  group_by(item) %>% 
  summarise(q2.5 = quantile(coeff, probs = 0.025),
            q97.5 = quantile(coeff, probs = 0.975)) %>% 
  mutate(Cross = if_else(q2.5 > 0 | q97.5 < 0, F, T))

# to find the quantiles of the post_coeff
post_coeff %>% 
  group_by(item) %>% 
  median_qi(coeff, .width = c( .66, .95))

post_coeff %>% 
  group_by(item) %>% 
  summarise(q50 = median(coeff))
```
```{r}
fg_colors <- post_coeff %>% 
  distinct(shortname, color) %>% 
  select(shortname, color) %>% 
  deframe()

title1 <- bquote(Outcome: log[e]~(Simpsons~reciprocal))

div_post <- post_coeff %>% 
  left_join(cross0) %>% 
  ggplot(aes(x = coeff, y = shortname, col = Cross)) +
  stat_pointinterval(.width = c(.66, .95)) +
  geom_vline(xintercept = 0, col = 'black', linetype = 'dashed') +
  labs(x = 'ln(diversity) change per 100g of food',
       y = '', 
       title = 'Diversity') +
  theme_classic() +
  theme(legend.position = 'none') +
  scale_color_manual(values = c("#EC0000", "gray40")) +
  theme(axis.text=element_text(size=8),
        axis.title=element_text(size=8),
        aspect.ratio=1)

div_post %>% 
  write_rds('../data/068_div_post.rds')

div_post
```


```{r post_coeff_binary}
coeff_bi <- post_samples %>% 
  select(!starts_with('b_fg')) %>% 
  select(-b_Intercept) %>% 
  gather('item', 'coeff') %>% 
  mutate(item_name = case_when(
    item ==  'b_inten_non' ~ 'Intensity: nonablative',
    item == 'b_inten_ab' ~ 'Intensity: ablative',
    item ==  'b_inten_re' ~ 'Intensity: reduced',
    item ==  'b_empiricalTRUE' ~ 'Empirical abx exposure',
    item == 'b_TPNTRUE' ~ 'TPN exposure',
    item ==  'b_ENTRUE' ~ 'EN exposure'
  )) %>% 
  mutate(item_name = factor(item_name, levels = c('Intensity: nonablative', 'Intensity: reduced',
                                                  'Intensity: ablative', 'TPN exposure','EN exposure',
                                                  'Empirical abx exposure'))) 

diversity_factor <- coeff_bi %>% 
  ggplot(aes(x = coeff, y = item_name)) +
  stat_pointinterval(.width = c(.66, .95)) +
  #scale_color_manual(values = c('#EC0000','#00468B')) +
  geom_vline(xintercept = 0, col = 'black', linetype = 'dashed') +
  labs(x = 'Coefficients',
       y = 'Factor variables',
       title = 'Diversity') +
  theme_classic() +
  theme(legend.position = 'none',
        aspect.ratio=1)

diversity_factor %>% 
  write_rds('../data/068_diversity_factor_forest.rds')


```

 
```{r post_sample_food_ave}
# when the food intake is average mean

###THE RESULTS IS THE LOG TRANSFORMED DIVERSITY !!!!##
ave_each_fg_post <- post_samples %>% 
  mutate(mean_fg = b_Intercept + 
           b_fg_fruit*mean_fg$fg_fruit +
           b_fg_meat*mean_fg$fg_meat + 
           b_fg_milk*mean_fg$fg_milk + 
           b_fg_oils*mean_fg$fg_oils + 
           b_fg_egg*mean_fg$fg_egg + 
           b_fg_grain*mean_fg$fg_grain +
           b_fg_sweets*mean_fg$fg_sweets +
           b_fg_legume*mean_fg$fg_legume +
           b_fg_veggie*mean_fg$fg_veggie +
           b_inten_re ) %>% 
  select(mean_fg) %>% 
  mutate(grp = 'ave_each') %>% 
  rename(post_res = mean_fg) %>% 
  select(grp, post_res)

# when the intake is max
post_coeffs <- post_samples %>% 
  select(b_Intercept, b_inten_re,  starts_with('b_fg')) %>% 
  gather('term','post_coeff') %>% 
  split(.$term) 

max_each_fg_post <- vals  %>%  
  set_names(vals) %>% 
  map(function(val) {
    res =
   post_coeffs$b_fg_egg$post_coeff * values %>% pluck(val) %>% pluck('b_fg_egg') +
   post_coeffs$b_fg_fruit$post_coeff * values %>% pluck(val) %>% pluck('b_fg_fruit') +
   post_coeffs$b_fg_grain$post_coeff * values %>% pluck(val) %>% pluck('b_fg_grain') +
   post_coeffs$b_fg_legume$post_coeff * values %>% pluck(val) %>% pluck('b_fg_legume') +
   post_coeffs$b_fg_meat$post_coeff * values %>% pluck(val) %>% pluck('b_fg_meat') +
   post_coeffs$b_fg_milk$post_coeff * values %>% pluck(val) %>% pluck('b_fg_milk') +
   post_coeffs$b_fg_oils$post_coeff * values %>% pluck(val) %>% pluck('b_fg_oils') +
   post_coeffs$b_fg_sweets$post_coeff * values %>% pluck(val) %>% pluck('b_fg_sweets') +
   post_coeffs$b_fg_veggie$post_coeff * values %>% pluck(val) %>% pluck('b_fg_veggie') +
   post_coeffs$b_inten_re$post_coeff  +
   post_coeffs$b_Intercept$post_coeff 
  }) %>% 
  bind_rows(.id = 'grp')
```

```{r post_diff}
# calculate the absolute difference between the max in each fg and the mean 
# note the mean is from EN-free records.
maxs <- max_each_fg_post %>% 
  as.list()

# diff_value_lt0 <-  maxs %>% 
#   map(function(vec) {
#     tibble(
#       max_=vec,
#       ave=ave_each_fg_post$post_res
#     ) %>% 
#       mutate(post_diff_ = max_ - ave)
#   }) %>% 
#   map( ~ count(x = ., post_diff_ < 0) %>% 
#           mutate(perc = n/sum(n) * 100) %>% 
#           slice(2) %>% 
#           select(perc)) %>% 
#   bind_rows(.id = 'term')


theme_set(theme_tidybayes() + cowplot::panel_border())

post_diff_df <- maxs %>% 
  map(function(vec) {
    tibble(
      max_=vec,
      ave=ave_each_fg_post$post_res
    ) %>% 
      mutate(post_diff_original_scale = exp(max_) - exp(ave),
             post_max_pred =  exp(max_),
             post_ave_pred =  exp(ave))
  }) %>% 
  bind_rows(.id = 'term') %>% 
  mutate(term = str_replace(term, 'max_','')) %>% 
  left_join(key %>% 
              select(term = fg1_name, color, shortname)) %>% 
  mutate(shortname = fct_reorder(shortname, post_diff_original_scale, .fun=median, .desc = F))
```
```{r post_diff_3}
# only plot the post diff forest in fruits and sweets
only3 <- post_diff_df %>% 
  filter(term %in% c('fg_fruit','fg_sweets', 'fg_veggie'))
```

```{r}
# the version that doesn't show the difference but show the max and the ave one
only3_two_df <- only3 %>% 
  gather('grp','predicted', post_max_pred:post_ave_pred) %>% 
  group_by(term, shortname, grp) %>% 
  median_qi(predicted, .width = c(.95, .8, .5)) %>% 
  mutate(feature = str_glue('{shortname} {grp}'))


only3_two <- only3_two_df %>%
  ggplot(aes(y = feature, x = predicted)) +
  geom_interval(aes(xmin = .lower, xmax = .upper)) + 
  #geom_vline(xintercept = 0, linetype = "dashed", col = 'black') +
  scale_color_brewer(palette = 'Greys')+
  facet_grid(feature~ ., scales = 'free') +
  labs(x = expression(Predicted~alpha~diversity),
       y = '', 
       title = 'Diversity prediction') +
  theme_classic() 
  
only3_two    
```


```{r post_diff_3}
only3_sim <- only3 %>% 
  group_by(term, shortname) %>% 
  median_qi(post_diff_original_scale, .width = c(.95, .8, .5)) %>%
  ggplot(aes(y = shortname, x = post_diff_original_scale)) +
  geom_interval(aes(xmin = .lower, xmax = .upper)) + 
  geom_vline(xintercept = 0, linetype = "dashed", col = 'black') +
  labs(x = expression(Change~`in`~alpha~diversity),
       y = '', 
       title = 'Diversity prediction') +
  theme_classic() + 
  #scale_color_manual(values = key %>% select(fg1_name, color) %>% deframe()) +
  scale_x_continuous(breaks = seq(-10, 20, 2)) +
  scale_color_brewer(palette = 'Greys')+
  xlim(-6, 4.5) +
  guides(color = guide_legend(override.aes = list(size = 4),
                              title = 'HDI'))+
  theme(axis.text=element_text(size=8),
       legend.position = c(0.87, 0.3),
       legend.key.size = unit(2, 'mm'),
       legend.title = element_text( size=6), 
       legend.text=element_text(size=6),
        axis.title=element_text(size=8),
       legend.key = element_rect(fill = 'white', colour = NA),
        aspect.ratio=1)
 
only3_sim  
 
only3_sim %>% 
  write_rds('../data/068_only3_sim.rds')

```



```{r post_diff}
post_diff_df %>% 
  ggplot(aes(y = term, x = post_diff_original_scale, col = term)) +
  stat_halfeye() +
  #scale_fill_manual(values = c("gray80", "skyblue")) +
  geom_vline(xintercept = 0, linetype = "dashed", col = 'red') +
  labs(x = "Difference in Simpson's reciprocal diversity",
       y = '',
       title = 'The diff in simpson reciprocal diversity if one food group is consumed\nat max amount than the average') +
  theme(legend.position = 'none') +
  scale_x_continuous(breaks = seq(-10, 20, 2)) +
  scale_color_manual(values = key %>% 
                       select(fg1_name, color) %>% deframe()) +
  xlim(-4.1, 12)


```

## the forest plot with prior and post 

```{r both}
both <- bind_rows(
  samples_prior %>% 
    select(starts_with('b_fg')) %>% mutate(grp = 'prior'),
  post_samples %>% 
    select(starts_with('b_fg')) %>% mutate(grp = 'post')
)  %>% 
  gather('item', 'coeff', b_fg_fruit:b_fg_veggie) 

summ <- both %>% 
  group_by(grp, item) %>% 
  summarise(q025 = quantile(coeff, 0.025),
            q975 = quantile(coeff, 0.975),
            q50 = quantile(coeff, 0.5)) %>% 
  arrange(grp, q50) 

fg_order <- summ %>%
  filter(grp == 'post') %>%
  arrange(-q50) %>%
  pull(item)
```


```{r pinterval}
pinterval <- both %>%  
  #mutate(item = str_replace(item, 'b_','')) %>% 
  left_join(key %>% 
              select(item = fg1_name)) %>% 
  mutate(item = factor(item, levels = fg_order)) %>% 
  ggplot(aes(x = coeff, y = grp, color = grp)) +
  stat_pointinterval(.width = c(.66, .95)) +
  scale_color_manual(values = c('#EC0000','#00468B')) +
  geom_vline(xintercept = 0, col = 'gray', linetype = 'dashed') +
  facet_wrap(item ~ .) +
  labs(x = 'Regression coefficients',
       y = '') +
  theme(legend.position = 'none')
 
pinterval
ggsave('../figs/paper/prior_post_pinterval_coeff.pdf', width = 10, height = 4)
```

## others

```{r post_mean_max}
# post_all <- bind_rows(ave_each_fg_post, max_each_fg_post) %>% 
#   mutate(div = exp(post_res))
# post_all %>%  write_csv('../figs/paper/data/post_ave_max_min_res_68.csv')
# 
# post_check_list <- fg_cha %>% 
#   set_names(fg_cha) %>% 
#   map(function(char){
#     post_all %>% 
#       filter(str_detect(grp, str_glue('ave_each|{char}'))) %>% 
#       gghistogram(x = 'div', fill = 'grp', color = 'white', palette = 'lancet', xlab = 'logdiversity',
#                   #add_density = TRUE, 
#                   bins = 30,
#                   title = str_glue('Post check {char}'))
#     })
# 
# g_post <- cowplot::plot_grid(post_check_list[[1]],post_check_list[[2]],post_check_list[[3]],post_check_list[[4]],post_check_list[[5]],post_check_list[[6]],post_check_list[[7]],post_check_list[[8]],post_check_list[[9]],
#     ncol = 3, nrow= 3, 
#     o = 'hv',
#     #labels = 'AUTO',
#     axis = 'bltr') 
# g_post
# 
# ggsave('../figs/paper/post_check_9fg.pdf', width = 10, height = 10, dpi = 300, plot = g_post)
```

## Post_top_patients

another thing to do is for both prior and posterior checks: use the ACTUAL diet from the 5 least fruit rich, and 5 most fruit rich diets.

something like :
for i in 5:
    top = topdiets[i]
    least = leastfruitdiets[i]
    coeffs = sample_posterior(n=1000) // sample_prior
    topdietdiversity_posterior = predict(top, coeffs)
    leastdietdiversity_posterior = predict(least,coeffs)
plot(topdietsdiversity_posterior) // prior 

```{r}
# the top and bottom fruit eaters diet 
# set.seed(123)
# N <- 5
# N_sample <- 1000
# topdiet <- meta %>% 
#   top_n(n = N, wt = fg_fruit) %>% 
#   mutate(TPNTRUE = if_else(TPN == TRUE, 1, 0),
#          ENTRUE = if_else(EN == TRUE, 1, 0),
#          empiricalTRUE = if_else(empirical == TRUE, 1, 0),
#          intensityreduced = if_else(intensity == 'reduced', 1, 0),
#          intensityablative = if_else(intensity == 'ablative', 1, 0)) %>% 
#   select(fg_egg, fg_fruit, fg_grain, fg_legume, fg_meat, fg_milk, fg_oils, fg_sweets, fg_veggie)
# 
# botdiet <- meta %>% 
#   filter(fg_fruit == 0) %>% 
#   slice_sample(n = 5) %>% 
#   mutate(TPNTRUE = if_else(TPN == TRUE, 1, 0),
#          ENTRUE = if_else(EN == TRUE, 1, 0),
#          empiricalTRUE = if_else(empirical == TRUE, 1, 0),
#          intensityreduced = if_else(intensity == 'reduced', 1, 0),
#          intensityablative = if_else(intensity == 'ablative', 1, 0))%>% 
#   select(fg_egg, fg_fruit, fg_grain, fg_legume, fg_meat, fg_milk, fg_oils, fg_sweets, fg_veggie)
# 
# 
# per_diet_post_pred <- function(fg_egg_, fg_fruit_, fg_grain_, fg_legume_, fg_meat_, fg_milk_, fg_oils_, 
#                                fg_sweets_, fg_veggie_) {
#   post_samp <- post_samples %>% 
#     sample_n(size = N_sample, replace = F)
#   
#   ret = pmap(post_samp, function(b_Intercept, b_fg_fruit, b_fg_meat, b_fg_milk, b_fg_oils, b_fg_egg,
#                                  b_fg_grain, b_fg_sweets, b_fg_legume, b_fg_veggie) {
#     b_Intercept + b_fg_fruit*fg_fruit_ + b_fg_meat*fg_meat_ + b_fg_milk*fg_milk_ + b_fg_oils*fg_oils_ +
#       b_fg_egg*fg_egg_ + b_fg_grain*fg_grain_ + b_fg_sweets*fg_sweets_ + b_fg_legume*fg_legume_ + 
#       b_fg_veggie*fg_veggie_ 
#   }) %>% 
#     set_names(seq(1, N_sample)) %>% 
#     bind_rows() %>% 
#     gather()
#   return(ret)
#                                }
# 
# 
# res_top <- pmap(topdiet, function(fg_egg, fg_fruit, fg_grain, fg_legume, fg_meat, fg_milk, fg_oils, fg_sweets, fg_veggie){
#   per_diet_post_pred(fg_egg, fg_fruit, fg_grain, fg_legume, fg_meat, fg_milk, fg_oils, fg_sweets, fg_veggie)
# }) %>% 
#   set_names(paste('D', seq(1, nrow(topdiet)), sep = '')) %>% 
#   bind_rows(.id = 'diet')
# 
# 
# res_bot <- pmap(botdiet, function(fg_egg, fg_fruit, fg_grain, fg_legume, fg_meat, fg_milk, fg_oils, fg_sweets, fg_veggie){
#   per_diet_post_pred(fg_egg, fg_fruit, fg_grain, fg_legume, fg_meat, fg_milk, fg_oils, fg_sweets, fg_veggie)
# }) %>% 
#   set_names(paste('D', seq(1, nrow(topdiet)), sep = '')) %>% 
#   bind_rows(.id = 'diet')
# 
# 
# # plot them together in one 
# bind_rows(
#   res_top %>% mutate(grp = 'top'),
#   res_bot %>% mutate(grp = 'bot')
# ) %>% 
#   gghistogram(x = 'value',bins = 30, fill = 'grp', palette = 'nejm', color = 'white', add = 'mean',
#                   xlab = 'Predicted log diversity', ylab = 'Probability density') +
#   ggsave('../figs/predicted_logdiversi_top_tybottom_5.pdf', width = 7, height = 5)
```
