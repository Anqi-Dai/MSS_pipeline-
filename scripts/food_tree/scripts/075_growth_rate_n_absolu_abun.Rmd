---
title: "growth_rate_and_absoluate_abun"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(vdbR)
connect_database('~/dbConfig.txt')
list_table_from_database('qpcr')
get_table_from_database('qpcr_16s_ag')
library(tidyverse)
```

```{r}
qpcr <- qpcr_16s_ag %>% 
  filter(!str_detect(sample_id_unique, 'heat|ethanol')) %>% 
  filter(!is.na(copies_16s_per_g))
```

```{r}
# all the patients that have a entercoccus growth rate
combined <- read_csv('../data/growth/069_irep_combined_res.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
target <- combined %>%  
  filter(str_detect(best_species, 'Enterococcus')) %>% 
  distinct(mrn) %>% 
  pull(mrn) 

entero <- combined %>%  
  filter(str_detect(best_species, 'Enterococcus')) %>% 
  group_by(sampleid, mrn) %>% 
  summarise(ave_irpe = mean(aveirep)) %>% 
  inner_join(meta %>% 
               select(sampleid, sdrt))

# all of these patients stool samples we have 
get_table_from_database('samples_castori_ag')
get_table_from_database('asv_annotation_blast_ag')
sam <- samples_castori_ag %>% 
  filter(mrn %in% target) %>% 
  distinct(sampleid) %>% 
  pull(sampleid)
samps <- samples_castori_ag %>% 
  filter(mrn %in% target) %>% 
  distinct(sampleid, mrn)

# get the entercoccus relab of these samples
cts <- get_counts_subset(sam)
ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')

cts_ <- cts %>% 
  left_join(asv_annotation_blast_ag %>% 
              select(asv_key, genus)) %>% 
  group_by(sampleid, genus) %>% 
  summarise(relab = sum(count_relative)) %>% 
  filter(genus == 'Enterococcus')  %>% 
  inner_join(qpcr %>% 
               select(sampleid = sample_id, copies_16s_per_g)) %>% 
  mutate(entero_copy = copies_16s_per_g*relab) %>% 
  inner_join(samples_castori_ag %>% 
               select(sampleid, datecollection)) %>% 
  inner_join(samps) %>% 
  inner_join(ptb %>% 
               select(mrn, hct)) %>% 
  mutate(sdrt = datecollection - hct) %>% 
  filter(sdrt < 54)
```
```{r}
entero %>% 
  ggplot(aes(x = sdrt, y = ave_irpe )) +
  geom_point() +
  geom_point(data = cts_, aes(x = sdrt, y = entero_copy, col = 'red')) +
  facet_wrap(~mrn)

# the patients that have both the irep and qpcr results
both <- intersect(cts_$mrn, entero$mrn)
```
```{r}
absl <- both %>% 
  set_names(both) %>% 
  imap(function(.x, .y){
    # set the min and max in the x axis to be the min and max of the global values
    xmax = max(max(entero %>% 
      filter(mrn == .x) %>% pull(sdrt)), max(cts_ %>% 
      filter(mrn == .x) %>% pull(sdrt))) + 2
    
    xmin = min(min(entero %>% 
      filter(mrn == .x) %>% pull(sdrt)), min(cts_ %>% 
      filter(mrn == .x) %>% pull(sdrt))) -2
    
    irep = entero %>% 
      filter(mrn == .x) %>% 
      ggplot(aes(x = sdrt, y = ave_irpe )) +
      geom_point() +
      labs(title = str_glue('{}')) +
      xlim(xmin, xmax) +
      labs(x = '',
           y = 'average irep values')
      
    
    copies = cts_ %>% 
      filter(mrn == .x) %>% 
      ggplot(aes(x = sdrt, y = entero_copy )) +
      geom_point() +
     # scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), 
      #          labels = scales::trans_format("log10", scales::math_format(10^.x))) +
      xlim(xmin, xmax) +
      labs(x = 'day relative to transplant',
           y = 'Enterococcus copy\nnumbers')
    
    res = cowplot::plot_grid(irep, copies, axis = 'tblr', align = 'hv', ncol = 1)
    #ggsave(str_glue('../data/{.y}.pdf'), width = 5, height = 4)
  })

seq(1, length(absl)) %>% 
  set_names(seq(1, length(absl))) %>% 
  imap(~ ggsave(str_glue('../data/Patient{.y}.pdf'), width = 5, height = 4, plot = absl[[.x]]))
```
## customize patient 11 for show

```{r}
# customize patient 11
# use the global highest irep value for the highest in the y axis.
irep_highest <- max(entero$ave_irpe) + 0.05
irep_q25 <- quantile(x = entero$ave_irpe, 0.25)
irep_q50 <- quantile(x = entero$ave_irpe, 0.5)
irep_q75 <- quantile(x = entero$ave_irpe, 0.75)

p11 <- names(absl)[11]
xmax = 15

xmin = -5

quantile_annot_df <- tibble(
  quant = c('25%','50%','75%'),
  height = c(irep_q25, irep_q50, irep_q75)
)

irep = entero %>% 
  filter(sdrt %in% -5:15) %>% 
  filter(mrn == p11) %>% 
  ggplot(aes(x = sdrt, y = ave_irpe )) +
  geom_point() +
  labs(title = str_glue('{}')) +
  geom_hline(yintercept = irep_q25, linetype = 'dashed') +
  geom_text(data = quantile_annot_df, mapping = aes(x = 14, y = height, label = quant), nudge_y = 0.02, size = 2.5) +
  geom_hline(yintercept = irep_q50, linetype = 'dashed') +
  geom_hline(yintercept = irep_q75, linetype = 'dashed') +
  xlim(xmin, xmax) +
  ylim(1, irep_highest) +
  labs(x = '',
       y = 'Average replication rate')+
  theme_classic()+
  theme(aspect.ratio=1,
        panel.grid.major.x = element_line(color = "grey85")) 
  

copies = cts_ %>% 
  filter(sdrt %in% -5:15) %>% 
  filter(mrn == p11) %>% 
  ggplot(aes(x = sdrt, y = entero_copy )) +
  geom_point() +
 # scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x), 
  #          labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  xlim(xmin, xmax) +
  labs(x = 'Day relative to transplant',
       y = 'Enterococcus copy\nnumbers') +
  theme_classic() +
  theme(aspect.ratio=1,
        panel.grid.major.x = element_line(colour = "grey85"))+
  scale_y_log10("Enterococcus copy\nnumbers",
        breaks = scales::trans_breaks("log10", function(x) 10^x),
        labels = scales::trans_format("log10", scales::math_format(10^.x)))

res = cowplot::plot_grid(irep, copies, axis = 'tblr', align = 'hv', ncol = 1)
res
ggsave('../figs/paper/075_p11_irep_copy.pdf',  
       width = 120,
       height = 120,
         units = c("mm"),
         dpi = 400, device = 'pdf')
```


