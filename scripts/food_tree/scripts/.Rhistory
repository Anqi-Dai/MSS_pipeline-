filter(mrn == ent_pt$mrn & str_detect(best_species, 'Enterococcus'))
lowerday <- -2
highday <- 12
ent_entries <- bind_rows(
check800 %>%
select(mrn, date:diet_data_status) %>%
mutate(date = lubridate::mdy(date)) %>%
filter(mrn == ent_pt$mrn) %>%
mutate(mrn = as.numeric(mrn)),
check33 %>%
filter(mrn == ent_pt$mrn) %>%
select(mrn, p1date, p1date_status) %>%
rename(date = p1date,
diet_data_status = p1date_status) %>%
mutate(date = lubridate::mdy(date)) %>%
mutate(diet_data_status = 'ok')
) %>%
left_join(ptb %>%
select(mrn, hct)) %>%
mutate(fdrt = date - hct) %>%
mutate(fdrt = as.numeric(fdrt))
# which days am I not sure in this range?
ent_unsure <- ent_entries %>%
filter(fdrt %in% lowerday:highday) %>%
right_join(tibble(fdrt = seq(lowerday, highday, 1)))
# find the dates of those days
hct_date <- ent_unsure %>%
select(hct) %>%
slice(1)
check_e <- ent_unsure %>%
mutate(hct = hct_date$hct) %>%
mutate(date = hct + fdrt) %>%
mutate(mrn = ent_pt$mrn) %>%
inner_join(patient_allo_ag %>% select(mrn, last, first)) %>%
filter(is.na(diet_data_status)) %>%
select(mrn, last, first, date,diet_data_status )
check2  <- bind_rows(
check_e, check_k
)
check2 %>% write_csv('../data/114_timeline_2_pt_check.csv')
View(check_e)
View(check2)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
View(dtb)
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgdrp1 = str_sub(Food_code, 1,1))
View(daily)
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
mutate(dailysum = sum(dehydrated_weight))
View(daily)
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight))
View(daily)
daily %>% write_csv('../data/115_summarize_food_groups_pt_daily.csv')
View(daily)
daily
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9"))
daily
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0)
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0)
daily
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
daily
29.882472	 + 82.256725
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
daily
View(daily)
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
missing <- read_csv('../data/112_has_missing_to_be_removed.csv')
klept <- read_csv('../data/095_Klebsiella-patient.csv')
older802 <- read_csv('../data/011_802_total_stool_samples.csv')
ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
tb <- read_csv('../data/069_tb.csv') %>%
rename(sampleid = Sample)
combined <- tb %>%
inner_join(older802 %>% select(sampleid, mrn, sdrt))
# finally after sorting out the mess in my head I'm able to see this familiar number, I'm so glad!!!!!
# finally after sorting out the mess in my head I'm able to see this familiar number, I'm so glad!!!!!
combined %>%
write_csv('../data/114_combined_irep_650.csv')
combined <- read_csv('../data/114_combined_irep_650.csv')
View(combined)
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep))
View(ent)
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only')
older802 <- read_csv('../data/011_802_total_stool_samples.csv')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only')
View(ent)
View(older802)
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
inner_join(older802 %>% select(sampleid, mrn, sdrt))
View(ent)
stb_pair <- ent %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
View(stb_pair)
daily
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69))
return(df)
}
mean_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
test <- daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  ))
View(test)
summarise(bigger69 = max(total69)
test <- daily %>%
daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  )) %>%
group_by(mrn)
summarise(bigger69 = max(.$total69)
test <- daily %>%
test <- daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  ))
summarise(bigger69 = max(.$total69)
test <- daily %>%
summarise(bigger69 = max(total69)
test <- daily %>%
daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  )) %>%
group_by(mrn)
test <- daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69))
daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  ))
test <- daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-1, -2  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69))
test <- daily %>%
filter(mrn == 35231846) %>%
filter(fdrt %in% c(-3, -2  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69))
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69))
return(df)
}
mean_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
mean_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(mean_p2d_df)
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
# two samples that have na values
setdiff(ent$sampleid, max69_p2d_df$sampleid)
View(ent)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
View(ent)
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(ent)
View(max69_p2d_df)
View(max69_p2d_df)
max69_p2d_df
library(tidyverse)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
older802 <- read_csv('../data/011_802_total_stool_samples.csv')
scatter_alpha <- 0.35
cor_text_size <- 3
axis_text_size <- 11
axis_title_size <- 11
# the newer version of fig3 A
max69_p2d_df %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(69) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
#annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_fruit_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
# the newer version of fig3 A
res_ent_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
max69_p2d_df %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(69) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
res_ent_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
max69_p2d_df %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(69) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
combined <- read_csv('../data/114_combined_irep_650.csv')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
inner_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- ent %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(ent)
# the newer version of fig3 A
res_ent_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
max69_p2d_df %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
kle <- combined %>%
filter(str_detect(best_species, 'Klebsiella')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Klebsiella only') %>%
inner_join(older802 %>% select(sampleid, mrn, sdrt))
View(kle)
stb_pair <- kle %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
stb_pair <- kle %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max69_p2d_df_kle <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(kle %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(kle)
View(max69_p2d_df_kle)
max69_p2d_df_kle <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(kle %>% pull(sampleid))
View(stb_pair)
max69_p2d_df_kle <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(kle %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
max69_p2d_df_kle <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(kle %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(kle)
# the newer version of fig3 B
res_kle_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df_kle ))
kle_max69_p <- round(res_kle_max69$coefficients[2, 'Pr(>|t|)'], 2)
kle_max69_p
max69_p2d_df_kle %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Klebsiella',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {kle_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
max69_p2d_df_kle %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Klebsiella',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {kle_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
