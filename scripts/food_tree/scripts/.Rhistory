) +
theme(legend.position = 'bottom',
axis.text.y = element_text(size=11, colour = x_txt_col),
legend.title = element_blank())
ggsave('../figs/paper/S7_top10_eaten_foods_of_3_099.pdf', width = 8.3, height = 6)
View(top3grp)
View(dtb)
dtb
#think about a way to depict the fiber sugar ratio in the top 10 foods
unique <- dtb %>%
distinct(Food_code, description)
View(unique)
#think about a way to depict the fiber sugar ratio in the top 10 foods
unique <- dtb %>%
distinct(Food_code, description, .keep_all = T)
View(unique)
View(unique)
#think about a way to depict the fiber sugar ratio in the top 10 foods
unique <- dtb %>%
distinct(Food_code, description, .keep_all = T) %>%
inner_join(top3grp)
View(unique)
unique
#think about a way to depict the fiber sugar ratio in the top 10 foods
unique <- dtb %>%
distinct(Food_code, description, .keep_all = T) %>%
inner_join(top3grp) %>%
mutate(fs_ratio = if_else(Sugars_g == 0, 0, Fibers_g/Sugars_g))
View(unique)
knitr::opts_chunk$set(echo = TRUE, message = F)
library(tidyverse)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
library(vdbR)
connect_database(config_file = "~/dbConfig.txt")
get_table_from_database('samples_castori_ag')
get_table_from_database('asv_alpha_diversity_ag')
get_table_from_database('antibiotics_antibacterial_multicenter_ag')
# selecting all stool samples of the patients
stb <- ptb %>%
left_join(samples_castori_ag %>%
filter(sampletype == 'Stool' | sampletype == 'stool') %>%
select(mrn, sampleid, datecollection), by = 'mrn') %>%
mutate(sdrt = datecollection - hct)
# remove all the stool samples collected >= 2 days after the latest diet sample for every patient
# get the latest diet sample for every patient
dtb_latest_dsample <- dtb %>%
arrange(mrn, desc(fdrt)) %>%
distinct(mrn, .keep_all = T) %>%
select(mrn, fdrt)
# join the lastest dsample day to the stb
stb_dsample_diff_tobe_removed <- stb %>%
left_join(dtb_latest_dsample, by = 'mrn')  %>%
mutate(diff = sdrt - fdrt) %>%
filter(diff >= 2) %>%
pull(sampleid)
stb1 <- stb %>%
filter(!sampleid %in% stb_dsample_diff_tobe_removed)
# also remove the stool samples that are earlier than the earliest diet sample for each patient
earliest_dsample <- dtb %>%
arrange(mrn, fdrt) %>%
distinct(mrn, .keep_all = T) %>%
select(mrn, fdrt)
early_2b_rm <- stb1 %>%
left_join(earliest_dsample, by = 'mrn')  %>%
mutate(diff = sdrt - fdrt) %>%
filter(diff <= 0) %>%
pull(sampleid)
stb2 <- stb1 %>%
filter(!sampleid %in% early_2b_rm) %>%
select(-hct, -datecollection)
# now find the samples that have actually been sequenced that we have entry in the alpha div table
# and also have a satisfying total count
stb3 <- stb2 %>%
filter(sampleid %in% asv_alpha_diversity_ag$sampleid) %>%
left_join(asv_alpha_diversity_ag %>% select(sampleid, count_total)) %>%
filter(count_total >= 400)
# there are patients that have more than 1 stool sample on the same day
stb3 %>%
distinct(mrn, sdrt)
# the sampleids are all different
stb3 %>%
distinct(sampleid)
censor_abx <- c('active_atb_vanco_po',	'active_atb_imipenem',	'active_atb_meropenem',	'active_atb_ertapenem',		'active_atb_cefepime',		'active_atb_linezolid',	'active_atb_metro',	'active_atb_piptazo')
# 2021-2-24 update the abx to be considering 2-day effect only (instead of 20 days)
abx_all <- read_csv('../data/cleaned_stool/abx_all_samples_with_censoring_info_2day_effect.csv')
# how many samples in stb3 have records in abx_all
have_abx_info <- abx_all %>%
filter(sampleid %in% stb3$sampleid) %>%
distinct(sampleid) %>%
pull(sampleid)
abx_this_censor_samples <- abx_all %>%
filter(sampleid %in% stb3$sampleid) %>%
select(sampleid, active_atb_cipro:active_atb_other) %>%
gather(key = 'abx_type', value = 'value', names(.)[2]:names(.)[ncol(.)]) %>%
filter(abx_type %in% censor_abx) %>%
filter(value == T) %>%
distinct(sampleid) %>%
pull(sampleid)
# keep the samples that I have abx usage info
stb4 <- stb3 %>%
filter(sampleid %in% have_abx_info) %>%
arrange(mrn, sdrt)
stb4 %>%
distinct(mrn, sdrt)# XXX are duplicated on the same day
stb5 <- stb4 %>%
arrange(mrn, sdrt, sampleid) %>%
distinct(mrn, sdrt, .keep_all = T)
# list the previous 2 days drt for every stool sample
qual_stool_df <- stb5 %>%
mutate(p1d = sdrt-1,
p2d = sdrt-2) %>%
select(mrn, p1d, p2d)
# use the no fake diet counts table and get the stool samples that should be removed -- not even one day
dtb_real <- dtb
no_real_diet_d_to_be_rm_stool_s <- function(mrn_, p1d_, p2d_){
df = dtb_real %>%
filter(mrn == mrn_) %>%
filter(fdrt == p1d_ | fdrt == p2d_  ) %>%
nrow()
return(df)
}
qual_stool2 <- pmap(qual_stool_df, function(mrn, p1d, p2d){
no_real_diet_d_to_be_rm_stool_s(mrn, p1d, p2d)
}) %>%
set_names(paste0("row", 1:nrow(qual_stool_df))) %>%
bind_rows() %>%
gather(key = 'id', value = 'num_d_records') %>%
arrange(num_d_records) %>%
full_join(stb5 %>%
mutate(id = paste0("row", 1:nrow(.))), by  = 'id')
stb6 <- qual_stool2 %>%
filter(num_d_records > 0)  %>%
select(-id, -num_d_records, -count_total)
# to classify the stool samples as having been affected by empirical abx or not.
stb7 <- stb6 %>%
mutate(empirical = if_else(sampleid %in% abx_this_censor_samples, T, F))
stb7 %>%
count(empirical)
# add the simpson_reciprocal diversity
stb8 <- stb7 %>%
inner_join(asv_alpha_diversity_ag %>% select(sampleid, simpson_reciprocal))  %>%
mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left'))
stb8 %>%
write_csv('../data/cleaned_stool/selected_stool_samples_type_abx.csv')
# load the newest final stb
# stb <- read_csv('../data/cleaned_stool/selected_stool_samples_type_abx.csv')
# the diet data
# library(ggpubr)
# stb_plot <- stb %>%
#   mutate(y = 0.8)
#
# dtb %>%
#   select(mrn, fdrt) %>%
#   mutate(y = 1) %>%
#   ggscatter(x = 'fdrt', y = 'y', color = 'forestgreen', xlab = 'Day relative to transplant', ylab = '') +
#   geom_point(data = stb_plot, aes(x = sdrt, y  = y, col = abx), size = 1.2) +
#   scale_color_manual(values = c('dimgray','darkgoldenrod2')) +
#   facet_wrap(~mrn, scales = "free") +
#   theme_bw() +
#   ylim(0.7, 1.1) +
#   theme(strip.text.x = element_blank(), #hide the mrns
#         axis.text.y = element_blank(),
#         axis.ticks.y = element_blank()) +
#   ggsave('../figs/97_all_pair_all_stool.pdf', width = 30, height = 12)
# some that I need to know why I don't have that information and request it to be completed with other people's assistance
# the stool sample we have collected that should enter this cohort but haven't been sequenced, what to do about them?
stb2_not_sequenced <- stb2 %>%
filter(!sampleid %in% asv_alpha_diversity_ag$sampleid) %>%
inner_join(samples_castori_ag %>% select(sampleid, datecollection))
stb2_not_sequenced %>%
write_csv('../data/!question/stool_samples_we_collected_but_no_diversity_info_for_diet.csv')
# the few samples that we don't have abx info
# from the same patient that has transplant on Jan 17, 2020.
yes_abx <- abx_all %>%
filter(sampleid %in% stb3$sampleid) %>%
pull(sampleid)
no_abx <- setdiff(stb3$sampleid, yes_abx )
no_ABX <- tibble(sampleid = no_abx)
no_ABX %>%
write_csv('../data/!question/patinet_has_transplant_in_2020_No_abx_info.csv')
whole <- read_excel('/Volumes/castoricenter/Human.Sequencing.Data/Sequenced.BMT.xlsx')
knitr::opts_chunk$set(echo = TRUE)
library(phytools)
library(tidyverse)
library(vdbR)
connect_database('~/dbConfig.txt')
library(vdbR)
connect_database('~/dbConfig.txt')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('asv_alpha_diversity_ag')
dat <- asv_alpha_diversity_ag %>%
distinct(oligos_id) %>%
mutate(poolid = str_extract(oligos_id, 'pool.+$')) %>%
distinct(poolid) %>%
filter(str_detect(poolid, 'pool835|pool935|pool940|pool1042|pool1048|pool1050|pool1064|pool1109|pool1117|pool1121'))
View(dat)
dat
View(asv_alpha_diversity_ag)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# reply from John
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv')
View(reply)
# reply from John
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>%
distinct(sid, .keep_all = T)
View(reply)
library(vdbR)
connect_database()
get_table_from_database('asv_alpha_diversity_ag')
View(asv_alpha_diversity_ag)
length(intersect(reply$sid, asv_alpha_diversity_ag$sampleid))
View(asv_alpha_diversity_ag)
# reply from John
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>%
distinct(sid, .keep_all = T) %>%
distinct(js_comment)
View(reply)
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv')
View(reply)
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>%
distinct(sid, .keep_all = T)
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>%
distinct(sid, .keep_all = T) %>%
distinct(js_comment)
View(asv_alpha_diversity_ag)
View(reply)
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>%
distinct(sid, .keep_all = T)
knitr::opts_chunk$set(echo = TRUE)
library(vdbR)
get_table_from_database('shotgun_lookup_ad')
connect_database()
library(vdbR)
connect_database()
get_table_from_database('shotgun_lookup_ad')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
axis_text_size <- 10
axis_title_size <- 10
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
f2a <- procrustes_Nday_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
library(ggpubr)
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
f2a <- procrustes_Nday_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
f2a <- procrustes_Nday_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
View(procrustes_Nday_score)
knitr::opts_chunk$set(echo = TRUE)
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
View(macro_pro)
two_score <- bind_rows(
procrustes_Nday_score, macro_pro
)
View(two_score)
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a
two_score
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp', group = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggdotchart(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp', group = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggscatter(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp', group = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggscatter(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp', group = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
f2a <- ggplot(two_score, aes(x = pNd, y = score, group = grp)) +
geom_line()
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggscatter(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp', group = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a <- ggplot(two_score, aes(x = pNd, y = score, group = grp)) +
geom_line()
f2a
f2a <- ggplot(two_score, aes(x = pNd, y = score, group = grp)) +
geom_line() +
theme_classic()
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggscatter(x = 'pNd', y = 'score', sorting = 'none', ylab = 'Procrustes score', color = 'grp', group = 'grp',
xlab = 'Number of previous days\nof dietary intake', size = 1.3) +
geom_line(aes(x = pNd, y = score), group = 1, linetype = 'dashed', size = 0.3) +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a <- ggplot(two_score, aes(x = pNd, y = score, group = grp)) +
geom_line() +
theme_classic()
f2a
f2a <- ggplot(two_score, aes(x = pNd, y = score, group = grp)) +
geom_line() +
theme_classic() +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggplot(aes(x = pNd, y = score, group = grp)) +
geom_line() +
theme_classic() +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggplot(aes(x = pNd, y = score, group = grp, color = grp)) +
geom_line() +
geom_point() +
labs(x = 'Number of previous days\nof dietary intake',
y = 'Procrustes score')
theme_classic() +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggplot(aes(x = pNd, y = score, group = grp, color = grp)) +
geom_line() +
geom_point() +
labs(x = 'Number of previous days\nof dietary intake',
y = 'Procrustes score')
theme_classic()
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggplot(aes(x = pNd, y = score, group = grp, color = grp)) +
geom_line() +
geom_point(size = 1.3) +
labs(x = 'Number of previous days\nof dietary intake',
y = 'Procrustes score')
theme_classic() +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
procrustes_Nday_score <- read_csv('../data/022_procrustes_Nday_score.csv')
macro_pro <- read_csv('../data/091_macro_procrustes_Nday_score.csv')
two_score <- bind_rows(
procrustes_Nday_score %>% mutate(grp = 'fg'),
macro_pro %>% mutate(grp = 'macro')
)
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggplot(aes(x = pNd, y = score, group = grp, color = grp)) +
geom_line(size = 0.3) +
geom_point(size = 1.3) +
labs(x = 'Number of previous days\nof dietary intake',
y = 'Procrustes score')
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))  +
theme_classic()
f2a
f2a <- two_score %>%
mutate(pNd = str_extract(pNd, '\\d')) %>%
ggplot(aes(x = pNd, y = score, group = grp, color = grp)) +
geom_line(size = 0.3) +
geom_point(size = 1.3) +
labs(x = 'Number of previous days\nof dietary intake',
y = 'Procrustes score')
theme_classic()  +
theme(aspect.ratio=1,
axis.text=element_text(size=8),
axis.title=element_text(size=8),
axis.text.x = element_text(angle=0, hjust=0.5))
f2a
