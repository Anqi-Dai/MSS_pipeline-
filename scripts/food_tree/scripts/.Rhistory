post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
})
View(dose_pred_eggs)
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
}) %>%
bind_rows()
View(dose_pred_eggs)
10^2
10^3
dose_pred_eggs
others <- dose_pred_eggs %>%
select(-mean)
View(others)
others <- dose_pred_eggs %>%
select(-mean) %>%
as.list()
View(others)
others
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
})
View(diffs)
View(diffs)
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows()
View(diffs)
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows()
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather
View(diffs)
diffs
# plotting
diffs %>%
ggboxplot(x = 'value', y = 'key')
diffs
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal') +
scale_y_sqrt()
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)') +
scale_y_sqrt()
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)') +
scale_y_sqrt()
ggsave('../data/119_egg_enter_pred.png')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)') +
scale_y_sqrt()
10^(column) -
10^(dose_pred_eggs$mean)
10^(dose_pred_eggs$mean)
View(others)
10^(-1.59)
View(diffs)
View(diffs)
diffs %>% summarise()
diffs
diffs %>% summarise(value)
summary(diffs$value)
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png')
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max, min))
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(quants = str_glue('q{quants}')) %>%
spread('quants', 'fg_egg')
eggs_ <- bind_cols(eggs, eggs_quantiles)  %>%
as.list()
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
}) %>%
bind_rows()
others <- dose_pred_eggs %>%
select(-mean) %>%
as.list()
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png')
ggsave('../data/119_egg_enter_pred.png', width = 10)
View(eggs_quantiles)
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05))
View(eggs_quantiles)
View(eggs_quants)
eggs_quants
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(fg_egg = fg_egg *100)
View(diffs)
c(0, seq(0.1, 1, 0.05))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = fg_egg *100)
diffs
View(diffs)
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = fg_egg *100) %>%
mutate(quants = str_glue('q{quants}'))
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather %>%
mutate(key = if_else(key == 'max', 'q1', key),
key = if_else(key == 'min', 'q0', key))
diffs
eggs_quants
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather %>%
mutate(key = if_else(key == 'max', 'q1', key),
key = if_else(key == 'min', 'q0', key)) %>%
left_join(eggs_quants %>% rename(key = quants))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}'))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}')) %>%
mutate(fg_egg = str_glue('{fg_egg}g'))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}'))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}')) %>%
mutate(fg_egg = str_glue('{fg_egg}g'))
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather %>%
mutate(key = if_else(key == 'max', 'q1', key),
key = if_else(key == 'min', 'q0', key)) %>%
left_join(eggs_quants %>% rename(key = quants)) %>%
mutate(xlabel = str_glue('{key}({fg_egg})'))
# plotting
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10% quantile\n...90% quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating different quantiles of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
# plotting
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating different quantiles of eggs\ncompared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
older802 <- read_csv('../data/011_802_total_stool_samples.csv')
scatter_alpha <- 0.35
cor_text_size <- 3
axis_text_size <- 11
axis_title_size <- 11
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
combined <- read_csv('../data/114_combined_irep_915.csv')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
#group_by(sampleid) %>%
#summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
left_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- combined %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T),
bigger6 = max(`6`, na.rm = T),
bigger9 = max(`9`, na.rm = T),
ave6 = mean(`6`, na.rm = T),
ave9 = mean(`9`, na.rm = T),
ave69 = mean(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(combined %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
combined <- read_csv('../data/114_combined_irep_915.csv')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
#group_by(sampleid) %>%
#summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
left_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- combined %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(combined %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
View(combined)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
View(max69_p2d_df)
View(unique_df)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
now <- combined %>%
left_join(unique_df) %>%
mutate(bigger69 = if_else(is.na(bigger69), 0,bigger69 ))
View(now)
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid)
View(add2)
# the 2 samples left out is because there was no sweets or fruits intake in the previous 2 days
# need to add them back manually since I don't have a way to do that programmatically
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid) %>%
mutate(bigger69 = 0) %>%
select(colnames(max69_p2d_df))
max69_p2d_df_all <- bind_rows(max69_p2d_df, add2)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
now <- combined %>%
left_join(unique_df) %>%
mutate(bigger69 = if_else(is.na(bigger69), 0,bigger69 ))
res_ent_max69 <- summary(lm(aveirep ~ bigger69, data = now ))
now
res_ent_max69 <- summary(lm(iRep ~ bigger69, data = now ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
ent_max69_p
f3a <- now %>%
ggscatter(x = 'bigger69', y = 'iRep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
ggsave('../figs/paper/115_f3a.pdf',
width = 80,
height = 80,
#height = 60,
units = c("mm"),
dpi = 400, plot = f3a)
View(ent)
View(combined)
stb_pair <- ent %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(combined %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
View(max69_p2d_df)
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid)
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
#group_by(sampleid) %>%
#summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
left_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- ent %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid)
# the 2 samples left out is because there was no sweets or fruits intake in the previous 2 days
# need to add them back manually since I don't have a way to do that programmatically
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid) %>%
mutate(bigger69 = 0) %>%
select(colnames(max69_p2d_df))
max69_p2d_df_all <- bind_rows(max69_p2d_df, add2)
View(max69_p2d_df_all)
ent %>% distinct(sampleid)
max69_p2d_df_all <- bind_rows(max69_p2d_df, add2) %>% distinct()
# get the irep value back in
both <- ent %>%
left_join(max69_p2d_df_all)
View(both)
res_ent_max69 <- summary(lm(iRep ~ bigger69, data = both ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
f3a <- both %>%
ggscatter(x = 'bigger69', y = 'iRep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
f3a
knitr::opts_chunk$set(echo = TRUE, message = F)
library(vdbR)
connect_database(config_file = "~/dbConfig.txt")
get_table_from_database('test9')
View(test9)
