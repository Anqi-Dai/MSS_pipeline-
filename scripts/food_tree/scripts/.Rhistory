bind_rows(.id = 'family')
prior_df %>%
write_csv('../data/087_family_macro_model_prior.csv')
post_df <- ret_family_macro %>%
imap(~ (suppressWarnings(posterior_samples(.x)) %>%
select(-starts_with('r_'))))  %>%
bind_rows(.id = 'family')
post_df %>%
write_csv('../data/087_family_macro_model_post.csv')
mean_macro <-  full %>%
select(starts_with('ave_')) %>%
summarise_all(funs(mean))
mean_macro <-  full %>%
select(starts_with('ave_')) %>%
summarise_all(funs(mean))
valid_interval_perc <- ret_family_macro %>%
imap(~ prior_draws(.x) %>%
mutate(mean_fg = Intercept +
b_ave_fiber * mean_macro$ave_fiber+
b_ave_fat_n_pro * mean_macro$ave_fat_n_pro+
b_ave_Sugars * mean_macro$ave_Sugars+
b_inten_re ) %>%
select(mean_fg) %>%
mutate(grp = 'ave_each') %>%
rename(prior_res = mean_fg) %>%
select(grp, prior_res) %>%
count(prior_res >-5.7 & prior_res<0) %>%
mutate(perc = n/4000*100) %>%
select(perc) %>%
slice(2) %>%
pull(perc) %>%
round(1) ) %>%
bind_rows(.id = .y) %>%
gather('family','within_interval_perc')
View(valid_interval_perc)
fam <- domcts <- cts %>%
filter(taxa_family %in% target_family) %>%
mutate(relablog = log10(relab + 2*10^-6))
View(fam)
mean_macro <-  full %>%
select(starts_with('ave_')) %>%
summarise_all(funs(mean))
fam <- domcts <- cts %>%
filter(taxa_family %in% target_family) %>%
mutate(relablog = log10(relab + 2*10^-6))
valid_interval_perc <- ret_family_macro %>%
imap(~ prior_draws(.x) %>%
mutate(mean_fg = Intercept +
b_ave_fiber * mean_macro$ave_fiber+
b_ave_fat_n_pro * mean_macro$ave_fat_n_pro+
b_ave_Sugars * mean_macro$ave_Sugars+
b_inten_re ) %>%
select(mean_fg) %>%
mutate(grp = 'ave_each') %>%
rename(prior_res = mean_fg) %>%
select(grp, prior_res) %>%
count(prior_res >min(fam$relablog) & prior_res<max(fam$relablog)) %>%
mutate(perc = n/4000*100) %>%
select(perc) %>%
slice(2) %>%
pull(perc) %>%
round(1) ) %>%
bind_rows(.id = .y) %>%
gather('family','within_interval_perc')
fam <-  cts %>%
filter(taxa_family %in% target_family) %>%
mutate(relablog = log10(relab + 2*10^-6))
post_df <- read_csv('../data/087_family_macro_model_post.csv')
View(post_df)
post_df <- read_csv('../data/087_family_macro_model_post.csv')
post_df <- read_csv('../data/087_family_macro_model_post.csv')
post_df <- read_csv('../data/087_family_macro_model_post.csv')
post_df <- read_csv('../data/087_family_macro_model_post.csv')
post_df <- read_csv('../data/087_family_macro_model_post.csv')
ret_family_macro <- post_df %>%
select(genus, starts_with('b_ave')) %>%
gather('item','coeff', names(.)[2]:names(.)[ncol(.)]) %>%
group_by(genus, item) %>%
summarise(q50 = median(coeff),
q2.5 = quantile(coeff, probs = 0.025),
q97.5 = quantile(coeff, probs = 0.975),
q12.5 = quantile(coeff, probs = 0.125),
q87.5 = quantile(coeff, probs = 0.875),
q1.25 = quantile(coeff, probs = 0.0125),
q98.75 = quantile(coeff, probs = 0.9875),
q0.5 = quantile(coeff, probs = 0.005),
q99.5 = quantile(coeff, probs = 0.995)
) %>%
ungroup() %>%
mutate(mark = if_else(q99.5 < 0 | q0.5 > 0, '***', if_else(q98.75 < 0 | q1.25 > 0, '**', if_else(q97.5 < 0 | q2.5 > 0, '*', '')))) %>%
mutate(color = if_else(q87.5 < 0, 'steelblue', if_else(q12.5 > 0, 'maroon', 'white'))) %>%
mutate(item = str_replace(item, 'b_ave_','')) %>%
mutate(item = str_to_title(item))
ret_family_macro <- post_df %>%
select(genus, starts_with('b_ave')) %>%
gather('item','coeff', names(.)[2]:names(.)[ncol(.)])
post_df <- read_csv('../data/087_family_macro_model_post.csv')
ret_family_macro <- post_df %>%
select(family, starts_with('b_ave')) %>%
gather('item','coeff', names(.)[2]:names(.)[ncol(.)]) %>%
group_by(family, item) %>%
summarise(q50 = median(coeff),
q2.5 = quantile(coeff, probs = 0.025),
q97.5 = quantile(coeff, probs = 0.975),
q12.5 = quantile(coeff, probs = 0.125),
q87.5 = quantile(coeff, probs = 0.875),
q1.25 = quantile(coeff, probs = 0.0125),
q98.75 = quantile(coeff, probs = 0.9875),
q0.5 = quantile(coeff, probs = 0.005),
q99.5 = quantile(coeff, probs = 0.995)
) %>%
ungroup() %>%
mutate(mark = if_else(q99.5 < 0 | q0.5 > 0, '***', if_else(q98.75 < 0 | q1.25 > 0, '**', if_else(q97.5 < 0 | q2.5 > 0, '*', '')))) %>%
mutate(color = if_else(q87.5 < 0, 'steelblue', if_else(q12.5 > 0, 'maroon', 'white'))) %>%
mutate(item = str_replace(item, 'b_ave_','')) %>%
mutate(item = str_to_title(item))
View(ret_family_macro)
post_res_family_macro <- post_df %>%
select(family, starts_with('b_ave')) %>%
gather('item','coeff', names(.)[2]:names(.)[ncol(.)]) %>%
group_by(family, item) %>%
summarise(q50 = median(coeff),
q2.5 = quantile(coeff, probs = 0.025),
q97.5 = quantile(coeff, probs = 0.975),
q12.5 = quantile(coeff, probs = 0.125),
q87.5 = quantile(coeff, probs = 0.875),
q1.25 = quantile(coeff, probs = 0.0125),
q98.75 = quantile(coeff, probs = 0.9875),
q0.5 = quantile(coeff, probs = 0.005),
q99.5 = quantile(coeff, probs = 0.995)
) %>%
ungroup() %>%
mutate(mark = if_else(q99.5 < 0 | q0.5 > 0, '***', if_else(q98.75 < 0 | q1.25 > 0, '**', if_else(q97.5 < 0 | q2.5 > 0, '*', '')))) %>%
mutate(color = if_else(q87.5 < 0, 'steelblue', if_else(q12.5 > 0, 'maroon', 'white'))) %>%
mutate(item = str_replace(item, 'b_ave_','')) %>%
mutate(item = str_to_title(item))
col_key <- post_res_family_macro %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
col_key
View(post_res_family_macro)
ggplot(post_res_family_macro, aes(x = family, y = item)) +
geom_tile(aes(fill = color,  x = family, y =  item), alpha = 0.5, color='white', width=0.95, height=0.95) +
geom_text(aes(label = mark, x = family,y =  item),
nudge_y = -0.1, nudge_x = 0,size = 5) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0','75% CI > 0 positive', '75% CI < 0 negative')) +
theme_light() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=50, hjust=1, size=11),
axis.text.y=element_text(size=11),
axis.title=element_text(size=axis_title_size),
#panel.grid.major = element_blank(),
#panel.grid.minor = element_blank(),
legend.position = 'top',
legend.key = element_rect( colour = "gray50"),
panel.background = element_blank())
ggplot(post_res_family_macro, aes(x = family, y = item)) +
geom_tile(aes(fill = color,  x = family, y =  item), alpha = 0.5, color='white', width=0.95, height=0.95) +
geom_text(aes(label = mark, x = family,y =  item),
nudge_y = -0.1, nudge_x = 0,size = 5) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0','75% CI > 0 positive', '75% CI < 0 negative')) +
theme_light() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=50, hjust=1, size=11),
axis.text.y=element_text(size=11),
axis.title=element_text(size=axis_title_size),
#panel.grid.major = element_blank(),
#panel.grid.minor = element_blank(),
legend.position = 'top',
legend.key = element_rect( colour = "gray50"),
panel.background = element_blank())
ggsave('../figs/paper/087_heatmap_family_24_macro_ggplot.pdf', width = 8, height = 3)
ggsave('../figs/paper/087_heatmap_family_24_macro_ggplot.pdf', width = 8, height = 8)
ggsave('../figs/paper/087_heatmap_family_24_macro_ggplot.pdf', width = 8, height = 5)
ggsave('../figs/paper/087_heatmap_family_24_macro_ggplot.pdf', width = 8, height = 4)
knitr::opts_chunk$set(echo = TRUE)
library(vdbR)
connect_database('~/dbConfig.txt')
# all the patients that have a entercoccus growth rate
combined <- read_csv('../data/growth/069_irep_combined_res.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
target <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
distinct(mrn) %>%
pull(mrn)
entero <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid, mrn) %>%
summarise(ave_irpe = mean(aveirep)) %>%
inner_join(meta %>%
select(sampleid, sdrt))
# all of these patients stool samples we have
get_table_from_database('samples_castori_ag')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# 2021-1-13
# Oriana samples Arielle samples shotgun
ba <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv')
View(ba)
# 2021-1-13
# Oriana samples Arielle samples shotgun
ba <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
select(sampleid)
# 2021-1-13
# Oriana samples Arielle samples shotgun
ba <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
select(sampleid) %>%
mutate(fid = if_else(str_detect(sampleid, '^FMT'), str_replace(sampleid, '\\.', '_'), sampleid))
arie <- Sys.glob('/Volumes/vandenBrinkLab/MMF/Sequencing Data/Arielle/Shotgun/')
arie <- list.files('/Volumes/vandenBrinkLab/MMF/Sequencing Data/Arielle/Shotgun/')
arie
arie <- tibble(
dir = list.files('/Volumes/vandenBrinkLab/MMF/Sequencing Data/Arielle/Shotgun/')
)
arie
arie <- tibble(
dir = list.files('/Volumes/vandenBrinkLab/MMF/Sequencing Data/Arielle/Shotgun/')
) %>%
mutate(fid = str_replace(dir, 'Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))
View(arie)
fids <- bind_rows(
ba %>% select(fid),
arie %>% select(fid)
)
View(fids)
280+52
fids %>%
write_csv('../data/OA2.csv')
fids %>%
write_csv('../data/OA2.csv', col_names = F)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
cur <- read_delim('../data/current.txt', delim = ' ', skip = 1, col_names = F) %>%
filter(str_detect(X9, 'Sample'))
View(cur)
cur <- read_delim('../data/current.txt', delim = ' ', skip = 1, col_names = F)
cur <- read_delim('../data/current.txt', delim = '\t', skip = 1, col_names = F)
cur <- read_delim('../data/current.txt', delim = ' ', skip = 1, col_names = F)
cur <- read_delim('../data/current.txt', delim = '\t', skip = 1, col_names = F)
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F)
cur
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F) %>%
mutate(folder = str_replace(X1, '^.+Sample_',''))
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F) %>%
mutate(folder = str_replace(X1, '^.+Sample_','')) %>%
mutate(folder = str_replace(X1, '_IGO.+$',''))
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F) %>%
mutate(folder = str_replace(X1, '^.+Sample_','')) %>%
mutate(folder = str_replace(folder, '_IGO.+$',''))
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F) %>%
mutate(fid = str_replace(X1, '^.+Sample_','')) %>%
mutate(fid = str_replace(folder, '_IGO.+$',''))
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F) %>%
mutate(fid = str_replace(X1, '^.+Sample_','')) %>%
mutate(fid = str_replace(fid, '_IGO.+$',''))
cur <- read_delim('../data/current.txt', delim = '\t',  col_names = F) %>%
mutate(fid = str_replace(X1, '^.+Sample_','')) %>%
mutate(fid = str_replace(fid, '_IGO.+$',''))
fids
overlap <- cur %>%
inner_join(fids)
View(overlap)
setdiff(fids$fid, cur$fid)
280+52
332-231
length(setdiff(fids$fid, cur$fid))
setdiff(fids$fid, cur$fid)
miss <- tibble(fid = setdiff(fids$fid, cur$fid))
View(miss)
library(tidyverse)
library(vdbR)
connect_database('~/dbConfig.txt')
get_table_from_database('shotgun_lookup_ad')
View(shotgun_lookup_ad)
miss
miss <- tibble(fid = setdiff(fids$fid, cur$fid)) %>%
left_join(shotgun_lookup_ad)
View(shotgun_lookup_ad)
pro12652 <-  tibble(
dir = list.files('/Volumes/vandenBrinkLab/MMF/Sequencing Data/Arielle/Shotgun/')
) %>%
mutate(fid = str_replace(dir, 'Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))
View(pro12652)
View(pro12652)
View(fids)
View(pro12652)
View(pro12652)
View(pro12652)
length(intersect(miss$fid, ba$fid))
View(ba)
miss <- tibble(fid = setdiff(fids$fid, cur$fid))
# fids: oriana all + arielle
miss <- tibble(fid = setdiff(fids$fid, cur$fid)) %>%
left_join(shotgun_lookup_ad)
tibble(fid = setdiff(fids$fid, cur$fid)) %>%
write_csv('../data/BA_missing.csv', col_names = F)
missing_fids <- setdiff(fids$fid, cur$fid)
ba
missing <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
mutate(fid = if_else(str_detect(sampleid, '^FMT'), str_replace(sampleid, '\\.', '_'), sampleid)) %>%
filter(fid %in% missing_fids)
View(missing)
missing %>%
write_csv('../data/BA_missing.csv', col_names = F)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
# family macro
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv') %>%
mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>%
mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
mutate(mrn = factor(mrn)) %>%
mutate(fg_egg = fg_egg/100,
fg_fruit = fg_fruit/100,
fg_grain = fg_grain/100,
fg_legume = fg_legume/100,
fg_meat = fg_meat/100,
fg_milk = fg_milk/100,
fg_oils = fg_oils/100,
fg_sweets = fg_sweets/100,
fg_veggie = fg_veggie/100) %>%
mutate(inten_non = if_else(intensity == 'nonablative', 1, 0),
inten_ab = if_else(intensity == 'ablative', 1, 0),
inten_re = if_else(intensity == 'reduced', 1, 0))
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_family_counts.csv') %>%
filter(sampleid %in% meta$sampleid) %>%
dplyr::select(sampleid, taxa_family, relab) %>%
mutate(taxa_family = str_extract(taxa_family, 'f__.+$')) %>%
mutate(taxa_family = str_replace(taxa_family, 'f__','')) %>%
filter(taxa_family != 'NA')
thre <- seq(0.0001, 0.003, 0.0001)
thre %>%
set_names(thre) %>%
map_dfr(function(num){
cts %>%
group_by(taxa_family) %>%
count(relab > num) %>%
rename(criteria = names(.)[2]) %>%
filter(criteria == 'TRUE') %>%
arrange(-n) %>%
mutate(perc = round(n/nrow(meta)*100, 0)) %>%
filter(perc > 10) %>%
nrow
}) %>%
gather('thre', 'num')
# choose 0.002
target_family <-  cts %>%
group_by(taxa_family) %>%
count(relab > 0.002) %>%
rename(criteria = names(.)[2]) %>%
filter(criteria == 'TRUE') %>%
arrange(-n) %>%
mutate(perc = round(n/nrow(meta)*100, 0)) %>%
filter(perc > 10) %>%
pull(taxa_family)
domcts <- cts %>%
filter(taxa_family %in% target_family) %>%
mutate(relablog = log10(relab + 2*10^-6)) %>%
dplyr::select(-relab) %>%
spread(key = 'taxa_family', value = 'relablog')
All <- domcts %>%
full_join(meta, by = "sampleid")
total <- All %>%
select(sampleid:Veillonellaceae) %>%
full_join(full)
full <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
total <- All %>%
select(sampleid:Veillonellaceae) %>%
full_join(full)
total %>%
write_csv('../data/087_ALL_meta_data.csv')
total <- read_csv('../data/087_ALL_meta_data.csv')
View(total)
library(ggpubr)
total %>%
ggscatter(x = 'Enterococcus', y = 'Enterococcaceae')
total %>%
ggscatter(x = 'Enterococcus', y = 'Enterococcaceae',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "pearson",  label.sep = "\n"))
total %>%
ggscatter(x = 'Enterococcus', y = 'Enterococcaceae',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "pearson",  label.sep = "\n")) +
geom_abline( slope = 1)
total %>%
ggscatter(x = 'Enterococcus', y = 'Enterococcaceae',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n")) +
geom_abline( slope = 1)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
full <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
View(full)
full <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
View(dtb)
View(dtb)
byday <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal),
d_protein = sum(Protein_g),
d_fat = sum(Fat_g),
d_carb = sum(Carbohydrates_g),
d_fiber = sum(Fibers_g),
d_sugar = sum(Sugars_g))
View(byday)
meta <- read_csv('../data/cleaned_stool/nutrition_samples_meta_p2d_fg9_updated.csv')
View(meta)
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
View(meta)
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
View(meta)
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
View(meta)
meta
full <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
byday <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal),
d_protein = sum(Protein_g),
d_fat = sum(Fat_g),
d_carb = sum(Carbohydrates_g),
d_fiber = sum(Fibers_g),
d_sugar = sum(Sugars_g)) %>%
rename(drt = fdrt) %>%
inner_join(full %>%
rename(drt = sdrt))
View(full)
byday <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal),
d_protein = sum(Protein_g),
d_fat = sum(Fat_g),
d_carb = sum(Carbohydrates_g),
d_fiber = sum(Fibers_g),
d_sugar = sum(Sugars_g)) %>%
rename(drt = fdrt) %>%
inner_join(full %>%
rename(drt = sdrt), by = c("mrn", "drt"))
full
byday <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal),
d_protein = sum(Protein_g),
d_fat = sum(Fat_g),
d_carb = sum(Carbohydrates_g),
d_fiber = sum(Fibers_g),
d_sugar = sum(Sugars_g)) %>%
rename(drt = fdrt) %>%
inner_join(full %>%
rename(drt = sdrt), by = c("mrn", "drt")) %>%
select(simpson_reciprocal, Blautia, Enterococcus, daycal:d_sugar)
?plot_grid
??plot_grid
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
total <- read_csv('../data/087_ALL_meta_data.csv')
total %>%
ggscatter(x = 'Enterococcus', y = 'Enterococcaceae',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n")) +
geom_abline( slope = 1)
View(total)
total %>%
filter(Enterococcus == 0)
total %>%
filter(Enterococcus == 0) %>%
select(Enterococcus, Enterococcaceae)
total %>%
filter(Enterococcus == 0) %>%
select(Enterococcus, Enterococcaceae, sampleid)
gcts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv')
View(gcts)
total %>%
filter(Enterococcus == 0) %>%
select(Enterococcus, Enterococcaceae, sampleid)
fcts <- read_csv('../data/cleaned_stool/ALL_stool_samples_family_counts.csv')
View(fcts)
fcts
fcts <- read_csv('../data/cleaned_stool/ALL_stool_samples_family_counts.csv') %>%
mutate(taxa_family = str_extract(taxa_family, 'f__.+$'))
total %>%
filter(Enterococcus == 0) %>%
select(Enterococcus, Enterococcaceae, sampleid)
total %>%
filter(Enterococcus == 0) %>%
select(Enterococcus, Enterococcaceae, sampleid)
View(total)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyverse)
