height = 60,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fac2)
coeff_bi <- post_samples %>%
select(starts_with('b_')) %>%
select(!starts_with('b_fg')) %>%
gather('item', 'coeff') %>%
mutate(item_name = case_when(
item ==  'b_intensitynonablative' ~ 'Intensity: nonablative',
item == 'b_intensityablative' ~ 'Intensity: ablative',
item ==  'b_intensityreduced' ~ 'Intensity: reduced',
item ==  'b_empiricalTRUE' ~ 'Empirical abx exposure',
item == 'b_TPNTRUE' ~ 'TPN exposure',
item ==  'b_ENTRUE' ~ 'EN exposure'
)) %>%
mutate(item_name = factor(item_name, levels = c('Intensity: nonablative', 'Intensity: reduced',
'Intensity: ablative', 'TPN exposure','EN exposure',
'Empirical abx exposure'))) %>%
mutate(grp = if_else(str_detect(item_name, 'Intensity'), 'Patient level', 'Sample level'))
entero_genus_factor <- coeff_bi %>%
ggplot(aes(x = coeff, y = item_name)) +
stat_pointinterval(.width = c(.66, .95)) +
#scale_color_manual(values = c('#EC0000','#00468B')) +
geom_vline(xintercept = 0, col = 'black', linetype = 'dashed') +
facet_wrap(grp~ . , scales = 'free', dir = 'v') +
labs(x = 'Coefficients',
y = 'Factor variables',
title = 'Enterococcus') +
theme_classic() +
theme(legend.position = 'none',
strip.background = element_blank(),
strip.text = element_blank(),
aspect.ratio=1/2)
entero_genus_factor %>% write_rds('../data/087_entero_genus_factor_forest.rds')
div_fac <- read_rds('../data/068_diversity_factor_forest.rds')
enter_fac <- read_rds('../data/087_entero_genus_factor_forest.rds')
fac2 <- plot_grid(  div_fac,enter_fac,
nrow = 1, labels = c('A','B'), rel_widths = c(1, 1))
ggsave('../figs/paper/S6_div_entero_factor_086.pdf',
width = 170,
height = 60,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fac2)
div_fac <- read_rds('../data/068_diversity_factor_forest.rds')
enter_fac <- read_rds('../data/087_entero_genus_factor_forest.rds')
fac2 <- plot_grid(  div_fac,enter_fac,
nrow = 1, labels = c('A','B'), rel_widths = c(1, 1))
ggsave('../figs/paper/S5_div_entero_factor_086.pdf',
width = 170,
height = 60,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fac2)
ggsave('../figs/paper/S5_div_entero_factor_086.jpg',
width = 170,
height = 60,
#height = 60,
units = c("mm"),
dpi = 400, device = 'jpg', plot = fac2)
knitr::opts_chunk$set(echo = TRUE)
# load the three tables
library(vdbR)
library(tidyverse)
connect_database('~/dbConfig.txt')
list_table_from_database('alpha')
get_table_from_database('asv_annotation_blast_ag')
get_table_from_database('asv_alpha_diversity_ag')
alpha <- asv_alpha_diversity_ag %>%
filter(str_detect(oligos_id, 'pool1126|pool1127|pool1129|pool1128')) %>%
select(sampleid:shannon)
dir.create('../data/hackensack')
alpha %>% write_csv('../data/hackensack/samples_alpha_diversity.csv')
cts <- get_counts_subset(alpha$sampleid) %>%
select(asv_key:count_total, count_relative)
taxa <- asv_annotation_blast_ag %>%
filter(asv_key %in% cts$asv_key) %>%
select(asv_key:blast_pass)
list(alpha = alpha,
counts = cts,
taxa = taxa) %>%
imap(function(.x, .y){
write_csv(.x, str_glue('../data/hackensack/hackensack_ASV_{.y}.csv'))
})
# check the meta table they sent us
meta <- readxl::read_excel('../data/3-1-22 Metadata MSK incl Abx.xlsx')
View(alpha)
View(alpha)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('asv_alpha_diversity_ag')
get_table_from_database('shotgun_lookup_ad')
get_table_from_database('asv_annotation_blast_ag')
dat <- asv_alpha_diversity_ag %>%
distinct(oligos_id) %>%
mutate(poolid = str_extract(oligos_id, 'pool.+$')) %>%
distinct(poolid) %>%
filter(str_detect(poolid, 'pool835|pool935|pool940|pool1042|pool1048|pool1050|pool1064|pool1109|pool1117|pool1121'))
#pool1109
asv_alpha_diversity_ag %>%
write_csv('../data/asv_alpha_diversity_ag.csv')
two <- asv_alpha_diversity_ag %>%
filter(str_detect(path_pool, 'pool1096\\+1097|pool1100')) %>%
#select(oligos_id, path_pool) %>%
distinct(oligos_id, .keep_all = T)
View(two)
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>%
distinct(sid, .keep_all = T)
View(reply)
two
two %>%
select(sampleid)
# send the sampleid of the "two " to lauren and John for identifying anything
two %>%
select(sampleid) %>%
write_csv('../data/duke_two_pools_90.csv')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(viridis)
# make the food code counts matrix
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
matri <- dtb %>%
select(mrn, fdrt, Food_code, dehydrated_weight) %>%
mutate(fid = str_glue('{mrn}d{fdrt}')) %>%
select(fid, Food_code, dehydrated_weight) %>%
group_by(fid, Food_code) %>%
summarise(total = sum(dehydrated_weight)) %>%
spread('fid', 'total', fill = 0)
matri %>%
write_csv('../data/cleaned_diet_data/FINAL_97_food_code_counts_matrix.csv')
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1]) %>%
write_csv('../softwares/phylo-umap/taxumap/data/taxUMAP_food_cts.csv')
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1]) %>%
write_csv('../softwares/phylo-umap/taxumap/data/taxUMAP_food_cts.csv')
# formatting the counts table to have samples in the rows
cts <- matri %>%
gather('fid', 'gram', names(.)[2]:names(.)[ncol(.)])
fid_sum <- cts %>%
group_by(fid) %>%
summarise(Sum = sum(gram))
cts_all <- cts %>%
left_join(fid_sum)  %>%
mutate(frelab = gram/Sum) %>%
select(Food_code, fid, frelab) %>%
spread(key = 'Food_code', value = 'frelab') %>%
rename(index_column = fid) %>%
mutate(index_column = str_glue('P{index_column}'))
# create pt number for the mrn
link <- cts_all %>%
select(index_column) %>%
transmute(mrn = str_extract(index_column, 'P.+d')) %>%
mutate(mrn = str_replace(mrn, 'P',''),
mrn = str_replace(mrn, 'd$','') ) %>%
distinct() %>%
mutate(pt = seq(1, nrow(.))) %>%
mutate(pt = str_pad(pt, 2, side = 'left', '0')) %>%
mutate(pt = str_glue('P{pt}'))
link_all <- cts_all %>%
select(index_column) %>%
mutate(fid = index_column) %>%
separate(index_column, into = c('mrn','fdrt'), sep = 'd') %>%
mutate(mrn = str_replace(mrn, 'P','')) %>%
left_join(link) %>%
mutate(index_column = str_glue('{pt}d{fdrt}'))
link_all %>%
write_csv('../data/cleaned_diet_data/deidentify_dsample_map.csv')
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1]) %>%
write_csv('../softwares/phylo-umap/taxumap/data/taxUMAP_food_cts.csv')
View(cts_all)
cts_all
# do a pcoa using the cts_all data
# you know the traditional pcoa, to highlight what is the advantage of the taxUMAP
food_cts <- cts_all %>%
column_to_rownames('index_column')
# do a pcoa using the cts_all data
# you know the traditional pcoa, to highlight what is the advantage of the taxUMAP
food_cts <- cts_all %>%
column_to_rownames('index_column')
dist_ <- vegdist(food_cts, method = 'bray')
dist_ <- vegan::vegdist(food_cts, method = 'bray')
eigen <- ape::pcoa(dist_)$values$Eigenvalues
percent_var <- signif(eigen/sum(eigen), 3)*100
bc <- cmdscale(dist_, k = 2)
View(bc)
View(dtb)
dtb
# find out the most consumed food group for that patient on that day
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight)
View(dom_per_day)
dom_per_day
# find out the most consumed food group for that patient on that day
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))
dom_per_day
# find out the most consumed food group for that patient on that day
sum_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 )) %>%
group_by(mrn, fdrt) %>%
summarise(daytotal = sum(dehydrated_weight))
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))
dom_per_day
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))  %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dayfgtotal = sum(dehydrated_weight))
dom_per_day
sum_per_day
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))  %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dayfgtotal = sum(dehydrated_weight)) %>%
left_join(sum_per_day)
dom_per_day
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))  %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dayfgtotal = sum(dehydrated_weight)) %>%
left_join(sum_per_day) %>%
mutate(fg_frac = dayfgtotal/daytotal)
dom_per_day
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))  %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dayfgtotal = sum(dehydrated_weight)) %>%
left_join(sum_per_day) %>%
mutate(fg_frac = dayfgtotal/daytotal) %>%
ungroup() %>%
group_by(mrn, fdrt) %>%
arrange(desc(fg_frac), .by_group = T)
dom_per_day <- dtb %>%
select(mrn, Food_code, fdrt, dehydrated_weight) %>%
mutate(fgrp1 = str_sub(as.character(Food_code),1,1 ))  %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dayfgtotal = sum(dehydrated_weight)) %>%
left_join(sum_per_day) %>%
mutate(fg_frac = dayfgtotal/daytotal) %>%
ungroup() %>%
group_by(mrn, fdrt) %>%
arrange(desc(fg_frac), .by_group = T) %>%
slice(1)
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')
View(dom_pcoa)
dom_pcoa
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd')
dom_pcoa
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = str_replace(pt, '^P','')) %>%
mutate(fdrt = as.numeric(fdrt))
dom_pcoa
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt))
dom_pcoa
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt)) %>%
full_join(dom_per_day)
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv')
View(key)
dom_pcoa
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt)) %>%
full_join(dom_per_day) %>%
left_join(key)
dom_pcoa
key
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt)) %>%
full_join(dom_per_day) %>%
left_join(key)
bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt)) %>%
full_join(dom_per_day)
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd') %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt)) %>%
full_join(dom_per_day) %>%
left_join(key)
dom_pcoa
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'fg1_name') +
labs(title = '') +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right')
library(ggpubr)
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'fg1_name') +
labs(title = '') +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right')
color_key <- dom_pcoa %>%
ungroup() %>%
distinct(shortname, color) %>%
select(shortname, color) %>%
#mutate(shortname = factor(shortname)) %>%
#arrange(shortname) %>%
deframe()
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right')
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right')
ggsave('../figs/paper/016_pcoa_food_cts.jpg',
width = 80,
height = 100,
#height = 60,
units = c("mm"),
dpi = 400)
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right',
legend.position= element_blank())
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right',
legend.position= 'none')
dom_pcoa %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1,
legend.position= 'none')
ggsave('../figs/paper/016_pcoa_food_cts.jpg',
width = 80,
height = 100,
#height = 60,
units = c("mm"),
dpi = 400)
install.packages('umap')
# do the same dimensionality reduction and then visualization using umap
library(umap)
View(cts_all)
cts_all[,2:ncol(cts_all)]
food_umap = umap(cts_all[,2:ncol(cts_all)])
View(food_umap)
View(dom_per_day)
View(dom_pcoa)
dom_pcoa <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
separate(sampleid, into = c('pt','fdrt'), sep = 'd', remove = F) %>%
mutate(mrn = as.numeric(str_replace(pt, '^P',''))) %>%
mutate(fdrt = as.numeric(fdrt)) %>%
full_join(dom_per_day) %>%
left_join(key)
all.equal(dom_pcoa$sampleid, cts_all$index_column)
all.equal(as.character(dom_pcoa$sampleid), as.character(cts_all$index_column))
all.equal(as.character(dom_pcoa$sampleid), as.character(cts_all$index_column))
all.equal(as.character(dom_pcoa$sampleid), as.character(cts_all$index_column))
plot.iris(food_umap, dom_pcoa$fgrp1)
food_umap$layout
food_umap$layout %>%
as.data.frame()
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid =cts_all$index_column )
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid =cts_all$index_column ) %>%
full_join(dom_pcoa)
dom_pcoa
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid =as.character(cts_all$index_column) ) %>%
full_join(dom_pcoa) %>%
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column))
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column))
food_umap$layout %>%
as.data.frame()
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column))
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column)) %>%
full_join(dom_pcoa)
dom_pcoa
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column)) %>%
full_join(dom_pcoa)
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column))
food_umap$layout %>%
as.data.frame()
food_umap$layout
food_umap$layout %>%
as.data.frame()
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column))
food_umap$layout
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column)) %>%
full_join(dom_pcoa %>%
select(sampleid, shortname), by = c( "sampleid"))
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column)) %>%
full_join(dom_pcoa %>%
select(sampleid, shortname), by = c( "sampleid"))  %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
theme(aspect.ratio=1,
legend.position= 'none')
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column)) %>%
full_join(dom_pcoa %>%
select(sampleid, shortname), by = c( "sampleid"))  %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
theme(aspect.ratio=1,
legend.position= 'none') +
lemon::coord_capped_cart(bottom = 'both', left = 'both')
food_umap$layout %>%
as.data.frame() %>%
mutate(sampleid = as.character(cts_all$index_column)) %>%
full_join(dom_pcoa %>%
select(sampleid, shortname), by = c( "sampleid"))  %>%
ggscatter(x = 'V1', y = 'V2', color =  'shortname',alpha = 1,size = 1 , shape = 16,) +
labs(title = '') +
scale_color_manual(values = color_key) +
theme(aspect.ratio=1,
legend.position= 'none') +
lemon::coord_capped_cart( left = 'both')
ggsave('../figs/paper/016_umap_food_cts.jpg',
width = 80,
height = 100,
#height = 60,
units = c("mm"),
dpi = 400)
