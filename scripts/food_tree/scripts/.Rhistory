arrange(sampleid)
all.equal(pheno$sampleid, colnames(ctslog2))
combat_ctslog2 = ComBat(dat=ctslog2, batch=pheno$BatchID, mod=NULL, par.prior=FALSE, mean.only=TRUE,prior.plots=T )
pca_res <- prcomp(combat_ctslog2 %>% t(), scale. = TRUE, center = T)
autoplot(pca_res)
cts <- auc %>%
select(-BatchID, - Group) %>%
gather('BA', 'auc', names(.)[2]:names(.)[ncol(.)]) %>%
spread('sampleid', 'auc') %>%
column_to_rownames('BA') %>%
as.matrix()
cts[cts<0] <- 0
pseudo <- min(cts[cts>0])
ctslog2 <- log2(cts + 1)
# the pheno data
pheno <- auc %>%
select(sampleid,BatchID,  Group) %>%
arrange(sampleid)
all.equal(pheno$sampleid, colnames(ctslog2))
combat_ctslog2 = ComBat(dat=ctslog2, batch=pheno$BatchID, mod=NULL, par.prior=FALSE, mean.only=TRUE,prior.plots=T )
pca_res <- prcomp(combat_ctslog2 %>% t(), scale. = TRUE, center = T)
pca_res$x
pca_res$x %>%
as.data.frame() %>%
rownames_to_column('sampleid') %>%
select(PC1, PC2, sampleid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'BatchID')
combat_ctslog2 %>%
as.data.frame() %>%
write_csv('../data/log2_transformed_auc_batch_corrected.csv')
combat_ctslog2
combat_ctslog2 %>%
as.data.frame()
combat_ctslog2 %>%
as.data.frame() %>%
rownames_to_column('BA') %>%
write_csv('../data/log2_transformed_auc_batch_corrected.csv')
devtools::install_version("RPostgreSQL", version="0.6-2")
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
ba <- read_excel('../data/KO_BAs.xlsx')
View(ba)
library(readxl)
ba <- read_excel('../data/KO_BAs.xlsx')
tb <- read_tsv('../data/map_EC_to_triplet_AC_U50_U90_Swissprot_and_Trembl.txt')
View(tb)
ba <- read_excel('../data/KO_BAs.xlsx')
ba <- read_excel('../data/KO_BAs.xlsx')
ba <- read_excel('../data/KO_BAs.xlsx')
all_ec <- tb$`1`
all_ec
ba
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
length(intersect(all_ec,ba$ECnum ))
intersect(all_ec,ba$ECnum )
ba
intersect(all_ec,ba$ECnum )
in_match <- ba %>%
filter(ECnum %in% all_ec)
in_match
bile_ko <- read_tsv('/Volumes/vandenBrinkLab/Angel_Dai/Oriana480/bile423/joined_humann3_KO_cpm_unstratified.tsv')
View(bile_ko)
bile_ko
ba
bile_ko <- read_tsv('/Volumes/vandenBrinkLab/Angel_Dai/Oriana480/bile423/joined_humann3_KO_cpm_unstratified.tsv') %>%
filter(`# Gene Family` %in% ba$KO)
# to look at the recent batch from Oriana
fns <- list.files('../data/KO/', full.names = T)
fns
# to look at the recent batch from Oriana
fns <- tibble(
fn = list.files('../data/KO/', full.names = T)
)
fns
# to look at the recent batch from Oriana
fns <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''))
fns
# to look at the recent batch from Oriana
fns <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', ''))
fns
# to look at the recent batch from Oriana
oriana <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
select(sampleid) %>%
mutate(fid = if_else(str_detect(sampleid, '^FMT'), str_replace(sampleid, '\\.', '_'), sampleid))
View(oriana)
fns <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
View(fns)
230-178
# to look at the recent batch from Oriana
oriana_all <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
select(sampleid) %>%
mutate(fid = if_else(str_detect(sampleid, '^FMT'), str_replace(sampleid, '\\.', '_'), sampleid))
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
View(oba)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana$fid)
View(oba)
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana_all$fid)
View(oba)
oba
test <- read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv')
View(test)
test
test
test <- read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv') %>%
filter(!str_detect(`# Gene Family`, '\\|'))
test <- read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv') %>%
filter(!str_detect(`# Gene Family`, '\\|'))
test
read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv') %>%
filter(!str_detect(`# Gene Family`, '\\|'))
read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv')
test <- read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv') %>%
filter(!str_detect(`# Gene Family`, '\\|'))
test
test <- read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv') %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2])
test <- read_tsv('../data/KO//1024E_humann3_KO_cpm.tsv') %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2])
test
oba
res <- oba %>%
pull(fn) %>%
map(~ read_tsv(.) %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2]) )
View(res)
ofn <- oba %>%
pull(fn)
ofn <- oba %>%
pull(fn)
ofn <- oba %>%
pull(fn)
ofn
ofn <- oba %>%
pull(fn)
ofn
res <- ofn %>%
set_names(ofn) %>%
map(~ read_tsv(.) %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2]) )
View(res)
res <- ofn %>%
set_names(ofn) %>%
map(~ read_tsv(.) %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2]) ) %>%
bind_rows(.id = 'fn')
View(res)
View(ba)
res
bas <- res %>%
filter(KOID %in% ba$KO)
View(bas)
View(oriana_all)
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba)
bas <- res %>%
filter(KOID %in% ba$KO)
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba)
oriana_all
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba) %>%
inner_join(oriana_all)
# to look at the recent batch from Oriana
pheno <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv')
pheno <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv')
View(pheno)
View(bas)
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba) %>%
inner_join(oriana_all)
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba) %>%
inner_join(oriana_all)
View(bas)
pheno
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba) %>%
inner_join(oriana_all) %>%
left_join(pheno %>%
select(BatchID, DiseaseGroup, sampleid, mrn))
library(ggpubr)
bas
bas %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID')
bas %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter')
bas
bas %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
View(oriana_all)
View(pheno)
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
onset <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/cohort_BAs_later.csv')
View(onset)
bas
bas %>%
filter(sampleid %in% onset$sampleid)
bas %>%
filter(sampleid %in% onset$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
perien <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/cohort_BAs_periengr.csv')
bas %>%
filter(sampleid %in% perien$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
bas %>%
filter(sampleid %in% perien$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
bas %>%
filter(sampleid %in% perien$sampleid) %>%
distinct(sampleid)
bas %>%
filter(sampleid %in% onset$sampleid) %>%
distinct(sampleid)
bas %>%
filter(sampleid %in% perien$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
ursodiol <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/ursodiol.csv')
View(ursodiol)
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
# ursodile exposure
include <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/ursodiol_exposed_samples_for_analysis.csv')
View(include)
bas %>%
filter(sampleid %in% perien$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
distinct(sampleid)
bas %>%
filter(sampleid %in% perien$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
bas %>%
filter(sampleid %in% onset$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(ggpubr)
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
tb <- read_tsv('../data/map_EC_to_triplet_AC_U50_U90_Swissprot_and_Trembl.txt')
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
# to look at the recent batch from Oriana
pheno <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv')
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
oriana_all <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
select(sampleid) %>%
mutate(fid = if_else(str_detect(sampleid, '^FMT'), str_replace(sampleid, '\\.', '_'), sampleid))
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana_all$fid)
onset <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/cohort_BAs_later.csv')
perien <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/cohort_BAs_periengr.csv')
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
ursodiol <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/ursodiol.csv')
ofn <- oba %>%
pull(fn)
res <- ofn %>%
set_names(ofn) %>%
map(~ read_tsv(.) %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2]) ) %>%
bind_rows(.id = 'fn')
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba) %>%
inner_join(oriana_all) %>%
left_join(pheno %>%
select(BatchID, DiseaseGroup, sampleid, mrn))
bas %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
bas %>%
filter(sampleid %in% onset$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
include <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/ursodiol_exposed_samples_for_analysis.csv')
bas %>%
filter(sampleid %in% onset$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
View(bas)
?connect_database
library(vdbR)
?connect_database
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
matri <- dtb %>%
select(mrn, fdrt, Food_code, dehydrated_weight) %>%
mutate(fid = str_glue('{mrn}d{fdrt}')) %>%
select(fid, Food_code, dehydrated_weight) %>%
group_by(fid, Food_code) %>%
summarise(total = sum(dehydrated_weight)) %>%
spread('fid', 'total', fill = 0)
cts <- matri %>%
gather('fid', 'gram', names(.)[2]:names(.)[ncol(.)])
fid_sum <- cts %>%
group_by(fid) %>%
summarise(Sum = sum(gram))
cts_all <- cts %>%
left_join(fid_sum)  %>%
mutate(frelab = gram/Sum) %>%
select(Food_code, fid, frelab) %>%
spread(key = 'Food_code', value = 'frelab') %>%
rename(index_column = fid) %>%
mutate(index_column = str_glue('P{index_column}'))
# create pt number for the mrn
link <- cts_all %>%
select(index_column) %>%
transmute(mrn = str_extract(index_column, 'P.+d')) %>%
mutate(mrn = str_replace(mrn, 'P',''),
mrn = str_replace(mrn, 'd$','') ) %>%
distinct() %>%
mutate(pt = seq(1, nrow(.))) %>%
mutate(pt = str_pad(pt, 2, side = 'left', '0')) %>%
mutate(pt = str_glue('P{pt}'))
link_all <- cts_all %>%
select(index_column) %>%
mutate(fid = index_column) %>%
separate(index_column, into = c('mrn','fdrt'), sep = 'd') %>%
mutate(mrn = str_replace(mrn, 'P','')) %>%
left_join(link) %>%
mutate(index_column = str_glue('{pt}d{fdrt}'))
View(link_all)
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1]) %>%
write_csv('../softwares/phylo-umap/taxumap/data/taxUMAP_food_cts.csv')
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1])
View(dtb)
dtb
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight))
View(requested)
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all)
link_all
link_all
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn)))
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn),
fdrt = as.numeric(fdrt)))
requested
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn),
fdrt = as.numeric(fdrt))) %>%
select(index_column,total_kcal, total_gram )
ungroup( %>%
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn),
fdrt = as.numeric(fdrt))) %>%
ungroup( )%>%
select(index_column,total_kcal, total_gram )
requested %>%
write_csv('../data/index_with_cal_and_gram.csv')
