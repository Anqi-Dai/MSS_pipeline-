b_intensityreduced_
}
mean_max_fruit <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_max_fruit(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_max_fruit')%>%
mutate(sigma = test$sigma)
mean_max_sweet <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_max_sweets(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_max_sweet')%>%
mutate(sigma = test$sigma)
mean_max_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_max_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_max_veggie') %>%
mutate(sigma = test$sigma)
# the 500 random sampled predicted  diversity per each mean and sd combo
# first draw 500 of the mean (ln(diversity)) and then exponentiate the 500 draws
sampled_div_fruit <- mean_max_fruit %>%
select(sigma, mean_max_fruit) %>%
pmap(function(sigma, mean_max_fruit){
rnorm(500, mean = mean_max_fruit, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather() %>% mutate(div_mean_max_fruit = exp(value))
sampled_div_sweet <- mean_max_sweet %>%
select(sigma, mean_max_sweet) %>%
pmap(function(sigma, mean_max_sweet){
rnorm(500, mean = mean_max_sweet, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_max_sweet = exp(value))
sampled_div_veggie <- mean_max_veggie %>%
select(sigma, mean_max_veggie) %>%
pmap(function(sigma, mean_max_veggie){
rnorm(500, mean = mean_max_veggie, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_max_veggie = exp(value))
cal_mean_all_0_fruit <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * 0 +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$fg_sweets +
b_fg_veggie_ * ave_fg$fg_veggie +
b_intensityreduced_
}
mean_all_0_fruit <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_fruit(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID')
test_coeffb
# to subset random 100 rows of the post_samples
set.seed(1)
test <- post_samples %>%
select(starts_with('b_fg'), b_intensityreduced, sigma) %>%
slice_sample(n = 100)
colnames(test)
test_coeffb <- test %>% select(-sigma)
max_fruit_ave <- max_ %>% select(key, max_fg_fruit) %>% spread('key','max_fg_fruit')
max_sweets_ave <- max_ %>% select(key, max_fg_sweets) %>% spread('key','max_fg_sweets')
max_veggie_ave <- max_ %>% select(key, max_fg_veggie) %>% spread('key','max_fg_veggie')
cal_mean_max_fruit <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * max_fruit_ave$b_fg_egg +
b_fg_fruit_ * max_fruit_ave$b_fg_fruit +
b_fg_grain_ * max_fruit_ave$b_fg_grain +
b_fg_legume_ * max_fruit_ave$b_fg_legume +
b_fg_meat_ * max_fruit_ave$b_fg_meat +
b_fg_milk_ * max_fruit_ave$b_fg_milk +
b_fg_oils_ * max_fruit_ave$b_fg_oils +
b_fg_sweets_ * max_fruit_ave$b_fg_sweets +
b_fg_veggie_ * max_fruit_ave$b_fg_veggie +
b_intensityreduced_
}
cal_mean_max_sweets <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * max_sweets_ave$b_fg_egg +
b_fg_fruit_ * max_sweets_ave$b_fg_fruit +
b_fg_grain_ * max_sweets_ave$b_fg_grain +
b_fg_legume_ * max_sweets_ave$b_fg_legume +
b_fg_meat_ * max_sweets_ave$b_fg_meat +
b_fg_milk_ * max_sweets_ave$b_fg_milk +
b_fg_oils_ * max_sweets_ave$b_fg_oils +
b_fg_sweets_ * max_sweets_ave$b_fg_sweets +
b_fg_veggie_ * max_sweets_ave$b_fg_veggie +
b_intensityreduced_
}
cal_mean_max_veggie <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * max_veggie_ave$b_fg_egg +
b_fg_fruit_ * max_veggie_ave$b_fg_fruit +
b_fg_grain_ * max_veggie_ave$b_fg_grain +
b_fg_legume_ * max_veggie_ave$b_fg_legume +
b_fg_meat_ * max_veggie_ave$b_fg_meat +
b_fg_milk_ * max_veggie_ave$b_fg_milk +
b_fg_oils_ * max_veggie_ave$b_fg_oils +
b_fg_sweets_ * max_veggie_ave$b_fg_sweets +
b_fg_veggie_ * max_veggie_ave$b_fg_veggie +
b_intensityreduced_
}
mean_max_fruit <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_max_fruit(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_max_fruit')%>%
mutate(sigma = test$sigma)
mean_max_sweet <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_max_sweets(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_max_sweet')%>%
mutate(sigma = test$sigma)
mean_max_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_max_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_max_veggie') %>%
mutate(sigma = test$sigma)
# the 500 random sampled predicted  diversity per each mean and sd combo
# first draw 500 of the mean (ln(diversity)) and then exponentiate the 500 draws
sampled_div_fruit <- mean_max_fruit %>%
select(sigma, mean_max_fruit) %>%
pmap(function(sigma, mean_max_fruit){
rnorm(500, mean = mean_max_fruit, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather() %>% mutate(div_mean_max_fruit = exp(value))
sampled_div_sweet <- mean_max_sweet %>%
select(sigma, mean_max_sweet) %>%
pmap(function(sigma, mean_max_sweet){
rnorm(500, mean = mean_max_sweet, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_max_sweet = exp(value))
sampled_div_veggie <- mean_max_veggie %>%
select(sigma, mean_max_veggie) %>%
pmap(function(sigma, mean_max_veggie){
rnorm(500, mean = mean_max_veggie, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_max_veggie = exp(value))
ave_fg <- meta %>%
select(starts_with('fg')) %>%
summarise_all(funs(mean))
cal_mean_all <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$fg_sweets +
b_fg_veggie_ * ave_fg$fg_veggie +
b_intensityreduced_
}
mean_all <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all')%>%
mutate(sigma = test$sigma)
sampled_div_mean_all <- mean_all %>%
select(sigma, mean_all) %>%
pmap(function(sigma, mean_all){
rnorm(500, mean = mean_all, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_all = exp(value))
cal_mean_all_0_fruit <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * 0 +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$fg_sweets +
b_fg_veggie_ * ave_fg$fg_veggie +
b_intensityreduced_
}
mean_all_0_fruit <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_fruit(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all')%>%
mutate(sigma = test$sigma)
sampled_div_mean_all <- mean_all %>%
select(sigma, mean_all) %>%
pmap(function(sigma, mean_all){
rnorm(500, mean = mean_all, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_all = exp(value))
pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_fruit(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID')
cal_mean_all_0_fruit <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * 0 +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$fg_sweets +
b_fg_veggie_ * ave_fg$fg_veggie +
b_intensityreduced_
}
mean_all_0_fruit <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_fruit(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_fruit')%>%
mutate(sigma = test$sigma)
sampled_div_mean_all_0_fruit <- mean_all_0_fruit %>%
select(sigma, mean_all_0_fruit) %>%
pmap(function(sigma, mean_all_0_fruit){
rnorm(500, mean = mean_all_0_fruit, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_all_0_fruit = exp(value))
cal_mean_all_0_sweet <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * 0 +
b_fg_veggie_ * ave_fg$fg_veggie +
b_intensityreduced_
}
mean_all_0_sweet <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_sweet(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_sweet')%>%
mutate(sigma = test$sigma)
sampled_div_mean_all_0_sweet <- mean_all_0_sweet %>%
select(sigma, mean_all_0_sweet) %>%
pmap(function(sigma, mean_all_0_sweet){
rnorm(500, mean = mean_all_0_sweet, sd = sigma)
}) %>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'id') %>%
gather()%>% mutate(div_mean_all_0_sweet = exp(value))
cal_mean_all_0_veggie  <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$sweets +
b_fg_veggie_ * 0 +
b_intensityreduced_
}
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_veggie')%>%
mutate(sigma = test$sigma)
cal_mean_all_0_veggie  <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$sweets +
b_fg_veggie_ * 0 +
b_intensityreduced_
}
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_veggie')%>%
mutate(sigma = test$sigma)
knitr::opts_chunk$set(echo = TRUE)
# the below table has the more updated data
pts <- read_csv('../data/pts_updated_through_june_2022.csv') %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename(mrn = MRN) %>%
mutate(hct = lubridate::dmy(HCT))
colnames(pts)
# the below table has the more updated data
pts <- read_csv('../data/pts_updated_through_june_2022.csv') %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename(mrn = MRN) %>%
mutate(hct = lubridate::dmy(HCT))
colnames(pts)
ptb1 <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
ptb2 <- read_csv('../data/129_ptb2.csv')
ptb <- bind_rows(
ptb1 %>% select(mrn:disease.simple) %>% mutate(batch = 'batch1'),
ptb2 %>% select(mrn:disease.simple) %>% mutate(batch = 'batch2')
)
pts_tb <- pts %>%
right_join(ptb, by = c("mrn", "hct"))
all_hct2 <- pts %>%
filter(mrn %in% ptb$mrn) %>%
select(mrn, hct) %>%
filter(duplicated(mrn))
# find all of the hct and to mark which hct are we using their diet data
at2 <- pts %>%
filter(mrn %in% all_hct2$mrn) %>%
select(mrn, hct) %>%
left_join(ptb , by = c("mrn", "hct")) %>%
select(mrn, hct, batch) %>%
arrange(mrn, hct) %>%
split(.$mrn) %>%
map_dfr(function(df){
df %>% mutate(id = seq(1, nrow(.)))
})
censor_pt <- at2 %>%
group_by(mrn) %>%
arrange(desc(id)) %>%
slice(1) %>%
filter(is.na(batch)) %>%
pull(mrn)
censor2 <- at2 %>%
filter(mrn %in% censor_pt)
library(vdbR)
connect_database()
get_table_from_database('patient_allo_ks_20221104')
ptb_gvhd <- patient_allo_ks_20221104 %>%
right_join(ptb, by = c("mrn", "hct")) %>%
select(mrn, hct, batch, starts_with('d100'))
ptb_all <- pts_tb %>%
full_join(ptb_gvhd, by = c("mrn", "hct", "batch")) %>%
mutate(ANEUT_500_DATE = dmy(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct
)) %>%
relocate(ttancday, .after = 'TIME_ANEUT_500') %>%
# correct one patient engraftment date
mutate(ANEUT_500_DATE = if_else(ANEUT_500_DATE == '2021-11-16', '2021-10-23', as.character(ANEUT_500_DATE)),
ANEUT_500_DATE = ymd(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct)) %>%
select(-TIME_ANEUT_500)
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
## Predictors
# total calorie intake averaged between day 0 and day of engraftment (TTANC)
# total [each macronutrient] intake averaged between day 0 and day of engraftment (TTANC)
# total [food group of interest, pick 1 or 2 or just systematically all of them] intake averaged between day 0 and day of engraftment (TTANC)
# average food diversity between the period
# the diversity close to the engraftment for the patients
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
# make a table withe daily total caloric intake
DTB <- read_csv('../data/152_combined_DTB.csv') %>%
mutate(fgrp1 = str_sub(as.character(Food_code), 1, 1))
# a table of the daily each macro
daily <- DTB %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal),
d_protein = sum(Protein_g),
d_fat = sum(Fat_g),
d_carb = sum(Carbohydrates_g),
d_fiber = sum(Fibers_g),
d_sugar = sum(Sugars_g))
dailyfg <- DTB %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailyfg = sum(dehydrated_weight)) %>%
left_join(key %>% select(fgrp1, shortname)) %>%
mutate(shortname = str_glue('daily_{shortname}')) %>%
select(mrn, fdrt, shortname, dailyfg) %>%
spread('shortname', 'dailyfg', fill = 0)
dailyall <- daily %>%
full_join(dailyfg)
# calculate the above listed values
# ignore the patients that had died before engraphtment
pts_ <- ptb_all %>%
filter(!is.na(ttancday)) %>%
pull(mrn)
ave_ttanc <- pts_ %>%
set_names(pts_) %>%
map(function(mrn_){
ttanc_day <- ptb_all %>%
filter(mrn == mrn_) %>%
pull(ttancday)
total_days <- dailyall %>%
filter(mrn == mrn_ & fdrt %in% 0:ttanc_day) %>% nrow
ave_values <- dailyall %>%
filter(mrn == mrn_ & fdrt %in% 0:ttanc_day) %>%
gather('group', 'gram', daycal:daily_Vegetables) %>%
group_by(mrn, group) %>%
summarise(ave_grp = sum(gram)/total_days)
}) %>% bind_rows()
ave_ttanc_df <- ave_ttanc %>%
spread('group','ave_grp')
# why are there 2 patients that don't have any nutrition predictors
pt2 <- setdiff(pts_, ave_ttanc_df$mrn)
# since we only have diet data pre-transplant
# I have attached a table for our 177 patients with the following data:
#
# weight data (including admission weight, BMI, discharge weight, weight loss)
# nutritional needs (kilocalories/day, grams of protein/day)
# nutritional risk (per the nutritional risk index, determined at time of admission)
weight <- readxl::read_excel('../data/DietPatients_WeightData.xlsx') %>%
mutate(mrn = as.numeric(MRN)) %>%
filter(mrn %in% ptb_all$mrn) %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename_all(~ gsub("\\(|\\)", "", .)) %>%
select(mrn, Admission_wt_kg, `Admission_BMI_kg/m^2`,Discharge_wt_kg, Wt_change_kg,`Wt_change_%`,`Kcal_Needs_30_kcal/kg`,`Protein_Needs_1.5_gm/kg`, Nutritional_Risk_Index_NRI ) %>%
mutate_if(is.character, as.numeric)
colnames(weight)
ave_ttanc_df
allpred <- ave_ttanc_df %>%
right_join(weight, by = "mrn")
allpred %>% write_csv('../data/156_predictors.csv')
allpred <- ave_ttanc_df %>%
right_join(weight, by = "mrn")
allpred %>% write_csv('../data/156_predictors.csv')
f2c <- read_rds('../data/068_div_post_ridge.rds')
ggsave('../data/086_f2c.pdf', width = 3,height = 3, plot = f2c)
cal_mean_all_0_veggie  <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$sweets +
b_fg_veggie_ * 0 +
b_intensityreduced_
}
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_veggie')%>%
mutate(sigma = test$sigma)
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_veggie')
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_veggie')
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID') %>%
gather('key','mean_all_0_veggie')
cal_mean_all_0_veggie  <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$sweets +
b_fg_veggie_ * 0 +
b_intensityreduced_
}
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID')
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID')
View(mean_all_0_veggie)
test_coeffb
ave_fg
cal_mean_all_0_veggie  <- function(b_fg_fruit_,b_fg_meat_,b_fg_milk_,b_fg_oils_,b_fg_egg_,b_fg_grain_,b_fg_sweets_,b_fg_legume_,b_fg_veggie_,b_intensityreduced_ ){
res =
b_fg_egg_ * ave_fg$fg_egg +
b_fg_fruit_ * ave_fg$fg_fruit +
b_fg_grain_ * ave_fg$fg_grain +
b_fg_legume_ * ave_fg$fg_legume +
b_fg_meat_ * ave_fg$fg_meat +
b_fg_milk_ * ave_fg$fg_milk +
b_fg_oils_ * ave_fg$fg_oils +
b_fg_sweets_ * ave_fg$sweets +
b_fg_veggie_ * 0 +
b_intensityreduced_
}
mean_all_0_veggie <- pmap(test_coeffb, function(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced){
cal_mean_all_0_veggie(b_fg_fruit,b_fg_meat,b_fg_milk,b_fg_oils,b_fg_egg,b_fg_grain,b_fg_sweets,b_fg_legume,b_fg_veggie,b_intensityreduced)
})%>% set_names(seq(1, 100)) %>%
bind_rows(.id = 'ID')
View(test_coeffb)
