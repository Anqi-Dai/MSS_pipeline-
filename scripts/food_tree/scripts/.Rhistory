axis.text.x = element_text(angle=45, hjust=2, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=1, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.5, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=-1, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.2, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = -0.2, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = 0, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
# calculate the percentage of interval that is >|< 0 for each genus/food combo
fg_order <- read_csv('../data/068_fg_sorting_order.csv') %>% pull(shortname)
perc_side <- post %>%
group_by(genus,item ) %>%
count(coeff >= 0) %>%
mutate(perc = round(n/4000, 2)) %>%
mutate(side = if_else(`coeff >= 0` == 'TRUE', 'positive', 'negative')) %>%
ungroup() %>%
select(genus, item, perc, side) %>%
spread('side', 'perc') %>%
mutate(item = str_replace(item, 'b_','')) %>%
left_join(key %>% select(item = fg1_name, shortname), by = "item") %>%
mutate(color = if_else(positive >= 0.75, 'maroon', if_else(negative >= 0.75, 'steelblue', 'white'))) %>%
mutate(mark = if_else(negative >= 0.99 | positive >= 0.99, '***', if_else(negative >= 0.975 | positive >= 0.975, '**', if_else(negative >= 0.95 | positive >= 0.95, '*', '')))) %>%
# order the columns by the number of stars in the columns
mutate(genus = factor(genus,
levels =c('Enterococcus','Klebsiella','Escherichia','Enterobacter','Citrobacter','Cronobacter'))) %>%
mutate(shortname = factor(shortname, levels = fg_order))
fg_order <- read_csv('../data/068_fg_sorting_order.csv') %>% pull(shortname)
fg_order <- read_csv('../data/068_fg_sorting_order.csv') %>% pull(shortname)
# calculate the percentage of interval that is >|< 0 for each genus/food combo
fg_order <- read_csv('../data/068_fg_sorting_order.csv') %>% pull(shortname)
perc_side <- post %>%
group_by(genus,item ) %>%
count(coeff >= 0) %>%
mutate(perc = round(n/4000, 2)) %>%
mutate(side = if_else(`coeff >= 0` == 'TRUE', 'positive', 'negative')) %>%
ungroup() %>%
select(genus, item, perc, side) %>%
spread('side', 'perc') %>%
mutate(item = str_replace(item, 'b_','')) %>%
left_join(key %>% select(item = fg1_name, shortname), by = "item") %>%
mutate(color = if_else(positive >= 0.75, 'maroon', if_else(negative >= 0.75, 'steelblue', 'white'))) %>%
mutate(mark = if_else(negative >= 0.99 | positive >= 0.99, '***', if_else(negative >= 0.975 | positive >= 0.975, '**', if_else(negative >= 0.95 | positive >= 0.95, '*', '')))) %>%
# order the columns by the number of stars in the columns
mutate(genus = factor(genus,
levels =c('Enterococcus','Klebsiella','Escherichia','Enterobacter','Citrobacter','Cronobacter'))) %>%
mutate(shortname = factor(shortname, levels = fg_order))
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = 0, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = 0.2, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = 0.5, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = 0.8, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.4,hjust = 0.9, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.8,hjust = 0.9, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=45, vjust=0.9,hjust = 0.9, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
bins <- read_tsv('../data/growth/irep/binning_table_all_simple_peter.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
inner_join(irep, by  = 'sbid') %>%
relocate(iRep, .after = 'Bin') %>%
relocate(best_species, .after = 'iRep') %>%
filter(!is.na(iRep)) %>%
arrange(Sample,Bin,  best_species) %>%
# if there are multiple get the average
#group_by(Sample, best_species, best_level) %>%
#summarise(aveirep = mean(iRep)) %>%
filter(best_species != 'Unclassified') %>%
mutate(sampleid = str_extract(Sample, '^Sample.+IGO'),
sampleid = str_replace(sampleid, 'Sample_',''),
sampleid = str_replace(sampleid, '_IGO','')) %>%
relocate(sampleid, .before = 'Sample')  %>%
mutate(sampleid = str_replace(sampleid, '_2', ''),
sampleid = str_replace(sampleid,'FMT_', 'FMT\\.'))
fns <- list.files('../data/growth/irep/peter_samples_irep/', full.names = T, pattern = '.tsv')
df <- tibble(fns = fns)
irep <- fns %>%
set_names(fns) %>%
purrr::map(~  read_tsv(file = ., n_max = 1 , col_types = 'cc',  skip = 2, col_names = c('bin','iRep')) %>%  select(iRep) ) %>%
bind_rows(.id = 'fn') %>%
mutate(fn = str_replace(fn, '_irep_dastool.tsv$',''),
fn = str_replace(fn, '../data/growth/irep/peter_samples_irep//','')) %>%
separate(fn, into = c('sampleid','samplebin'), sep = '__concat__', remove = T) %>%
mutate(iRep = as.numeric(iRep)) %>%
mutate(sbid = str_glue('{sampleid}__{samplebin}')) %>%
filter(str_detect(sampleid, '^Sample')) # to only include the project 13141 ones
samp <- irep %>%
distinct(sampleid)
fns <- list.files('../data/growth/irep/peter_samples_irep/', full.names = T, pattern = '.tsv')
df <- tibble(fns = fns)
irep <- fns %>%
set_names(fns) %>%
purrr::map(~  read_tsv(file = ., n_max = 1 , col_types = 'cc',  skip = 2, col_names = c('bin','iRep')) %>%  select(iRep) ) %>%
bind_rows(.id = 'fn') %>%
mutate(fn = str_replace(fn, '_irep_dastool.tsv$',''),
fn = str_replace(fn, '../data/growth/irep/peter_samples_irep//','')) %>%
separate(fn, into = c('sampleid','samplebin'), sep = '__concat__', remove = T) %>%
mutate(iRep = as.numeric(iRep)) %>%
mutate(sbid = str_glue('{sampleid}__{samplebin}')) %>%
filter(str_detect(sampleid, '^Sample')) # to only include the project 13141 ones
samp <- irep %>%
distinct(sampleid)
bins <- read_tsv('../data/growth/irep/binning_table_all_simple_peter.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
inner_join(irep, by  = 'sbid') %>%
relocate(iRep, .after = 'Bin') %>%
relocate(best_species, .after = 'iRep') %>%
filter(!is.na(iRep)) %>%
arrange(Sample,Bin,  best_species) %>%
# if there are multiple get the average
#group_by(Sample, best_species, best_level) %>%
#summarise(aveirep = mean(iRep)) %>%
filter(best_species != 'Unclassified') %>%
mutate(sampleid = str_extract(Sample, '^Sample.+IGO'),
sampleid = str_replace(sampleid, 'Sample_',''),
sampleid = str_replace(sampleid, '_IGO','')) %>%
relocate(sampleid, .before = 'Sample')  %>%
mutate(sampleid = str_replace(sampleid, '_2', ''),
sampleid = str_replace(sampleid,'FMT_', 'FMT\\.'))
# find the genus and family of the irep bins
colnames(bins)
# do these samples overlap with the current diet cohort?
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
stool <- read_csv('../data/011_802_total_stool_samples.csv')
length(intersect(stool$sampleid, bins$sampleid))
length(intersect(meta$sampleid, bins$sampleid)) # 28
has_diet <- intersect(meta$sampleid, bins$sampleid)
# find the previous 2 days sum of fruits and sweets
p2d_sum69 <- meta %>%
filter(sampleid %in% has_diet) %>%
select(sampleid, fg_fruit, fg_sweets) %>%
mutate(sum69 = (fg_fruit + fg_sweets) *2)
library(vdbR)
connect_database()
list_table_from_database('blast')
get_table_from_database('asv_annotation_blast_ag')
target <- asv_annotation_blast_ag %>%
filter(family %in% c('Enterobacteriaceae','Enterococcaceae')) %>%
distinct(family, genus) %>%
summarise(genera = str_c(genus, collapse = "|"))
find_higher <- bins %>%
distinct(best_species,  best_level) %>%
arrange(best_species) %>%
filter(str_detect(best_species, target$genera)) %>%
mutate(genus = c('Enterobacter','Enterococcus','Enterococcus','Enterococcus','Escherichia','Klebsiella','Klebsiella'))
family2 <- bins %>%
select(sampleid,samplebin,  iRep, best_species,  best_level) %>%
inner_join(find_higher) %>%
inner_join(p2d_sum69 %>%
select(sampleid, sum_sugar = sum69)) %>%
select(sampleid, samplebin, iRep, genus, sum_sugar)
family2_irep <- bins %>%
select(sampleid,samplebin,  iRep, best_species,  best_level) %>%
inner_join(find_higher)
older <-  read_csv('../data/sum of sugar intake vs max zscore family(E,E).csv') %>%
select(colnames(family2_irep))
all_fam2_irep <- bind_rows(family2_irep,older )%>%
split(.$genus) %>%
map(function(df){
df %>%
mutate(iRep_zscore = scale(.$iRep, center = T, scale = T)[,1])
}
) %>%
bind_rows()  %>%
inner_join(all %>% select(sampleid, sum_sugar)
)
