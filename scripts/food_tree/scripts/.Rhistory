prior = priors,
cores = ncores,
chains = 2,
seed = 123, sample_prior = T)
# extract posterior samples for the coeff
post_samples  <- read_csv('../data/068_div_model_fg_post.csv')
# save it out for the forest plot of the coeff
post_fg_coeff <- post_samples %>%
select(starts_with('b_fg')) %>%
gather('item', 'value')
post_fg_coeff_mean <- post_fg_coeff  %>%
group_by(item) %>%
summarise(meanperitem = mean(value))
# make the forest plot of the post coeff
# like the one on the ash abstract
post_coeff <- post_samples %>%
select(starts_with('b_fg')) %>%
gather('item', 'coeff') %>%
mutate(item = str_replace(item, 'b_fg_','')) %>%
mutate(fgrp1 = case_when(
item ==  'milk' ~ '1',
item == 'meat' ~ '2',
item ==  'egg' ~ '3',
item ==  'legume' ~ '4',
item == 'grain' ~ '5',
item == 'fruit' ~ '6',
item == 'veggie' ~ '7',
item ==  'oils' ~ '8',
item ==  'sweets' ~ '9'
))  %>%
left_join(key %>% select(fgrp1, color, shortname))  %>%
mutate(shortname = fct_reorder(shortname, coeff, .fun=median, .desc = F))
fg_labels <- levels(post_coeff$shortname)
cross0 <- post_coeff %>%
group_by(item) %>%
summarise(q2.5 = quantile(coeff, probs = 0.025),
q97.5 = quantile(coeff, probs = 0.975)) %>%
mutate(Cross = if_else(q2.5 > 0 | q97.5 < 0, F, T))
# to find the quantiles of the post_coeff
post_coeff %>%
group_by(item) %>%
tidybayes::median_qi(coeff, .width = c( .66, .95))
post_coeff %>%
group_by(item) %>%
summarise(q50 = median(coeff))
post_coeff %>%
group_by(item) %>%
summarise(ave = mean(coeff))
post_coeff %>%
filter(item == 'fruit') %>%
count(coeff < 0) %>%
mutate(perc = n/sum(n)*100)
fg_colors <- post_coeff %>%
distinct(shortname, color) %>%
select(shortname, color) %>%
deframe()
title1 <- bquote(Outcome: log[e]~(Simpsons~reciprocal))
div_post <- post_coeff %>%
left_join(cross0) %>%
ggplot(aes(x = coeff, y = shortname, col = Cross)) +
stat_pointinterval(.width = c(.66, .95)) +
geom_vline(xintercept = 0, col = 'black', linetype = 'dashed') +
labs(x = 'ln(diversity) change per 100g of food',
y = '',
title = 'Diversity') +
theme_classic() +
theme(legend.position = 'none') +
scale_color_manual(values = c("#EC0000", "gray40")) +
theme(axis.text=element_text(size=8, color  = 'black'),
axis.title=element_text(size=8),
aspect.ratio=1)
div_post %>%
write_rds('../data/068_div_post.rds')
div_post
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=90, hjust=1, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
genus_fg_extra
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=90, hjust=1, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
f2c <- read_rds('../data/068_div_post.rds')
#f2d <- read_rds('../data/068_only3_sim.rds')
f2d <- read_rds('../data/101_f2d_diversity_pred_two_diff.rds')
f2e <- read_rds('../data/087_entero_genus_fg_main.rds')
f2e <- read_rds('../data/120_F2E_extra_genera.rds')
left <- cowplot::align_plots(f2a, f2c, align = 'v', axis = 'l')
top <- plot_grid(left[[1]], diagram, labels = c('A', 'B'),rel_widths  = c(1, 2) )
bottom <- plot_grid(  left[[2]],f2d,f2e,
nrow = 1, labels = c('C','D', 'E'), rel_widths  = c(1, 1, 1), align = 'hv')
f2 <-  plot_grid(top,bottom,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F2_model_results_086.pdf',
width = 190,
height = 120,
#height = 60,
units = c("mm"),
dpi = 400, plot = f2)
genus_fg_extra
left <- cowplot::align_plots(f2a, f2c, align = 'v', axis = 'l')
top <- plot_grid(left[[1]], diagram, labels = c('A', 'B'),rel_widths  = c(1, 2) )
bottom <- plot_grid(  left[[2]],f2d,f2e,
nrow = 1, labels = c('C','D', 'E'), rel_widths  = c(1, 1, 1.5), align = 'hv')
f2 <-  plot_grid(top,bottom,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F2_model_results_086.pdf',
width = 190,
height = 120,
#height = 60,
units = c("mm"),
dpi = 400, plot = f2)
left <- cowplot::align_plots(f2a, f2c, align = 'v', axis = 'l')
top <- plot_grid(left[[1]], diagram, labels = c('A', 'B'),rel_widths  = c(1, 2) )
bottom <- plot_grid(  left[[2]],f2d,f2e,
nrow = 1, labels = c('C','D', 'E'), rel_widths  = c(1, 1, 1.3), align = 'hv')
f2 <-  plot_grid(top,bottom,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F2_model_results_086.pdf',
width = 190,
height = 120,
#height = 60,
units = c("mm"),
dpi = 400, plot = f2)
left <- cowplot::align_plots(f2a, f2c, align = 'v', axis = 'l')
top <- plot_grid(left[[1]], diagram, labels = c('A', 'B'),rel_widths  = c(1, 2) )
bottom <- plot_grid(  left[[2]],f2d,f2e,
nrow = 1, labels = c('C','D', 'E'), rel_widths  = c(1, 1, 1.1), align = 'hv')
f2 <-  plot_grid(top,bottom,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F2_model_results_086.pdf',
width = 190,
height = 120,
#height = 60,
units = c("mm"),
dpi = 400, plot = f2)
ggsave(genus_fg_extra,
'../data/120_F2E_extra_genera.pdf', width =  70,
height = 70,
units = c("mm"),
dpi = 400)
col_key <- perc_side %>%
ungroup() %>%
distinct(color) %>%
pull(color)
names(col_key) <- col_key
genus_fg_extra <- ggplot(perc_side, aes(x = genus, y = shortname)) +
geom_tile(aes(fill = color,  x = genus, y =  shortname), alpha = 0.5, color='gray0', width=1, height=1) +
geom_text(aes(label = mark, x = genus,y =  shortname),
nudge_y = -0.05, nudge_x = 0,size = 3) +
scale_fill_manual(values = col_key, labels = c('Less than 75% CI crosses 0', '75% CI < 0 negative','75% CI > 0 positive')) +
theme_void() +
theme(axis.title.x = element_blank(),
axis.title.y = element_blank(),
axis.text.x = element_text(angle=90, hjust=1, size=axis_text_size),
axis.text.y=element_text(size=axis_text_size, hjust=0.95,vjust=0.2),
axis.title=element_text(size=axis_title_size),
legend.position = 'none',legend.text=element_text(size=8),
legend.key = element_rect( colour = "gray50"))
genus_fg_extra %>% write_rds('../data/120_F2E_extra_genera.rds')
ggsave('../data/120_F2E_extra_genera.pdf', width =  70,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
ggsave('../data/120_F2E_extra_genera.pdf', width =  60,plot = genus_fg_extra,
height = 70,
units = c("mm"),
dpi = 400)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('asv_alpha_diversity_ag')
library(readxl)
q <- read_excel('../data/Tsoni_59samples_pool1154_16SqPCR_Results_07112022.xlsx')
View(q)
pheno <- read_excel('../data/Exp9_Flourfenicol, Biapenem + Diets .xlsx')
View(pheno)
View(q)
View(pheno)
asv_alpha_diversity_ag
sampleids <- asv_alpha_diversity_ag %>%
filter(str_detect(oligos_id, 'pool1154'))
View(sampleids)
cts <- get_counts_subset(sampleids$sampleid)
View(cts)
get_table_from_database('asv_annotation_blast_ag')
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus')
View(cts_entero)
q
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)
View(pheno)
pheno
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = `Tube ID`,Treatment:Mouse_identifier ))
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(x %>%
select(sampleid = `Tube ID`,Treatment:Mouse_identifier ))
pheno
pheno %>%
select(sampleid = `Tube ID`, Treatment:Mouse_identifier )
pheno
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = TubeID, Treatment:Mouse_identifier ))
View(sampleids)
sampleids
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = TubeID, Treatment:Mouse_identifier )) %>%
full_join(sampleids %>%
select(sampleid:shannon))
View(cts_entero)
library(ggpubr)
cts_entero
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', facet.by = 'Treatment')
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment)
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_classic()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_default()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_light()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_minimal()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_cowplot()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_pubclean()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_update()
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_update()
?scale_x_discrete
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_update() +
scale_x_discrete('Day', labels = c(0,3,7))
cts_entero
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_update() +
scale_x_discrete('Day', labels = c('0',3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'relab') +
facet_grid(~ Treatment) +
theme_update() +
scale_x_continuous('Day', breaks = c(0,3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', label = 'Mouse_identifier') +
facet_grid(~ Treatment) +
theme_update() +
scale_x_continuous('Day', breaks = c(0,3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', label = 'Mouse_identifier', repel = T) +
facet_grid(~ Treatment) +
theme_update() +
scale_x_continuous('Day', breaks = c(0,3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', label = 'Mouse_identifier', repel = T) +
facet_grid(~ Treatment) +
theme_update() +
scale_x_continuous('Day', breaks = c(0,3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', label = 'Mouse_identifier', repel = T) +
facet_grid(~ Treatment) +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
ggsave('../data/121_mouse_exp.pdf', width = 10)
ggsave('../data/121_mouse_exp.pdf', width = 11)
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', label = 'Mouse_identifier', repel = T,
ylab = 'Enterococcus relative abundance') +
facet_grid(~ Treatment) +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'relab', label = 'Mouse_identifier', repel = T,
ylab = 'Enterococcus relative abundance') +
facet_grid(~ Treatment) +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = TubeID, Treatment:Mouse_identifier )) %>%
full_join(sampleids %>%
select(sampleid:shannon)) %>%
select(-shannon) %>%
relocate(relab, .after = simpson_reciprocal)
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = TubeID, Treatment:Mouse_identifier )) %>%
full_join(sampleids %>%
select(sampleid:shannon)) %>%
select(-shannon) %>%
relocate(relab, .after = simpson_reciprocal) %>%
relocate(entero_copy, .after = relab)
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = TubeID, Treatment:Mouse_identifier )) %>%
full_join(sampleids %>%
select(sampleid:shannon)) %>%
select(-shannon) %>%
relocate(relab, .after = simpson_reciprocal) %>%
relocate(entero_copy, .after = relab)  %>%
gather('key', 'value', simpson_reciprocal:entero_copy)
cts_entero <- cts %>%
left_join(asv_annotation_blast_ag %>%
select(asv_key, genus)) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(count_relative)) %>%
filter(genus == 'Enterococcus') %>%
full_join(q %>%
select(sampleid  = `Tube ID`, copies_16s_per_g = `16S COPIES/G`)) %>%
mutate(entero_copy = copies_16s_per_g*relab)  %>%
inner_join(pheno %>%
select(sampleid = TubeID, Treatment:Mouse_identifier )) %>%
full_join(sampleids %>%
select(sampleid:shannon)) %>%
select(-shannon) %>%
relocate(relab, .after = simpson_reciprocal) %>%
relocate(entero_copy, .after = relab)  %>%
gather('key', 'value', simpson_reciprocal:entero_copy) %>%
mutate(key = factor(key, levels = c('entero_copy','relab','simpson_reciprocal')))
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,
ylab = 'Enterococcus relative abundance') +
facet_grid(key~ Treatment) +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment) +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment, scales = 'free_y') +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment, scales = 'free_y') +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,color = 'Day',
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment, scales = 'free_y') +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,color = 'Day',
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment, scales = 'free_y') +
theme_linedraw() +
scale_x_continuous('Day', breaks = c(0,3,7))  +
theme(legend.position = 'none')
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,color = 'Day',
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment, scales = 'free_y') +
theme_transparent() +
scale_x_continuous('Day', breaks = c(0,3,7))  +
theme(legend.position = 'none')
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
ggscatter(x = 'Day', y = 'value', label = 'Mouse_identifier', repel = T,color = 'Day',
ylab = 'Enterococcus and alpha diversity') +
facet_grid(key~ Treatment, scales = 'free_y') +
theme_update() +
scale_x_continuous('Day', breaks = c(0,3,7))  +
theme(legend.position = 'none')
ggsave('../data/121_mouse_exp.pdf', width = 15)
cts_entero %>%
write_csv('../data/121_mouse_exp.csv')
