mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(beyond_engraftment, .after = 'ttancday')
transplant_stays %>%
write_csv('../data/156_transplant_data.csv')
ave_ttanc_df %>% write_csv('../data/156_predictors.csv')
colnames(transplant_stays)
View(pts_tb)
# the below table has the more updated data
pts <- read_csv('../data/pts_updated_through_june_2022.csv') %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename(mrn = MRN) %>%
mutate(hct = lubridate::dmy(HCT))
View(pts)
pts_tb <- pts %>%
right_join(ptb, by = c("mrn", "hct")) %>%
select(mrn, hct, batch, TIME_ANEUT_500,ANEUT_500_DATE, Relapse:COD)
ptb_all <- pts_tb %>%
full_join(ptb_gvhd, by = c("mrn", "hct", "batch")) %>%
mutate(ANEUT_500_DATE = dmy(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct
)) %>%
relocate(ttancday, .after = 'TIME_ANEUT_500') %>%
# correct one patient engraftment date
mutate(ANEUT_500_DATE = if_else(ANEUT_500_DATE == '2021-11-16', '2021-10-23', as.character(ANEUT_500_DATE)),
ANEUT_500_DATE = ymd(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct)) %>%
select(-TIME_ANEUT_500)
ptb_all %>% write_csv('../data/156_combined_clinical_data.csv')
View(ptb_all)
# "/Volumes/vandenbrinklab/Angel_Dai/Nutrition_project/visits_nutrition_cohort"
# key fields include
# admit_date
# discharge_date
# if you just select the visit where the HCT date is in between the admit_date and the discharge_date  you will identify the main transplant hospitalization, and from that can calculate length of stay and, importantly, duration of hospitalization beyond engraftment, which I think is the clinical variable most likely to correlate with nutrition
visits <- read_csv('/Volumes/vandenbrinklab/Angel_Dai/Nutrition_project/visits_nutrition_cohort/nutrition_cohort_visits_2023-02-16.csv')  %>%
mutate(mrn = as.numeric(MRN)) %>%
select(mrn, admit_date, discharge_date) %>%
mutate(visit_int = interval(admit_date, discharge_date)) %>%
inner_join(ptb_all %>% select(mrn, hct)) %>%
mutate(hct_int =  interval(hct, hct)) %>%
mutate(transplant_hospitalization = int_overlaps(visit_int, hct_int)) %>%
distinct()
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(beyond_engraftment, .after = 'ttancday')
transplant_stays %>%
write_csv('../data/156_transplant_data.csv')
ave_ttanc_df %>% write_csv('../data/156_predictors.csv')
colnames(transplant_stays)
View(transplant_stays)
pts_ <- ptb_all %>%
filter(!is.na(ttancday)) %>%
pull(mrn)
View(pts)
colnames(pts)
pts_tb <- pts %>%
right_join(ptb, by = c("mrn", "hct"))
# the gvhd data
library(vdbR)
connect_database()
get_table_from_database('patient_allo_ks_20221104')
colnames(patient_allo_ks_20221104)
ptb_gvhd <- patient_allo_ks_20221104 %>%
right_join(ptb, by = c("mrn", "hct")) %>%
select(mrn, hct, batch, starts_with('d100'))
ptb_all <- pts_tb %>%
full_join(ptb_gvhd, by = c("mrn", "hct", "batch")) %>%
mutate(ANEUT_500_DATE = dmy(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct
)) %>%
relocate(ttancday, .after = 'TIME_ANEUT_500') %>%
# correct one patient engraftment date
mutate(ANEUT_500_DATE = if_else(ANEUT_500_DATE == '2021-11-16', '2021-10-23', as.character(ANEUT_500_DATE)),
ANEUT_500_DATE = ymd(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct)) %>%
select(-TIME_ANEUT_500)
ptb_all %>% write_csv('../data/156_combined_clinical_data.csv')
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date))
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(beyond_engraftment, .after = 'ttancday')
transplant_stays %>%
write_csv('../data/156_transplant_data.csv')
colnames(transplant_stays)
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday')
colnames(transplant_stays)
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT)
transplant_stays %>%
write_csv('../data/156_transplant_data.csv')
# I have attached a table for our 177 patients with the following data:
#
# weight data (including admission weight, BMI, discharge weight, weight loss)
# nutritional needs (kilocalories/day, grams of protein/day)
# nutritional risk (per the nutritional risk index, determined at time of admission)
weight <- readxl::read_excel('../data/DietPatients_WeightData.xlsx') %>%
mutate(mrn = as.numeric(MRN)) %>%
filter(mrn %in% ptb_all$mrn) %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename_all(~ gsub("\\(|\\)", "", .)) %>%
select(mrn, Admission_wt_kg, `Admission_BMI_kg/m^2`,Discharge_wt_kg, Wt_change_kg,`Wt_change_%`,`Kcal_Needs_30_kcal/kg`,`Protein_Needs_1.5_gm/kg`, Nutritional_Risk_Index_NRI ) %>%
mutate_if(is.character, as.numeric)
library(tidyverse)
library(lubridate)
# I have attached a table for our 177 patients with the following data:
#
# weight data (including admission weight, BMI, discharge weight, weight loss)
# nutritional needs (kilocalories/day, grams of protein/day)
# nutritional risk (per the nutritional risk index, determined at time of admission)
weight <- readxl::read_excel('../data/DietPatients_WeightData.xlsx') %>%
mutate(mrn = as.numeric(MRN)) %>%
filter(mrn %in% ptb_all$mrn) %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename_all(~ gsub("\\(|\\)", "", .)) %>%
select(mrn, Admission_wt_kg, `Admission_BMI_kg/m^2`,Discharge_wt_kg, Wt_change_kg,`Wt_change_%`,`Kcal_Needs_30_kcal/kg`,`Protein_Needs_1.5_gm/kg`, Nutritional_Risk_Index_NRI ) %>%
mutate_if(is.character, as.numeric)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(lubridate)
# the below table has the more updated data
pts <- read_csv('../data/pts_updated_through_june_2022.csv') %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename(mrn = MRN) %>%
mutate(hct = lubridate::dmy(HCT))
colnames(pts)
# Relapse, Relapse Date
# POD, POD Date
# Status , Last Contact
# gvhd data from the patients table
ptb1 <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
ptb2 <- read_csv('../data/129_new_76_full_patient_info.csv')
ptb <- bind_rows(
ptb1 %>% select(mrn, hct) %>% mutate(batch = 'batch1'),
ptb2 %>% select(mrn, hct) %>% mutate(batch = 'batch2')
)
pts_tb <- pts %>%
right_join(ptb, by = c("mrn", "hct"))
# the gvhd data
library(vdbR)
connect_database()
# I have attached a table for our 177 patients with the following data:
#
# weight data (including admission weight, BMI, discharge weight, weight loss)
# nutritional needs (kilocalories/day, grams of protein/day)
# nutritional risk (per the nutritional risk index, determined at time of admission)
weight <- readxl::read_excel('../data/DietPatients_WeightData.xlsx') %>%
mutate(mrn = as.numeric(MRN)) %>%
filter(mrn %in% ptb_all$mrn) %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename_all(~ gsub("\\(|\\)", "", .)) %>%
select(mrn, Admission_wt_kg, `Admission_BMI_kg/m^2`,Discharge_wt_kg, Wt_change_kg,`Wt_change_%`,`Kcal_Needs_30_kcal/kg`,`Protein_Needs_1.5_gm/kg`, Nutritional_Risk_Index_NRI ) %>%
mutate_if(is.character, as.numeric)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(lubridate)
# the below table has the more updated data
pts <- read_csv('../data/pts_updated_through_june_2022.csv') %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename(mrn = MRN) %>%
mutate(hct = lubridate::dmy(HCT))
colnames(pts)
# Relapse, Relapse Date
# POD, POD Date
# Status , Last Contact
# gvhd data from the patients table
ptb1 <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
ptb2 <- read_csv('../data/129_new_76_full_patient_info.csv')
ptb <- bind_rows(
ptb1 %>% select(mrn, hct) %>% mutate(batch = 'batch1'),
ptb2 %>% select(mrn, hct) %>% mutate(batch = 'batch2')
)
pts_tb <- pts %>%
right_join(ptb, by = c("mrn", "hct"))
# the gvhd data
library(vdbR)
connect_database()
get_table_from_database('patient_allo_ks_20221104')
colnames(patient_allo_ks_20221104)
ptb_gvhd <- patient_allo_ks_20221104 %>%
right_join(ptb, by = c("mrn", "hct")) %>%
select(mrn, hct, batch, starts_with('d100'))
ptb_all <- pts_tb %>%
full_join(ptb_gvhd, by = c("mrn", "hct", "batch")) %>%
mutate(ANEUT_500_DATE = dmy(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct
)) %>%
relocate(ttancday, .after = 'TIME_ANEUT_500') %>%
# correct one patient engraftment date
mutate(ANEUT_500_DATE = if_else(ANEUT_500_DATE == '2021-11-16', '2021-10-23', as.character(ANEUT_500_DATE)),
ANEUT_500_DATE = ymd(ANEUT_500_DATE)) %>%
mutate(ttancday = as.numeric(ANEUT_500_DATE - hct)) %>%
select(-TIME_ANEUT_500)
ptb_all %>% write_csv('../data/156_combined_clinical_data.csv')
## Outcomes of interest
#OS
#length of stay/duration of hospitalization, perhaps duration of hospitalization after engraftment
#TRM (transplant related mortality). TRM is defined as death not preceded by relapse(or progression of disesase)
#Grade 2-4 GVHD diagnosis (for analysis of GVHD outcomes, exclude Graft type "T-cell depleted PBSC")
#GRM (GVHD-related mortality) (for analysis of GVHD outcomes, exclude Graft type "T-cell depleted PBSC")
## Predictors
# total calorie intake averaged between day 0 and day of engraftment (TTANC)
# total [each macronutrient] intake averaged between day 0 and day of engraftment (TTANC)
# total [food group of interest, pick 1 or 2 or just systematically all of them] intake averaged between day 0 and day of engraftment (TTANC)
#
# in multivariable Cox (or Fine-Gray cuminc cmprsk)  models that have terms for
# outcome ~ predictor + conditioning_intensity + graft_type
# Tsoni thinks the role of medications in this analysis can be that if we find a relationship between one of the outcomes and one of the predictors, we can further check if the relationship holds after adding a term to account for patients on high doses of opioids (patient controlled analgesia, PCA device) as a surrogate of severe toxicity
## Predictors
# total calorie intake averaged between day 0 and day of engraftment (TTANC)
# total [each macronutrient] intake averaged between day 0 and day of engraftment (TTANC)
# total [food group of interest, pick 1 or 2 or just systematically all of them] intake averaged between day 0 and day of engraftment (TTANC)
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
# make a table withe daily total caloric intake
DTB <- read_csv('../data/152_combined_DTB.csv') %>%
mutate(fgrp1 = str_sub(as.character(Food_code), 1, 1))
# a table of the daily each macro
daily <- DTB %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal),
d_protein = sum(Protein_g),
d_fat = sum(Fat_g),
d_carb = sum(Carbohydrates_g),
d_fiber = sum(Fibers_g),
d_sugar = sum(Sugars_g))
dailyfg <- DTB %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailyfg = sum(dehydrated_weight)) %>%
left_join(key %>% select(fgrp1, shortname)) %>%
mutate(shortname = str_glue('daily_{shortname}')) %>%
select(mrn, fdrt, shortname, dailyfg) %>%
spread('shortname', 'dailyfg', fill = 0)
dailyall <- daily %>%
full_join(dailyfg)
# calculate the above listed values
# ignore the patients that had died before engraphtment
pts_ <- ptb_all %>%
filter(!is.na(ttancday)) %>%
pull(mrn)
ave_ttanc <- pts_ %>%
set_names(pts_) %>%
map(function(mrn_){
ttanc_day <- ptb_all %>%
filter(mrn == mrn_) %>%
pull(ttancday)
total_days <- ttanc_day + 1
ave_values <- dailyall %>%
filter(mrn == mrn_ & fdrt %in% 0:ttanc_day) %>%
gather('group', 'gram', daycal:daily_Vegetables) %>%
group_by(mrn, group) %>%
summarise(ave_grp = sum(gram)/total_days)
}) %>% bind_rows()
ave_ttanc_df <- ave_ttanc %>%
spread('group','ave_grp')
# I have attached a table for our 177 patients with the following data:
#
# weight data (including admission weight, BMI, discharge weight, weight loss)
# nutritional needs (kilocalories/day, grams of protein/day)
# nutritional risk (per the nutritional risk index, determined at time of admission)
weight <- readxl::read_excel('../data/DietPatients_WeightData.xlsx') %>%
mutate(mrn = as.numeric(MRN)) %>%
filter(mrn %in% ptb_all$mrn) %>%
rename_all(~ gsub(" ", "_", .)) %>%
rename_all(~ gsub("\\(|\\)", "", .)) %>%
select(mrn, Admission_wt_kg, `Admission_BMI_kg/m^2`,Discharge_wt_kg, Wt_change_kg,`Wt_change_%`,`Kcal_Needs_30_kcal/kg`,`Protein_Needs_1.5_gm/kg`, Nutritional_Risk_Index_NRI ) %>%
mutate_if(is.character, as.numeric)
colnames(weight)
View(weight)
# "/Volumes/vandenbrinklab/Angel_Dai/Nutrition_project/visits_nutrition_cohort"
# key fields include
# admit_date
# discharge_date
# if you just select the visit where the HCT date is in between the admit_date and the discharge_date  you will identify the main transplant hospitalization, and from that can calculate length of stay and, importantly, duration of hospitalization beyond engraftment, which I think is the clinical variable most likely to correlate with nutrition
visits <- read_csv('/Volumes/vandenbrinklab/Angel_Dai/Nutrition_project/visits_nutrition_cohort/nutrition_cohort_visits_2023-02-16.csv')  %>%
mutate(mrn = as.numeric(MRN)) %>%
select(mrn, admit_date, discharge_date) %>%
mutate(visit_int = interval(admit_date, discharge_date)) %>%
inner_join(ptb_all %>% select(mrn, hct)) %>%
mutate(hct_int =  interval(hct, hct)) %>%
mutate(transplant_hospitalization = int_overlaps(visit_int, hct_int)) %>%
distinct()
# "/Volumes/vandenbrinklab/Angel_Dai/Nutrition_project/visits_nutrition_cohort"
# key fields include
# admit_date
# discharge_date
# if you just select the visit where the HCT date is in between the admit_date and the discharge_date  you will identify the main transplant hospitalization, and from that can calculate length of stay and, importantly, duration of hospitalization beyond engraftment, which I think is the clinical variable most likely to correlate with nutrition
visits <- read_csv('/Volumes/vandenbrinklab/Angel_Dai/Nutrition_project/visits_nutrition_cohort/nutrition_cohort_visits_2023-02-16.csv')  %>%
mutate(mrn = as.numeric(MRN)) %>%
select(mrn, admit_date, discharge_date) %>%
mutate(visit_int = interval(admit_date, discharge_date)) %>%
inner_join(ptb_all %>% select(mrn, hct)) %>%
mutate(hct_int =  interval(hct, hct)) %>%
mutate(transplant_hospitalization = int_overlaps(visit_int, hct_int)) %>%
distinct()
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT)
transplant_stays %>%
write_csv('../data/156_transplant_data.csv')
ave_ttanc_df %>% write_csv('../data/156_predictors.csv')
colnames(transplant_stays)
View(ave_ttanc_df)
# why are there 2 patients that don't have any nutrition predictors
pt2 <- setdiff(pts_, ave_ttanc_df$mrn)
pt2
View(DTB)
View(transplant_stays)
View(ave_ttanc)
View(dailyall)
View(weight)
# combine to get the most comprehensive predcitor data I have
allpred <- ave_ttanc_df %>%
right_join(weight)
# combine to get the most comprehensive predcitor data I have
allpred <- ave_ttanc_df %>%
right_join(weight, by = "mrn")
View(allpred)
allpred %>% write_csv('../data/156_predictors.csv')
View(ptb_all)
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT) %>%
mutate(discharge_date_for_nutrition = if_else(discharge_date == '2017-02-04', '2017-02-06', as.character(discharge_date)))
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT) %>%
mutate(discharge_date_for_nutrition = if_else(discharge_date == '2017-02-04', '2017-02-06', as.character(discharge_date))) %>%
relocate(discharge_date_for_nutrition, .after = 'hct')
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT) %>%
mutate(discharge_date_for_nutrition = if_else(discharge_date == '2017-02-04', '2017-02-06', as.character(discharge_date))) %>%
relocate(discharge_date_for_nutrition, .after = 'hct') %>%
mutate(discharge_date_for_nutrition = ymd(discharge_date_for_nutrition))
colnames(transplant_stays)
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT) %>%
mutate(discharge_date_for_nutrition = if_else(discharge_date == '2017-02-04', '2017-02-06', as.character(discharge_date))) %>%
relocate(discharge_date_for_nutrition, .after = 'hct') %>%
relocate(ANEUT_500_DATE, .after = 'discharge_date_for_nutrition') %>%
mutate(discharge_date_for_nutrition = ymd(discharge_date_for_nutrition))
colnames(transplant_stays)
colnames(transplant_stays)
colnames(transplant_stays)
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT) %>%
mutate(discharge_date_for_nutrition = if_else(discharge_date == '2017-02-04', '2017-02-06', as.character(discharge_date))) %>%
relocate(discharge_date_for_nutrition, .after = 'hct') %>%
relocate(ANEUT_500_DATE, .after = 'discharge_date_for_nutrition') %>%
mutate(discharge_date_for_nutrition = ymd(discharge_date_for_nutrition),
leng_of_stay = as.numeric(discharge_date_for_nutrition - admit_date)) %>%
relocate(leng_of_stay, .after = 'ANEUT_500_DATE') %>%
mutate(beyond_engraftment = as.numeric(discharge_date_for_nutrition -ANEUT_500_DATE ))
transplant_stays <- visits %>%
filter(transplant_hospitalization == 'TRUE') %>%
# there is one entry needs to be removed seems wrong
arrange(mrn, admit_date) %>%
distinct(mrn, .keep_all = T) %>%
select(-ends_with('int')) %>%
mutate(leng_of_stay = as.numeric(discharge_date - admit_date)) %>%
full_join(ptb_all , by = c("mrn", "hct")) %>%
# calculate duration of hospitalization beyond engraftment
mutate(discharge_day = as.numeric(discharge_date - hct)) %>%
relocate(discharge_day, .after = 'batch') %>%
mutate(beyond_engraftment = discharge_day - ttancday) %>%
relocate(ttancday, .after = 'HCT') %>%
relocate(beyond_engraftment, .after = 'ttancday') %>%
select(-HCT) %>%
mutate(discharge_date_for_nutrition = if_else(discharge_date == '2017-02-04', '2017-02-06', as.character(discharge_date))) %>%
relocate(discharge_date_for_nutrition, .after = 'hct') %>%
relocate(ANEUT_500_DATE, .after = 'discharge_date_for_nutrition') %>%
mutate(discharge_date_for_nutrition = ymd(discharge_date_for_nutrition),
leng_of_stay = as.numeric(discharge_date_for_nutrition - admit_date)) %>%
relocate(leng_of_stay, .after = 'ANEUT_500_DATE') %>%
mutate(beyond_engraftment = as.numeric(discharge_date_for_nutrition -ANEUT_500_DATE )) %>%
relocate(beyond_engraftment, .after = 'leng_of_stay')
transplant_stays %>%
write_csv('../data/156_transplant_data.csv')
View(ptb2)
View(allpred)
