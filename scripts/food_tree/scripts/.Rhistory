dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
older802 <- read_csv('../data/011_802_total_stool_samples.csv')
scatter_alpha <- 0.35
cor_text_size <- 3
axis_text_size <- 11
axis_title_size <- 11
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
combined <- read_csv('../data/114_combined_irep_650.csv')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
inner_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- ent %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(ent)
# the 2 samples left out is because there was no sweets or fruits intake in the previous 2 days
# need to add them back manually since I don't have a way to do that programmatically
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid) %>%
mutate(bigger69 = 0) %>%
select(colnames(max69_p2d_df))
max69_p2d_df_all <- bind_rows(max69_p2d_df, add2)
# the newer version of fig3 A
res_ent_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df_all ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
f3a <- max69_p2d_df_all %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
ggsave('../figs/paper/115_f3a.pdf',
width = 80,
height = 80,
#height = 60,
units = c("mm"),
dpi = 400, plot = f3a)
kle <- combined %>%
filter(str_detect(best_species, 'Klebsiella')) %>%
group_by(sampleid) %>%
summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Klebsiella only') %>%
inner_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- kle %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max69_p2d_df_kle <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(kle %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(kle)
# the newer version of fig3 B
res_kle_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df_kle ))
kle_max69_p <- round(res_kle_max69$coefficients[2, 'Pr(>|t|)'], 2)
f3b <-max69_p2d_df_kle %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Klebsiella',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {kle_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
ggsave('../figs/paper/115_f3b.pdf',
width = 80,
height = 80,
#height = 60,
units = c("mm"),
dpi = 400, plot = f3b)
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
#group_by(sampleid) %>%
#summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
left_join(older802 %>% select(sampleid, mrn, sdrt))
View(ent)
# calculate the daily sum of each food group
daily <- dtb %>%
mutate(Food_code = as.character(Food_code),
fgrp1 = str_sub(Food_code, 1,1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(dailysum = sum(dehydrated_weight)) %>%
filter(fgrp1 %in% c("6", "9")) %>%
spread('fgrp1', 'dailysum', fill = 0) %>%
mutate(total69 = `6` + `9`)
combined <- read_csv('../data/114_combined_irep_650.csv')
ent <- combined %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
#group_by(sampleid) %>%
#summarise(ave_irep = mean(aveirep)) %>%
mutate(grp = 'Enterococcus only') %>%
left_join(older802 %>% select(sampleid, mrn, sdrt))
stb_pair <- ent %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
inner_join(ent)
# the 2 samples left out is because there was no sweets or fruits intake in the previous 2 days
# need to add them back manually since I don't have a way to do that programmatically
add2 <- ent %>%
filter(!sampleid %in% max69_p2d_df$sampleid) %>%
mutate(bigger69 = 0) %>%
select(colnames(max69_p2d_df))
max69_p2d_df_all <- bind_rows(max69_p2d_df, add2)
# the newer version of fig3 A
res_ent_max69 <- summary(lm(ave_irep ~ bigger69, data = max69_p2d_df_all ))
f3a
View(max69_p2d_df)
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
})
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
left_join(ent)
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
right_join(ent)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T))
return(df)
}
View(max69_p2d_df)
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
View(stb_pair)
max69_p2d_df
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(ent %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid') %>%
distinct(sampleid, .keep_all = T)
now <- ent %>%
left_join(max69_p2d_df)
View(now)
now <- ent %>%
left_join(max69_p2d_df) %>%
mutate(bigger69 = if_else(is.na(bigger69), 0,bigger69 ))
res_ent_max69 <- summary(lm(ave_irep ~ bigger69, data = now ))
# the newer version of fig3 A
res_ent_max69 <- summary(lm(aveirep ~ bigger69, data = now ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
f3a <- now %>%
ggscatter(x = 'bigger69', y = 'ave_irep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
f3a
res_ent_max69 <- summary(lm(aveirep ~ bigger69, data = now ))
ent_max69_p <- round(res_ent_max69$coefficients[2, 'Pr(>|t|)'], 2)
f3a <- now %>%
ggscatter(x = 'bigger69', y = 'aveirep', alpha = scatter_alpha, shape = 16,
xlab = 'max(sweets+fruits) in\nprevious 2 days (g)',
ylab = 'Growth rate',
title = 'Enterococcus',
add = "reg.line",
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE) +
annotate("text", x = 40, y = 1, label = str_glue("paste(italic(p), \" = {ent_max69_p}\")"), parse = TRUE) +
theme_classic() +
theme(
plot.background = element_blank(),
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
aspect.ratio = 1,
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
strip.text.x = element_text(size = 8))
f3a
missing <- read_csv('../data/112_has_missing_to_be_removed.csv')
View(missing)
View(meta)
View(combined)
meta %>%
distinct(sampleid)
combined %>%
distinct(sampleid)
f3b
f3a
knitr::opts_chunk$set(echo = TRUE)
# all the irep values I got
fns <- list.files('../data/growth/irep/updated_irep/', full.names = T, pattern = '.tsv')
irep <- fns %>%
set_names(fns) %>%
purrr::map(~  read_tsv(file = ., n_max = 1 , col_types = 'cc',  skip = 2, col_names = c('bin','iRep')) %>%  select(iRep) ) %>%
bind_rows(.id = 'fn') %>%
mutate(fn = str_replace(fn, '_irep.tsv$',''),
fn = str_replace(fn, '../data/growth/irep/updated_irep//','')) %>%
separate(fn, into = c('sampleid','samplebin'), sep = '__concat__', remove = T) %>%
mutate(iRep = as.numeric(iRep)) %>%
mutate(samplebin = str_replace(samplebin, '_irep_dastool.tsv','')) %>%
mutate(sbid = str_glue('{sampleid}__{samplebin}'))
full <- read_tsv('../data/growth/bhatpipeline/binning_table_all_full.tsv')
tb <- read_tsv('../data/growth/bhatpipeline/binning_table_all_simple.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
inner_join(irep, by  = 'sbid') %>%
relocate(iRep, .after = 'Bin') %>%
relocate(best_species, .after = 'iRep') %>%
filter(!is.na(iRep)) %>%
arrange(Sample,Bin,  best_species) %>%
# if there are multiple get the average
group_by(Sample, best_species, best_level) %>%
summarise(aveirep = mean(iRep)) %>%
filter(best_species != 'Unclassified')
# save a copy of the high quality bins from the growth samples
bins <-  read_tsv('../data/growth/bhatpipeline/binning_table_all_simple.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
filter(best_species != 'Unclassified') %>%
arrange(Sample,Bin,  best_species) %>%
relocate(best_species, .after = 'Bin')
bins %>%
distinct(Sample,  best_species)
# check the one best species that have multiple irep
tb %>%
count(Sample, best_species, sort = T)
# combined %>%
#   mutate(gt15 = if_else(iRep > 1.5, T, F)) %>%
#   count(gt15) %>%
#   mutate(perc = n/sum(n)*100)
View(tb)
tb %>%
distinct(sampleid)
tb %>%
distinct(
Sample
)
tb %>%
ungroup %>%
distinct(
Sample
)
View(combined)
stb_pair <- combined %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
View(daily)
stb_pair <- combined %>%
select(mrn, sdrt) %>%
transmute(mrn = mrn,
p1d = sdrt-1,
p2d = sdrt-2)
max_p2d_69 <-  function(mrn_, p1d_, p2d_){
df = daily %>%
filter(mrn == mrn_) %>%
filter(fdrt %in% c(p1d_, p2d_  )) %>%
group_by(mrn) %>%
summarise(bigger69 = max(total69, na.rm = T),
bigger6 = max(`6`, na.rm = T),
bigger9 = max(`9`, na.rm = T),
ave6 = mean(`6`, na.rm = T),
ave9 = mean(`9`, na.rm = T),
ave69 = mean(total69, na.rm = T))
return(df)
}
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
})
View(max69_p2d_df)
max69_p2d_df <- pmap(stb_pair, function(mrn, p1d, p2d){
max_p2d_69(mrn, p1d, p2d)
}) %>%
set_names(combined %>% pull(sampleid)) %>%
bind_rows(.id = 'sampleid')
View(max69_p2d_df)
View(max69_p2d_df)
View(daily)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
unique_df <- max69_p2d_df %>%
distinct(sampleid, .keep_all = T)
now <- ent %>%
left_join(unique_df)
now <- combined %>%
left_join(unique_df)
View(now)
View(combined)
tb <- read_tsv('../data/growth/bhatpipeline/binning_table_all_simple.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
inner_join(irep, by  = 'sbid') %>%
relocate(iRep, .after = 'Bin') %>%
relocate(best_species, .after = 'iRep') %>%
filter(!is.na(iRep)) %>%
arrange(Sample,Bin,  best_species)
tb <- read_tsv('../data/growth/bhatpipeline/binning_table_all_simple.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
inner_join(irep, by  = 'sbid') %>%
relocate(iRep, .after = 'Bin') %>%
relocate(best_species, .after = 'iRep') %>%
filter(!is.na(iRep)) %>%
arrange(Sample,Bin,  best_species) %>%
# if there are multiple get the average
group_by(Sample, best_species, best_level) %>%
summarise(aveirep = mean(iRep))
tb <- read_tsv('../data/growth/bhatpipeline/binning_table_all_simple.tsv') %>%
rename_all(~ gsub("\\.", "_", .)) %>%
mutate(fpmbp = `# contigs (>= 0 bp)`/Size_Mb) %>%
filter(Completeness >= 75 & fpmbp <= 175 & Contamination <= 2) %>%
mutate(Sample = str_replace(Sample, '__concat',''),
sbid = str_glue('{Sample}__{Bin}')) %>%
inner_join(irep, by  = 'sbid') %>%
relocate(iRep, .after = 'Bin') %>%
relocate(best_species, .after = 'iRep') %>%
filter(!is.na(iRep)) %>%
arrange(Sample,Bin,  best_species)
View(tb)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
fns <- list.files('~/Desktop/', pattern = '^md5')
fns
fns <- list.files('~/Desktop/', pattern = '^md5')
fns
fns <- list.files('~/Desktop/', pattern = '^md5', full.names = T)
test <- read_delim(fns[1], delim = ' ')
View(test)
test <- read_delim(fns[1])
test <- read_delim(fns[1], col_names = F)
test <- read_delim(fns[1], col_names = F, col_select = X3)
test <-
files <- fns %>%
set_names(fns) %>%
map(~ read_delim(., col_names = F, col_select = X3))
View(files)
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3))
View(files)
View(test)
View(test[["/Users/daia1/Desktop//md5sum.MSK.Batch_207.txt"]])
View(test[["/Users/daia1/Desktop//md5sum.MSK.WMS.Batch134.txt"]])
View(test[["/Users/daia1/Desktop//md5sum.MSK.WMS.Jan19.txt"]])
View(test[["/Users/daia1/Desktop//md5sum.MSK.WMS.OCT19.txt"]])
files
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$',''))
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$','')) %>%
distinct(sampleid)
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$','')
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$',''))
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$',''))
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$',''))
files <- fns %>%
set_names(fns) %>%
map_dfr(~ read_delim(., col_names = F, col_select = X3)) %>%
mutate(sampleid = str_replace(X3, '_.+$','')) %>%
distinct(sampleid)
View(files)
files %>%
write_csv('../data/13_seres_unique_sampleids.csv')
knitr::opts_chunk$set(echo = TRUE)
# the melissa table
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt')
library(tidyverse)
# the melissa table
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt')
View(tb)
# the melissa table
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt', comment = '#')
View(tb)
tb
View(tb)
# the melissa table
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt', comment = '#') %>%
gather("sampleid", "relative_abundance", 3:152)
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt', comment = '#')
# the melissa table
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt', comment = '#') %>%
gather("sampleid", "relative_abundance", 3:152)%>%
mutate(sampleid = str_replace(sampleid, 'Sample_GB_',''),
sampleid = str_replace(sampleid, 'Sample_GB',''),
sampleid = str_replace(sampleid, '_IGO_13037.+$',''))
tb <- read_tsv('~/pipeline/scripts/shotgun_pipeline/data/IGO_13037/merged_abundance_table_metaphlan3.txt', comment = '#')
View(tb)
