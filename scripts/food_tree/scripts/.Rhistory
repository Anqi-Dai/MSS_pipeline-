units = c("mm"),
dpi = 400, device = 'pdf', plot = fig1_umap)
dcoords <- read_csv('../data/016_umap_embedding_for_angel.csv')
link <- read_csv('../data/cleaned_diet_data/deidentify_dsample_map.csv')
coord <- dcoords %>%
inner_join(link) %>%
select(-fid, -pt)
fcts_fg <- read_csv('../data/cleaned_diet_data/summarize_food_groups_pt_daily.csv')
fcts_fg_dom <- fcts_fg %>%
group_by(mrn, fdrt) %>%
arrange(-grp_frac, .by_group = T) %>%
slice(1) %>%
ungroup() %>%
transmute(fid = str_glue('P{mrn}d{fdrt}'),
fg1_dom = fg1_name) %>%
inner_join(link %>% select(fid, index_column))
df <- coord %>%
inner_join(fcts_fg_dom) %>%
left_join(fpalette %>% select(fg1_dom = fg1_name, color)) %>%
add_count(fg1_dom)
color_key <- df %>%
distinct(fg1_dom, color) %>%
mutate(fg1_dom = factor(fg1_dom)) %>%
arrange(fg1_dom) %>%
deframe()
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'fg1_dom', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
aspect.ratio=1)
fig1_umap
ggsave('../figs/paper/072_fig1_umap.pdf',
width = 52,
height = 52,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fig1_umap)
View(df)
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv')
View(key)
df
df <- coord %>%
inner_join(fcts_fg_dom) %>%
left_join(fpalette %>% select(fg1_dom = fg1_name, color)) %>%
add_count(fg1_dom) %>%
rename(fg1_name = fg1_dom) %>%
left_join(key )
df
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'shortname', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
aspect.ratio=1)
fig1_umap
ggsave('../figs/paper/072_fig1_umap.pdf',
width = 52,
height = 52,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fig1_umap)
color_key <- df %>%
distinct(shortname, color) %>%
mutate(shortname = factor(shortname)) %>%
arrange(shortname) %>%
deframe()
color_key
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'shortname', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
aspect.ratio=1)
fig1_umap
ggsave('../figs/paper/072_fig1_umap.pdf',
width = 52,
height = 52,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fig1_umap)
color_key <- df %>%
distinct(shortname, color) %>%
mutate(shortname = factor(shortname)) %>%
arrange(shortname) %>%
deframe()
color_key
color_key <- df %>%
distinct(shortname, color) %>%
#mutate(shortname = factor(shortname)) %>%
#arrange(shortname) %>%
deframe()
color_key
color_key <- df %>%
distinct(color, shortname) %>%
#mutate(shortname = factor(shortname)) %>%
#arrange(shortname) %>%
deframe()
color_key
color_key <- df %>%
distinct(color, shortname)
View(color_key)
color_key <- df %>%
distinct(shortname, color) %>%
#mutate(shortname = factor(shortname)) %>%
#arrange(shortname) %>%
deframe()
color_key
color_key <- df %>%
distinct(shortname, color)
color_key <- df %>%
ungroup() %>%
distinct(shortname, color)
color_key <- df %>%
ungroup() %>%
distinct(shortname, color) %>%
select(shortname, color)
color_key <- df %>%
ungroup() %>%
distinct(shortname, color) %>%
select(shortname, color) %>%
#mutate(shortname = factor(shortname)) %>%
#arrange(shortname) %>%
deframe()
color_key
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'shortname', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
aspect.ratio=1)
fig1_umap
ggsave('../figs/paper/072_fig1_umap.pdf',
width = 52,
height = 52,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fig1_umap)
# import the tree from pdf to a ggplot kind of object
# p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
# tree <- grImport2::pictureGrob( p )# soooo freaking slow!!!!!
p <- '../figs/paper/080_food_tree_ring.png'
tree <- ggdraw() +
draw_image(p,   scale = 1)
tree
# import the tree from pdf to a ggplot kind of object
# p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
# tree <- grImport2::pictureGrob( p )# soooo freaking slow!!!!!
p <- '../figs/paper/080_food_tree_ring.png'
tree <- ggdraw() +
draw_image(p,   scale = 1)
tree
top <- plot_grid(tree,  fg_legend_, fig1_umap,labels = c('A',NA, "B"),
nrow = 1, rel_widths = c(1.3,1.1,1), axis = 'lbrt', align = 'hv')
top <- plot_grid(tree, fig1_umap,labels = c('A',NA, "B"),
nrow = 1, rel_widths = c(1.3,1.1,1), axis = 'lbrt', align = 'hv')
top
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1.3,1), axis = 'lbrt', align = 'hv')
top
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1,6,1), axis = 'lbrt', align = 'hv')
top
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1.6,1), axis = 'lbrt', align = 'hv')
top
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1.3,1), axis = 'lbrt', align = 'hv')
top
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1,1), axis = 'lbrt', align = 'hv')
top
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1,1),
nrow = 2)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(cowplot)
library(ggimage)
axis_text_size <- 11
axis_title_size <- 11
alpha_val <- 0.05
point_size <- 1.2
scatter_col <- 'gray14'
pick_point_size <- 1
pick_line_size <- 0.5
example_pt_line_size <- 0.3
diet_line_color <- '#E41A1C'
stool_line_color <- 'blue'
# the colors for each food group specified and saved here
fpalette <- tribble(
~fg1_name, ~color, ~fgrp1,
#--|--|
'fg_milk' , '#3498DB', '1',
'fg_meat' , '#591605', '2',
'fg_egg' , '#F1C40F', '3',
'fg_legume' , '#E67E22', '4',
'fg_grain' , '#D35400', '5',
'fg_fruit' , '#7D3C98', '6',
'fg_veggie' , '#229954', '7',
'fg_oils' , '#707B7C',  '8',
'fg_sweets' , '#db2589' , '9'
)
fpalette %>%
write_csv('../data/cleaned_diet_data/food_group_color_key.csv')
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
# the macronutrients scatter plot
m_all <- dtb %>%
select(mrn, fdrt,Protein_g:Sodium_g ) %>%
gather('grp','gram', Protein_g:Sodium_g) %>%
mutate(grp = str_replace(grp, '_g$','')) %>%
group_by(mrn, fdrt, grp) %>%
summarise(eachsum = sum(gram))
# nutrition data
macro_list <- m_all %>%
split(.$grp) %>%
imap(function(.x, .y) {
ggscatter(data = .x ,x = 'fdrt', y = 'eachsum', alpha = 0.02, size = point_size,
xlab = 'Day relative to HCT',
ylab = 'Grams',
title = str_glue('{.y}'),
add = "loess", conf.int = TRUE,
add.params = list(color = diet_line_color, fill = "hotpink", size = 1))  +
theme(axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
aspect.ratio=1)
})
macro <- plot_grid(macro_list[[1]],macro_list[[2]],macro_list[[3]],macro_list[[4]],macro_list[[5]],macro_list[[6]],
nrow = 2,
align = 'hv',
#rel_widths =  c(1,1),
#rel_heights = c(1,1),
labels = c('A','B','C', 'D','E','F'),
axis = 'tblr')
ggsave('../figs/paper/072_macro_fig1_supp.pdf',
width = 160,
height = 120,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf')
# picked patient
stool_alpha <- meta %>%
ggscatter(x = 'sdrt', y = 'simpson_reciprocal', alpha = alpha_val, size = point_size,
xlab = 'Day relative to HCT', shape = 'triangle',
ylab = expression(Microbiome~alpha~diversity),
title = expression(Microbiome~alpha~diversity),
add = "loess", conf.int = TRUE,
add.params = list(color = stool_line_color, fill = "darkblue", size = 1)) +
theme(axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
aspect.ratio=1)
day_calori <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(daycal = sum(Calories_kcal))
day_cal <- day_calori %>%
ggscatter(x = 'fdrt', y = 'daycal', alpha = alpha_val, size = point_size,
xlab = 'Day relative to HCT',
ylab = 'Daily caloric intake',
title = 'Daily caloric intake',
color = scatter_col,
add = "loess", conf.int = TRUE,
add.params = list(color = diet_line_color, fill = "hotpink", size = 1)) +
theme(axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
aspect.ratio=1)
# this faith pd is recently calculated in 2021-07
faith <- read_tsv('../data/cleaned_diet_data/FINAL_97_faith_pd/alpha-diversity.tsv') %>%
separate(...1, into = c('mrn', 'fdrt'), sep = 'd', convert = T)  %>%
mutate(mrn = as.numeric(str_replace(mrn, 'P','')))
diet_alpha <- faith %>%
ggscatter('fdrt', 'faith_pd',
alpha = alpha_val,size = point_size,
color = scatter_col,
ylab = expression(Diet~alpha~diversity),
xlab = 'Day relative to HCT',
title = expression(Diet~alpha~diversity),
add = "loess", conf.int = TRUE,
add.params = list(color = diet_line_color, fill = "hotpink", size = 1)) +
theme(axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
plot.title = element_text(size=axis_title_size),
#plot.title = element_text(size=11, hjust = 0.5,  face = 'bold')
) +
theme(aspect.ratio=1)
bot <- plot_grid(day_cal, diet_alpha, stool_alpha,
nrow = 1,
align = 'hv',
#rel_widths =  c(1,1),
#rel_heights = c(1,1),
labels = c('C','D','E'),
axis = 'tblr')
bot
ggsave('../figs/paper/072_bot_fig1.tiff',
width = 180,
height = 60,
#height = 60,
units = c("mm"),
dpi = 400, device = 'tiff', plot = bot)
# the patient that is picked to showcase the timeline in data collection
pick <- read_csv('../figs/paper/data/patient_pick_d0_diet.csv')
pick <- read_csv('../figs/paper/data/patient_pick_d0_diet.csv')
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1.5,1), axis = 'lbrt', align = 'hv')
top
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1.4,1), axis = 'lbrt', align = 'hv')
top
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1.3,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1,1), axis = 'lbrt', align = 'hv')
top
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1.3,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
# import the tree from pdf to a ggplot kind of object
# p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
# tree <- grImport2::pictureGrob( p )# soooo freaking slow!!!!!
p <- '../figs/paper/080_food_tree_ring.png'
tree <- ggdraw() +
draw_image(p,   scale = 1.3)
tree
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1,1), axis = 'lbrt', align = 'hv')
top
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1.3,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'shortname', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
aspect.ratio=1) +
guides(colour = guide_legend(override.aes = list(alpha=1)))
fig1_umap
ggsave('../figs/paper/072_fig1_umap.pdf',
width = 52,
height = 52,
#height = 60,
units = c("mm"),
dpi = 400, device = 'pdf', plot = fig1_umap)
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'shortname', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
legend. title = element_blank(),
fig1_umap <- df %>%
arrange(desc(n)) %>%
ggscatter(x = 'taxumap1', y = 'taxumap2', color = 'shortname', alpha = 0.2,size = point_size , xlab = 'UMAP1', ylab = 'UMAP2') +
scale_color_manual(values = color_key) +
theme_classic() +
theme(legend.position = "right",
legend.title = element_blank(),
axis.text=element_text(size=axis_text_size),
axis.title=element_text(size=axis_title_size),
aspect.ratio=1) +
guides(colour = guide_legend(override.aes = list(alpha=1)))
fig1_umap
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1,1), axis = 'lbrt', align = 'hv')
top
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1.3,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Jan31.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
# assemble all
f1 <-  plot_grid(top, bot,
rel_heights = c(1.3,1),
nrow = 2)
ggsave('../figs/paper/F1_overview_072_Feb1.pdf',
width = 190,
height = 140,
#height = 60,
units = c("mm"),
dpi = 400, plot = f1)
# import the tree from pdf to a ggplot kind of object
# p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
# tree <- grImport2::pictureGrob( p )# soooo freaking slow!!!!!
p <- '../figs/paper/080_food_tree_ring.png'
tree <- ggdraw() +
draw_image(p,   scale = 1.3)
tree
# import the tree from pdf to a ggplot kind of object
# p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
# tree <- grImport2::pictureGrob( p )# soooo freaking slow!!!!!
p <- '../figs/paper/080_food_tree_ring.png'
tree <- ggdraw() +
draw_image(p,   scale = 1.3)
tree
# import the tree from pdf to a ggplot kind of object
# p <- grImport2::readPicture( "../figs/paper/080_food_tree_ring.svg" )
# tree <- grImport2::pictureGrob( p )# soooo freaking slow!!!!!
p <- '../figs/paper/080_food_tree_ring.png'
tree <- ggdraw() +
draw_image(p,   scale = 1.5)
tree
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1,1), axis = 'lbrt', align = 'hv')
top
top <- plot_grid(tree, fig1_umap,labels = c('A', "B"),
nrow = 1, rel_widths = c(1.5,1), axis = 'lbrt', align = 'hv')
top
knitr::opts_chunk$set(echo = TRUE, message = F)
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv') %>%
mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>%
mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
mutate(mrn = factor(mrn)) %>%
mutate(fg_egg = fg_egg/100,
fg_fruit = fg_fruit/100,
fg_grain = fg_grain/100,
fg_legume = fg_legume/100,
fg_meat = fg_meat/100,
fg_milk = fg_milk/100,
fg_oils = fg_oils/100,
fg_sweets = fg_sweets/100,
fg_veggie = fg_veggie/100) %>%
mutate(inten_non = if_else(intensity == 'nonablative', 1, 0),
inten_ab = if_else(intensity == 'ablative', 1, 0),
inten_re = if_else(intensity == 'reduced', 1, 0))
colnames(meta)
meta %>%
distinct(mrn)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
dtb %>%
distinct(mrn)
dtb %>%
distinct(mrn)
dtb %>%
distinct(mrn) %>%
write_csv('../data/nutrition_patients_97_mrns.csv', col_names = T)
