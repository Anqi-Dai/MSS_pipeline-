ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
bas %>%
filter(sampleid %in% onset$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(ggpubr)
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
tb <- read_tsv('../data/map_EC_to_triplet_AC_U50_U90_Swissprot_and_Trembl.txt')
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
ba <- read_excel('../data/KO_BAs.xlsx') %>%
mutate(ECnum = str_replace(EC, 'EC:',''))
# to look at the recent batch from Oriana
pheno <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv')
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
oriana_all <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/all_BAs_conc.csv') %>%
select(sampleid) %>%
mutate(fid = if_else(str_detect(sampleid, '^FMT'), str_replace(sampleid, '\\.', '_'), sampleid))
oba <- tibble(
fn = list.files('../data/KO/', full.names = T)
) %>%
mutate(fid = str_replace(fn, '../data/KO//', ''),
fid = str_replace(fid, '_humann3_KO_cpm.tsv', '')) %>%
filter(fid %in% oriana_all$fid)
onset <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/cohort_BAs_later.csv')
perien <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/cohort_BAs_periengr.csv')
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
ursodiol <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/ursodiol.csv')
ofn <- oba %>%
pull(fn)
res <- ofn %>%
set_names(ofn) %>%
map(~ read_tsv(.) %>%
filter(!str_detect(`# Gene Family`, '\\|')) %>%
rename(KOID = `# Gene Family`,
cpm = names(.)[2]) ) %>%
bind_rows(.id = 'fn')
bas <- res %>%
filter(KOID %in% ba$KO) %>%
left_join(oba) %>%
inner_join(oriana_all) %>%
left_join(pheno %>%
select(BatchID, DiseaseGroup, sampleid, mrn))
bas %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
bas %>%
filter(sampleid %in% onset$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
include <- read_csv('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/ursodiol_exposed_samples_for_analysis.csv')
bas %>%
filter(sampleid %in% onset$sampleid) %>%
filter(sampleid %in% include$sampleid) %>%
ggboxplot(x  = 'DiseaseGroup', y = 'cpm', facet.by = 'KOID', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
View(bas)
?connect_database
library(vdbR)
?connect_database
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
matri <- dtb %>%
select(mrn, fdrt, Food_code, dehydrated_weight) %>%
mutate(fid = str_glue('{mrn}d{fdrt}')) %>%
select(fid, Food_code, dehydrated_weight) %>%
group_by(fid, Food_code) %>%
summarise(total = sum(dehydrated_weight)) %>%
spread('fid', 'total', fill = 0)
cts <- matri %>%
gather('fid', 'gram', names(.)[2]:names(.)[ncol(.)])
fid_sum <- cts %>%
group_by(fid) %>%
summarise(Sum = sum(gram))
cts_all <- cts %>%
left_join(fid_sum)  %>%
mutate(frelab = gram/Sum) %>%
select(Food_code, fid, frelab) %>%
spread(key = 'Food_code', value = 'frelab') %>%
rename(index_column = fid) %>%
mutate(index_column = str_glue('P{index_column}'))
# create pt number for the mrn
link <- cts_all %>%
select(index_column) %>%
transmute(mrn = str_extract(index_column, 'P.+d')) %>%
mutate(mrn = str_replace(mrn, 'P',''),
mrn = str_replace(mrn, 'd$','') ) %>%
distinct() %>%
mutate(pt = seq(1, nrow(.))) %>%
mutate(pt = str_pad(pt, 2, side = 'left', '0')) %>%
mutate(pt = str_glue('P{pt}'))
link_all <- cts_all %>%
select(index_column) %>%
mutate(fid = index_column) %>%
separate(index_column, into = c('mrn','fdrt'), sep = 'd') %>%
mutate(mrn = str_replace(mrn, 'P','')) %>%
left_join(link) %>%
mutate(index_column = str_glue('{pt}d{fdrt}'))
View(link_all)
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1]) %>%
write_csv('../softwares/phylo-umap/taxumap/data/taxUMAP_food_cts.csv')
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1])
View(dtb)
dtb
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight))
View(requested)
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all)
link_all
link_all
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn)))
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn),
fdrt = as.numeric(fdrt)))
requested
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn),
fdrt = as.numeric(fdrt))) %>%
select(index_column,total_kcal, total_gram )
ungroup( %>%
# requested by Jonas (can you send me another file, with the same sample index, that has the total kcal in one column, and the total grams in another in it? )
requested <- dtb %>%
group_by(mrn, fdrt) %>%
summarise(total_kcal = sum(Calories_kcal),
total_gram = sum(dehydrated_weight)) %>%
full_join(link_all %>%
mutate(mrn = as.numeric(mrn),
fdrt = as.numeric(fdrt))) %>%
ungroup( )%>%
select(index_column,total_kcal, total_gram )
requested %>%
write_csv('../data/index_with_cal_and_gram.csv')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(viridis)
# make the food code counts matrix
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
matri <- dtb %>%
select(mrn, fdrt, Food_code, dehydrated_weight) %>%
mutate(fid = str_glue('{mrn}d{fdrt}')) %>%
select(fid, Food_code, dehydrated_weight) %>%
group_by(fid, Food_code) %>%
summarise(total = sum(dehydrated_weight)) %>%
spread('fid', 'total', fill = 0)
matri %>%
write_csv('../data/cleaned_diet_data/FINAL_97_food_code_counts_matrix.csv')
# formatting the counts table to have samples in the rows
cts <- matri %>%
gather('fid', 'gram', names(.)[2]:names(.)[ncol(.)])
fid_sum <- cts %>%
group_by(fid) %>%
summarise(Sum = sum(gram))
cts_all <- cts %>%
left_join(fid_sum)  %>%
mutate(frelab = gram/Sum) %>%
select(Food_code, fid, frelab) %>%
spread(key = 'Food_code', value = 'frelab') %>%
rename(index_column = fid) %>%
mutate(index_column = str_glue('P{index_column}'))
# create pt number for the mrn
link <- cts_all %>%
select(index_column) %>%
transmute(mrn = str_extract(index_column, 'P.+d')) %>%
mutate(mrn = str_replace(mrn, 'P',''),
mrn = str_replace(mrn, 'd$','') ) %>%
distinct() %>%
mutate(pt = seq(1, nrow(.))) %>%
mutate(pt = str_pad(pt, 2, side = 'left', '0')) %>%
mutate(pt = str_glue('P{pt}'))
link_all <- cts_all %>%
select(index_column) %>%
mutate(fid = index_column) %>%
separate(index_column, into = c('mrn','fdrt'), sep = 'd') %>%
mutate(mrn = str_replace(mrn, 'P','')) %>%
left_join(link) %>%
mutate(index_column = str_glue('{pt}d{fdrt}'))
link_all %>%
write_csv('../data/cleaned_diet_data/deidentify_dsample_map.csv')
cts_all %>%
rename(fid = index_column) %>%
full_join(link_all %>% select(fid, index_column)) %>%
select(index_column, names(.)[2]:names(.)[ncol(.)-1]) %>%
write_csv('../softwares/phylo-umap/taxumap/data/taxUMAP_food_cts.csv')
detable <- cts_all %>%
gather('foodcode', 'relab', names(.)[2]:names(.)[ncol(.)]) %>%
filter(str_detect(foodcode, '^9')) %>%
arrange(-relab) %>%
rename(fid = index_column) %>%
left_join(link_all %>% select(fid, index_column))
View(detable)
detable <- cts_all %>%
gather('foodcode', 'relab', names(.)[2]:names(.)[ncol(.)]) %>%
filter(str_detect(foodcode, '^9')) %>%
arrange(-relab) %>%
rename(fid = index_column) %>%
left_join(link_all %>% select(fid, index_column))
View(dtb)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(vdbR)
connect_database(config_file = '~/dbConfig.txt')
get_table_from_database('shotgun_lookup_ad')
pilot <- meta %>%
filter(fid %in% shotgun_lookup_ad$fid) %>%
pull(fid)
meta <- read_csv(file = file.path(serpath, '08_shotgun_meta.csv'))
serpath <- '/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/'
meta <- read_csv(file = file.path(serpath, '08_shotgun_meta.csv'))
pilot <- meta %>%
filter(fid %in% shotgun_lookup_ad$fid) %>%
pull(fid)
new <- meta %>%
filter(!fid %in% shotgun_lookup_ad$fid)
pools <- bind_rows(
tibble(
fid = new$fid,
projectid = 'Project_12652'
),
shotgun_lookup_ad %>%
filter(fid %in% pilot) %>%
select(fid, projectid)
)
kos <- read_csv(file.path(serpath, '08_shotgun_KO.csv'))
ko <- kos %>%
filter(!str_detect(KOID,'\\|')) %>%
select(-sampleid) %>%
spread('fid', 'cpm', fill =0 ) %>%
column_to_rownames('KOID') %>%
as.matrix()
pseudo <- min(ko[ko>0])/2
ctslog2 <- log2(ko + pseudo)
pheno <- pools %>%
arrange(fid)
all.equal(pheno$fid, colnames(ctslog2))
# pca raw
pca_ori <- prcomp(ctslog2 %>% t(), scale. = TRUE, center = T)
pools %>%
count(projectid, sort = T)
pca_ori$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid', alpha = 0.5)
library(sva)
combat_ctslog2 = ComBat(dat=ctslog2, batch=pheno$projectid, mod=NULL, par.prior=FALSE, mean.only=TRUE,prior.plots=T )
combat_ctslog2 = ComBat(dat=ctslog2, batch=pheno$projectid, mod=NULL, par.prior=FALSE, mean.only=TRUE,prior.plots=T )
pca_res <- prcomp(combat_ctslog2 %>% t(), scale. = TRUE, center = T)
pca_res$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid)
pca_res$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)
pca_res$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid')
ctslog2 <- ko
all.equal(pheno$fid, colnames(ctslog2))
# pca raw
pca_ori <- prcomp(ctslog2 %>% t(), scale. = TRUE, center = T)
pools %>%
count(projectid, sort = T)
pca_ori$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid', alpha = 0.5)
ctslog2 <- ko
all.equal(pheno$fid, colnames(ctslog2))
ctslog2 <- ko
all.equal(pheno$fid, colnames(ctslog2))
pca_ori$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid', alpha = 0.5)
library(sva)
combat_ctslog2 = ComBat(dat=ctslog2, batch=pheno$projectid, mod=NULL, par.prior=FALSE, mean.only=TRUE,prior.plots=T )
pca_res <- prcomp(combat_ctslog2 %>% t(), scale. = TRUE, center = T)
pca_res$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid')
# pca raw
pca_ori <- prcomp(ctslog2 %>% t(), scale. = TRUE, center = T)
pools %>%
count(projectid, sort = T)
pca_ori$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid', alpha = 0.5)
ko <- kos %>%
filter(!str_detect(KOID,'\\|')) %>%
select(-sampleid) %>%
spread('fid', 'cpm', fill =0 ) %>%
column_to_rownames('KOID') %>%
as.matrix()
pseudo <- min(ko[ko>0])/2
ctslog2 <- log2(ko + pseudo)
pheno <- pools %>%
arrange(fid)
all.equal(pheno$fid, colnames(ctslog2))
# pca raw
pca_ori <- prcomp(ctslog2 %>% t(), scale. = TRUE, center = T)
pools %>%
count(projectid, sort = T)
pca_ori$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid', alpha = 0.5)
library(sva)
combat_ctslog2 = ComBat(dat=ctslog2, batch=pheno$projectid, mod=NULL, par.prior=FALSE, mean.only=TRUE,prior.plots=T )
pca_res <- prcomp(combat_ctslog2 %>% t(), scale. = TRUE, center = T)
pca_res$x %>%
as.data.frame() %>%
rownames_to_column('fid') %>%
select(PC1, PC2, fid) %>%
full_join(pheno)  %>%
ggscatter(x = 'PC1', y = 'PC2', color = 'projectid')
knitr::opts_chunk$set(echo = TRUE)
serpath <- '/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/'
meta <- read_csv(file = file.path(serpath, '08_shotgun_meta.csv'))
View(meta)
fns <- list.files('../data/new_meta/', full.names = T)
test <- read_tsv(fns[1])
test
fns <- list.files('../data/new_meta/', full.names = T, skip = 1)
fns <- list.files('../data/new_meta/', full.names = T)
test <- read_tsv(fns[1], skip = 1)
View(test)
test <- read_tsv(fns[1], skip = 4)
test
test <- read_tsv(fns[1], skip = 4) %>%
select(taxa = names(.)[1],
relative_abundance)
fns
res <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4) %>%
select(taxa = names(.)[1],
relative_abundance) )
res <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4) %>%
select(taxa = names(.)[1],
relative_abundance) )
View(res)
res <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4) %>%
select(taxa = names(.)[1],
relative_abundance) )%>%
bind_rows(.id = 'fn')
View(res)
res
res <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4) %>%
select(taxa = names(.)[1],
relative_abundance) )%>%
bind_rows(.id = 'fn') %>%
mutate(fid = str_replace(fn, '../data/new_meta//', ''),
fid = str_replace(fid, '_metaphlan3_profile.txt', '')) %>%
filter(fid %in% meta$fid)
View(res)
res %>% distinct(sampleid) %>% nrow
res %>% distinct(fid) %>% nrow
View(meta)
all <- res %>%
left_join(meta)
View(all)
View(all)
# alpha diversity
library(vegan)
all %>% write_csv(file = file.path(serpath, '10_shotgun_metaphlan.csv'))
cts
all
cts_all <- all %>%
select(taxa, relative_abundance, sampleid) %>%
spread(key = 'taxa', value = 'relative_abundance', fill = 0) %>%
column_to_rownames('sampleid')
combined <- diversity(cts_all, index = 'inv')
combined <- diversity(cts_all, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv')
combined <- diversity(cts_all, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv') %>%
full_join(meta)
combined <- diversity(cts_all, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv') %>%
full_join(meta)   %>%
rename(simpson_reciprocal = inv)
View(combined)
combined %>%
filter(in_onset == 'TRUE') %>%
filter(urso_expo == 'TRUE') %>%
ggboxplot(x  = 'DiseaseGroup', y = 'simpson_reciprocal', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
combined %>%
filter(in_onset == 'TRUE') %>%
filter(urso_expo == 'TRUE') %>%
ggboxplot(x  = 'DiseaseGroup', y = 'simpson_reciprocal', add = 'jitter') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
ggsave('../figs/10_onset_alpha.pdf', width = 8, height = 6)
combined %>%
filter(in_onset == 'TRUE') %>%
filter(urso_expo == 'TRUE') %>%
ggboxplot(x  = 'DiseaseGroup', y = 'simpson_reciprocal', add = 'jitter',
title = 'onset') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
ggsave('../figs/10_onset_alpha.pdf', width = 8, height = 6)
# peri samples
combined %>%
filter(in_peri == 'TRUE') %>%
filter(urso_expo == 'TRUE') %>%
ggboxplot(x  = 'DiseaseGroup', y = 'simpson_reciprocal', add = 'jitter',
title = 'onset') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
ggsave('../figs/10_peri_alpha.pdf', width = 8, height = 6)
View(combined)
# peri samples
combined %>%
filter(in_peri == 'TRUE') %>%
filter(urso_expo == 'TRUE') %>%
ggboxplot(x  = 'DiseaseGroup', y = 'simpson_reciprocal', add = 'jitter',
title = 'peri') +
stat_compare_means(comparisons= list(c('GVHD', 'CTRL')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
ggsave('../figs/10_peri_alpha.pdf', width = 8, height = 6)
list.files('/Volumes/vandenbrinklab/oriana/Study ideas/bile_acids/final_datasets/')
