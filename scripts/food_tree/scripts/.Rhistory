spearman_rho = round(spearman_cor$estimate, 2)
spearman_pval = round(spearman_cor$p.value , 2)
return(list(genus = .y, rho = spearman_rho, pval = spearman_pval))
} )
# show the % of the samples that have the relab of the genus > 10^-4
perc_thre <- g_relab %>%
count(genus, relab > 10^-4) %>%
filter(`relab > 10^-4` == 'TRUE') %>%
mutate(passthre_perc = round(n/1009*100, 0))
spearman_all <- spearman_res %>%
left_join(perc_thre) %>%
mutate(n = ifelse(is.na(n), 0, n),
passthre_perc = ifelse(is.na(passthre_perc), 0, passthre_perc))
# to visualize the ones that passed the threshold to scatter plot
selected <- spearman_all %>%
filter(passthre_perc > 10 & pval < 0.05)
g_relab %>%
filter(genus %in% selected$genus) %>%
left_join(selected %>% select(genus, rho, pval)) %>%
filter(rho < 0) %>%
ggscatter( x = 'simpson_reciprocal', y = 'relab', facet.by = 'genus',alpha =0.2,
title = 'genus with correlation < 0',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", label.y.npc = "top", color = 'red'))
View(spearman_all)
ggsave('../data/172_diversity_genus_relab_cor.pdf', width = 9)
spearman_all %>% write_csv('../data/172_spearman_all.csv')
domination <- g_relab %>%
count(genus, relab > 0.3) %>%
filter(`relab > 0.3` == 'TRUE') %>%
mutate(dom_perc = round(n/1009*100, 0))
domination %>%
filter(dom_perc > 0) %>%
write_csv('../data/172_has_domination30_genus.csv')
passthregenus <- spearman_all %>%
filter(passthre_perc > 15 )
logrelab <- read_csv('../data/088_genus_relab_log10_wide.csv') %>%
gather('genus','logrelab', names(.)[2]:names(.)[ncol(.)]) %>%
filter(genus %in% passthregenus$genus) %>%
spread('genus','logrelab') %>%
inner_join(meta %>% select(sampleid, simpson_reciprocal))
response <- logrelab$simpson_reciprocal
genuslog <- logrelab %>% select(-sampleid) %>% as.matrix()
res <- lm(response ~ 1 + genuslog )
summary(res)
selected <- spearman_all %>%
filter(passthre_perc > 10 & pval < 0.05)
View(selected)
library(brms)
?prior_draws
hshs
?brm
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
irep <- read_csv('../data/114_combined_irep_915.csv') %>%
select(sampleid:sdrt, iRep, best_species) %>%
mutate(best_species = str_replace(best_species, '\\[',''),
best_species = str_replace(best_species, '\\]','')) %>%
mutate(genus = str_extract(best_species, "[^\\s]+"))
meta <- read_csv('../data/153_combined_META.csv')
# the ones identify as from Enterococcus
entero <- irep %>%
filter(str_detect(best_species, 'Enterococcus')) %>%
group_by(sampleid) %>%
summarise(max_entero = max(iRep)) %>%
inner_join(meta %>% select(sampleid, fg_sweets, empirical))
entero %>%
ggscatter(x = 'fg_sweets', y = 'max_entero',  facet.by = 'empirical',
#color = 'genus',palette = 'lancet',
xlab = 'Sweets',
ylab = 'Growth rate ',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", size = 2.5))
stools <- irep %>%
distinct(sampleid, mrn, sdrt) %>%
mutate(p1d = sdrt - 1)
# calculate the previous one day sweets intake
dtb <- read_csv('../data/152_combined_DTB.csv')
fgrps_df <- dtb %>%
select(mrn, fdrt, dehydrated_weight, Food_code) %>%
mutate(fgrp1 = str_sub(Food_code, 1, 1)) %>%
group_by(mrn, fdrt, fgrp1) %>%
summarise(grp_tol = sum(dehydrated_weight))%>%
mutate(fg1_name = case_when(
fgrp1 == '1' ~ 'fg_milk',
fgrp1 == '2' ~ 'fg_meat',
fgrp1 == '3' ~ 'fg_egg',
fgrp1 == '4' ~ 'fg_legume',
fgrp1 == '5' ~ 'fg_grain',
fgrp1 == '6' ~ 'fg_fruit',
fgrp1 == '7' ~ 'fg_veggie',
fgrp1 == '8' ~ 'fg_oils',
fgrp1 == '9' ~ 'fg_sweets'
)) %>%
select(-fgrp1) %>%
spread('fg1_name','grp_tol', fill = 0) %>%
select(mrn, p1d = fdrt, fg_sweets)
p1d_irep <- stools %>%
left_join(fgrps_df, by = c("mrn", "p1d")) %>%
filter(!is.na(fg_sweets))
should <- read_csv('../data/135_selected_samples_for_irep_analysis.csv')
p1d_irep_df <- irep %>%
left_join(p1d_irep, by = c("sampleid", "mrn", "sdrt")) %>%
filter(!is.na(fg_sweets)) %>%
filter(sampleid %in% should$sampleid)
# do the correlation of the enterococcus and the p1d sweets
p1d_entero <- p1d_irep_df %>%
filter(genus == 'Enterococcus') %>%
group_by(sampleid, mrn, p1d, fg_sweets) %>%
summarise(max_entero = max(iRep))  %>%
rename(p1d_sweets = fg_sweets) %>%
inner_join(meta %>% select(sampleid,  empirical)) %>%
group_by(mrn) %>%
slice_sample(n = 1)
p1d_entero %>%
ggscatter(x = 'p1d_sweets', y = 'max_entero',
facet.by = 'empirical',
#color = 'genus',palette = 'lancet',
xlab = 'Sweets',
ylab = 'Growth rate ',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", size = 2.5))
# this is the data with the p1d sweets
zscore_p1d <- p1d_irep_df %>%
split(.$genus) %>%
map(function(df){
df %>%
mutate(iRep_zscore = scale(.$iRep, center = T, scale = T)[,1])
}
) %>%
bind_rows()
biggest <- zscore_p1d %>%
group_by(sampleid) %>%
arrange(desc(iRep_zscore), .by_group = T) %>%
slice(1)
them <- read_csv('../data/sum of sugar intake vs max zscore family(E,E).csv')
genus_pal <- tibble(
genus = them %>% distinct(genus) %>% pull(genus),
colors = c('#cd2026','#326634','#ee2023','#991b1d')
) %>%
deframe
current <- biggest %>%
filter(genus %in% them$genus)
current %>%
ggscatter(x = 'fg_sweets', y = 'iRep_zscore',  color = 'genus',
xlab = 'Sweets ',
ylab = 'Growth rate\n(standardized within genus) ',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", size = 2.5)) +
scale_color_manual(values = genus_pal) +
theme(aspect.ratio = 1,
axis.text=element_text(size=11),
axis.title=element_text(size=11),
legend.position = 'top',
legend.title=element_blank())
current %>% ungroup %>% count(mrn, sort = T)
# what about the p2d sweets
p2d_cor <- irep %>%
filter(sampleid %in% should$sampleid) %>%
inner_join(meta %>% select(sampleid, fg_sweets, empirical)) %>%
split(.$genus) %>%
map(function(df){
df %>%
mutate(iRep_zscore = scale(.$iRep, center = T, scale = T)[,1])
}
) %>%
bind_rows() %>%
group_by(sampleid) %>%
arrange(desc(iRep_zscore), .by_group = T) %>%
slice(1) %>%
filter(genus %in% them$genus)
p2d_cor %>%
ggscatter(x = 'fg_sweets', y = 'iRep_zscore',  color = 'genus',
xlab = 'Sweets ',
ylab = 'Growth rate\n(standardized within genus) ',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", size = 2.5)) +
scale_color_manual(values = genus_pal) +
theme(aspect.ratio = 1,
axis.text=element_text(size=11),
axis.title=element_text(size=11),
legend.position = 'top',
legend.title=element_blank())
entero %>%
ggscatter(x = 'fg_sweets', y = 'max_entero',
#facet.by = 'empirical',
#color = 'genus',palette = 'lancet',
xlab = 'Sweets',
ylab = 'Growth rate ',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", size = 2.5))
entero %>%
ggscatter(x = 'fg_sweets', y = 'max_entero',
facet.by = 'empirical',
#color = 'genus',palette = 'lancet',
xlab = 'Sweets',
ylab = 'Growth rate ',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n", label.x.npc = "left", size = 2.5))
knitr::opts_chunk$set(echo = TRUE)
library(tidyvesse)
library(tidyverse)
library(ggpubr)
knitr::opts_chunk$set(echo = TRUE)
# to change the df a little bit
full <- read_csv('../data/090_all_samples_meta_p2d_fg9_dietall_genera90.csv')
b
# to change the df a little bit
full <- read_csv('../data/090_all_samples_meta_p2d_fg9_dietall_genera90.csv') %>%
mutate(abx = if_else(empirical == 'TRUE', 1, 0),
TPN = if_else(TPN == 'TRUE', 1, 0),
EN = if_else(EN == 'TRUE', 1, 0)) %>%
mutate(      ave_fiber_e= ave_fiber*abx,
ave_fat_e=ave_fat*abx,
ave_Sugars_e=ave_Sugars*abx)
alpha_macro_fat <- log(simpson_reciprocal) ~ 0 +
ave_fiber:empirical +
ave_fat:empirical +
ave_Sugars:empirical +
ave_fiber +
ave_fat +
ave_Sugars +
empirical+
intensityAblative +
intensityNonablative+
intensityReduced +
TPN+
EN+
(1 | mrn) +
(1 | timebin)
get_prior(formula = alpha_macro_fat, data = full)
library(tidyverse)
library(ggpubr)
library(tidybayes)
library(brms)
library(rstan)
options(mc.cores = parallel::detectCores())
ncores = parallel::detectCores()
rstan_options(auto_write = TRUE)
axis_text_size <- 10
axis_title_size <- 10
alpha_macro_fat <- log(simpson_reciprocal) ~ 0 +
ave_fiber:empirical +
ave_fat:empirical +
ave_Sugars:empirical +
ave_fiber +
ave_fat +
ave_Sugars +
empirical+
intensityAblative +
intensityNonablative+
intensityReduced +
TPN+
EN+
(1 | mrn) +
(1 | timebin)
get_prior(formula = alpha_macro_fat, data = full)
alpha_macro_fat <- log(simpson_reciprocal) ~ 0 +
ave_fiber:empirical +
ave_fat:empirical +
ave_Sugars:empirical +
ave_fiber +
ave_fat +
ave_Sugars +
empirical+
intensity +
TPN+
EN+
(1 | mrn) +
(1 | timebin)
full <- meta %>%
full_join(p2d_diet, by = c("sampleid", "mrn")) %>%
full_join(gcts, by = "sampleid") %>%
mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>%
mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
mutate(mrn = factor(mrn)) %>%
mutate(ave_fiber = ave_fiber/100,
ave_fat = ave_fat/100,
ave_Protein = ave_Protein/100,
ave_Sugars = ave_Sugars/100,
ave_carb = ave_carb/100,
ave_cal = ave_cal/1000
) %>%
mutate(intensityAblative = if_else(intensity == 'ablative', T, F),
intensityNonablative = if_else(intensity == 'nonablative', T, F),
intensityReduced = if_else(intensity == 'reduced', T, F))
# to change the df a little bit
full <- read_csv('../data/090_all_samples_meta_p2d_fg9_dietall_genera90.csv') %>%
mutate(abx = if_else(empirical == 'TRUE', 1, 0),
TPN = if_else(TPN == 'TRUE', 1, 0),
EN = if_else(EN == 'TRUE', 1, 0)) %>%
mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
mutate(      ave_fiber_e= ave_fiber*abx,
ave_fat_e=ave_fat*abx,
ave_Sugars_e=ave_Sugars*abx)
alpha_macro_fat <- log(simpson_reciprocal) ~ 0 +
ave_fiber:empirical +
ave_fat:empirical +
ave_Sugars:empirical +
ave_fiber +
ave_fat +
ave_Sugars +
empirical+
intensity +
TPN+
EN+
(1 | mrn) +
(1 | timebin)
get_prior(formula = alpha_macro_fat, data = full)
alpha_macro_fat <- log(simpson_reciprocal) ~ 0 +
ave_fiber_e +
ave_fat_e +
ave_Sugars_e +
ave_fiber +
ave_fat +
ave_Sugars +
abx+
intensity +
TPN+
EN+
(1 | mrn) +
(1 | timebin)
get_prior(formula = alpha_macro_fat, data = full)
priors_alpha_macro_fat <- c(
# for the macro nutrients
prior(normal(0, 1), class = 'b', coef = "ave_fiber"),
prior(normal(0, 1), class = 'b', coef = "ave_fat"),
prior(normal(0, 1), class = 'b', coef = "ave_Sugars"),
# for the interaction terms
prior(normal(0, 1), class = 'b', coef = "ave_fiber_e"),
prior(normal(0, 1), class = 'b', coef = "ave_fat_e"),
prior(normal(0, 1), class = 'b', coef = "ave_Sugars_e"),
# for the TPN
prior(normal(0, 0.1), class = 'b', coef = "TPN"),
# for the EN
prior(normal(0, 0.1), class = 'b', coef = "EN"),
# for the empirical
prior(normal(0, 0.5), class = 'b', coef = "abx"),
# for the intensity
prior(normal(2, 1), class = 'b', coef = "intensityablative"),
prior(normal(2, 1), class = 'b', coef = "intensityreduced"),
prior(normal(2, 1), class = 'b', coef = "intensitynonablative"))
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(brms)
library(ggpubr)
library(tidybayes)
library(cowplot)
library(ggridges)
library(brmstools)
options(mc.cores = parallel::detectCores())
rstan::rstan_options(auto_write = TRUE)
theme_set(theme_tidybayes() + panel_border())
ncores <- parallel::detectCores()
key <- read_csv('../data/cleaned_diet_data/food_group_color_key_final.csv', col_types = 'ccccc')
axis_text_size <- 10
axis_title_size <- 10
meta <- read_csv('../data/153_combined_META.csv') %>%
mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>%
mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
mutate(mrn = factor(mrn)) %>%
mutate(fg_egg = fg_egg/100,
fg_fruit = fg_fruit/100,
fg_grain = fg_grain/100,
fg_legume = fg_legume/100,
fg_meat = fg_meat/100,
fg_milk = fg_milk/100,
fg_oils = fg_oils/100,
fg_sweets = fg_sweets/100,
fg_veggie = fg_veggie/100) %>%
mutate(abx = if_else(empirical == 'TRUE', 1, 0),
TPN = if_else(TPN == 'TRUE', 1, 0),
EN = if_else(EN == 'TRUE', 1, 0)) %>%
mutate(      fg_fruit_e= fg_fruit*abx,
fg_meat_e=fg_meat*abx,
fg_milk_e=fg_milk*abx,
fg_oils_e=fg_oils*abx,
fg_egg_e=fg_egg*abx,
fg_grain_e=fg_grain*abx,
fg_sweets_e=fg_sweets*abx,
fg_legume_e=fg_legume*abx,
fg_veggie_e = fg_veggie*abx)
div_model  <- log(simpson_reciprocal) ~ 0 +
intensity+
fg_fruit_e+
fg_meat_e+
fg_milk_e+
fg_oils_e+
fg_egg_e+
fg_grain_e+
fg_sweets_e+
fg_legume_e+
fg_veggie_e+
abx+
fg_fruit+
fg_meat+
fg_milk+
fg_oils+
fg_egg+
fg_grain+
fg_sweets+
fg_legume+
fg_veggie+
TPN+
EN+
(1 | mrn) +
(1 | timebin)
get_prior(div_model,data = meta )
div_priors <- c(# for the food group variables
prior(normal(0, 1), class = 'b', coef = "fg_egg"),
prior(normal(0, 1), class = 'b', coef = "fg_fruit"),
prior(normal(0, 1), class = 'b', coef = "fg_grain"),
prior(normal(0, 1), class = 'b', coef = "fg_legume"),
prior(normal(0, 1), class = 'b', coef = "fg_meat"),
prior(normal(0, 1), class = 'b', coef = "fg_milk"),
prior(normal(0, 1), class = 'b', coef = "fg_oils"),
prior(normal(0, 1), class = 'b', coef = "fg_sweets"),
prior(normal(0, 1), class = 'b', coef = "fg_veggie"),
# interaction terms
prior(normal(0, 1), class = 'b', coef = "fg_egg_e"),
prior(normal(0, 1), class = 'b', coef = "fg_fruit_e"),
prior(normal(0, 1), class = 'b', coef = "fg_grain_e"),
prior(normal(0, 1), class = 'b', coef = "fg_legume_e"),
prior(normal(0, 1), class = 'b', coef = "fg_meat_e"),
prior(normal(0, 1), class = 'b', coef = "fg_milk_e"),
prior(normal(0, 1), class = 'b', coef = "fg_oils_e"),
prior(normal(0, 1), class = 'b', coef = "fg_sweets_e"),
prior(normal(0, 1), class = 'b', coef = "fg_veggie_e"),
# for the TPN
prior(normal(0, 0.1), class = 'b', coef = "TPN"),
# for the EN
prior(normal(0, 0.1), class = 'b', coef = "EN"),
# for the empirical
prior(normal(0, 0.5), class = 'b', coef = "abx"),
# for the intensity
prior(normal( 2, 1), class = 'b', coef = "intensityablative"),
prior(normal( 2, 1), class = 'b', coef = "intensityreduced"),
prior(normal( 2, 1), class = 'b', coef = "intensitynonablative")
)
fitPrior <- brm(div_model, data=meta, prior=div_priors,
sample_prior = "only")
pp_check(fitPrior)
pp_check(fitPrior, plotfun = "scatter_avg")
?pp_check
bayesplot::pp_check(fitPrior, plotfun = "scatter_avg")
library(bayesplot)
pp_check(fitPrior, plotfun = "scatter_avg")
pp_check(fitPrior, plotfun = "scatter")
?pp_check
?bayesplot::pp_check
?bayesplot::pp_check
pp_check(fitPrior, fun = "scatter")
bayesplot::pp_check(fitPrior, fun = "scatter")
div_priors <- c(# for the food group variables
prior(normal(0, 1), class = 'b', coef = "fg_egg"),
prior(normal(0, 1), class = 'b', coef = "fg_fruit"),
prior(normal(0, 1), class = 'b', coef = "fg_grain"),
prior(normal(0, 1), class = 'b', coef = "fg_legume"),
prior(normal(0, 1), class = 'b', coef = "fg_meat"),
prior(normal(0, 1), class = 'b', coef = "fg_milk"),
prior(normal(0, 1), class = 'b', coef = "fg_oils"),
prior(normal(0, 1), class = 'b', coef = "fg_sweets"),
prior(normal(0, 1), class = 'b', coef = "fg_veggie"),
# interaction terms
prior(normal(0, 1), class = 'b', coef = "fg_egg_e"),
prior(normal(0, 1), class = 'b', coef = "fg_fruit_e"),
prior(normal(0, 1), class = 'b', coef = "fg_grain_e"),
prior(normal(0, 1), class = 'b', coef = "fg_legume_e"),
prior(normal(0, 1), class = 'b', coef = "fg_meat_e"),
prior(normal(0, 1), class = 'b', coef = "fg_milk_e"),
prior(normal(0, 1), class = 'b', coef = "fg_oils_e"),
prior(normal(0, 1), class = 'b', coef = "fg_sweets_e"),
prior(normal(0, 1), class = 'b', coef = "fg_veggie_e"),
# for the TPN
prior(normal(0, 0.1), class = 'b', coef = "TPN"),
# for the EN
prior(normal(0, 0.1), class = 'b', coef = "EN"),
# for the empirical
prior(normal(0, 0.5), class = 'b', coef = "abx"),
# for the intensity
prior(normal( 2, .1), class = 'b', coef = "intensityablative"),
prior(normal( 2, .1), class = 'b', coef = "intensityreduced"),
prior(normal( 2, .1), class = 'b', coef = "intensitynonablative")
)
fitPrior <- brm(div_model, data=meta, prior=div_priors,
sample_prior = "only")
pp_check(fitPrior, fun = "scatter")
?pp_check
pp_check(fitPrior, ppc = "scatter")
pp_check(fitPrior, plotfun = "boxplot", nreps = 10, notch = FALSE)
