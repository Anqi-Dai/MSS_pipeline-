beta_df %>%
ggscatter(x = 'V1', y = 'V2', color =  'grp', palette = 'lancet',alpha = 1, label = 'sampleid') +
labs(title = '') +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right')
beta_df %>%
ggscatter(x = 'V1', y = 'V2', color =  'grp', palette = 'lancet',alpha = 1, label = 'sampleid') +
labs(title = '') +
xlab(paste0("PC 1 [",percent_var[1],"%]")) +
ylab(paste0("PC 2 [",percent_var[2],"%]")) +
theme(aspect.ratio=1, legend.position = 'right')
# some DE method try Maslin first
if(!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install("Maaslin2")
library(Maaslin2)
View(spp)
spp
library(Maaslin2)
library(Maaslin2)
spp_cts
View(spp)
spp_cts <- spp %>%
filter(clade_name %in% keep_spp)
View(spp_cts)
spp_cts <- spp %>%
filter(clade_name %in% keep_spp) %>%
select(sampleid, clade_name,perc ) %>%
spread(key = 'clade_name', value = 'perc', fill = 0)
spp_cts <- spp %>%
filter(clade_name %in% keep_spp) %>%
select(sampleid, clade_name,perc ) %>%
spread(key = 'clade_name', value = 'perc', fill = 0) %>%
column_to_rownames('sampleid')
View(pheno)
pheno
fit_data <- Maaslin2(
input_data = spp_cts,
input_metadata = pheno,
normalization = "NONE",
output = "output",
fixed_effects = c("grp"),
reference = c("grp,BM"))
pheno
fit_data <- Maaslin2(
input_data = spp_cts,
input_metadata = pheno %>% column_to_rownames('sampleid'),
normalization = "NONE",
output = "output",
fixed_effects = c("grp"),
reference = c("grp,BM"))
spp %>%
filter(clade_name %in% keep_spp)
spp_cts <- spp %>%
filter(clade_name %in% keep_spp) %>%
mutate(gspp = str_extract(clade_name, 'g__.+$'))
spp_cts <- spp %>%
filter(clade_name %in% keep_spp) %>%
mutate(gspp = str_extract(clade_name, 'g__.+$')) %>%
select(sampleid, gspp,perc ) %>%
spread(key = 'gspp', value = 'perc', fill = 0) %>%
column_to_rownames('sampleid')
library(Maaslin2)
spp_cts <- spp %>%
filter(clade_name %in% keep_spp) %>%
mutate(gspp = str_extract(clade_name, 'g__.+$')) %>%
select(sampleid, gspp,perc ) %>%
spread(key = 'gspp', value = 'perc', fill = 0) %>%
column_to_rownames('sampleid')
fit_data <- Maaslin2(
input_data = spp_cts,
input_metadata = pheno %>% column_to_rownames('sampleid'),
normalization = "NONE",
output = "../data/output",
fixed_effects = c("grp"),
reference = c("grp,BM"))
?Maaslin2
# looking at the results from Maaslin2
res <- read_tsv('../data/output/significant_results.tsv')
View(res)
# looking at the results from Maaslin2
res <- read_tsv('../data/output/significant_results.tsv')
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
# I could do something similar to the dosage thing in diversity and the three food groups
# only eggs and the enterococcus
postres <- read_csv('../data/087_Enterococcus_model_fg_post.csv')
View(postres)
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv') %>%
mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>%
mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>%
mutate(mrn = factor(mrn)) %>%
mutate(fg_egg = fg_egg/100,
fg_fruit = fg_fruit/100,
fg_grain = fg_grain/100,
fg_legume = fg_legume/100,
fg_meat = fg_meat/100,
fg_milk = fg_milk/100,
fg_oils = fg_oils/100,
fg_sweets = fg_sweets/100,
fg_veggie = fg_veggie/100)
View(meta)
meta
eggs <- meta %>%
select(fg_egg)
eggs
meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max))
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max)) %>%
gather
eggs
meta %>%
select(fg_egg)
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max)) %>%
gather
eggs
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max)) %>%
gather
eggs
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max))
eggs
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max, quantile(., probs = seq(0.1, 1, 0.05))))
eggs
View(eggs)
seq(0.1, 1, 0.05)
quantile(., probs = seq(0.1, 0.95, 0.05)
seq(0.1, 0.95, 0.05)
seq(0.1, 0.95, 0.05)
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max,min,  quantile(., probs = seq(0.1, 0.95, 0.05))))
eggs
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))
View(eggs_quantiles)
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05))
quantile(meta$fg_egg, probs = o.95)
quantile(meta$fg_egg, probs = 0.95)
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max,min))
View(eggs)
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max,min))
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(quants = str_glue('q{quants}'))
eggs_quantiles
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max,min))
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(quants = str_glue('q{quants}')) %>%
spread('quants', 'fg_egg')
eggs_quantiles
eggs_ <- bind_cols(eggs, eggs_quantiles)
View(eggs_)
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max,min))
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(quants = str_glue('q{quants}')) %>%
spread('quants', 'fg_egg')
eggs_ <- bind_cols(eggs, eggs_quantiles)  %>%
as.list()
View(eggs_)
mean_fg <-  meta %>%
select(starts_with('fg')) %>%
summarise_all(funs(mean))
eggs_
eggs_ %>%
pluck('max')
eggs_
eggs_
eggs_
# I could do something similar to the dosage thing in diversity and the three food groups
# only eggs and the enterococcus
post_coeffs <- read_csv('../data/087_Enterococcus_model_fg_post.csv')
post_coeffs
View(post_coeffs)
post_coeffs
View(post_coeffs)
post_coeffs$b_intensityreduced
View(mean_fg)
mean_fg
mean_fg
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
})
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
})
View(dose_pred_eggs)
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
}) %>%
bind_rows()
View(dose_pred_eggs)
10^2
10^3
dose_pred_eggs
others <- dose_pred_eggs %>%
select(-mean)
View(others)
others <- dose_pred_eggs %>%
select(-mean) %>%
as.list()
View(others)
others
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
})
View(diffs)
View(diffs)
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows()
View(diffs)
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows()
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather
View(diffs)
diffs
# plotting
diffs %>%
ggboxplot(x = 'value', y = 'key')
diffs
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal') +
scale_y_sqrt()
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)') +
scale_y_sqrt()
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)') +
scale_y_sqrt()
ggsave('../data/119_egg_enter_pred.png')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)') +
scale_y_sqrt()
10^(column) -
10^(dose_pred_eggs$mean)
10^(dose_pred_eggs$mean)
View(others)
10^(-1.59)
View(diffs)
View(diffs)
diffs %>% summarise()
diffs
diffs %>% summarise(value)
summary(diffs$value)
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png')
# find out a series of values for different amounts of egg consumption
eggs <- meta %>%
select(fg_egg) %>%
summarise_all(funs(mean, max, min))
eggs_quantiles <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(quants = str_glue('q{quants}')) %>%
spread('quants', 'fg_egg')
eggs_ <- bind_cols(eggs, eggs_quantiles)  %>%
as.list()
dose_pred_eggs  <- eggs_ %>%
map(function(val) {
res =
post_coeffs$b_fg_egg * val +
post_coeffs$b_fg_fruit * mean_fg$fg_fruit +
post_coeffs$b_fg_grain * mean_fg$fg_grain +
post_coeffs$b_fg_legume * mean_fg$fg_legume +
post_coeffs$b_fg_meat * mean_fg$fg_meat +
post_coeffs$b_fg_milk * mean_fg$fg_milk+
post_coeffs$b_fg_oils * mean_fg$fg_oils +
post_coeffs$b_fg_sweets * mean_fg$fg_sweets +
post_coeffs$b_fg_veggie * mean_fg$fg_veggie +
post_coeffs$b_intensityreduced
}) %>%
bind_rows()
others <- dose_pred_eggs %>%
select(-mean) %>%
as.list()
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather
# plotting
diffs %>%
ggboxplot(x = 'key', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png')
ggsave('../data/119_egg_enter_pred.png', width = 10)
View(eggs_quantiles)
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05))
View(eggs_quantiles)
View(eggs_quants)
eggs_quants
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = seq(0.1, 0.95, 0.05))))  %>%
mutate(quants = seq(0.1, 0.95, 0.05)) %>%
mutate(fg_egg = fg_egg *100)
View(diffs)
c(0, seq(0.1, 1, 0.05))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = fg_egg *100)
diffs
View(diffs)
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = fg_egg *100) %>%
mutate(quants = str_glue('q{quants}'))
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather %>%
mutate(key = if_else(key == 'max', 'q1', key),
key = if_else(key == 'min', 'q0', key))
diffs
eggs_quants
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather %>%
mutate(key = if_else(key == 'max', 'q1', key),
key = if_else(key == 'min', 'q0', key)) %>%
left_join(eggs_quants %>% rename(key = quants))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}'))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}')) %>%
mutate(fg_egg = str_glue('{fg_egg}g'))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}'))
eggs_quants <- meta %>%
select(fg_egg) %>%
summarise_all(funs( quantile(., probs = c(0, seq(0.1, 1, 0.05)))))  %>%
mutate(quants = c(0, seq(0.1, 1, 0.05))) %>%
mutate(fg_egg = round(fg_egg *100, 1)) %>%
mutate(quants = str_glue('q{quants}')) %>%
mutate(fg_egg = str_glue('{fg_egg}g'))
diffs <- others %>%
map(function(column){
10^(column) - 10^(dose_pred_eggs$mean)
}) %>% bind_rows() %>%
gather %>%
mutate(key = if_else(key == 'max', 'q1', key),
key = if_else(key == 'min', 'q0', key)) %>%
left_join(eggs_quants %>% rename(key = quants)) %>%
mutate(xlabel = str_glue('{key}({fg_egg})'))
# plotting
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10%_quantile\n...90%_quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating max/10% quantile\n...90% quantile of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating different quantiles of eggs compared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
# plotting
diffs %>%
ggboxplot(x = 'xlabel', y = 'value', orientation = 'horizontal', xlab = 'different levels of egg intake in the previous two days',
ylab = 'predicted change in Enterococcus relab when eating different quantiles of eggs\ncompared to avg egg intake(the other food group kept at the avg)')
ggsave('../data/119_egg_enter_pred.png', width = 10)
