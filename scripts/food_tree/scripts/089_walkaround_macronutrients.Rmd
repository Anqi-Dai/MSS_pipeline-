---
title: "The walkaround macronutrients"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(tidybayes)  
library(brms)
library(rstan)
#devtools::install_github("zeehio/facetscales")
library(facetscales)
options(mc.cores = parallel::detectCores())
ncores = parallel::detectCores()
rstan_options(auto_write = TRUE)
axis_text_size <- 10
axis_title_size <- 10
```

**Same day** macro nutrients with calories and stool sample 

# the 3 by 2 grid scatter plot

```{r}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
full <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')

byday <- dtb %>% 
  group_by(mrn, fdrt) %>% 
  summarise(daycal = sum(Calories_kcal),
            d_protein = sum(Protein_g),
            d_fat = sum(Fat_g),
            d_carb = sum(Carbohydrates_g),
            d_fiber = sum(Fibers_g),
            d_sugar = sum(Sugars_g)) %>% 
  rename(drt = fdrt) %>% 
  inner_join(full %>% 
               rename(drt = sdrt) %>% 
               select(mrn,drt, simpson_reciprocal, intensity, empirical, TPN, EN, Actinomyces: Veillonella), by = c("mrn", "drt")) %>% 
  mutate(timebin = cut_width(drt, 7, boundary=0, closed = 'left')) %>% 
  mutate(mrn = factor(mrn)) %>% 
  mutate(d_fiber = d_fiber/100,
         d_fat = d_fat/100,
         d_protein = d_protein/100,
         d_sugar = d_sugar/100,
         d_carb = d_carb/100,
         daycal = daycal/1000
         ) %>% 
  mutate(inten_non = if_else(intensity == 'nonablative', 1, 0),
         inten_ab = if_else(intensity == 'ablative', 1, 0),
         inten_re = if_else(intensity == 'reduced', 1, 0)) %>% 
  ungroup()

byday_original <- dtb %>% 
  group_by(mrn, fdrt) %>% 
  summarise(daycal = sum(Calories_kcal),
            d_protein = sum(Protein_g),
            d_fat = sum(Fat_g),
            d_carb = sum(Carbohydrates_g),
            d_fiber = sum(Fibers_g),
            d_sugar = sum(Sugars_g)) %>% 
  rename(drt = fdrt) %>% 
  inner_join(full %>% 
               rename(drt = sdrt) %>% 
               select(mrn,drt, simpson_reciprocal, intensity, empirical, TPN, EN, Actinomyces: Veillonella), by = c("mrn", "drt")) %>% 
  ungroup()

byday %>% write_csv('../data/089_sameday_diet_and_microbiome.csv')
byday_original %>% distinct(mrn, fdrt)
```

```{r}
macro_panel <- byday_original %>% 
  mutate(simpson_reciprocal_nlog  = log(simpson_reciprocal)) %>% 
  rename(`log10(Blautia)` = Blautia,
         `log10(Enterococcus)` = Enterococcus,
         `log(Simpson reciprocal)` = simpson_reciprocal_nlog) %>% 
  dplyr::select(`log(Simpson reciprocal)`, `log10(Blautia)`, `log10(Enterococcus)`,  daycal:d_sugar ) %>% 
  mutate(daycal = daycal/1000) %>%  # now divide the value by 1000 to save some space in x axis text!!! 
  gather('yaxis', 'value', `log(Simpson reciprocal)`:`log10(Enterococcus)`) %>% 
  mutate(yaxis = factor(yaxis, levels = c('log(Simpson reciprocal)','log10(Blautia)','log10(Enterococcus)'))) %>% 
  gather('xaxis', 'number', daycal:d_sugar) %>% 
  mutate(xaxis = factor(xaxis, levels = c('daycal','d_carb','d_sugar','d_fiber','d_protein','d_fat'))) %>% 
  mutate(xaxis = if_else(str_detect(xaxis, '^d_'), str_replace(xaxis, 'd_',''), str_replace(xaxis, '^day','')),
         xaxis = if_else(str_detect(xaxis, 'cal'), str_replace(xaxis, 'cal','caloric'), xaxis),
         xaxis = str_to_title(xaxis),
         xaxis = str_glue('Daily {xaxis} Intake')) %>% 
  mutate(xaxis = factor(xaxis, levels = c('Daily Caloric Intake','Daily Carb Intake','Daily Sugar Intake','Daily Fiber Intake','Daily Protein Intake','Daily Fat Intake')))
 
```


```{r}
library(facetscales)
scales_y <- list(
  `log(Simpson reciprocal)` = scale_y_continuous(limits = c(0, 4), breaks = seq(0, 4, 1)),
  `log10(Blautia)` = scale_y_continuous(limits = c(-6, 0), breaks = seq(-6, 0, 2)),
  `log10(Enterococcus)` = scale_y_continuous(limits = c(-6, 0), breaks = seq(-6, 0, 2))
)

scales_x <- list(
  `Daily Caloric Intake` = scale_x_continuous(limits = c(0, 3.3), breaks = seq(0, 3.3, 1)),
  `Daily Protein Intake` = scale_x_continuous(limits = c(0, 170), breaks = seq(0, 170, 50)),
  `Daily Fat Intake` = scale_x_continuous(limits = c(0, 165), breaks = seq(0, 165, 50)),
  `Daily Carb Intake` = scale_x_continuous(limits = c(0, 410), breaks = seq(0, 410, 100)),
  `Daily Fiber Intake` = scale_x_continuous(limits = c(0, 80), breaks = seq(0, 80, 20)),        
  `Daily Sugar Intake` = scale_x_continuous(limits = c(0, 325), breaks = seq(0, 325, 100) )
)


macro_facets <- macro_panel %>% 
  ggscatter(x = 'number', y = 'value', alpha = 0.05, xlab = '', ylab = '',size = 1.2, 
             add = "reg.line",  # Add regressin line
           add.params = list(color = "darkblue", fill = "gray59"), # Customize line
           conf.int = TRUE, # Add confidence interval
          ) +
  facet_grid_sc(rows = vars(yaxis), cols = vars(xaxis), scales = list(y = scales_y, x = scales_x)) +
  theme_classic(base_size = 11) +
  theme(aspect.ratio = 1,
        panel.background = element_rect(fill = "gray97"),
        panel.grid.major = element_blank(), 
        strip.background = element_blank(),
        strip.text = element_blank(),
        panel.grid.minor = element_blank()
       ) 

ggsave('../figs/paper/S2_sameday_macronutrients_microbiome_089.pdf', 
       width = 180, 
       units = c("mm"),
       plot = macro_facets)

```

```{r}
# since I need to annotate the p value of the slope I can't do it in facet wrap
# need to manually arrange them

# calculate the p value of the slopes
pvals <- macro_panel %>% 
  split(., list(.$xaxis, .$yaxis)) %>% 
  map(function(df) {
    res = summary(lm(value ~ number, data = df ))
    return(pval = round(res$coefficients[2, 'Pr(>|t|)'], 3))
  })
# 
# dfs <- macro_panel %>% 
#   split(., list(.$xaxis, .$yaxis))
# 
# panels <- list()
# 
# 
# for (i in 1: length(dfs)){
#   panels[[i]] <- dfs[[i]] %>% 
#   ggscatter(x = 'number', y = 'value', alpha = 0.05, xlab = '', ylab = '',size = 1.2, 
#              add = "reg.line",  # Add regressin line
#            add.params = list(color = "darkblue", fill = "lightgray"), # Customize line
#            conf.int = TRUE # Add confidence interval
#            ) +
#   theme_classic(base_size = 11) +
#   theme(aspect.ratio = 1,
#         panel.grid.major = element_blank(), 
#         panel.grid.minor = element_blank()
#        )  +
#   annotate("text", x = 100, y = 0, label = str_glue("paste(italic(p), \" = {pvals[[i]]}\")"), parse = TRUE)
# }
# names(panels) <- names(dfs)
```


```{r}
library(gridExtra)
n <- length(dfs)
nCol <- 6
all <- do.call("grid.arrange", c(panels, ncol=nCol))
 
ggsave('../figs/paper/S2_sameday_macronutrients_microbiome_089_2.pdf', 
       width = 190, 
       units = c("mm"),
       plot = all)
```


