---
title: "The walkaround macronutrients"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(tidybayes)  
library(brms)
library(rstan)
options(mc.cores = parallel::detectCores())
ncores = parallel::detectCores()
rstan_options(auto_write = TRUE)
axis_text_size <- 10
axis_title_size <- 10
```

**Same day** macro nutrients with calories and stool sample 

# the 3 by 2 grid scatter plot

```{r}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
full <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')

byday <- dtb %>% 
  group_by(mrn, fdrt) %>% 
  summarise(daycal = sum(Calories_kcal),
            d_protein = sum(Protein_g),
            d_fat = sum(Fat_g),
            d_carb = sum(Carbohydrates_g),
            d_fiber = sum(Fibers_g),
            d_sugar = sum(Sugars_g)) %>% 
  rename(drt = fdrt) %>% 
  inner_join(full %>% 
               rename(drt = sdrt) %>% 
               select(mrn,drt, simpson_reciprocal, intensity, empirical, TPN, EN, Actinomyces: Veillonella), by = c("mrn", "drt")) %>% 
  mutate(timebin = cut_width(drt, 7, boundary=0, closed = 'left')) %>% 
  mutate(mrn = factor(mrn)) %>% 
  mutate(d_fiber = d_fiber/100,
         d_fat = d_fat/100,
         d_protein = d_protein/100,
         d_sugar = d_sugar/100,
         d_carb = d_carb/100,
         daycal = daycal/1000
         ) %>% 
  mutate(inten_non = if_else(intensity == 'nonablative', 1, 0),
         inten_ab = if_else(intensity == 'ablative', 1, 0),
         inten_re = if_else(intensity == 'reduced', 1, 0)) %>% 
  ungroup()

byday_original <- dtb %>% 
  group_by(mrn, fdrt) %>% 
  summarise(daycal = sum(Calories_kcal),
            d_protein = sum(Protein_g),
            d_fat = sum(Fat_g),
            d_carb = sum(Carbohydrates_g),
            d_fiber = sum(Fibers_g),
            d_sugar = sum(Sugars_g)) %>% 
  rename(drt = fdrt) %>% 
  inner_join(full %>% 
               rename(drt = sdrt) %>% 
               select(mrn,drt, simpson_reciprocal, intensity, empirical, TPN, EN, Actinomyces: Veillonella), by = c("mrn", "drt")) %>% 
  ungroup()

byday %>% write_csv('../data/089_sameday_diet_and_microbiome.csv')

```

```{r}
macro_panel <- byday_original %>% 
  mutate(simpson_reciprocal_nlog  = log(simpson_reciprocal)) %>% 
  rename(`log10(Blautia)` = Blautia,
         `log10(Enterococcus)` = Enterococcus,
         `log(Simpson reciprocal)` = simpson_reciprocal_nlog) %>% 
  dplyr::select(`log(Simpson reciprocal)`, `log10(Blautia)`, `log10(Enterococcus)`,  daycal:d_sugar ) %>% 
  gather('yaxis', 'value', `log(Simpson reciprocal)`:`log10(Enterococcus)`) %>% 
  mutate(yaxis = factor(yaxis, levels = c('log(Simpson reciprocal)','log10(Blautia)','log10(Enterococcus)'))) %>% 
  gather('xaxis', 'number', daycal:d_sugar) %>% 
  mutate(xaxis = factor(xaxis, levels = c('daycal','d_carb','d_sugar','d_fiber','d_protein','d_fat'))) %>% 
  mutate(xaxis = if_else(str_detect(xaxis, '^d_'), str_replace(xaxis, 'd_',''), str_replace(xaxis, '^day','')),
         xaxis = if_else(str_detect(xaxis, 'cal'), str_replace(xaxis, 'cal','caloric'), xaxis),
         xaxis = str_to_title(xaxis),
         xaxis = str_glue('Daily {xaxis} Intake')) %>% 
  mutate(xaxis = factor(xaxis, levels = c('Daily Caloric Intake','Daily Carb Intake','Daily Sugar Intake','Daily Fiber Intake','Daily Protein Intake','Daily Fat Intake')))


```


```{r}
macro_panel %>% 
  ggscatter(x = 'number', y = 'value', alpha = 0.2,xlab = '', ylab = '',size = 1.2, 
             add = "reg.line",  # Add regressin line
           add.params = list(color = "blue", fill = "lightgray"), # Customize line
           conf.int = TRUE, # Add confidence interval
           cor.coef = TRUE, # Add correlation coefficient.
           cor.coeff.args = list(method = "spearman", 
                                 label.sep = "\n", 
                                 label.x.npc = "middle", 
                                 label.y.npc = "top",
                                 size = 3,
                                 color = 'red')) +
  facet_grid(yaxis ~ xaxis, scales = 'free') + 
  theme_bw(base_size = 11) +
  theme(aspect.ratio = 1,
        panel.grid.major = element_blank(), 
        #strip.background = element_blank(),
        #strip.text = element_blank(),
        panel.grid.minor = element_blank()
       ) 
```

```{r}
# since I need to annotate the p value of the slope I can't do it in facet wrap
# need to manually arrange them

# calculate the p value of the slopes
pvals <- macro_panel %>% 
  split(., list(.$xaxis, .$yaxis)) %>% 
  map(function(df) {
    res = summary(lm(value ~ number, data = df ))
    return(pval = round(res$coefficients[2, 'Pr(>|t|)'], 3))
  })

dfs <- macro_panel %>% 
  split(., list(.$xaxis, .$yaxis))

panels <- list()


for (i in 1: length(dfs)){
  panels[[i]] <- dfs[[i]] %>% 
  ggscatter(x = 'number', y = 'value', alpha = 0.05, xlab = '', ylab = '',size = 1.2, 
             add = "reg.line",  # Add regressin line
           add.params = list(color = "darkblue", fill = "lightgray"), # Customize line
           conf.int = TRUE # Add confidence interval
           ) +
  theme_classic(base_size = 11) +
  theme(aspect.ratio = 1,
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()
       )  +
  annotate("text", x = 100, y = 0, label = str_glue("paste(italic(p), \" = {pvals[[i]]}\")"), parse = TRUE)
}
names(panels) <- names(dfs)
```

```{r}
# some tweaking of the figures
# limit the middle row y axis to be below 0
for (i in 1: length(dfs)){
  if(str_detect(names(dfs)[[i]], 'Blautia')){
    panels[[i]] <- dfs[[i]] %>% 
  ggscatter(x = 'number', y = 'value', alpha = 0.05, xlab = '', ylab = '',size = 1.2, 
             add = "reg.line",  # Add regressin line
           add.params = list(color = "darkblue", fill = "lightgray"), # Customize line
           conf.int = TRUE # Add confidence interval
           ) +
  theme_classic(base_size = 11) +
  theme(aspect.ratio = 1,
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()
       )  +
  annotate("text", x = 100, y = 0, label = str_glue("paste(italic(p), \" = {pvals[[i]]}\")"), parse = TRUE) +
      ylim(-6, 0)
  }
}

# all the other columns except the first column won't have y axis text
# all the other rows except the bottom row won't have x text
for (i in 1: length(dfs)){
  if(!str_detect(names(dfs)[[i]], 'Enteroco|Caloric')){
    panels[[i]] <- dfs[[i]] %>% 
  ggscatter(x = 'number', y = 'value', alpha = 0.05, xlab = '', ylab = '',size = 1.2, 
             add = "reg.line",  # Add regressin line
           add.params = list(color = "darkblue", fill = "lightgray"), # Customize line
           conf.int = TRUE # Add confidence interval
           ) +
  theme_classic(base_size = 11) +
  theme(aspect.ratio = 1,
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()
       )  +
  annotate("text", x = 100, y = 0, label = str_glue("paste(italic(p), \" = {pvals[[i]]}\")"), parse = TRUE)
  }
}
```


```{r}
library(gridExtra)
n <- length(dfs)
nCol <- 6
all <- do.call("grid.arrange", c(panels, ncol=nCol))
ggsave('../figs/paper/S2_sameday_macronutrients_microbiome_089.pdf', 
       width = 18, 
       height = 9,
       plot = all)

```


