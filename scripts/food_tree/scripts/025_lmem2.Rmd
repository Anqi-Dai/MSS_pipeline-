---
title: "the other way around linear mixed effects"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:  
    toc: true
    toc_float: true 
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(lmerTest)
library(ggpubr)
```

```{r}
dat <- read_csv('../data/cleaned_stool/all_samples_meta_p2d.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(abx = factor(abx, levels = c('non_empirical','empirical')))

fac_col <- c('mrn','source',  'sex', 'abx')

dat[fac_col] <- lapply(dat[fac_col], factor)  
colnames(dat)

summary(dat)

dat2 <- dat %>% 
  #mutate(abx = as.character(abx)) %>% 
  filter(abx == 'non_empirical')
dat %>% 
  distinct(mrn, .keep_all = T)  %>% 
  dplyr::count(intensity)
```

```{r}
# visualize how the alpha div change according to time
dat %>% 
  ggscatter(x = 'sdrt', y = 'simpson_reciprocal',alpha = 0.5, 
   add = "loess", conf.int = TRUE) 
```


# important food groups one by one

```{r}
mod23 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

mod23_2 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                sdrt^2 +
                #sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)
anova(mod23, mod23_2)
# It doesn't seem I need to use the time square term
```


```{r}
mod24 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               fg_meat+
               #fg_milk+
               #fg_oils+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod24)

# yes meat!
```


```{r}
mod25 <-  lmer(simpson_reciprocal ~ 
              fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod25)
# no fruit 
```
```{r}
mod26 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               fg_milk+
               #fg_oils+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod26)
# yes milk!
```
```{r}
mod27 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               fg_oils+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod27)
# yes oil!
```
```{r}
mod34 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                fg_egg+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod34)
# yes egg!
```

```{r}
mod35 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                #fg_egg+
                fg_grain+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod35)
# yes grain!
```
```{r}
mod36 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                #fg_egg+
                #fg_grain+
                fg_sweets+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod36)
#no sweets!
```
```{r}
mod37 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                #fg_egg+
                #fg_grain+
                #fg_sweets+
                fg_legume+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod37)
# no legume
```
```{r}
mod38 <-  lmer(simpson_reciprocal ~ 
              #fg_fruit+
               #fg_meat+
               #fg_milk+
               #fg_oils+
                #fg_egg+
                #fg_grain+
                #fg_sweets+
                #fg_legume+
                fg_veggie+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod38)
# yes fg_veggie!
```

 
# if only looking at nutrients

```{r}
mod28 <-  lmer(simpson_reciprocal ~ 
                Nut_Carbohydrates +
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod28)

# yes Nut_Carbohydrates!
```

```{r}
mod29 <-  lmer(simpson_reciprocal ~ 
                Nut_Fat +
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod29)

# yes Nut_Fat! 
```

```{r}
mod30 <-  lmer(simpson_reciprocal ~ 
                Nut_Proteing +
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod30)

# yes protein!
```
```{r}
mod31 <-  lmer(simpson_reciprocal ~ 
                Nut_Fibers +
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod31)

# no fiber! 
```
```{r}
mod32 <-  lmer(simpson_reciprocal ~ 
                Nut_Sugars +
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod32)
# no Nut_Sugars
```
```{r}
mod33 <-  lmer(simpson_reciprocal ~ 
                Nut_Sodium +
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = FALSE, data = dat)

anova(mod23, mod33)
# yes Nut_Sodium
```

**sodium, fat, protein is important**

# use some functions to do backward model selection

```{r}
# compute correlation matrix for the fg and nut
fmetrics <- dat %>% 
  select(fg_egg:Nut_Sugars)

f_cor <- cor(fmetrics, method = "pearson")

library(caret)
f_cor_res <- findCorrelation(f_cor, names = T)
f_cor_res
```
```{r}
mod99 <-  lmer(simpson_reciprocal ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
                Nut_Carbohydrates+
                Nut_Fat+
                Nut_Fibers+
                Nut_Proteing+
                Nut_Sodium+
                Nut_Sugars+
                sdrt+
               abx + 
               source + 
               age +
               (1 + abx | mrn), REML = F, data = dat)
step(mod99)

head(dat$timebin)
```

# finalizing the model: what I care about and wanna model?

```{r}
mod102 <-  lmer(simpson_reciprocal ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin), REML = F, data = dat )
summary(mod102)
```

# why is fruit decreasing the diversity 

## pariwise correlation between the food group columns

```{r}
library(arrangements)

fgs <- dat %>% 
  select(starts_with('fg_'))

pw_cor <- cor(fgs, method = 'spearman')

library(pheatmap)

pheatmap(
  pw_cor,
  #color=bwrPalette, 
  #annotation_col = annot,
  show_rownames = TRUE,
  show_colnames = TRUE,
  #filename = '../data/spearman.pairwise.cor.noTrans.jpeg',
  height = 8,
  width = 8,
  angle_col = '45',
  display_numbers = T,
  cluster_rows =T,
  cluster_cols=T
)


# 
fgs_ <- fgs %>% 
  mutate(rowsum = rowSums(.))
pw_cor_ <- cor(fgs_, method = 'spearman')

pheatmap(
  pw_cor_,
  #color=bwrPalette, 
  #annotation_col = annot,
  show_rownames = TRUE,
  show_colnames = TRUE,
  #filename = '../data/spearman.pairwise.cor.noTrans.jpeg',
  height = 8,
  width = 8,
  angle_col = '45',
  display_numbers = T,
  cluster_rows =T,
  cluster_cols=T
)
```


## when do patients eat fruits?

```{r}
dat %>% 
  mutate(fg_fruit = scale(fg_fruit)) %>% 
  ggplot(aes(x = timebin, y = fg_fruit)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = 'jitter', alpha = 0.5, size = 2, col = 'forestgreen') +
  theme_bw()
```

```{r}
# calculate the average fruit consumption by each timebin
dat %>% 
  group_by(timebin) %>% 
  summarise(timebin_ave = mean(fg_fruit))
```

## Plot individual patients over time with fruit and diversity shown



```{r}
dat %>% 
  select(mrn, sdrt, simpson_reciprocal, fg_fruit) %>% 
  ggplot() +
  geom_line(mapping = aes(x = sdrt, y = fg_fruit), color = '#1B9E77') +
  geom_point(mapping = aes(x = sdrt, y = fg_fruit), color = '#1B9E77') +
  geom_line(mapping = aes(x = sdrt, y = simpson_reciprocal), color = '#A6761D') +
  geom_point(mapping = aes(x = sdrt, y = simpson_reciprocal), color = '#A6761D') +
  #scale_color_manual(values = c('#1B9E77','#A6761D')) +
  facet_wrap(~mrn, scales = 'free_y')  +
  #scale_y_continuous("Fruit consumption (g)", sec.axis = sec_axis(~ . / 4, name = "simpson_reciprocal")) +
  theme_bw()+
  theme(
  strip.text.x = element_blank(),
  legend.position = 'bottom'
) +
  ggsave('../figs/97_fruit_diversity.pdf', width = 20, height = 17)

range(dat$simpson_reciprocal)
range(dat$fg_fruit)
 
```

## how this model predicts diversity for most extreme fruit eaters

```{r}
# the top 10 and bottom 10 fruit eaters
mean_fruit <- dat %>% 
  group_by(mrn) %>% 
  summarise(fruit_mean = mean(fg_fruit)) %>% 
  arrange(-fruit_mean) %>% 
  ungroup() %>% 
  pull(mrn)

dat %>% 
  ggboxplot(x = 'mrn', y = 'fg_fruit', add = 'jitter', order = mean_fruit) +
  geom_boxplot(outlier.shape = NA)  +
  ggsave('../figs/fruit_boxplot_mrn_mean.pdf', width = 10, height = 6)

N <- 10
top10 <- as.character(head(mean_fruit, N))
bottom10 <- as.character(tail(mean_fruit, N))

prediction_subset <- dat %>% 
  filter(mrn %in% c(top10, bottom10))


predicted_ <- predict(mod102,newdata=dat,allow.new.levels=TRUE)

tibble(
  observed = dat$simpson_reciprocal,
  predicted = predicted_,
  mrn = dat$mrn
) %>% 
  ggscatter(x = 'observed', y = 'predicted', 
            #color = 'mrn',
            add = "reg.line",  # Add regressin line
           add.params = list(color = "blue", fill = "lightgray"), # Customize line
           conf.int = TRUE, # Add confidence interval
           cor.coef = TRUE, # Add correlation coefficient.
           cor.coeff.args = list(method = "pearson", label.x = 3, label.sep = "\n"),
           xlab = 'Observed simpson reciprocal',
           ylab = 'Predicted simpson reciprocal',
           title = 'Observed VS predicted diversity from LMEM (Pearson correlation)') +
  theme(legend.position = 'none')

```

For scoring this is enough


## this prediction, split 20 80 and do 10 times and then calculate average

```{r}
n <- nrow(dat)

split_mod_predi <- function(){
  ind <- sample(c(TRUE, FALSE), n, replace=TRUE, prob=c(0.7, 0.3))
  modd <- dat[ind, ]
  valid <- dat[!ind, ]
  
  model <- lmer(simpson_reciprocal ~ 
                fg_fruit+
                 fg_meat+
                 fg_milk+
                 fg_oils+
                  fg_egg+ 
                  fg_grain+
                  fg_sweets+
                  fg_legume+
                  fg_veggie+
                 abx + 
                 intensity + 
                 (1 | mrn) +
                  (1 | timebin), REML = F, data = modd )
  pred <- predict(model,newdata=valid,allow.new.levels=TRUE)
  
  df = tibble(
    observed = valid$simpson_reciprocal,
    predicted = pred)
  return(df)
}

rep_N <- list()
for(i in 1:10){
  rep_N[[i]] = split_mod_predi()
}

pearson_cor <- rep_N %>% 
  set_names(paste("P", seq(1,10), sep = '')) %>% 
  map_dfr(~ cor(.$observed, .$predicted, method = 'pearson')) %>% 
  gather('id', 'Pearson') 

pearson_cor %>% 
  mutate(Pearson = round(Pearson, 2)) %>% 
  ggboxplot(y = 'Pearson', label = T, add = 'point')
```

## swab fruit consumptions for high and low eaters 

what if low fruit eaters had eaten a lot of fruit or what if high fruit eaters had eaten less fruit, then compare the predictions with the real vs the swabbed diet. so the point is to see how the coeffs of fruit is in effects when you consider a patients amounts of fruit consumption

```{r}
tope <- dat %>% 
  filter(mrn %in% top10)

bote <- dat %>% 
  filter(mrn %in% bottom10)

# get the highest number fruit 61 from the tope df
tope_ <- tope %>% 
  arrange(-fg_fruit) 

tope__ <- tope_[1:nrow(bote),]

high_eater_swab <- tope__ %>% 
  mutate(fg_fruit = bote$fg_fruit)

low_eater_swab <- bote %>% 
  mutate(fg_fruit = tope__$fg_fruit)

high_eater_swab_pred <- predict(mod102,newdata=high_eater_swab,allow.new.levels=TRUE)
high_eater_real_pred <- predict(mod102,newdata=tope__,allow.new.levels=TRUE)

high_eater_swab_both <- tibble(
  true = tope__$simpson_reciprocal,
  swab_predict = high_eater_swab_pred,
  real_predict = high_eater_real_pred
) %>% 
  gather('type', 'value', swab_predict:real_predict)

high_eater_swab_both %>% 
  ggscatter(x = 'true', y = 'value', 
            xlab = 'True diversity', ylab = 'Predicted diversity',
            add = "reg.line", 
            add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
           conf.int = TRUE, # Add confidence interval
           cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
           cor.coeff.args = list(method = "pearson", label.x = 3, label.sep = "\n"),
           title = 'Top eaters') +
  facet_grid(~type)

high_eater_swab_both %>% 
  ggscatter(x = 'true', y = 'value', color = 'type', palette = 'lancet',
            xlab = 'Observed diversity', ylab = 'Predicted diversity',
            title = 'Top eaters')  +
  geom_line(aes(group = true), color = "grey", alpha = 0.8)
  
```

```{r}
low_eater_swab_pred <- predict(mod102,newdata=low_eater_swab,allow.new.levels=TRUE)
low_eater_real_pred <- predict(mod102,newdata=bote,allow.new.levels=TRUE)

low_eater_swab_both <- tibble(
  true = bote$simpson_reciprocal,
  swab_predict = low_eater_swab_pred,
  real_predict = low_eater_real_pred
) %>% 
  gather('type', 'value', swab_predict:real_predict)
 
low_eater_swab_both %>% 
  ggscatter(x = 'true', y = 'value', xlab = 'True diversity', ylab = 'Predicted diversity',
            title = 'Bottom eaters',
            add = "reg.line", 
             add.params = list(color = "blue", fill = "lightgray"), # Customize reg. line
           conf.int = TRUE, # Add confidence interval
           cor.coef = TRUE, # Add correlation coefficient. see ?stat_cor
           cor.coeff.args = list(method = "pearson", label.x = 3, label.sep = "\n")) +
  facet_grid(~type)


low_eater_swab_both %>% 
  ggscatter(x = 'true', y = 'value', color = 'type', palette = 'lancet',
            xlab = 'Observed diversity', ylab = 'Predicted diversity',
            title = 'Bottom eaters')  +
  geom_line(aes(group = true), color = "grey", alpha = 0.8)
```

```{r}
swab_df <- bind_rows(
  low_eater_swab_both %>% 
    mutate(grp = 'low'),
  high_eater_swab_both %>% 
    mutate(grp = 'high')
) %>% 
  spread('type', 'value') %>% 
  mutate(diff = swab_predict - real_predict)

swab_df %>% 
  group_by(grp) %>% 
  summarise(ave_diff = mean(diff))

swab_df %>% 
  ggboxplot(x = 'grp', y  = 'diff',
            add = 'jitter') +
  theme_cleveland()

swab_df %>% 
  gghistogram(x = 'diff') +
  facet_grid(~ grp)
```
