---
title: "common dominating genera"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(ggpubr)
```

```{r}
dat <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg11.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(empirical = factor(empirical, levels = c('FALSE','TRUE')))

# look at the genus level
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv') %>% 
  filter(sampleid %in% dat$sampleid) %>% 
  dplyr::select(sampleid, taxa_genus, relab) %>% 
  mutate(taxa_genus = str_extract(taxa_genus, 'g__.+$'))

```

## The dominating genera:

g__Enterococcus, 

g__Streptococcus,

g__lactobacillus, 

g__Staphylococcus, 

g__Escherecia, 

g__Klebsiella

```{r}
# get the relab of those genera

domgen <- c('g__Enterococcus', 'g__Streptococcus', 'g__Lactobacillus', 'g__Staphylococcus', 'g__Escherichia', 'g__Klebsiella')

domcts <- cts %>% 
  filter(taxa_genus %in% domgen) %>% 
  mutate(relablog = log10(relab + 2*10^-6)) %>% 
  dplyr::select(-relab) %>% 
  mutate(taxa_genus = str_replace(taxa_genus, 'g__','')) %>% 
  spread(key = 'taxa_genus', value = 'relablog')

all <- domcts %>% 
  full_join(dat, by = "sampleid")

```

## linear mixed model using the dominating genera relab as read-out

### g__Staphylococcus

```{r}
library(lmerTest)

mod_staphy <-  lmer(Staphylococcus ~ 
               fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_staphy)
```



### g__Enterococcus

```{r}
mod_g__Enterococcus <-  lmer(Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Enterococcus)
```

### g__Escherichia

```{r}
mod_g__Escherichia <-  lmer(Escherichia ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Escherichia)
```

### g__Klebsiella

```{r}
mod_g__Klebsiella <-  lmer(Klebsiella ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Klebsiella)
```

### g__Lactobacillus

```{r}
mod_g__Lactobacillus <-  lmer(Lactobacillus ~ 
             fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Lactobacillus)
```

### g__Streptococcus

```{r}
mod_g__Streptococcus <-  lmer(Streptococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Streptococcus)
```

## brms way

```{r function}
# a function to draw the ridge density plot for the bayes results
draw_ridge_density_fg <- function(brm_mod){
  posterior_model <- posterior_samples(brm_mod) %>% 
    select(starts_with('b')) %>% 
    select(-b_Intercept) %>% 
    gather('item', 'value') %>% 
    group_by(item) %>% 
    mutate(meanperitem = mean(value))%>%
    ungroup()

  posterior_model_only_food_group <- posterior_model %>% 
    filter(str_detect(item, '_fg_')) %>% 
    mutate(item = str_replace(item, 'b_fg_',''))
  
  ggplot()+
    ggridges::geom_density_ridges(data  = posterior_model_only_food_group, 
                                  aes(x      = value,
                                      y      = reorder(as.factor(item), meanperitem),
                                      height = ..density..),
                                  scale = 1.5, size = 0.25,
                                  alpha = 0.6) +
    geom_vline(xintercept = 0, col = "red") +
    #scale_x_continuous(limits = c(-0.02,0.03)) +
    labs(y = '',
         title = '') +
    #theme(axis.text.y = element_text(size=40)) +
    ggthemes::theme_tufte() +
    theme(axis.text.y = element_text(size=30),
          axis.text.x = element_text(size=15))
}
```

 
```{r}
# use the brms to check the g__Enterococcus model 
library(brms)   
library(ggmcmc)

model_Staphylococcus <- brm( Staphylococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Staphylococcus)
```

```{r}
model_Enterococcus <- brm( Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Enterococcus)
```


```{r}
model_Escherichia <- brm( Escherichia ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Escherichia)
```

```{r}
model_Klebsiella <- brm( Klebsiella ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Klebsiella)
```

```{r}
model_Lactobacillus  <- brm( Lactobacillus  ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Lactobacillus)
```
```{r}
model_Streptococcus  <- brm( Streptococcus  ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Streptococcus)
```
```{r}
# put them in a facet grid plot
dom <- list(
  model_Streptococcus = model_Streptococcus,
  model_Enterococcus = model_Enterococcus,
  model_Escherichia = model_Escherichia,
  model_Klebsiella = model_Klebsiella,
  model_Staphylococcus = model_Staphylococcus,
  model_Lactobacillus = model_Lactobacillus
) 

dom %>% 
  purrr::map(
    ~ draw_ridge_density_fg(.)
  ) %>% 
  cowplot::plot_grid(plotlist = ., align = 'hv', ncol = 3, labels = names(.))  +
  ggsave('../figs/dom_genera_brms.pdf', width = 14, height = 10)
```

## use the enterococcus domination as the response

```{r}
entercts <- cts %>% 
  filter(taxa_genus == 'g__Enterococcus') %>% 
  mutate(enterodom = if_else(relab > 0.3, T, F)) %>% 
  rename(enterorelab = relab) %>% 
  select(-taxa_genus)

All <- all %>% 
  full_join(entercts)
```

```{r}
model_enterodom  <- brm( enterodom  ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = All, 
              family = bernoulli(), 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 
plot(model_enterodom)
draw_ridge_density_fg(model_enterodom)
stanplot(model_enterodom, type = "trace")
```

```{r}
mod_entero <-  glmer(enterodom ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical +  
               intensity + 
                TPN +
               (1 | mrn) +
                (1 | timebin),family = binomial, data = All )
print(mod_entero, corr = FALSE)
se <- sqrt(diag(vcov(mod_entero)))
(tab <- cbind(Est = fixef(mod_entero), LL = fixef(mod_entero) - 1.96 * se, UL = fixef(mod_entero) + 1.96 *
    se))
exp(tab)# odd ratio
# OR > 1 indicates increased occurrences of an event
```


```{r}
oddr <- exp(tab) %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname != '(Intercept)') %>% 
  filter(str_detect(rowname, 'fg'))

oddr %>% 
  arrange(Est) %>% 
  ggscatter(x = 'rowname', y = 'Est', color = 'red',
              ylab = 'Odds ratio',
              title = 'Enterococcus domination as outcome',
              xlab = '') +
    geom_errorbar(aes( ymin  = LL,
                     ymax  = UL,
                     width = 0.25))+
  coord_flip() +
  geom_hline(yintercept = 1, col = "firebrick", linetype = 'dashed') +
  scale_y_log10()
```

## use the GVHD Yes and No as the outcome 

```{r}
# get from the patients allo table whether the patients have gvhd
source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')

get_table_from_database('patient_allo_ag')

pt_gvhd <- patient_allo_ag %>% 
  filter(mrn %in% All$mrn) %>% 
  arrange(hct) %>% 
  distinct(mrn, .keep_all = T) %>% 
  distinct(mrn, gvhd) %>% 
  filter(gvhd != 'N/E')

all_gvhd <- All %>% 
  inner_join(pt_gvhd) %>% 
  mutate(gvhd = if_else(gvhd == 'Y', T, F))

all_gvhd %>% 
  count(gvhd)

```

```{r}
model_gvhd  <- brm( gvhd  ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all_gvhd, 
              family = bernoulli(), 
              warmup = 10000, iter = 20000, 
              cores = 32, chains = 2, 
              seed = 123) 

stanplot(model_gvhd, type = "trace")
draw_ridge_density_fg(model_gvhd)

modelposterior <- as.mcmc(model_gvhd) # with the as.mcmc() command we can use all the CODA package convergence statistics and plotting options
coda::gelman.diag(modelposterior[, 1:4])
#The Gelman-Rubin Diagnostic shows the PSRF values (using the within and between chain variability). You should look at the Upper CI/Upper limit, which are all should be close to 1. If they aren’t close to 1, you should use more iterations. Note: The Gelman and Rubin diagnostic is also automatically given in the summary of brms under the column Rhat


coda::geweke.diag(modelposterior[, 1:4])
#The Geweke Diagnostic shows the z-scores for a test of equality of means between the first and last parts of each chain, which should be <1.96. A separate statistic is calculated for each variable in each chain. In this way it check whether a chain has stabalized. If this is not the case, you should increase the number of iterations. In the plots you should check how often values exceed the boundary lines of the z-scores. Scores above 1.96 or below -1.96 mean that the two portions of the chain significantly differ and full chain convergence was not obtained.
geweke.plot(modelposterior[, 1:4])


# still need more samples to converge possibly 
```

