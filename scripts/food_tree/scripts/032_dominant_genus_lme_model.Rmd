---
title: "common dominating genera"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(ggpubr)
```

```{r}
dat <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg11.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(empirical = factor(empirical, levels = c('FALSE','TRUE')))

# look at the genus level
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv') %>% 
  filter(sampleid %in% dat$sampleid) %>% 
  dplyr::select(sampleid, taxa_genus, relab) %>% 
  mutate(taxa_genus = str_extract(taxa_genus, 'g__.+$'))

```

## The dominating genera:

g__Enterococcus, 

g__Streptococcus,

g__lactobacillus, 

g__Staphylococcus, 

g__Escherecia, 

g__Klebsiella

```{r}
# get the relab of those genera

domgen <- c('g__Enterococcus', 'g__Streptococcus', 'g__Lactobacillus', 'g__Staphylococcus', 'g__Escherichia', 'g__Klebsiella')

domcts <- cts %>% 
  filter(taxa_genus %in% domgen) %>% 
  mutate(relablog = log10(relab + 2*10^-6)) %>% 
  dplyr::select(-relab) %>% 
  mutate(taxa_genus = str_replace(taxa_genus, 'g__','')) %>% 
  spread(key = 'taxa_genus', value = 'relablog')

all <- domcts %>% 
  full_join(dat, by = "sampleid")

```

## linear mixed model using the dominating genera relab as read-out

### g__Staphylococcus

```{r}
library(lmerTest)

mod_staphy <-  lmer(Staphylococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_staphy)
```



### g__Enterococcus

```{r}
mod_g__Enterococcus <-  lmer(Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Enterococcus)
```

### g__Escherichia

```{r}
mod_g__Escherichia <-  lmer(Escherichia ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Escherichia)
```

### g__Klebsiella

```{r}
mod_g__Klebsiella <-  lmer(Klebsiella ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Klebsiella)
```

### g__Lactobacillus

```{r}
mod_g__Lactobacillus <-  lmer(Lactobacillus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Lactobacillus)
```

### g__Streptococcus

```{r}
mod_g__Streptococcus <-  lmer(Streptococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Streptococcus)
```

veggie increases Lactobacillus
milk increases Streptococcus
sweets and veggie increases g__Enterococcus with a p value 0.07 and 0.09

```{r}
# use the brms to check the g__Enterococcus model 
library(brms)   
library(ggmcmc)

model_Enterococcus <- brm( Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+
                fg_legume+
                fg_veggie+
               abx + 
               intensity + 
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 
plot(model_Enterococcus)
```


