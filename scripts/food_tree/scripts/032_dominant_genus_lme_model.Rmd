---
title: "common dominating genera"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(ggpubr)
```

```{r}
dat <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg11.csv') %>% 
  mutate(timebin = cut_width(sdrt, 7, boundary=0, closed = 'left')) %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(empirical = factor(empirical, levels = c('FALSE','TRUE')))

# look at the genus level
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv') %>% 
  filter(sampleid %in% dat$sampleid) %>% 
  dplyr::select(sampleid, taxa_genus, relab) %>% 
  mutate(taxa_genus = str_extract(taxa_genus, 'g__.+$'))

```

## The dominating genera:

g__Enterococcus, 

g__Streptococcus,

g__lactobacillus, 

g__Staphylococcus, 

g__Escherecia, 

g__Klebsiella

```{r}
# get the relab of those genera

domgen <- c('g__Enterococcus', 'g__Streptococcus', 'g__Lactobacillus', 'g__Staphylococcus', 'g__Escherichia', 'g__Klebsiella')

domcts <- cts %>% 
  filter(taxa_genus %in% domgen) %>% 
  mutate(relablog = log10(relab + 2*10^-6)) %>% 
  dplyr::select(-relab) %>% 
  mutate(taxa_genus = str_replace(taxa_genus, 'g__','')) %>% 
  spread(key = 'taxa_genus', value = 'relablog')

all <- domcts %>% 
  full_join(dat, by = "sampleid")

```

## linear mixed model using the dominating genera relab as read-out

### g__Staphylococcus

```{r}
library(lmerTest)

mod_staphy <-  lmer(Staphylococcus ~ 
               fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_staphy)
```



### g__Enterococcus

```{r}
mod_g__Enterococcus <-  lmer(Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Enterococcus)
```

### g__Escherichia

```{r}
mod_g__Escherichia <-  lmer(Escherichia ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Escherichia)
```

### g__Klebsiella

```{r}
mod_g__Klebsiella <-  lmer(Klebsiella ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Klebsiella)
```

### g__Lactobacillus

```{r}
mod_g__Lactobacillus <-  lmer(Lactobacillus ~ 
             fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Lactobacillus)
```

### g__Streptococcus

```{r}
mod_g__Streptococcus <-  lmer(Streptococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin), REML = F, data = all )
summary(mod_g__Streptococcus)
```

## brms way

```{r}
# a function to draw the ridge density plot for the bayes results
draw_ridge_density_fg <- function(brm_mod){
  posterior_model <- posterior_samples(brm_mod) %>% 
    select(starts_with('b')) %>% 
    select(-b_Intercept) %>% 
    gather('item', 'value') %>% 
    group_by(item) %>% 
    mutate(meanperitem = mean(value))%>%
    ungroup()

  posterior_model_only_food_group <- posterior_model %>% 
    filter(str_detect(item, '_fg_'))
  
  ggplot()+
    ggridges::geom_density_ridges(data  = posterior_model_only_food_group, 
                                  aes(x      = value,
                                      y      = reorder(as.factor(item), meanperitem),
                                      height = ..density..),
                                  scale = 1.5, size = 0.25,
                                  alpha = 0.6) +
    geom_vline(xintercept = 0, col = "red") +
    #scale_x_continuous(limits = c(-0.02,0.03)) +
    labs(y = 'Food groups',
         title = 'Posterior distribution of regression coefficient for food groups') +
    theme(axis.text.y = element_text(size=20)) +
    ggthemes::theme_tufte()
}
```

 
```{r}
# use the brms to check the g__Enterococcus model 
library(brms)   
library(ggmcmc)

model_Enterococcus <- brm( Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Enterococcus)
```

```{r}
model_Enterococcus <- brm( Enterococcus ~ 
              fg_fruit+
               fg_meat+
               fg_milk+
               fg_oils+
                fg_egg+ 
                fg_grain+
                fg_sweets+  
                fg_legume+
                fg_veggie+
                fg_ndrink+
                fg_EN+
               empirical + 
               intensity + 
                 TPN +
               (1 | mrn) +
                (1 | timebin),  
              data = all, 
              warmup = 1000, iter = 3000, 
              cores = 8, chains = 2, 
              seed = 123) 

draw_ridge_density_fg(model_Enterococcus)
```


