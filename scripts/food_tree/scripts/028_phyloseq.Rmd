---
title: "look at the tree informed microbiome beta diversity using phyloseq"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(phyloseq)
library(tidyverse)
```

# build phyloseq object

```{r}
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d.csv') %>% 
    mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
    mutate(abx = factor(abx, levels = c('non_empirical','empirical')),
           mrn = factor(mrn)) %>% 
  arrange(sampleid) %>% 
  column_to_rownames('sampleid')


asv_counts_ag <- read_csv('../data/asv_counts_ag_Feb17.csv')

cts <- asv_counts_ag %>% 
  filter(sampleid %in% meta$sampleid) %>% 
  select(asv_key, sampleid, count) %>% 
  arrange(sampleid) %>% 
  spread(key = 'sampleid', value = 'count', fill = 0) %>% 
  arrange(asv_key) %>% 
  column_to_rownames('asv_key') %>% 
  as.matrix()

all.equal(colnames(cts), meta$sampleid)

source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')

ANNOT <- get_table_from_database('asv_annotation_blast_ag')

annot <- ANNOT %>% 
  filter(asv_key %in% rownames(cts)) %>% 
  dplyr::select(asv_key:species) %>% 
  arrange(asv_key) %>% 
  column_to_rownames('asv_key') %>% 
  as.matrix()

colnames(annot) <- c("Kingdom", "Phylum",  "Class",  "Order",  "Family", "Genus", "Species" )

all(rownames(annot) == rownames(cts))

all_tree <- ape::read.tree('../data/cleaned_stool/asv_sequences_all.newick')
```


```{r}
ps <- phyloseq(otu_table(cts, taxa_are_rows=T), 
               sample_data(meta), 
               tax_table(annot),
               phy_tree(all_tree))

ps
otu_table(ps)
```

