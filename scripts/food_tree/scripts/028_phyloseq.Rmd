---
title: "look at the tree informed microbiome beta diversity using phyloseq"
output: html_document
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(phyloseq)
library(tidyverse)
```

# build phyloseq object

```{r}
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d.csv') %>% 
  mutate(intensity = factor(intensity, levels = c('nonablative','reduced','ablative'))) %>% 
  mutate(abx = factor(abx, levels = c('non_empirical','empirical')),
           mrn = factor(mrn)) %>% 
  arrange(sampleid) %>% 
  column_to_rownames('sampleid')


asv_counts_ag <- read_csv('../data/asv_counts_ag_Feb17.csv')

cts <- asv_counts_ag %>% 
  filter(sampleid %in% rownames(meta)) %>% 
  select(asv_key, sampleid, count) %>% 
  arrange(sampleid) %>% 
  spread(key = 'sampleid', value = 'count', fill = 0) %>% 
  arrange(asv_key) %>% 
  column_to_rownames('asv_key') %>% 
  as.matrix()

all.equal(colnames(cts), rownames(meta))

source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')

ANNOT <- get_table_from_database('asv_annotation_blast_ag')

annot <- ANNOT %>% 
  filter(asv_key %in% rownames(cts)) %>% 
  dplyr::select(asv_key:species) %>% 
  arrange(asv_key) %>% 
  column_to_rownames('asv_key') %>% 
  as.matrix()

colnames(annot) <- c("Kingdom", "Phylum",  "Class",  "Order",  "Family", "Genus", "Species" )

all(rownames(annot) == rownames(cts))

all_tree <- ape::read.tree('../data/cleaned_stool/asv_sequences_all.newick')
```


```{r}
ps <- phyloseq(otu_table(cts, taxa_are_rows=T), 
               sample_data(meta), 
               tax_table(annot),
               phy_tree(all_tree))

ps
```

# filter 

```{r}
table(tax_table(ps)[, "Phylum"], exclude = NULL)

# filter out the phylum is NA and only have one feature ones 
ps1 <- subset_taxa(ps, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))
```
```{r}
# Compute prevalence of each feature, store as data.frame
prevdf = apply(X = otu_table(ps1),
               MARGIN = ifelse(taxa_are_rows(ps1), yes = 1, no = 2),
               FUN = function(x){sum(x > 0)})

# Add taxonomy and total read counts to this data.frame
prevdf = bind_cols(
  data_frame(
    Prevalence = prevdf,
    TotalAbundance = taxa_sums(ps1)),
  %>% 
    as.data.frame())


 tax_table(ps) 
 data_frame(tax_table(ps) )
   
```
```{r}
ps2 = transform_sample_counts(ps1, function(x){x / sum(x)})
plotAfter = plot_abundance(ps2,"")

otu_table(ps2)
```

```{r}
qplot(log10(colSums(otu_table(ps1))),binwidth=0.2) +
  xlab("Logged counts-per-sample")

qplot(sample_data(ps2)$fg_fruit, geom = "histogram",binwidth=20)
```
