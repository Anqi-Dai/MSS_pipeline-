---
title: "correlate food with microbiome family taxon"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr) 
```

```{r}
source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')
get_table_from_database_predefined_filter('asv_counts_ag')
get_table_from_database('asv_annotation_blast_ag')
```

```{r}
pair3 <- read_csv('../data/finalized/paired/pair_p3day_food_level2_res_fil.csv')

nodes <- read_tsv('../data/source/NodeLabelsMCT.txt', col_types = cols(.default = col_character())) %>% 
  filter(str_length(Level.code) == 2) %>% 
  # remove the ones ending with 0 like 20 and 50
  filter(!str_detect(Level.code, '0$'))
```


```{r}
cts <- asv_counts_ag %>% 
  filter(sampleid %in% pair3$sampleid) %>% 
  select(asv_key, sampleid, count) %>% 
  spread(key = 'sampleid', value = 'count', fill = 0) %>% 
  arrange(asv_key)  

annot <- asv_annotation_blast_ag %>% 
  filter(asv_key %in% cts$asv_key) %>% 
  mutate(ordr =  if_else(ordr == '', str_glue('of_class_{class}'), ordr),
         family =  if_else(family == '', str_glue('of_order_{ordr}'), family),
         genus =  if_else(genus == '', str_glue('of_family_{family}'), genus),
         species =  if_else(species == '', str_glue('of_genus_{genus}'), species)) %>% 
  mutate(taxa_spp = str_glue('k__{kingdom}|p__{phylum}|c__{class}|o__{ordr}|f__{family}|g__{genus}|s__{species}'))


# replace the asv_key with the genus taxa level
# summarize from asv level to genus level
# get the relative abundance for the genera
cts_all <- cts %>% 
  full_join(annot %>%  select(asv_key, taxa_spp), by  = 'asv_key') %>% 
  select(-asv_key) %>% 
  gather(key = 'sampleid', value = 'count', names(.)[1]:names(.)[ncol(.) - 1]) %>% 
  group_by(sampleid, taxa_spp) %>% 
  summarise(cnt = sum(count)) %>% 
  # get the total count from the db to calculate the relab
  left_join(asv_counts_ag %>% distinct(sampleid,count_total ), by = 'sampleid') %>% 
  mutate(relab = cnt/count_total) %>% 
  select(sampleid, taxa_spp, relab) 

pair3_both <- pair3 %>% 
  left_join(cts_all , by  = 'sampleid')
```

```{r}
# every species relab and correlate with the level 2 food group ave weight

pair3_both_spearm <- pair3_both %>% 
  split(.$taxa_spp) %>% 
  map(function(df){
     df %>% 
        split(.$Level.code) %>% 
        map(function(df_l2){
          test = suppressWarnings(cor.test(df_l2$ave_level2, 
                         df_l2$relab, 
                         method = 'spearman', 
                         exact = F))
          return(list(rho = round(test$estimate, 2),
                      pval = test$p.value))}) %>% 
        bind_rows(.id = 'Level.code')
  }) %>% 
  bind_rows(.id = 'taxa_spp') %>% 
  filter(!is.na(rho)) %>% 
  mutate(FDR = p.adjust(pval, method = 'BH')) %>% 
  mutate(neglogFDR = -log(FDR)) %>% 
  arrange(desc(neglogFDR)) 

```

```{r}
# get the sig ones (FDR < 0.1)
pair3_both_spearm_sig <- pair3_both_spearm %>% 
  filter(FDR < 0.1) %>% 
  mutate(taxa_spp = str_extract(taxa_spp, 'f__.+$')) %>% 
  # join with the node lables 
  left_join(nodes , by  = 'Level.code') %>% 
  rename(description = Main.food.description) %>% 
  mutate(spp = str_extract(taxa_spp, 's__.+$')) %>% 
  # to add a tiny amount to avoid the FDR == 0 situation  
  mutate(FDR = if_else(FDR == 0, FDR + 10^-6, FDR)) %>% 
  mutate(neglogFDR = -log(FDR)) 
```


