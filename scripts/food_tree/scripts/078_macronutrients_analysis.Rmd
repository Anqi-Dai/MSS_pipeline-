---
title: "macronutrients_analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggpubr)
library(vdbR)
connect_database('~/dbConfig.txt')
list_table_from_database('nutri')
get_table_from_database('nutrition_ag')
```

```{r}
# the % needs met data

```

```{r}
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
```

## microbiome 

```{r genus}
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv') %>% 
  filter(sampleid %in% meta$sampleid) 

thre <- seq(0.0001, 0.002, 0.0001)
thre %>% 
  set_names(thre) %>% 
  map_dfr(function(num){
    cts %>% 
    group_by(genus) %>% 
    count(relab > num) %>% 
    rename(criteria = names(.)[2]) %>% 
    filter(criteria == 'TRUE') %>% 
    arrange(-n) %>% 
    filter(genus != 'NA') %>% 
    mutate(perc = round(n/nrow(meta)*100, 0)) %>% 
    filter(perc > 10) %>% 
      nrow
  }) %>% 
  gather('thre', 'num')

target_genera <-  cts %>% 
  group_by(genus) %>% 
  count(relab > 0.002) %>% 
  rename(criteria = names(.)[2]) %>% 
  filter(criteria == 'TRUE') %>% 
  arrange(-n) %>% 
  filter(genus != 'NA') %>% 
  mutate(perc = round(n/nrow(meta)*100, 0)) %>% 
  filter(perc > 10) %>% 
  pull(genus) 

gcts <- cts %>% 
  filter(genus %in% target_genera) %>% 
  mutate(relablog = log10(relab + 2*10^-6)) %>% 
  dplyr::select(-relab) %>% 
  spread(key = 'genus', value = 'relablog', fill = 0)
```

## food and p2d average in cal and nutrients

```{r p2d_cal}
# the daily caloric intake :
all_daily_pt <- dtb %>%
  group_by(mrn, fdrt) %>%
  summarise(total_daily = sum(Calories_kcal))

# the previous two days average for each stool sample

stb_pair <- meta %>%  
  select(mrn, sdrt) %>% 
  transmute(mrn = mrn,
            p1d = sdrt-1,
            p2d = sdrt-2) 

mean_p2d_cal <-  function(mrn_, p1d_, p2d_){
  df = all_daily_pt %>% 
    filter(mrn == mrn_) %>% 
    filter(fdrt %in% c(p1d_, p2d_  )) %>% 
    group_by(mrn) %>% 
    summarise(ave_cal = sum(total_daily)/2)
  return(df)
}

mean_p2d_df_cal <- pmap(stb_pair, function(mrn, p1d, p2d){
    mean_p2d_cal(mrn, p1d, p2d)
  }) %>% 
  set_names(meta %>% pull(sampleid)) %>% 
  bind_rows(.id = 'sampleid') 
```

```{r p2d_nutrients}
# the daily total of each nutrients 
nutrients <- dtb %>%
  select(mrn, fdrt, Protein_g:Sugars_g) %>% 
  gather('type','gram', Protein_g:Sugars_g) %>% 
  group_by(mrn, fdrt, type) %>%
  summarise(total_daily = sum(gram)) %>% 
  split(.$type)

mean_p2d_fiber <-  function(mrn_, p1d_, p2d_){
  df = nutrients$Fibers_g %>% 
    filter(mrn == mrn_) %>% 
    filter(fdrt %in% c(p1d_, p2d_  )) %>% 
    group_by(mrn) %>% 
    summarise(ave_fiber = sum(total_daily)/2)
  return(df)
}
mean_p2d_carb <-  function(mrn_, p1d_, p2d_){
  df = nutrients$Carbohydrates_g %>% 
    filter(mrn == mrn_) %>% 
    filter(fdrt %in% c(p1d_, p2d_  )) %>% 
    group_by(mrn) %>% 
    summarise(ave_carb = sum(total_daily)/2)
  return(df)
}

mean_p2d_fat <-  function(mrn_, p1d_, p2d_){
  df = nutrients$Fat_g %>% 
    filter(mrn == mrn_) %>% 
    filter(fdrt %in% c(p1d_, p2d_  )) %>% 
    group_by(mrn) %>% 
    summarise(ave_fat = sum(total_daily)/2)
  return(df)
}
mean_p2d_Protein <-  function(mrn_, p1d_, p2d_){
  df = nutrients$Protein_g %>% 
    filter(mrn == mrn_) %>% 
    filter(fdrt %in% c(p1d_, p2d_  )) %>% 
    group_by(mrn) %>% 
    summarise(ave_Protein = sum(total_daily)/2)
  return(df)
}
mean_p2d_Sugars <-  function(mrn_, p1d_, p2d_){
  df = nutrients$Sugars_g %>% 
    filter(mrn == mrn_) %>% 
    filter(fdrt %in% c(p1d_, p2d_  )) %>% 
    group_by(mrn) %>% 
    summarise(ave_Sugars = sum(total_daily)/2)
  return(df)
}

mean_p2d_df_res <- pmap(stb_pair, function(mrn, p1d, p2d){
    mean_p2d_fiber(mrn, p1d, p2d)
    mean_p2d_fat(mrn, p1d, p2d)
    mean_p2d_Protein(mrn, p1d, p2d)
    mean_p2d_Sugars(mrn, p1d, p2d)
    mean_p2d_carb(mrn, p1d, p2d)
  }) %>% 
  set_names(meta %>% pull(sampleid)) %>% 
  bind_rows(.id = 'sampleid') 
```

