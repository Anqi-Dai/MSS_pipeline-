---
title: "envfit stool alpha diversity"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(vegan)
library(tidyverse)
library(ggpubr)
library(ape)
library(rbiom)
```

Fit the family abunance onto stool alpha diversity colored PCoA

# all samples bc distance PCoA colored by stool alpha diversity

```{r}
# all samples genus counts matrix and pcoa
cts <- read_csv('../data/cleaned_stool/ALL_stool_samples_genus_counts.csv') %>% 
  select(sampleid, taxa_genus, relab) %>% 
  spread(key = 'taxa_genus', value = 'relab') %>% 
  column_to_rownames('sampleid')

meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d.csv')

dist_all <- vegdist(cts, method = 'bray')

all_bc <- cmdscale(dist_all, k = 2) %>% 
  as.data.frame() %>% 
  rownames_to_column('sampleid') %>% 
  full_join(meta) %>% 
  mutate(sqrtSR = sqrt(simpson_reciprocal))

# the percent variance
eigen <- pcoa(dist_all)$values$Eigenvalues
percent_var <- signif(eigen/sum(eigen), 3)*100

library("viridis") 

all_bc %>% 
  ggscatter(x = 'V1', y = 'V2', color = 'sqrtSR', alpha = 0.5)  +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  scale_color_viridis()

```

```{r}
# all sample family abundance
source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')
get_table_from_database('asv_annotation_blast_ag')

asv_counts_ag <- read_csv('../data/asv_counts_ag_Feb17.csv')

```

```{r}
# load the family level counts
cts_fam <- read_csv('../data/cleaned_stool/ALL_stool_samples_family_counts.csv')


ord <- pcoa(dist_all)
(fit <- envfit(ord, topn_cts, perm = 999))

```

# the asv level all stool sample counts and relab

```{r}
cts <- asv_counts_ag %>% 
  filter(sampleid %in% meta$sampleid) %>% 
  dplyr::select(asv_key, sampleid, count) 

# replace the asv_key with the genus taxa level
# summarize from asv level to genus level
# get the relative abundance for the genera
cts_asv <- cts %>% 
  # get the total count from the db to calculate the relab
  left_join(asv_counts_ag %>% distinct(sampleid,count_total ), by = 'sampleid') %>% 
  mutate(relab = count/count_total)  
```


# the microbiome weighted unifrac on asv level counts(relab)

```{r}
cts <- cts_asv %>% 
  dplyr::select(asv_key, sampleid, relab) %>% 
  spread(key = 'sampleid', value = 'relab', fill = 0) %>% 
  column_to_rownames('asv_key') %>% 
  as.matrix()

all_tree <- ape::read.tree('../data/cleaned_stool/asv_sequences_all.newick')

wunifrac_res <- rbiom::unifrac(cts, weighted = TRUE, tree = all_tree)
head(wunifrac_res)
```


