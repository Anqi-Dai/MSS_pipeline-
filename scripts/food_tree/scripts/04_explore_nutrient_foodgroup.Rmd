---
title: "Explore the ALL records, on a nutrient and food group level"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(kableExtra)
library(ggvenn) 
library(RColorBrewer)
library(readxl)
source('~/db.R')
```

```{r}
All <- read_csv('../data/finalized/all_patients_record.csv')

# convert the date to day relative to HCT
allo <- get_data_from_query_OTU(0, 'patient_allo_ag') %>% 
  filter(str_detect(indication, fixed('initial', ignore_case=TRUE))) %>% 
  select(mrn, hct)

All <- All %>% 
  rename(mrn = MRN) %>% 
  left_join(allo, by = 'mrn') %>% 
  mutate(DayRT = Date - hct) %>% 
  select(-Date, -hct) %>% 
  select(key, mrn, DayRT, Meal : Sodium_mg)
```


```{r}
# have to associate a food code to a food_nsc
code <- read_csv('../data/finalized/unique_food_nsc_with_food_code.csv', col_types = 'ccccc') %>% 
  filter(Food_NSC %in% All$Food_NSC) %>% 
  select(1:3)

# join with code to the all table
final <- All %>% 
  left_join(code, by  = 'Food_NSC') %>% 
  rename(Food_code = Food.Code,
         description = FNDDS.Main.Food.Description)
```

```{r}
# need to get the total dehydrated weight of that food
# FNDDS ref table with energy info
engy <- read_excel('../data/source/2015-2016 FNDDS At A Glance - FNDDS Nutrient Values.xlsx', skip = 1, col_types  = 'text') %>% 
  rename_all(funs(str_replace_all(., ' ','_'))) %>% 
  rename_all(funs(str_replace_all(., '\\(|\\)',''))) %>% 
  select(Food_code, Energy_kcal, Water_g) %>% 
  mutate(Energy_kcal = as.numeric(Energy_kcal),
         Water_g = as.numeric(Water_g))
  
final_join <- final %>% 
  left_join(engy, by  = 'Food_code') 

Final <- final_join %>% 
  mutate(total_weight = if_else(Energy_kcal == 0, 99999, Calories_kcal/Energy_kcal*100)) %>% 
  mutate(dehydrated_weight = if_else(total_weight == 99999, 0, total_weight*(1 - Water_g/100)))

Final %>% 
  write_csv('../data/finalized/all_patients_record_w_food_code.csv')

colnames(Final)
```


## The food group for each patient 

```{r}
# node labels different levels of nodes
# setting the color for each food group
nodes <- read_tsv('../data/source/NodeLabels.txt', col_types = 'cc') %>% 
  filter(nchar(Level.code) == 1) %>% 
  rename(food_grp = Level.code)

scale_fill_manual_value <- c("Milk_and_Milk_Products" = "#a9a9a9", "Meat_Poultry_Fish_and_Mixtures" = "#800000",
                               "Eggs" = "#ffe119", "Dry_Beans_Peas_Other_Legumes_Nuts_and_Seeds" = "#808000",
                               "Grain_Product" = "#9a6324", "Fruits" = "#911eb4",
                               "Vegetables" = "#469990", "Fats_Oils_and_Salad_Dressings" = "#000075", "Sugars_Sweets_and_Beverages" = "#e5a47c")

nodes %>% 
  kable() %>% 
  kable_styling(full_width = F)
```

```{r}
fgroup <- Final %>% 
  select(mrn, DayRT, dehydrated_weight, Food_code) %>% 
  mutate(food_grp = str_sub(Food_code, 1, 1))

# the total dehydated weight for a patient for one day
total_daily <- fgroup %>% 
  group_by(mrn, DayRT) %>% 
  summarise(daily_tol = sum(dehydrated_weight))

food_per_group <- fgroup %>% 
  group_by(mrn, DayRT, food_grp) %>% 
  summarise(grp_tol = sum(dehydrated_weight))

# joined together
fgroup_relab <- food_per_group %>% 
  left_join(total_daily) %>% 
  mutate(grp_relab = grp_tol/daily_tol) %>% 
  arrange(mrn, DayRT, food_grp) %>% 
  ungroup() %>% 
  left_join(nodes, by = 'food_grp') %>% 
  mutate(Main.food.description = factor(Main.food.description, levels = c('Grain_Product','Sugars_Sweets_and_Beverages','Meat_Poultry_Fish_and_Mixtures','Milk_and_Milk_Products','Vegetables','Fruits','Dry_Beans_Peas_Other_Legumes_Nuts_and_Seeds','Eggs','Fats_Oils_and_Salad_Dressings'))) %>% 
  # if one whole day the pt only has consumed suger beverage the value is NaN and need to set that to be 1 for the group 9
  mutate(grp_relab = if_else(is.nan(grp_relab), 1, grp_relab))


```
```{r}
# how many patients how many days of data
npt <- fgroup_relab %>% 
  count(mrn) %>% 
  nrow()

pt_days <- fgroup_relab %>% 
  count(mrn, DayRT) %>% 
  ungroup() %>% 
  count(mrn)

pt_days %>% 
  gghistogram(x = 'n', bins = 10, color = 'white', fill = 'navy',
              xlab = 'Number of days of records per patient',
              title = 'How many days of records each patient has')

max(pt_days$DayRT)
min(pt_days$DayRT)
```

```{r food_group_plot}
res <- fgroup_relab %>% 
  ggplot(aes(x = DayRT, y = grp_relab, fill =  Main.food.description)) +
  geom_bar(position="stack", stat="identity") +
  scale_fill_manual(values = scale_fill_manual_value) +
  labs(y = 'Relative Abundance') +
  #scale_x_continuous(expand = c(0, 0)) +
  #scale_y_continuous(limits = c(0, 1),expand = c(0, 0)) +
  theme_classic() +
  theme(axis.title.x=element_blank(),
        #axis.text.x=element_blank(),
        axis.ticks.x = element_blank(),
        legend.position="bottom") +
  facet_wrap(~mrn) +
  ggsave('../figs/food_group.jpg', width = 25, height = 15)
```


## The nutrient level

```{r}
colnames(Final)
```

```{r}
nutrients <- Final %>% 
  select(mrn, DayRT, Food_NSC, Calories_kcal, Proteing_g:Sodium_mg, description, dehydrated_weight) %>% 
  # CURRENTLY REMOVE THE ROWS WITH CALORIES AND TOTAL WEIGHT EQUAL TO 0
  filter(Calories_kcal != 0 & dehydrated_weight!= 0) 

```


```{r}
# get the total gram of nutrient per patient per day
nut_daily_tol <- nutrients %>% 
  select(mrn, DayRT, Proteing_g:Sodium_mg) %>% 
  gather('nutrient','weight', Proteing_g:Sodium_mg) %>% 
  group_by(mrn, DayRT,nutrient) %>% 
  summarise(nutrient_tol_day = sum(weight)) %>% 
  # conver the mg in sodium to g
  mutate(nutrient = str_replace(nutrient, '_.+$','')) %>% 
  mutate(nutrient_tol_day = if_else(nutrient == 'Sodium', nutrient_tol_day/1000, nutrient_tol_day)) %>% 
  ungroup()


# get the total dehydrated weight per patient per day
de_wt_daily <- nutrients %>% 
  select(mrn, DayRT, dehydrated_weight) %>% 
  group_by(mrn, DayRT) %>% 
  summarise(total_de_wt_daily = sum(dehydrated_weight)) %>% 
  ungroup


# join them together
# USE THE DEHYDRATED WEIGHT CONVERTED FROM THE CALORIES AND WATER PROPORTION AS THE DENOMINATOR
nutr_joined <- nut_daily_tol %>% 
  left_join(de_wt_daily) %>% 
  mutate(nut_relab = nutrient_tol_day/total_de_wt_daily) %>% 
  mutate(nutrient = factor(nutrient))
```

```{r nutrient_plot}
# plot 

nutr_joined %>% 
  ggbarplot(x = 'DayRT', y  = 'nut_relab', fill = 'nutrient',size = 0.01,
            color = 'white', palette = 'lancet') +
  facet_wrap(~ mrn) +
  ggsave('../figs/food_nutrient.jpg', width = 25, height = 15, dpi = 300)



# one patient for example
nutr_joined %>% 
  filter(mrn == 35580223) %>% 
  ggbarplot(x = 'DayRT', y  = 'nut_relab', fill = 'nutrient',size = 0.01,
            color = 'white', palette = 'lancet') +
  ggsave('../figs/food_nutrient_example.jpg', dpi = 300)

```

