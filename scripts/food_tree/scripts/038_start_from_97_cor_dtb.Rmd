---
title: "Start from 97 corrected dtb"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F)
```

```{r}
library(tidyverse)
library(readxl)
```

Comments from Peter: The only concern is how much is "each" that is being served in some foods. Have to ask the kitchen how big is the portion.

(About a quarter in the small_cor has the calories corrected. )

## Integrate the Peter curated smallest portion into the dataset

```{r}
small_cor <- read_csv('../data/!question/double_check_for_calories_also_nutrients_peter.csv') %>% 
  unite(col = 'food_full', Food_NSC:Unit, sep = '__', remove = T) 

cur <- read_csv('../data/!question/all_97_cor.csv') %>% 
  rename(Protein_g = Proteing_g) %>% 
  mutate(Sodium_g = round(Sodium_mg/1000, 3)) %>% 
  select(-Sodium_mg) %>% 
  unite(col = 'food_full', Food_NSC:Unit, sep = '__', remove = T) 


all_small_cor <- cur %>% 
  filter(food_full %in% small_cor$food_full) %>% 
  distinct(food_full, Por_eaten, .keep_all = T) %>% 
  select(MRN:Por_eaten) %>% 
  left_join(small_cor) %>% 
  arrange(food_full, Calories_kcal)

# use the ratio to correct other portions
all_small_cor_res <- all_small_cor %>% 
  group_by(food_full) %>% 
  mutate(Calories_kcal = Calories_kcal[1],
         Protein_g = Protein_g[1],
         Fat_g = Fat_g[1],
         Carbohydrates_g = Carbohydrates_g[1],
         Fibers_g = Fibers_g[1],
         Sugars_g = Sugars_g[1],
         Sodium_g = Sodium_g[1]) %>% 
  split(.$food_full) %>% 
  map_dfr(~ mutate(.data = ., ratio = Por_eaten/Por_eaten[1]) %>% 
        split(.$Por_eaten) %>% 
        map_dfr(~ mutate(.data = .,   
                   Calories_kcal = Calories_kcal*ratio,
                   Protein_g = Protein_g*ratio,
                   Fat_g = Fat_g*ratio,
                   Carbohydrates_g = Carbohydrates_g*ratio,
                   Fibers_g = Fibers_g*ratio,
                   Sugars_g = Sugars_g*ratio,
                   Sodium_g = Sodium_g*ratio)) %>% 
        select(-ratio))

all_small_cor_res %>% 
  summary 
####### 3 of 2017 Dressing, Creamy Italian (.5)__pkt 274g fat?? (I probably should focus on the calories for now...)

# then scale the different food_full and portion to repeated occurences 
cur2 <- cur %>%  
  select(MRN: Por_eaten) %>% 
  left_join(all_small_cor_res %>% select(food_full:Sodium_g) %>% distinct(), by = c('food_full','Por_eaten'))
```


## Load other dataset

```{r}

all_code <- read_csv('../data/cleaned_diet_data/all_food_nsc_with_code_FINAL.csv') %>% 
  select(-FNDDS.Main.Food.Description)

```

## Foods with zero calorie and their gram weight
 
```{r}
cal0_peter <- read_excel('../data/cal_0_food_nsc_all_with_unit_Peter.xls')

# the things that should be removed from combined
na_rm <- cal0_peter %>% 
  filter(`gram weight` == 'NA') %>% 
  distinct(Food_NSC) %>% 
  pull(Food_NSC)

# remove the items that are not valid food like salt and pepper and ice
cur3 <- cur2 %>% 
  separate(food_full, into = c('Food_NSC','Unit'), sep = '__') %>% 
  filter(! Food_NSC %in% na_rm)

# the items that are watery and now I have a total weight
cal0_peter_items <- cal0_peter %>%   
  filter(`gram weight` != 'NA')  %>% 
  rename(total_weight = `gram weight`) %>% 
  mutate(total_weight = as.numeric(total_weight)) %>% 
  distinct(Food_NSC) %>% 
  pull(Food_NSC) 

cal0_peter_clean <- cal0_peter %>% 
  filter(`gram weight` != 'NA')  %>% 
  rename(total_weight = `gram weight`) %>% 
  mutate(total_weight = as.numeric(total_weight)) %>% 
  distinct()

cal0_split <- cur3 %>% 
  split(.$Food_NSC %in% cal0_peter_items)

cal0_join_with_other <- cal0_split %>% 
  pluck('TRUE') %>%  
  left_join(cal0_peter_clean) 

# there are several NA because they are of other portions
# correct this 
other_portion_NA_items <- cal0_join_with_other %>% 
  filter(is.na(total_weight)) %>% 
  distinct(Food_NSC) %>% 
  pull(Food_NSC)

other_portion_NA_foods <- cal0_join_with_other %>% 
  filter(Food_NSC %in% other_portion_NA_items) %>% 
  arrange(Food_NSC, Unit, total_weight) %>% 
  unite(col = 'food_full', Food_NSC:Unit, sep = '__', remove = T) %>% 
  group_by(food_full) %>% 
  mutate(total_weight = total_weight[1]) %>% 
  split(.$food_full) %>% 
  map_dfr(~ mutate(.data = ., ratio = Por_eaten/Por_eaten[1]) %>% 
        split(.$Por_eaten) %>% 
        map_dfr(~ mutate(.data = .,   
                   total_weight = total_weight*ratio)) %>% 
        select(-ratio)) %>% 
  separate(food_full, into = c('Food_NSC','Unit'), sep = '__') 

cur4 <- bind_rows(
  cal0_split %>% pluck('FALSE'),
  cal0_join_with_other %>% filter(!Food_NSC %in% other_portion_NA_items),
  other_portion_NA_foods
)


```


```{r}
# for the stuff in the above result that is NA in the gram weight goddamn messed up calories for the food! do a calculation instead
cal0_weight <- cal0_split %>% 
  pluck('TRUE') %>%  
  left_join(cal0_peter_clean) %>% 
  filter(!is.na(total_weight))  %>% 
  # join by the food code
  left_join(all_code, by = 'Food_NSC')

# most of the cal!=0 stuff that needs the fndds conversion
other_need <- bind_rows(
  cal0_split %>% pluck('FALSE'),
  cal0_join_with_other
) %>% 
  # join by the food code
  left_join(all_code, by = 'Food_NSC')
```


## Get the food code for the items

## Get the dehydrated weight for the non zero calorie foods

## Convert the date to fdrt

## Add the EN and TPN data

## Check the date range and finalize the data


