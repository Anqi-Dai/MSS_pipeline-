---
title: "klebsiella high irep"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggpubr)
library(tidyverse)
library(cowplot)
plot_ratio <- 1/2
```

```{r}
combined <- read_csv('../data/growth/069_irep_combined_res.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
all_fruit <- read_csv('../data/075_all_daily_fruit.csv')
all_sweet <- read_csv('../data/075_all_daily_sweet.csv')


highest_daily_fruit_intake <- ceiling( max(all_fruit$fruitdaily))
lowest_daily_fruit_intake <- floor( min(all_fruit$fruitdaily))

highest_daily_sweet_intake <- ceiling( max(all_sweet$sweetdaily))
lowest_daily_sweet_intake <- floor( min(all_sweet$sweetdaily))

all_kle_irep <- combined %>% 
  filter(str_detect(best_species, 'Klebsiella'))

irep_highest <- ceiling( max(all_kle_irep$aveirep))
```

```{r abso}
library(vdbR)
connect_database('~/dbConfig.txt')
get_table_from_database('qpcr_16s_ag')
get_table_from_database('antibiotics_antibacterial_multicenter_ag')
qpcr <- qpcr_16s_ag %>% 
  filter(!str_detect(sample_id_unique, 'heat|ethanol')) %>% 
  filter(!is.na(copies_16s_per_g))


target <- combined %>% 
  filter(str_detect(best_species, 'Klebsiella')) %>% 
  arrange(desc(aveirep)) %>% 
  slice(1) %>% 
  select(mrn) %>% 
  pull(mrn)

# all of the stool samples we have of this patient
get_table_from_database('samples_castori_ag')
get_table_from_database('asv_annotation_blast_ag')
sam <- samples_castori_ag %>% 
  filter(mrn %in% target) %>% 
  distinct(sampleid) %>% 
  pull(sampleid)

samps <- samples_castori_ag %>% 
  filter(mrn %in% target) %>% 
  distinct(sampleid, mrn)

# get the  relab of these samples
cts <- get_counts_subset(sam)
ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
cts_ <- cts %>% 
  left_join(asv_annotation_blast_ag %>% 
              select(asv_key, genus)) %>% 
  group_by(sampleid, genus) %>% 
  summarise(relab = sum(count_relative)) %>% 
  filter(genus == 'Klebsiella')  %>% 
  inner_join(qpcr %>% 
               select(sampleid = sample_id, copies_16s_per_g)) %>% 
  mutate(kle_copy = copies_16s_per_g*relab) %>% 
  inner_join(samples_castori_ag %>% 
               select(sampleid, datecollection)) %>% 
  inner_join(samps) %>% 
  inner_join(ptb %>% 
               select(mrn, hct)) %>% 
  mutate(sdrt = datecollection - hct) 

```
```{r irep}
growth <- combined %>% 
  filter(mrn == target & str_detect(best_species, 'Klebsiella'))
```

```{r food}
# fruit intake
lowerday <- min(growth$sdrt)
highday <- max(growth$sdrt)

fruit <- dtb %>%  
  filter(mrn == target & fdrt %in% lowerday:highday) %>% 
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^6')) %>% 
  group_by(fdrt) %>% 
  summarise(fruitsum = sum(dehydrated_weight)) %>% 
  full_join(tibble(
    fdrt = seq(lowerday, highday, 1)
  )) %>% 
  mutate(fruitsum = if_else(is.na(fruitsum), 0, fruitsum))


sweets <- dtb %>%  
  filter(mrn == target & fdrt %in% lowerday:highday) %>% 
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^9')) %>% 
  group_by(fdrt) %>% 
  summarise(sweetsum = sum(dehydrated_weight)) %>% 
  full_join(tibble(
    fdrt = seq(lowerday, highday, 1)
  )) %>% 
  mutate(sweetsum = if_else(is.na(sweetsum), 0, sweetsum))

```
```{r abx}
# abx
abx <- antibiotics_antibacterial_multicenter_ag %>% 
  filter(patient_id == as.character(target) ) %>% 
  rename(mrn = patient_id) %>% 
  mutate(mrn = as.numeric(mrn)) %>% 
  left_join(ptb %>% 
              select(mrn, hct)) %>% 
  mutate(startdrt = start - hct,
         stopdrt = stop - hct) %>% 
  # only select the days relevant
  filter(startdrt %in% -2:4) %>% 
  mutate(drugfull = str_glue('{drug_name_clean} ({route_simple})')) %>% 
  arrange(startdrt, stopdrt) %>% 
  mutate(yval = seq(1, nrow(.)))
```
```{r plotting}
xmin <- lowerday - 1 
xmax <- highday + 1  
 
# plotting
copies <- cts_ %>% 
  ggplot(aes(x = sdrt, y = kle_copy )) +
  geom_point() +
  geom_line(aes(x = sdrt, y = kle_copy), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = 'Day relative to transplant',
       y = 'Klebsiella copy\nnumbers',
       title = 'Copy numbers') +
  theme_classic() +
  theme(aspect.ratio=plot_ratio,
        plot.margin = margin(l=-0.8,unit="cm"),
        panel.grid.major.x = element_line(colour = "grey85"))


fruit_time <- fruit %>% 
  ggplot(aes(x = fdrt, y = fruitsum )) +
  geom_point() +
  geom_line(aes(x = fdrt, y = fruitsum), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = '',
       y = 'Fruits intake',
       title = 'Fruits intake') +
  theme_classic() + 
  ylim(lowest_daily_fruit_intake, highest_daily_fruit_intake)+
  geom_hline(yintercept = quantile(x = all_fruit$fruitdaily, 0.25), linetype = 'dashed') +
  geom_hline(yintercept = quantile(x = all_fruit$fruitdaily, 0.5), linetype = 'dashed') + 
  geom_hline(yintercept = quantile(x = all_fruit$fruitdaily, 0.75), linetype = 'dashed') +
  theme(aspect.ratio=plot_ratio,  
        plot.margin = margin(l=-0.8,unit="cm"),
        #axis.text.x=element_blank(),
        #axis.ticks.x=element_blank(),
        panel.grid.major.x = element_line(colour = "grey85"))

  
sweets_time <- sweets %>%    
  ggplot(aes(x = fdrt, y = sweetsum )) +
  geom_point() +
  geom_line(aes(x = fdrt, y = sweetsum), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = '',
       y = 'Sweets intake',
       title = 'Sweets intake') +
  theme_classic() + 
  ylim(lowest_daily_sweet_intake, highest_daily_sweet_intake)+
  geom_hline(yintercept = quantile(x = all_sweet$sweetdaily, 0.25), linetype = 'dashed') +
  geom_hline(yintercept = quantile(x = all_sweet$sweetdaily, 0.5), linetype = 'dashed') + 
  geom_hline(yintercept = quantile(x = all_sweet$sweetdaily, 0.75), linetype = 'dashed') +
  theme(aspect.ratio=plot_ratio,
        plot.margin = margin(l=-0.8,unit="cm"),
        #axis.text.x=element_blank(),
        #axis.ticks.x=element_blank(),
        panel.grid.major.x = element_line(colour = "grey85"))

abx_time <- ggplot(abx, aes(x = startdrt, y = yval, xend = stopdrt, yend = yval, label = drugfull )) +
  geom_segment(
     size = 0.5, lineend = 'round',
     arrow = arrow(length = unit(0.05, "inches"))
  ) +
  geom_text(hjust = 'outside', nudge_y = -0.1, nudge_x = 5, size = 2) +
   xlim(xmin, xmax) +
  labs(x = '',
       y = '',
       title = 'Antibiotics') + 
  theme_classic() +
  theme(aspect.ratio=plot_ratio,
        #axis.text.x=element_blank(),
        #axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.grid.major.x = element_line(color = "grey85"))



irep = growth %>% 
  ggplot(aes(x = sdrt, y = aveirep )) +
  geom_point() +
  labs(title = str_glue('{}')) +
  geom_hline(yintercept = quantile(x = all_kle_irep$aveirep, 0.25), linetype = 'dashed') +
  geom_hline(yintercept = quantile(x = all_kle_irep$aveirep, 0.5), linetype = 'dashed') +
  geom_hline(yintercept = quantile(x = all_kle_irep$aveirep, 0.75), linetype = 'dashed') +
  xlim(xmin, xmax) +
  ylim(1, irep_highest) +
  labs(x = '', 
       y = 'Growth rate',
       title = 'Klebsiella')+
  theme_classic()+
  theme(aspect.ratio=plot_ratio,
        #axis.text.x=element_blank(),
        #axis.ticks.x=element_blank(),
        panel.grid.major.x = element_line(color = "grey85"))
```


```{r population_box}
# the boxes of the populations 
all_kle <- all_kle_irep %>% 
  ggviolin(y = 'aveirep', add = 'boxplot') +
  theme_classic() +
   ylim(1, irep_highest) +
  theme(aspect.ratio=6*plot_ratio,
       axis.ticks.x=element_blank(),
       axis.title.x = element_blank(),
       axis.ticks.y=element_blank(),
       axis.title.y = element_blank(),
       axis.text.y = element_blank(),
       line = element_blank(),
       axis.text.x = element_blank() ) 


violin9 <- all_sweet %>% 
  ggviolin(y = 'sweetdaily', add = 'boxplot') +
  theme_classic() +
   ylim(lowest_daily_sweet_intake, highest_daily_sweet_intake)+
  theme(aspect.ratio=6*plot_ratio,
       axis.ticks.x=element_blank(),
       axis.title.x = element_blank(),
       axis.ticks.y=element_blank(),
       axis.title.y = element_blank(),
       axis.text.y = element_blank(),
       line = element_blank(),
       axis.text.x = element_blank() )
```


```{r population_box}
violin6 <- all_fruit %>% 
  ggviolin(y = 'fruitdaily', add = 'boxplot') +
  theme_classic() +
   ylim(lowest_daily_fruit_intake, highest_daily_fruit_intake)+
  theme(aspect.ratio=2,
       axis.ticks.x=element_blank(),
       axis.title.x = element_blank(),
       axis.ticks.y=element_blank(),
       axis.title.y = element_blank(),
       axis.text.y = element_blank(),
       #line = element_blank(),
       axis.text.x = element_blank() )

f_row <- plot_grid(
                     fruit_time,violin6,
                     byrow = T,
          ncol = 2, axis = 'b', align = 'h', 
          rel_widths = c(1, 0.3))
f_row  
```


```{r population_box}
pkle_ver <- plot_grid(abx_time, NA,
                     sweets_time,violin9,
                     fruit_time,violin6,
                     irep, all_kle,
                     copies,NA,
                     byrow = T,
          ncol = 2, axis = 'ltbr', align = 'hv', 
          rel_widths = c(1, 0.5))
pkle_ver

ggsave('../figs/paper/095_irep_kle_vertical.pdf', width = 90,
      height = 250, units = 'mm', dpi = 400, plot = pkle_ver)
```

```{r with_p11}
p11 <- read_rds('../data/075_p11_vertical5.rds')
 
both <- plot_grid(p11, pkle_ver,
                     byrow = T,
          ncol = 2, axis = 'ltbr', align = 'hv', rel_widths = c(1, 1), labels = c('C','D'))

ggsave('../figs/paper/095_both_vertical5.pdf', width = 260,
      height = 250, units = 'mm', dpi = 400, plot = both)
```


# Scatter two by two  

```{r} 
tbt_kle <- bind_rows( 
  combined %>% 
    filter(str_detect(best_species, 'Klebsiella')) %>% 
    group_by(sampleid) %>% 
    summarise(ave_irep = mean(aveirep)) %>% 
    inner_join(meta) %>% 
    mutate(grp = 'Klebsiella only'),
  combined %>% 
    filter(!str_detect(best_species, 'Klebsiella')) %>% 
    group_by(sampleid) %>% 
    summarise(ave_irep = mean(aveirep)) %>% 
    inner_join(meta) %>% 
    mutate(grp = 'All taxa excl. Klebsiella')
) %>% 
  select(sampleid, ave_irep, grp, fg_sweets, fg_fruit ) %>% 
  gather('fg', 'gram', fg_sweets:fg_fruit) %>% 
  mutate(grp = factor(grp, levels = c('Klebsiella only','All taxa excl. Klebsiella'))) %>% 
  left_join(key)

f3b <- tbt_kle %>% 
  ggscatter(x = 'gram', y = 'ave_irep', alpha = 0.5,
            xlab = 'Intake in previous 2 days (g)',
            ylab = 'Average growth rate\n(iRep estimation)',
             add = "reg.line", 
           add.params = list(color = "blue", fill = "lightgray"), # Customize line
           conf.int = TRUE,
           cor.coef = TRUE, 
           cor.coeff.args = list(method = "spearman",  label.sep = "\n", size = 2, label.x = 180)) +
  facet_grid(shortname ~ grp) +
  theme_bw() +
  theme(strip.text.x = element_text(size = 8))

f3b %>% write_rds('../data/094_f3b.rds')
```

```{r whole_f3}
f3a <- read_rds('../data/094_f3a.rds')
f3b <- read_rds('../data/094_f3b.rds')


top <- plot_grid(f3a, f3b, labels = c('A', 'B'),rel_widths  = c(1, 1) )

f3 <-  plot_grid(top,both,
                 rel_heights = c(1,4),
                 nrow = 2)

 
ggsave('../figs/paper/F3_entero_fruit_095.pdf',
       width = 180,
       height = 300,
         #height = 60,
         units = c("mm"),
         dpi = 400, plot = f3)  
```


