---
title: "klebsiella high irep"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggpubr)
library(tidyverse)
```

```{r}
combined <- read_csv('../data/growth/069_irep_combined_res.csv')
meta <- read_csv('../data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
dtb <- read_csv('../data/cleaned_diet_data/FINAL_97_with_code_all_foods_drt_with_EN_finalized.csv')
```

```{r abso}
library(vdbR)
connect_database('~/dbConfig.txt')
get_table_from_database('qpcr_16s_ag')
get_table_from_database('antibiotics_antibacterial_multicenter_ag')
qpcr <- qpcr_16s_ag %>% 
  filter(!str_detect(sample_id_unique, 'heat|ethanol')) %>% 
  filter(!is.na(copies_16s_per_g))


target <- combined %>% 
  filter(str_detect(best_species, 'Klebsiella')) %>% 
  arrange(desc(aveirep)) %>% 
  slice(1) %>% 
  select(mrn) %>% 
  pull(mrn)

# all of the stool samples we have of this patient
get_table_from_database('samples_castori_ag')
get_table_from_database('asv_annotation_blast_ag')
sam <- samples_castori_ag %>% 
  filter(mrn %in% target) %>% 
  distinct(sampleid) %>% 
  pull(sampleid)

samps <- samples_castori_ag %>% 
  filter(mrn %in% target) %>% 
  distinct(sampleid, mrn)

# get the  relab of these samples
cts <- get_counts_subset(sam)
ptb <- read_csv('../data/cleaned_patients/diet_patients_97.csv')
cts_ <- cts %>% 
  left_join(asv_annotation_blast_ag %>% 
              select(asv_key, genus)) %>% 
  group_by(sampleid, genus) %>% 
  summarise(relab = sum(count_relative)) %>% 
  filter(genus == 'Klebsiella')  %>% 
  inner_join(qpcr %>% 
               select(sampleid = sample_id, copies_16s_per_g)) %>% 
  mutate(kle_copy = copies_16s_per_g*relab) %>% 
  inner_join(samples_castori_ag %>% 
               select(sampleid, datecollection)) %>% 
  inner_join(samps) %>% 
  inner_join(ptb %>% 
               select(mrn, hct)) %>% 
  mutate(sdrt = datecollection - hct) 

```
```{r irep}
growth <- combined %>% 
  filter(mrn == target & str_detect(best_species, 'Klebsiella'))
```

```{r food}
# fruit intake
lowerday <- min(growth$sdrt)
highday <- max(growth$sdrt)

fruit <- dtb %>%  
  filter(mrn == target & fdrt %in% lowerday:highday) %>% 
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^6')) %>% 
  group_by(fdrt) %>% 
  summarise(fruitsum = sum(dehydrated_weight)) %>% 
  full_join(tibble(
    fdrt = seq(lowerday, highday, 1)
  )) %>% 
  mutate(fruitsum = if_else(is.na(fruitsum), 0, fruitsum))


sweets <- dtb %>%  
  filter(mrn == target & fdrt %in% lowerday:highday) %>% 
  mutate(Food_code = as.character(Food_code) ) %>% 
  filter(str_detect(Food_code, '^9')) %>% 
  group_by(fdrt) %>% 
  summarise(sweetsum = sum(dehydrated_weight)) %>% 
  full_join(tibble(
    fdrt = seq(lowerday, highday, 1)
  )) %>% 
  mutate(sweetsum = if_else(is.na(sweetsum), 0, sweetsum))

```
```{r abx}
# abx
abx <- antibiotics_antibacterial_multicenter_ag %>% 
  filter(patient_id == as.character(target) ) %>% 
  rename(mrn = patient_id) %>% 
  mutate(mrn = as.numeric(mrn)) %>% 
  left_join(ptb %>% 
              select(mrn, hct)) %>% 
  mutate(startdrt = start - hct,
         stopdrt = stop - hct) %>% 
  # only select the days relevant
  filter(startdrt %in% -2:4) %>% 
  mutate(drugfull = str_glue('{drug_name_clean} ({route_simple})')) %>% 
  arrange(startdrt, stopdrt) %>% 
  mutate(yval = seq(1, nrow(.)))
```
```{r}
xmin <- lowerday - 1 
xmax <- highday + 1  
 
# plotting
copies <- cts_ %>% 
  ggplot(aes(x = sdrt, y = kle_copy )) +
  geom_point() +
  geom_line(aes(x = sdrt, y = kle_copy), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = 'Day relative to transplant',
       y = 'Klebsiella copy\nnumbers',
       title = 'Copy numbers') +
  theme_classic() +
  theme(aspect.ratio=1,
        plot.margin = margin(l=-0.8,unit="cm"),
        panel.grid.major.x = element_line(colour = "grey85"))


fruit_time <- fruit %>% 
  ggplot(aes(x = fdrt, y = fruitsum )) +
  geom_point() +
  geom_line(aes(x = fdrt, y = fruitsum), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = '',
       y = 'Fruit intake',
       title = 'Fruit intake') +
  theme_classic() + 
  #ylim(lowest_daily_fruit_intake, highest_daily_fruit_intake)+
  #scale_y_sqrt() +
  #geom_hline(yintercept = f_q25, linetype = 'dashed') +
  #geom_hline(yintercept = f_q50, linetype = 'dashed') + 
  #geom_hline(yintercept = f_q75, linetype = 'dashed') +
  theme(aspect.ratio=1,
        plot.margin = margin(l=-0.8,unit="cm"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid.major.x = element_line(colour = "grey85"))

  
sweets_time <- sweets %>%    
  ggplot(aes(x = fdrt, y = sweetsum )) +
  geom_point() +
  geom_line(aes(x = fdrt, y = sweetsum), linetype = 'solid', size = 0.5, col = 'black') +
  xlim(xmin, xmax) +
  labs(x = '',
       y = 'Sweets intake',
       title = 'Sweets intake') +
  theme_classic() + 
 # ylim(lowest_daily_sweet_intake, highest_daily_sweet_intake)+
  #scale_y_sqrt() +
  #geom_hline(yintercept = s_q25, linetype = 'dashed') +
  #geom_hline(yintercept = s_q50, linetype = 'dashed') + 
  #geom_hline(yintercept = s_q75, linetype = 'dashed') +
  theme(aspect.ratio=1,
        plot.margin = margin(l=-0.8,unit="cm"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid.major.x = element_line(colour = "grey85"))

abx_time <- ggplot(abx, aes(x = startdrt, y = yval, xend = stopdrt, yend = yval, label = drugfull )) +
  geom_segment(
     size = 0.5, lineend = 'round',
     arrow = arrow(length = unit(0.05, "inches"))
  ) +
  geom_text(hjust = 'outside', nudge_y = -0.1, nudge_x = 5, size = 2) +
  labs(x = '',
       y = '',
       title = 'Antibiotics') + 
  theme_classic() +
  theme(aspect.ratio=1,
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.y=element_blank(),
        panel.grid.major.x = element_line(color = "grey85"))



irep = growth %>% 
  ggplot(aes(x = sdrt, y = aveirep )) +
  geom_point() +
  labs(title = str_glue('{}')) +
  #geom_hline(yintercept = irep_q25, linetype = 'dashed') +
  #geom_hline(yintercept = irep_q50, linetype = 'dashed') +
  #geom_hline(yintercept = irep_q75, linetype = 'dashed') +
  xlim(xmin, xmax) +
  #ylim(1, irep_highest) +
  labs(x = '',
       y = 'Average replication rate',
       title = 'Klebsiella')+
  theme_classic()+
  theme(aspect.ratio=1,
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid.major.x = element_line(color = "grey85"))
 
 
 
pkle_ver <- plot_grid(abx_time, 
                     sweets_time, 
                     fruit_time,
                     irep, 
                     copies,
                     byrow = T,
          ncol = 1, axis = 'ltbr', align = 'hv')
pkle_ver

ggsave('../figs/paper/095_irep_kle_vertical.pdf', width = 130,
      height = 250, units = 'mm', dpi = 400, plot = pkle_ver)
```

