---
title: "Prepare the mean microbe composition table and mean food counts table for every patient"
output: html_document 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
```

```{r}
# get the stool cohort for these patients
stb <- read_csv('../data/finalized/stool/filter_stool_close_to_diet_meta.csv') %>% 
  filter(keep == 'keep')

nrow(stb)
```

# the mean microbe composition table 

```{r}
source('~/db_connect_simple.R')
connect_database(config_file = '~/dbConfig.txt')
get_table_from_database_predefined_filter('asv_counts_ag')
ANNOT <- get_table_from_database('asv_annotation_blast_ag')
```

```{r}
cts <- asv_counts_ag %>% 
  filter(sampleid %in% stb$sampleid) %>% 
  select(asv_key, sampleid, count) %>% 
  spread(key = 'sampleid', value = 'count', fill = 0) %>% 
  arrange(asv_key)  


annot <- ANNOT %>% 
  filter(asv_key %in% cts$asv_key) %>% 
  mutate(ordr =  if_else(ordr == '', str_glue('of_class_{class}'), ordr),
         family =  if_else(family == '', str_glue('of_order_{ordr}'), family),
         genus =  if_else(genus == '', str_glue('of_family_{family}'), genus),
         species =  if_else(species == '', str_glue('of_genus_{genus}'), species)) %>% 
  mutate(taxa_species = str_glue('k__{kingdom}|p__{phylum}|c__{class}|o__{ordr}|f__{family}|g__{genus}|s__{species}'))


# replace the asv_key with the genus taxa level
# summarize from asv level to genus level
# get the relative abundance for the genera
cts_all <- cts %>% 
  full_join(annot %>%  select(asv_key, taxa_species), by  = 'asv_key') %>% 
  select(-asv_key) %>% 
  gather(key = 'sampleid', value = 'count', names(.)[1]:names(.)[ncol(.) - 1]) %>% 
  group_by(sampleid, taxa_species) %>% 
  summarise(cnt = sum(count)) %>% 
  # get the total count from the db to calculate the relab
  left_join(asv_counts_ag %>% distinct(sampleid,count_total ), by = 'sampleid') %>% 
  mutate(relab = cnt/count_total) %>% 
  select(sampleid, taxa_species, relab) %>% 
  left_join(stb %>% select(mrn, sampleid), by = 'sampleid') %>% 
  # get the mean relab for the species for every pt
  group_by(mrn, taxa_species) %>% 
  summarise(mean_relab = mean(relab)) %>% 
  spread(key = 'mrn', value = 'mean_relab', fill = 0)


cts_all %>% 
  write_tsv('../data/finalized/stool/mean_microbe_relab_per_pt.tsv')

# and then following will be going to snakefile to do the qiime way. 


```

# the mean food counts table 

```{r}
final <- read_csv('../data/finalized/all_patients_record_w_food_code.csv')

food_mean <- final %>% 
  select(mrn, Food_code, dehydrated_weight) %>% 
  group_by(mrn, Food_code) %>% 
  summarise(mean_dewt = mean(dehydrated_weight)) %>% 
  spread(key = 'mrn', value = 'mean_dewt', fill = 0)

food_mean %>% 
  write_tsv('../data/finalized/mean_foodID_dehydrated_weight_per_pt.tsv')

# and then go to qiime and do something simimlar to the microbe
```

# doing procrustes myself using vegan package

```{r}
library(vegan)
scts <- cts_all %>% 
  gather('mrn', 'mean_relab', names(.)[2]:names(.)[ncol(.)]) %>% 
  spread('taxa_species','mean_relab') %>% 
  column_to_rownames('mrn')

scts.bray <- vegdist(scts, method = "bray")
add <-  !(is.euclid(scts.bray))
pcoa.scts <- cmdscale(scts.bray, k = nrow(scts)-1, eig = TRUE, add = add)
ordiplot(pcoa.scts, type = "text", main = "PCoA for Species Data, Bray Distances")
```

```{r}
fcts <- food_mean %>% 
  gather('mrn','mean_dewt', names(.)[2]:names(.)[ncol(.)]) %>% 
  spread('Food_code','mean_dewt') %>% 
  column_to_rownames('mrn')


```

