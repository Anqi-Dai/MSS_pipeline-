---
title: "Tree building"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(data.tree)
library(viridisLite)
library(dplyr)
library(tidyr)
library(reshape2)
library(kableExtra)
library(readxl)
```


```{r}
### The food database with all the unique food from the diet project
# need to get rid of the all the special characters, so that you will only see underscores
# all!!!! including the semicolon damn the semi colon
# uni is the table with unique food_nsc translated to fndds code
uni <- read_excel('../data/source/eaten_FNDDS.xlsx', sheet = 1)

uni_rm <- read_excel('../data/source/eaten_FNDDS.xlsx', sheet = 2, col_names = F)

uniq_food <- uni %>% 
  distinct(item1_value_raw_raw,  .keep_all = T)

food_database <- uniq_food %>% 
  select(-item1_index) %>% 
  rename(FoodID = Food.Code,
         Main.food.description = FNDDS.Main.Food.Description) %>% 
  select(item1_value_raw_raw: WWEIA.Category.Description) %>% 
  filter(!is.na(FoodID)) %>% 
  mutate(Main.food.description = str_replace_all(Main.food.description,',| |-|\\(|\\)|%|/|"|;','_')) %>% 
  mutate(Main.food.description = str_replace_all(Main.food.description,"'",""))

food_database %>% 
  write_tsv('../data/source/food_database_file.tsv')


food_database %>% 
  distinct(Main.food.description)

length(intersect(food_database$Main.food.description, food_cts$Main.food.description))
```


```{r}
food_database_fn <- '../data/source/food_database_file.tsv'
nodes_fn <- '../data/source/NodeLabelsMCT.txt'
#nodes_fn <- '../data/source/NodeLabels.txt'
num.levels <- 7
```

```{r}

fdata <- read.table(food_database_fn, header = TRUE, sep="\t", colClasses="character", fill = TRUE , quote="", strip.white=T)
nodes <- read.table(nodes_fn, header = TRUE, sep="\t", fill = TRUE , colClasses="character")

main <- fdata[,c("FoodID", "Main.food.description")]


# if there happen to be duplicate FoodIDs in main, remove them
main <- main[!duplicated(main$FoodID),]

flevels <- NULL
for(i in 1:num.levels)
    flevels <- cbind(flevels, I(substr(main$FoodID, 1, i)))
colnames(flevels) <- paste0("L",1:num.levels)
main <- data.frame(main, flevels, stringsAsFactors=F)
```

```{r}
# melt the data, merge to get the node names, then cast back
main.melt <- melt(main, id.vars = "FoodID", variable.name = "Level", value.name = "Level.code")
main.merge <- merge(main.melt, nodes, by = "Level.code")
main.cast <- dcast(main.merge, FoodID ~ Level, value.var = "Main.food.description")

# prepend level to all level descriptions
main.cast[is.na(main.cast)] <- ""
main.cast[,colnames(main.cast)[-1]] <- sapply(colnames(main.cast)[-1], function(colname) paste(colname, main.cast[,colname], sep="_"))

# merge back with original table to grab Food Description
main.join <- merge(main.cast, main[,c("FoodID","Main.food.description")], by="FoodID")
```

```{r}
# create a proper newick string for the tree
newickstring <- paste("foodtreeroot", apply(main.join, 1, function(xx) paste(xx[-1], collapse="/")), sep="/")
# create a proper taxonomy string for QIIME
taxonomy <- apply(main.join, 1, function(xx) paste(xx[-1], collapse=";"))

final.table <- data.frame(main.join, newickstring, taxonomy, stringsAsFactors=F)



#######################################################
# remove the three items that are not in the feature table
#######################################################
# remove3 <- setdiff(final.table %>% 
#          pull(Main.food.description) , food_cts %>% mutate(main_food_desc = str_replace_all(main_food_desc, ' ', '_')) %>% 
#           pull(main_food_desc)
#           )

final.table <- final.table 
# %>% 
#   filter(!Main.food.description %in% remove3)

# to see the overlap between the food id in the feature table and the food id in the tree file
length(intersect(final.table$FoodID, food_cts$FoodID))

# recreate the newick string that will be in the tree file replacing the main food desc with food id
final.table <- final.table %>% 
  mutate(newickstring = str_glue('foodtreeroot/{L1}/{L2}/{L3}/{L4}/{L5}/{L6}/{FoodID}'))
```


```{r}
#### Make and export the tree ####
foodTree <- as.Node(final.table, pathName = "newickstring")
tree <- ToNewick(foodTree)
cat(tree, file = '../data/source/output_food_tree_datatree.newick')

#### Make and export the taxonomy file ####
export <- final.table %>% select(FoodID, taxonomy, Main.food.description)
#export$Main.food.description <- gsub("_", " ", export$Main.food.description)
write.table(export, '../data/source/output_taxonomy.txt', sep = "\t", quote = FALSE, row.names = FALSE)
```


```{bash}
# in terminal
graphlan_annotate.py --annot annotation.base.txt output_food_tree_datatree.newick  guide_1.xml
graphlan.py guide_1.xml food_tree.png --dpi 300 --size 3.5
```

```{r}
# library(networkD3)
# useRtreeList <- ToListExplicit(foodTree, unname = TRUE)
# radialNetwork( useRtreeList)
```

```{r}
# tree_df <- data.tree::ToDataFrameTree(foodTree)
# library(DiagrammeR)
# tt <- data.tree::To

```
