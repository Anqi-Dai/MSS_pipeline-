---
title: "Relax paring threshold"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**For the 67 patients**

# fill in the diet matrix

```{r}
dtb67 <- read_csv('../data/finalized/all_patients_record_w_food_code.csv') %>% 
  select(mrn: Menu, Food_NSC,Por_eaten:Sodium_mg, Food_code:description, dehydrated_weight )

```


## create *0* counts for the entero nutrition info

```{r}
entero <- read_csv('../data/cleaned_diet_data/TPN_EN patients.csv') %>% 
  filter(mrn %in% dtb67$mrn) %>% 
  rename(DayRT = Days.Post.HSCT) %>% 
  mutate(nut_type = if_else(TPN.1..EN.2 == 1, "TPN", "EN")) %>% 
  select(mrn, DayRT, nut_type)
```
 
```{r}
# to see if there is overlap between the normal diet and the above one
overlap <- entero %>% 
  inner_join(dtb67) %>% 
  distinct(mrn, DayRT, nut_type)

overlap %>% 
  distinct(nut_type)

# since all of the overlap are TPN which doesn't go thru colon, so ignore them  in the entero table
```
 
```{r}
entero_clean <- entero %>% 
  left_join(overlap, by = c("mrn", "DayRT")) %>% 
  filter(is.na(nut_type.y))  %>% 
  rename(nut_type = nut_type.x) %>% 
  select(-nut_type.y) %>% 
  select(- nut_type)
```
 
```{r}
ftb_colnames <- colnames(dtb67)
```
 
 
```{r}
# use all of the foods this patients has ever eaten as the food_nsc
create_fake_food_cts_for_enteral_patient <- function(mrn_, DayRT_){
  this_pt = dtb67 %>% 
    filter(mrn == mrn_) %>% 
    distinct(mrn, Food_NSC, Food_code, description) %>% 
    mutate(DayRT = DayRT_, 
           Meal = "fake meal",
           Menu = 'fake menu',
           Por_eaten = 0,
           Calories_kcal = 0, 
           Proteing_g = 0, 
           Fat_g = 0,
           Carbohydrates_g = 0,
           Fibers_g = 0,
           Sugars_g =0,
           Sodium_mg =0,
           dehydrated_weight = 0) %>% 
    select(all_of(ftb_colnames))
}
         
fake_enteral <- pmap_dfr(entero_clean, function(mrn, DayRT){
  create_fake_food_cts_for_enteral_patient(mrn, DayRT)
} )

```
 
## create *NA* counts for the missing days 

No need to create cuz we are gonna ignore it.


## the combined table(include fake data)

```{r}
filled <- bind_rows(dtb67, fake_enteral)
```

# make one stool with previous 3 days diet pairing

There has to be one real day's data in the previous 3 days
   
 
## Get all of the qualified stool samples (remove the empirical abx affected ones)

```{r}
all_stool <- read_csv('../data/finalized/stool/filter_stool_close_to_diet_meta.csv') %>% 
  filter(keep == 'keep')  

censor_abx <- c('active_atb_vanco_po',	'active_atb_imipenem',	'active_atb_meropenem',	'active_atb_ertapenem',		'active_atb_cefepime',		'active_atb_linezolid',	'active_atb_metro',	'active_atb_piptazo')

abx_all <- read_csv('../data/finalized/abx/abx_all_samples_with_censoring_info.csv')
  
abx_all_stool_censor_samples <- abx_all %>% 
  filter(sampleid %in% all_stool$sampleid) %>% 
  select(sampleid, active_atb_cipro:active_atb_other) %>% 
  gather(key = 'abx_type', value = 'value', names(.)[2]:names(.)[ncol(.)]) %>% 
  filter(abx_type %in% censor_abx) %>% 
  filter(value == T) %>% 
  distinct(sampleid) %>% 
  pull(sampleid)  

qua_stool <- all_stool %>% 
  filter(!sampleid %in% abx_all_stool_censor_samples) %>% 
  select(mrn, sampleid, drt) %>% 
  mutate(id = paste0("row", 1:nrow(.)))

qua_stool %>% 
  count(mrn) %>% 
  arrange(n)

```


```{r}
# continue selecting qualified stool samples, there has to be at least one real day's diet data in the previous three days.

# list the previous three days drt for every stool sample 
qual_stool_df <- qua_stool %>% 
  mutate(p1d = drt-1,
         p2d = drt-2,
         p3d = drt-3) %>% 
  select(-sampleid, -drt, -id)

# use the non fake diet counts table and get the stool samples that should be removed -- not even one day
no_real_diet_d_to_be_rm_stool_s <- function(mrn_, p1d_, p2d_, p3d_){
  df = dtb67 %>% 
    filter(mrn == mrn_) %>% 
    filter(DayRT == p1d_ | DayRT == p2d_ |DayRT == p3d_ ) %>% 
    nrow()
  
  return(df)
}

qual_stool2 <- pmap(qual_stool_df, function(mrn, p1d, p2d, p3d){
    no_real_diet_d_to_be_rm_stool_s(mrn, p1d, p2d, p3d)
  }) %>% 
  set_names(paste0("row", 1:nrow(qual_stool_df))) %>% 
  bind_rows() %>% 
  gather(key = 'id', value = 'num_d_records') %>% 
  arrange(num_d_records) %>% 
  full_join(qua_stool, by  = 'id')
  
qual_stool_sampled_final <- qual_stool2 %>% 
  filter(num_d_records > 0)  %>% 
  select(-id, -num_d_records)
```




