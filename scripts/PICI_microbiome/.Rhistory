arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_responder}'))
meta_amadeus
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}'))
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}'))
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}')) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(pid_res ~ CD8_Conversion_Hot_to_Cold, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold.pdf', width = 20, height = 15)
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}')) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(pid_res ~ CD8_Conversion_Hot_to_Cold, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold_with_pidres.pdf', width = 20, height = 15)
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold_with_pidres.pdf', width = 10, height = 6)
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}')) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(pid_res ~ CD8_Conversion_Hot_to_Cold, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold_with_pidres.pdf', width = 10, height = 8)
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}')) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(pid_res ~ CD8_Conversion_Hot_to_Cold, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold_with_pidres.pdf', width = 15, height = 8)
?facet_wrap
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}')) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(pid_res ~ CD8_Conversion_Hot_to_Cold, scales = 'free', nrow = 2) +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold_with_pidres.pdf', width = 15, height = 8)
View(family)
# the dat with family relab and also meta data
dat <- family %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}'))
View(dat)
dat
# create a small legend with only the major fams
major_fam <- dat %>%
filter(relab > 4) %>%
distinct(fam)
View(major_fam)
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam)
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam) %>%
pull(fam)
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam) %>%
pull(fam)
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'right')
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 5)
palette
full_pal <- palette
dat_order_fam <- dat %>%
mutate(fam = fct_reorder(fam, family,  .desc = F))
dat_order_fam
names(palette) <- levels(dat_order_fam$fam)
full_pal
# split by Best_Overall_Response
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
arrange(sid) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white',
xlab = '', ylab = 'Relative abundance') +
facet_wrap(~ Best_Overall_Response, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_Best_Overall_Response.pdf', width = 10, height = 5)
names(full_pal) <- levels(dat_order_fam$fam)
full_pal
full_pal[names(full_pal) %in% major_fam]
fam22 <- full_pal[names(full_pal) %in% major_fam]
fam22
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'right')
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 5)
?guide_legend
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam) %>%
pull(fam)
dat_order_fam <- dat %>%
mutate(fam = fct_reorder(fam, family,  .desc = F))
full_pal <- palette
names(full_pal) <- levels(dat_order_fam$fam)
fam22 <- full_pal[names(full_pal) %in% major_fam]
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'right')  +
guides(col = guide_legend(ncol = 1))
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 5)
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'right')  +
guides(col = guide_legend(ncol = 1, nrow = 22))
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'right')  +
guides(col = guide_legend(ncol = 1))
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'right')  +
guides(fam = guide_legend(ncol = 1))
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
#theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')  +
guides(fam = guide_legend(ncol = 1))
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = fam22) +
#theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')  +
guides(fam = guide_legend(ncol = 1)) +
theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')  +
guides(fill = guide_legend(ncol = 1))
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam) %>%
pull(fam)
dat_order_fam <- dat %>%
mutate(fam = fct_reorder(fam, family,  .desc = F))
full_pal <- palette
names(full_pal) <- levels(dat_order_fam$fam)
fam22 <- full_pal[names(full_pal) %in% major_fam]
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')  +
guides(fill = guide_legend(ncol = 1))
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 5)
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam) %>%
pull(fam)
dat_order_fam <- dat %>%
mutate(fam = fct_reorder(fam, family,  .desc = F))
full_pal <- palette
names(full_pal) <- levels(dat_order_fam$fam)
fam22 <- full_pal[names(full_pal) %in% major_fam]
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')  +
guides(fill = guide_legend(ncol = 1))
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 5)
# create a small legend with only the major fams
major_fam <- dat %>%
ungroup() %>%
filter(relab > 4) %>%
distinct(fam) %>%
pull(fam)
dat_order_fam <- dat %>%
mutate(fam = fct_reorder(fam, family,  .desc = F))
full_pal <- palette
names(full_pal) <- levels(dat_order_fam$fam)
fam22 <- full_pal[names(full_pal) %in% major_fam]
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
filter(fam %in% major_fam) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
scale_fill_manual(values = fam22) +
theme( axis.text.x = element_text(angle=45, hjust=1), legend.position = 'right')  +
guides(fill = guide_legend(ncol = 1))
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 5)
ggsave('../figs/03_family_legend22.pdf', width = 10, height = 8)
# split by visit
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_visit.pdf', width = 10, height = 5)
# split by visit
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ,
xlab = '', ylab = 'Relative abundance') +
facet_wrap(~ Visit, scales = 'free') +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_visit.pdf', width = 10, height = 5)
family %>%
mutate(fam = str_extract(family, 'f__.+$')) %>%
mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}')) %>%
ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' , xlab = '', ylab = 'Relative abundance') +
facet_wrap(pid_res ~ CD8_Conversion_Hot_to_Cold, scales = 'free', nrow = 2) +
scale_fill_manual(values = palette) +
theme( axis.text.x = element_text(angle=45, hjust=1),
legend.position = 'none')
ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold_with_pidres.pdf', width = 15, height = 8)
?adonis
View(family)
family
fam_table <- family %>%
select(sampleid, fam, relab)
View(fam_table)
fam_table <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab')
fam_table <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus)
fam_table <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
fam_joined <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
View(fam_joined)
fam_joined
fam_df <- fam_joined %>%
select(f__Acidaminococcaceae: f__Victivallaceae)
meta_amadeus
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit, data=fam_joined, permutations=999, method = 'bray',
strata = "pid")
fam_df
fam_df <- fam_joined %>%
ungroup() %>%
select(f__Acidaminococcaceae: f__Victivallaceae)
fam_df
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit, data=fam_joined, permutations=999, method = 'bray',
strata = "pid")
fam_joined
fam_joined <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
fam_df <- fam_joined %>%
ungroup() %>%
select(f__Acidaminococcaceae: f__Victivallaceae)
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit, data=fam_joined, permutations=999, method = 'bray',
strata = "pid")
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
summary(pmv_test)
pmv_test
meta_amadeus
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid + ORR_Responder, data=fam_joined, permutations=999, method = 'bray')
pmv_test
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid + ORR_Responder, data=fam_joined, permutations=999, method = 'bray')
pmv_test
meta_amadeus
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid + CD8_Conversion_Hot_to_Cold, data=fam_joined, permutations=999, method = 'bray')
pmv_test
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
fam_joined <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
fam_df <- fam_joined %>%
ungroup() %>%
select(f__Acidaminococcaceae: f__Victivallaceae)
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
fam_joined <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
fam_joined <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
fam_df <- fam_joined %>%
ungroup() %>%
select(f__Acidaminococcaceae: f__Victivallaceae)
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
knitr::opts_chunk$set(echo = TRUE, message = F)
library(vegan)
library(ggpubr)
library(tidyverse)
# clean some columns variables
meta_amadeus <- read_csv('../data/01_meta_amadeus_full.csv')  %>%
mutate(Visit = if_else(Visit == 'On_Treatment', 'Rx', Visit)) %>%
mutate(ORR_Responder = if_else(ORR_Responder == 'Non-responder', 'N_responder', 'Y_responder')) %>%
mutate(CD8_Conversion_Hot_to_Cold = if_else(CD8_Conversion_Hot_to_Cold == 'No on-treatment biopsy', 'no_Rx_biopsy',CD8_Conversion_Hot_to_Cold)) %>%
mutate(sid = str_glue('{pid}__{Visit}')) %>%
arrange(sid)
# Only look at the spp in the current samples (29)
spp <- read_csv('../data/02_all_shotgun_metaphlan_spp.csv') %>%
filter(sampleid %in% meta_amadeus$sampleid)
# filter >0.01% in more than 25% samples
nsamp <- meta_amadeus %>% distinct(sampleid) %>% nrow
keepspp <- spp %>%
filter(perc > 0.01) %>%
count(clade_name) %>%
filter(n > floor(nsamp * 0.25)) %>%
pull(clade_name)
s <- tibble(spp = keepspp) %>%
mutate(spp = str_extract(spp, 's__.+$'))
cts_fil <- spp %>%
filter(clade_name %in% keepspp) %>%
select(sampleid, clade_name,perc ) %>%
spread(key = 'clade_name', value = 'perc', fill = 0) %>%
column_to_rownames('sampleid')
dist_ <- vegdist(cts_fil, method = 'bray')
eigen <- ape::pcoa(dist_)$values$Eigenvalues
percent_var <- signif(eigen/sum(eigen), 3)*100
bc <- cmdscale(dist_, k = 2)
beta_meta_amadeus <- bc %>%
as.data.frame() %>%
rownames_to_column('sampleid')  %>%
full_join(meta_amadeus)
spp %>%
write_csv('../data/03_amadeus_species_perc.csv')
# plotting at the genus level
genera <- spp %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(perc))
genera %>%
write_csv('../data/03_amadeus_genus_perc.csv')
genera %>%
ungroup() %>%
distinct(genus)
family <- spp %>%
mutate(family = str_replace(clade_name, '\\|g__.+$','')) %>%
group_by(sampleid, family) %>%
summarise(relab = sum(perc)) %>%
mutate(fam = str_extract(family, 'f__.+$'))
family %>%
write_csv('../data/03_amadeus_family_perc.csv')
# the dat with family relab and also meta data
dat <- family %>%
left_join(meta_amadeus, by = "sampleid") %>%
arrange(sid) %>%
mutate(pid_res = str_glue('{pid}: {ORR_Responder}'))
fam_joined <- family %>%
select(sampleid, fam, relab) %>%
spread('fam', 'relab') %>%
full_join(meta_amadeus, by = "sampleid")
fam_df <- fam_joined %>%
ungroup() %>%
select(f__Acidaminococcaceae: f__Victivallaceae)
pmv_test <- adonis(fam_df ~ Manual_Tumor_Buckets + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
meta_amadeus
pmv_test <- adonis(fam_df ~ CD8_Conversion_Hot_to_Cold + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
pmv_test <- adonis(fam_df ~ ORR_Responder + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
meta_amadeus
pmv_test <- adonis(fam_df ~ ORR_Responder + Manual_Tumor_Buckets + Visit + pid, data=fam_joined, permutations=999, method = 'bray')
pmv_test
