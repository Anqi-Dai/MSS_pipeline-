---
title: "beta diversity"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F)
```

```{r}
library(vegan)
library(ggpubr)
library(tidyverse)
```

```{r}
# clean some columns variables
meta_amadeus <- read_csv('../data/01_meta_amadeus_full.csv')  %>% 
  mutate(Visit = if_else(Visit == 'On_Treatment', 'Rx', Visit)) %>% 
  mutate(ORR_Responder = if_else(ORR_Responder == 'Non-responder', 'N_responder', 'Y_responder')) %>% 
  mutate(CD8_Conversion_Hot_to_Cold = if_else(CD8_Conversion_Hot_to_Cold == 'No on-treatment biopsy', 'no_Rx_biopsy',CD8_Conversion_Hot_to_Cold)) %>% 
  mutate(sid = str_glue('{pid}__{Visit}')) %>% 
  arrange(sid)
```


```{r}
# Only look at the spp in the current samples (29)
spp <- read_csv('../data/02_all_shotgun_metaphlan_spp.csv') %>% 
  filter(sampleid %in% meta_amadeus$sampleid)

# filter >0.01% in more than 25% samples
nsamp <- meta_amadeus %>% distinct(sampleid) %>% nrow

keepspp <- spp %>% 
  filter(perc > 0.01) %>% 
  count(clade_name) %>% 
  filter(n > floor(nsamp * 0.25)) %>% 
  pull(clade_name)

s <- tibble(spp = keepspp) %>% 
  mutate(spp = str_extract(spp, 's__.+$'))


cts_fil <- spp %>% 
  filter(clade_name %in% keepspp) %>% 
  select(sampleid, clade_name,perc ) %>% 
  spread(key = 'clade_name', value = 'perc', fill = 0) %>% 
  column_to_rownames('sampleid')


dist_ <- vegdist(cts_fil, method = 'bray')
eigen <- ape::pcoa(dist_)$values$Eigenvalues
percent_var <- signif(eigen/sum(eigen), 3)*100
bc <- cmdscale(dist_, k = 2)

beta_meta_amadeus <- bc %>%
  as.data.frame() %>%
  rownames_to_column('sampleid')  %>% 
  full_join(meta_amadeus)
```

# PCOA

```{r}
# color by response status
beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'ORR_Responder', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1)

# color by visit
beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'Visit', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1)

# color by study day
beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'Study_Day', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1) + 
  viridis::scale_color_viridis()

# color by pt
library(randomcoloR)
single_pt <- meta_amadeus %>% 
  count(pid, sort = T) %>% 
  filter(n == 1) %>% 
  pull(pid)

paired_pt <- meta_amadeus %>% 
  count(pid, sort = T) %>% 
  filter(n == 2) %>% 
  pull(pid)

paired_palette <- distinctColorPalette(length(paired_pt))

pal <- c(paired_palette, rep('black', length(single_pt)))
names(pal) <- c(paired_pt, single_pt)

beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'pid', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1) +
  scale_color_manual(values = pal)  

# color by alpha diversity
beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'inv', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1) +
  viridis::scale_color_viridis()

# color by tumor type
beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'Manual_Tumor_Buckets', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1) +
  scale_color_brewer(palette = 'Set1')

# color by Best_Overall_Response
beta_meta_amadeus %>% 
  ggscatter(x = 'V1', y = 'V2', color =  'Best_Overall_Response', palette = 'jco', shape = 'CD8_Conversion_Hot_to_Cold') +
  labs(title = '') +
  xlab(paste0("PC 1 [",percent_var[1],"%]")) +
  ylab(paste0("PC 2 [",percent_var[2],"%]")) +
  theme(aspect.ratio=1) 
```

# bar plot 

```{r}
spp %>% 
  write_csv('../data/03_amadeus_species_perc.csv')
# plotting at the genus level
genera <- spp %>% 
  mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>% 
  group_by(sampleid, genus) %>% 
  summarise(relab = sum(perc))

genera %>% 
  write_csv('../data/03_amadeus_genus_perc.csv')

genera %>% 
  ungroup() %>% 
  distinct(genus)

family <- spp %>% 
  mutate(family = str_replace(clade_name, '\\|g__.+$','')) %>% 
  group_by(sampleid, family) %>% 
  summarise(relab = sum(perc)) %>% 
  mutate(fam = str_extract(family, 'f__.+$')) 

family %>% 
  write_csv('../data/03_amadeus_family_perc.csv')

family %>% 
  ungroup() %>% 
  distinct(family)

# assign colors to the families
library(RColorBrewer)
pal <- family %>% 
  ungroup() %>% 
  distinct(family, fam) %>% 
  arrange(family) %>% 
  mutate(color = c(rep(brewer.pal(9, 'Set1'), 6), brewer.pal(4, 'Set1')))

pal_vec <- pal %>% 
  select(fam, color) %>% 
  deframe()

```
```{r}
# compute hierarchical cluster
hc <- hclust(dist_, method = 'complete')
dend <- as.dendrogram(hc)
sample_dendogram_order <- labels(dend)
```

```{r}







library(randomcoloR)
n <- 58
palette <- distinctColorPalette(n)
pie(rep(1, n), col=palette)

```


```{r}
family %>% 
  mutate(fam = str_extract(family, 'f__.+$')) %>% 
  mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
  left_join(meta_amadeus, by = "sampleid") %>% 
  arrange(sid) %>% 
  ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
  #geom_bar( stat = 'identity') +
  facet_wrap(~ pid, scales = 'free') +
  scale_fill_manual(values = palette) +
  theme( axis.text.x = element_text(angle=45, hjust=1),
         legend.position = 'right') 

ggsave('../figs/03_family_bar_pid.pdf', width = 15, height = 15)

```

```{r}
family %>% 
  mutate(fam = str_extract(family, 'f__.+$')) %>% 
  mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
  left_join(meta_amadeus, by = "sampleid") %>% 
  arrange(sid) %>% 
  ggbarplot(x = 'sid', y = 'relab', fill = 'fam', color = 'white' ) +
  #geom_bar( stat = 'identity') +
  facet_wrap(pid ~ CD8_Conversion_Hot_to_Cold, scales = 'free') +
  scale_fill_manual(values = palette) +
  theme( axis.text.x = element_text(angle=45, hjust=1),
         legend.position = 'right') 

ggsave('../figs/03_family_bar_CD8_Conversion_Hot_to_Cold.pdf', width = 20, height = 15)
```

```{r}
# split by visit
family %>% 
  mutate(fam = str_extract(family, 'f__.+$')) %>% 
  mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
  left_join(meta_amadeus, by = "sampleid") %>% 
  mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>% 
  ggplot(aes(x = sid, y = relab, fill = fam) ) +
  geom_bar( stat = 'identity') +
  facet_wrap(~ Best_Overall_Response, scales = 'free') +
  scale_fill_manual(values = palette) +
  theme( axis.text.x = element_text(angle=45, hjust=1)) 

ggsave('../figs/03_family_bar_Best_Overall_Response.pdf', width = 15, height = 5)
```
```{r}
# split by visit
family %>% 
  mutate(fam = str_extract(family, 'f__.+$')) %>% 
  mutate(fam = fct_reorder(fam, family,  .desc = F)) %>%
  left_join(meta_amadeus, by = "sampleid") %>% 
  mutate(sampleid = factor(sampleid, levels = sample_dendogram_order)) %>% 
  ggplot(aes(x = sampleid, y = relab, fill = fam) ) +
  geom_bar( stat = 'identity') +
  facet_wrap(~ Visit, scales = 'free') +
  scale_fill_manual(values = palette) +
  theme( axis.text.x = element_text(angle=45, hjust=1)) 

ggsave('../figs/03_family_bar_visit.pdf', width = 15, height = 5)
```


