---
title: "random forest hana"
author: "Anqi Dai"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

```{r}
library(tidyverse)
library(randomForest)
library(ggpubr)
library(kableExtra)
library(arrangements)
```

# load the tables

```{r}
# it contains all the pheno and all the genera info
dat <- read_csv('../data/pheno_unconventional_periengr_d30_allsamples.csv')



range(dat$sample_day)

dat %>% 
  count(mrn)
```
 
# clean the pheno table

```{r}
# the categorical has to be factored
pheno <- dat %>% 
  distinct(mrn, MAIT_reconstitution, MAIT_Vd2) %>% 
  mutate(MAIT_reconstitution = factor(MAIT_reconstitution),
         MAIT_Vd2 = factor(MAIT_Vd2)) %>% 
  mutate(mrn = as.character(mrn)) %>% 
  arrange(mrn)

pheno %>% 
  count(MAIT_reconstitution)

pheno %>% 
  count(MAIT_Vd2)
```


# get the median relab for all genera

```{r}
cts_median <- dat %>% 
  select(mrn, sampleid, Abiotrophia:Xanthomonas) %>% 
  gather('genus', 'relab',names(.)[3]:names(.)[ncol(.)] ) %>% 
  group_by(mrn, genus) %>% 
  summarise(median_relab = median(relab)) %>% 
  spread('mrn', 'median_relab') 
  

# get the top most abundant N genera
N <- 50

cts_median_top <- cts_median %>% 
  mutate(genus_sum = rowSums(.[2:ncol(.)])) %>% 
  arrange(desc(genus_sum)) %>% 
  top_n(n = N) %>% 
  select(-genus_sum) %>% 
  gather('mrn', 'med_relab', names(.)[2]:names(.)[ncol(.)]) %>% 
  spread('genus', 'med_relab') %>% 
  arrange(mrn) %>% 
  column_to_rownames('mrn') %>% 
  as.matrix()

all.equal(rownames(cts_median_top), pheno$mrn)

```

# random forest


```{r}
# for MAIT_reconstitution
mod_recon <- randomForest(cts_median_top, pheno$MAIT_reconstitution, importance = T)

impor_feature <- importance(mod_recon, type=1) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = 'genus') %>% 
  arrange(MeanDecreaseAccuracy)


# plot the err rate change
mod_recon  %>% 
  pluck('err.rate') %>% 
  as.data.frame() %>% 
  mutate(ntree = seq(1, nrow(.))) %>% 
  gather(key = 'type', value = 'ERR', names(.)[1]:names(.)[ncol(.)-1]) %>% 
  ggline(x = 'ntree', y = 'ERR', color = 'type', palette = 'jama') +
  labs(x = 'Number of trees', 
       y = 'Error rate')
```

```{r}
# for MAIT_Vd2
mod_vd2 <- randomForest(cts_median_top, pheno$MAIT_Vd2, importance = T)

impor_feature <- importance(mod_vd2, type=1) %>% 
  as.data.frame() %>% 
  rownames_to_column(var = 'genus') %>% 
  arrange(MeanDecreaseAccuracy)


# plot the err rate change
mod_vd2  %>% 
  pluck('err.rate') %>% 
  as.data.frame() %>% 
  mutate(ntree = seq(1, nrow(.))) %>% 
  gather(key = 'type', value = 'ERR', names(.)[1]:names(.)[ncol(.)-1]) %>% 
  ggline(x = 'ntree', y = 'ERR', color = 'type', palette = 'jama') +
  labs(x = 'Number of trees', 
       y = 'Error rate')
```

# the simper method

```{r}
library(vegan)
pmv_mait <- adonis(cts_median_top ~ MAIT_reconstitution, data=pheno, permutations=999, method = 'bray')
pmv_mait

pmv_vd2 <- adonis(cts_median_top ~ MAIT_Vd2, data=pheno, permutations=999, method = 'bray')
pmv_vd2


# to see the within group dispersion
dist_pmv <- vegdist(cts_median_top, method = 'bray')
bd <- betadisper(dist_pmv, pheno$MAIT_Vd2)
boxplot(bd)
anova(bd)        
```

```{r}
# use a loop to try all the vd2 combinations
vd2_4 <- pheno %>% 
  mutate(MAIT_Vd2 = as.character(MAIT_Vd2)) %>% 
  distinct(MAIT_Vd2) %>% 
  pull(MAIT_Vd2)

combi <- combinations(vd2_4, 2) %>% 
  as.data.frame() 
  

all_top <- cts_median_top %>% 
  as.data.frame() %>% 
  rownames_to_column('mrn') %>% 
  full_join(pheno, by = 'mrn')
```

```{r}
pairwise_adonis <- apply(combi, 1, function(Row){

  pheno_sub <- pheno %>% 
    filter(MAIT_Vd2 %in% c(Row[['V1']],Row[['V2']])) %>% 
    arrange(mrn)
  
  cts_median_top_sub <- cts_median_top %>% 
    as.data.frame() %>% 
    rownames_to_column('mrn') %>% 
    filter(mrn %in% pheno_sub$mrn) %>% 
    arrange(mrn) %>% 
    column_to_rownames('mrn')
  
  # calculate the within group dispersion anova
  dist_pmv <- vegdist(cts_median_top_sub, method = 'bray')
  bd <- betadisper(dist_pmv, pheno_sub$MAIT_Vd2)
  anova_res <- anova(bd)  
  
  # get the top N most contributing features
  sim <- simper(cts_median_top_sub , group = pheno_sub$MAIT_Vd2)

  genus_contri <- summary(sim) %>% 
    pluck(str_glue("{Row[['V1']]}_{Row[['V2']]}")) %>% 
    rownames_to_column('genus') %>% 
    arrange(desc(average)) %>% 
    head(n = 20)
  
  if(all.equal(rownames(cts_median_top_sub), pheno_sub$mrn)  == T){
    pmv_pair_vd2 <- adonis(cts_median_top_sub ~ MAIT_Vd2, data=pheno_sub, permutations=999, method = 'bray')
    return(list(pw_adonis_pval = pmv_pair_vd2$aov.tab$`Pr(>F)`[1],
           anova_pval = anova_res$`Pr(>F)`[1],
           topN_feature_df = genus_contri))
  }else{
    stop("rownames don't match")
    }
})

pw_adonis_pval_list <- list() 
for(i in 1:nrow(combi)){
  pw_adonis_pval_list[[i]]= pairwise_adonis[[i]]$pw_adonis_pval
}


anova_pval_list <- list() 
for(i in 1:nrow(combi)){
  anova_pval_list[[i]]= pairwise_adonis[[i]]$anova_pval
}

pairwise_adonis[[1]]$topN_feature_df
 
pairwise_adonis[[2]]$topN_feature_df 
```


```{r}
pairwise_adonis_res <- bind_cols(combi, pairwise_adonis ) %>% 
  transmute(pair = str_glue('{V1}_{V2}'),
            pw_adonis_pval,
            anova_pval) %>% 
  arrange(pw_adonis_pval) %>% 
  mutate(fdr_pw_adonis = p.adjust(pw_adonis_pval, method = 'BH'))
```

# take a look at the pcoa of the two comparisons that are significant above

```{r}
# for the none and Vd2	
Row <- list(V1 = 'none', V2 = 'Vd2')
#Row <- list(V1 = 'none', V2 = 'both')
pheno_sub <- pheno %>% 
  filter(MAIT_Vd2 %in% c(Row[['V1']],Row[['V2']])) %>% 
  arrange(mrn)

cts_median_top_sub <- cts_median_top %>% 
  as.data.frame() %>% 
  rownames_to_column('mrn') %>% 
  filter(mrn %in% pheno_sub$mrn) %>% 
  arrange(mrn) %>% 
  column_to_rownames('mrn')

# calculate the within group dispersion anova
dist_pmv <- vegdist(cts_median_top_sub, method = 'bray')

bc <- cmdscale(dist_pmv, k = 2) 

bc %>% 
    as.data.frame() %>% 
    rownames_to_column('mrn') %>% 
    full_join(pheno_sub, by = 'mrn') %>% 
    ggscatter(x = 'V1', y = 'V2', color =  'MAIT_Vd2',  palette = 'jco') +
    labs(x = 'PCo 1', y = 'PCo 2', title = 'PCoA (BC distance)') 

```


```{r}
# wanna try to see it in 3D
# 1. get the distance matrix 
distance_matrix <- as.matrix(dist_pmv)
distance_matrix %>% write.table('../data/none_vd2_BC_matrix.tsv', sep = '\t', row.names = T)

# also write out the pheno_sub to tsv
pheno_sub %>% 
  # cuz they will only accept certain strings to be first column name
  rename(sampleid = mrn) %>% 
  write_tsv('../data/none_vd2_pheno.tsv')
```

```{bash}
# import it into qiime qza object
qiime tools import --input-path ../data/none_vd2_BC_matrix.tsv \
  --output-path  ../data/none_vd2_BC_matrix.qza --type "DistanceMatrix"
  
# get the pcoa for the dist matrix
qiime diversity pcoa --i-distance-matrix ../data/none_vd2_BC_matrix.qza  \
  --o-pcoa ../data/none_vd2_BC_pcoa.qza
  
# visualize with emperor
qiime emperor plot  --i-pcoa ../data/none_vd2_BC_pcoa.qza   --m-metadata-file ../data/none_vd2_pheno.tsv --o-visualization  ../data/none_vd2_BC_emperor.qzv
```


