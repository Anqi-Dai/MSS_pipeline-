---
title: "Duke samples"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('asv_alpha_diversity_ag')
get_table_from_database('shotgun_lookup_ad')
dat <- asv_alpha_diversity_ag %>% 
  distinct(oligos_id) %>% 
  mutate(poolid = str_extract(oligos_id, 'pool.+$')) %>% 
  distinct(poolid) %>% 
  filter(str_detect(poolid, 'pool835|pool935|pool940|pool1042|pool1048|pool1050|pool1064|pool1109|pool1117|pool1121'))

#pool1109
asv_alpha_diversity_ag %>% 
  write_csv('../data/asv_alpha_diversity_ag.csv')
```

```{r}
# total: 2678
duke <- read_csv('../data/duke_samples_for_angel_02-22-2022 (1).csv') %>% 
  rename(oligos_id = oligoid)

# already 1769
already <- duke %>% 
  inner_join(asv_alpha_diversity_ag, by = 'oligos_id') %>% 
  distinct(oligos_id, .keep_all = T)

already %>% 
  select(oligos_id, path_pool ) %>% 
  write_csv('../data/duke/already_1769_path.csv')

# missing 
missing <- duke %>% 
  filter(!oligos_id %in% asv_alpha_diversity_ag$oligos_id)

find <- missing %>% 
  filter(submitted_for_sequencing == 'yes') %>% 
  select(sampleid, sampleid_clean, oligos_id, notes , experiment)  %>% 
  mutate(sid = str_replace_all(oligos_id, '-|/|_','\\.'))

find %>% 
  count(notes)

two <- asv_alpha_diversity_ag %>% 
  filter(str_detect(path_pool, 'pool1096\\+1097|pool1100')) %>% 
  select(oligos_id, path_pool) %>% 
  distinct(oligos_id, .keep_all = T) 
 
length(intersect(two$sid, find$sid))
setdiff(two$sid, find$sid)

two %>% 
  write_csv('../data/duke/two_pools_90_path.csv')
```


```{r}
setdiff( find$sid, two$sid)

# the 228 that don't know what the pool or where the samples are
where <- find %>% 
  filter(!sid %in% two$sid)

where %>% 
  write_csv('../data/duke/where_the_228.csv')
```

```{r}
# reply from John
reply <- read_csv('~/Downloads/where_the_228_JS_03-21-2022.csv') %>% 
  distinct(sid, .keep_all = T) %>% 
  distinct(js_comment)

length(intersect(reply$sid, asv_alpha_diversity_ag$sampleid))

# after running the last pool 11037
reply %>% 
  filter(str_detect(js_comment, '11037'))
```



```{r}
# assemble the file path that need to be copied to the duke folder in amplicon
current <- bind_rows(
  two %>% 
    mutate(R1 = str_glue('{path_pool}/{oligos_id}_R1.fastq.gz'),
           R2 = str_glue('{path_pool}/{oligos_id}_R2.fastq.gz')),
  already %>% 
    mutate(R1 = str_glue('{path_pool}/{oligos_id}_R1.fastq.gz'),
           R2 = str_glue('{path_pool}/{oligos_id}_R2.fastq.gz'))
) %>% 
  filter(!str_detect(oligos_id, '^blank'))


current %>% 
  select(R1, R2) %>% 
  gather() %>% 
  mutate(cmd = str_glue('cp {value} /home/daia1/my_workdir/samples/amplicon/duke')) %>% 
  select(cmd) %>% 
  write_csv('../data/cp_duke_1851.sh',col_names = F)
```

