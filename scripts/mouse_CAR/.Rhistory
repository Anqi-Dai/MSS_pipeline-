correct=FALSE)
ggsave('../data/03_Ruminococcus_gnavus_FMT.pdf', width = 8, height = 6)
gnavus %>%
filter(!Condition %in% c('Post-FMT 2','5th Week post-CAR T','4th Week post-CAR T')) %>%
#arrange(Date_Collected) %>%
mutate(condition_simple = factor(condition_simple, levels = order_level)) %>%
ggboxplot(x = 'Group', y = 'relative_abundance', add = 'jitter', add.params = list( size = 3),color = 'Group',
xlab = '', ylab = 'Ruminococcus_gnavus relative abundance') +
scale_color_manual(values = color_key) +
facet_grid(. ~ condition_simple, scales = 'free') +
theme(axis.text.x=element_text(angle = 90, hjust = 0)) +
stat_compare_means(comparisons= list(c('Responder', 'Non-Responder')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
ggsave('../data/03_Ruminococcus_gnavus_FMT.pdf', width = 8, height = 6)
gnavus %>%
filter(!Condition %in% c('Post-FMT 2','5th Week post-CAR T','4th Week post-CAR T')) %>%
#arrange(Date_Collected) %>%
mutate(condition_simple = factor(condition_simple, levels = order_level)) %>%
ggboxplot(x = 'Group', y = 'relative_abundance', add = 'jitter', add.params = list( size = 3),color = 'Group',
xlab = '', ylab = 'Ruminococcus_gnavus relative abundance') +
scale_color_manual(values = color_key) +
facet_grid(. ~ condition_simple, scales = 'free') +
theme(axis.text.x=element_text(angle = 90, hjust = 0)) +
stat_compare_means(comparisons= list(c('Responder', 'Non-Responder')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
ggsave('../data/03_Ruminococcus_gnavus_FMT.pdf', width = 8, height = 6)
View(taxa)
View(rumino_fam)
View(asv_annotation_blast_ag)
View(taxa)
View(taxa)
View(meta_mouse)
View(FMT)
library(vdbR)
connect_database()
cc <- get_counts_subset(c('1943B'))
View(cc)
ta <- cc %>%
inner_join(asv_annotation_blast_ag %>% select(asv_key, genus))
View(ta)
ta
ta <- cc %>%
inner_join(asv_annotation_blast_ag %>% select(asv_key, genus)) %>%
group_by(genus) %>%
summarise(relab = sum(count_relative))
View(taxa)
View(taxa)
View(genera)
View(taxa)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
View(taxa)
# 1964A and PH131
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$'))
View(mouse)
# human
human <- get_counts_subset(c('1964A'))
library(vdbR)
connect_database()
# human
human <- get_counts_subset(c('1964A'))
View(human)
human <- get_counts_subset(c('1964A'))
# human
human <- get_counts_subset(c('1964A')) %>%
inner_join(asv_annotation_blast_ag %>% select(asv_key, genus)) %>%
group_by(genus) %>%
summarise(relab = sum(count_relative))
# 1964A and PH131
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$')) %>%
mutate(ge = str_replace(ge, 'g__',''))
# 1964A and PH131
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$')) %>%
mutate(ge = str_replace(ge, 'g__',''))
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$'))
# 1964A and PH131
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$')) %>%
mutate(ge = str_replace(ge, 'g__',''))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$')) %>%
mutate(ge = str_replace(ge, 'g__',''))
# human
human <- get_counts_subset(c('1964A')) %>%
inner_join(asv_annotation_blast_ag %>% select(asv_key, genus)) %>%
group_by(genus) %>%
summarise(relab = sum(count_relative))
length(intersect(mouse$ge, human$genus))
mouse <- taxa %>%
filter(sampleid == 'PH131') %>%
mutate(genus = str_replace(clade_name, '\\|s__.+$','')) %>%
group_by(sampleid, genus) %>%
summarise(relab = sum(relative_abundance)) %>%
ungroup() %>%
mutate(ge = str_extract(genus, 'g__.+$')) %>%
mutate(ge = str_replace(ge, 'g__',''))
# human
human <- get_counts_subset(c('1964A')) %>%
inner_join(asv_annotation_blast_ag %>% select(asv_key, genus)) %>%
group_by(genus) %>%
summarise(relab = sum(count_relative))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
length(intersect(mouse$ge, human$genus))
# give those 36 colors but make the others gray
shared <- intersect(mouse$ge, human$genus)
mouse_df <- mouse %>%
mutate(grp = if_else(ge %in% shared, 'shared', 'no'))
View(mouse_df)
mouse_other <- mouse_df %>%
filter(grp == 'no')
View(mouse_other)
mouse_other
mouse_other <- mouse_df %>%
filter(grp == 'no') %>%
group_by(grp) %>%
summarise(relab = sum(relab))
mouse_other <- mouse_df %>%
filter(grp == 'no') %>%
group_by(sampleid,grp) %>%
summarise(relab = sum(relab))
mouse_other <- mouse_df %>%
filter(grp == 'no') %>%
group_by(sampleid,grp) %>%
summarise(relab = sum(relab)) %>%
mutate(ge = 'Other')
mouse_df <- mouse %>%
mutate(grp = if_else(ge %in% shared, 'shared', 'no')) %>%
arrange(desc(grp))
library(randomcoloR)
set.seed(123)
n <- length(shared)
palette <- distinctColorPalette(n)
gray_num  <- nrow(mouse) - n
mouse_df <- mouse %>%
mutate(grp = if_else(ge %in% shared, 'shared', 'no')) %>%
arrange(desc(grp)) %>%
mutate(colors = c(palette, rep('gray',gray_num )))
human
human_gray <- nrow(human) - n
human_df <-  human %>%
mutate(grp = if_else(genus %in% shared, 'shared', 'no')) %>%
arrange(desc(grp)) %>%
mutate(colors = c(palette, rep('gray',human_gray )))
View(human_df)
human_df
human_df
human_df_pal <- human_df %>%
distinct(genus, colors) %>%
deframe
human_df %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
human_p <- human_df %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_human.pdf', plot = human_p)
ggsave('../data/04_human.pdf', plot = human_p, height = 10)
human_df_pal
human_p <- human_df %>%
arrange(grp) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_human.pdf', plot = human_p, height = 10)
human_p <- human_df %>%
mutate(genus = fct_reorder(genus, .fun = desc(grp))) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
human_p <- human_df %>%
mutate(genus = fct_reorder(genus, grp)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_human.pdf', plot = human_p, height = 10)
human_p <- human_df %>%
mutate(genus = fct_reorder(genus, grp, .desc = T)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
human_p <- human_df %>%
mutate(genus = fct_reorder(genus, grp, .desc = T)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = human_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_human.pdf', plot = human_p, height = 10)
mouse_df_pal <- mouse_df %>%
distinct(genus, colors) %>%
deframe
View(mouse_df)
mouse_df_pal <- mouse_df %>%
distinct(ge, colors) %>%
deframe
mouse_df_pal <- mouse_df %>%
distinct(ge, colors) %>%
deframe
mouse_p <- mouse_df %>%
mutate(ge = fct_reorder(ge, grp, .desc = T)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot( y = 'relab', fill = 'ge', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = mouse_df_pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_mouse.pdf', plot = mouse_p, height = 10)
ggsave('../data/04_mouse.pdf', plot = mouse_p, height = 15)
ggsave('../data/04_mouse.pdf', plot = mouse_p, height = 10, width = 10)
# this is just kinda hard
mouse_clean <- mouse_df %>%
select(genus = ge, mouse_relab = relab)
View(mouse_clean)
# this is just kinda hard
mouse_clean <- mouse_df %>%
filter(grp == 'shared') %>%
select(genus = ge, mouse_relab = relab)
shared <- human_df %>%
filter(grp == 'shared')
View(shared)
shared <- human_df %>%
filter(grp == 'shared') %>%
full_join(mouse_clean)
View(shared)
shared
shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab))
shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab)) %>%
mutate(relab = 1- total_human,
mouse_relab = 1- total_mouse)
shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab)) %>%
mutate(relab = 1- total_human,
mouse_relab = 1- total_mouse) %>%
mutate(grp = 'other', colors = 'gray', genus = 'Other')
shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab)) %>%
mutate(relab = 1- total_human,
mouse_relab = 1- total_mouse) %>%
mutate(grp = 'other', colors = 'gray', genus = 'Other') %>%
select(colnames(shared))
others <- shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab)) %>%
mutate(relab = 1- total_human,
mouse_relab = 1- total_mouse) %>%
mutate(grp = 'other', colors = 'gray', genus = 'Other') %>%
select(colnames(shared))
View(others)
combined <- bind_rows(shared, others)
View(combined)
combined
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab')
View(combined_p)
combined_p
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab)
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab)
combined_p
combined
pal <- combined %>%
distinct(genus, colors) %>%
deframe
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=90, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_combined_p.pdf', plot = combined_p, height = 10, width = 10)
# this is just kinda hard
mouse_clean <- mouse_df %>%
filter(grp == 'shared') %>%
select(genus = ge, mouse_relab = relab)
shared <- human_df %>%
filter(grp == 'shared') %>%
full_join(mouse_clean)
others <- shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab)) %>%
mutate(relab = 1- total_human,
mouse_relab = 1- total_mouse) %>%
mutate(grp = 'other', colors = 'gray', genus = 'Other') %>%
select(colnames(shared))
combined <- bind_rows(shared, others)
pal <- combined %>%
distinct(genus, colors) %>%
deframe
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=0, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_combined_p.pdf', plot = combined_p, height = 10, width = 10)
View(combined)
# this is just kinda hard
mouse_clean <- mouse_df %>%
filter(grp == 'shared') %>%
select(genus = ge, mouse_relab = relab)
shared <- human_df %>%
filter(grp == 'shared') %>%
full_join(mouse_clean)
others <- shared %>%
group_by(grp) %>%
summarise(total_human = sum(relab),
total_mouse = sum(mouse_relab)) %>%
mutate(relab = 1- total_human,
mouse_relab = 1- total_mouse) %>%
mutate(grp = 'other', colors = 'gray', genus = 'Other') %>%
select(colnames(shared))
combined <- bind_rows(shared, others)
pal <- combined %>%
distinct(genus, colors) %>%
deframe
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = fct_reorder(genus, grp, .desc = T)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=0, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_combined_p.pdf', plot = combined_p, height = 10, width = 10)
combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab)
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = fct_reorder(genus, grp, .desc = T)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=0, hjust=0, size = 6.5),
legend.position = 'bottom')
combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = fct_reorder(genus, grp, .desc = T))
combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = fct_reorder(genus, grp, .desc = T))
combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = fct_reorder(genus, grp, .desc = T))
genus_order <- combined %>%
distinct(grp, genus)
genus_order <- combined %>%
distinct(grp, genus) %>%
arrange(desc(grp))
View(genus_order)
genus_order <- combined %>%
distinct(grp, genus) %>%
arrange(desc(grp)) %>%
pull(genus)
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = factor(genus,levels = genus_order)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=0, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_combined_p.pdf', plot = combined_p, height = 10, width = 10)
combined_p <- combined %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = factor(genus,levels = genus_order)) %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=0, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_combined_p.pdf', plot = combined_p, height = 10, width = 10)
View(combined_p)
combined <- bind_rows(shared, others) %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = factor(genus,levels = genus_order))
combined
combined <- bind_rows(shared, others) %>%
relocate(relab, .after = 'mouse_relab') %>%
gather('organism', 'relab',mouse_relab: relab) %>%
mutate(genus = factor(genus,levels = genus_order)) %>%
mutate(organism = if_else(str_detect(organism, 'mouse'), 'Mouse', "Human"))
combined_p <- combined  %>%
#filter(genus %in% keepgenera) %>%
ggbarplot(x = 'organism' , y = 'relab', fill = 'genus', color = 'white' , xlab = '', ylab = 'Relative abundance') +
#facet_wrap(Day ~ fiber, scales = 'free') +
scale_fill_manual(values = pal) +
theme( axis.text.x = element_text(angle=0, hjust=0, size = 6.5),
legend.position = 'bottom')
ggsave('../data/04_combined_p.pdf', plot = combined_p, height = 10, width = 10)
taxa <- read_csv('../data/01_all_metaphlan.csv') %>%
filter(sampleid %in% FMT$sampleid)
View(taxa)
taxa <- read_csv('../data/01_all_metaphlan.csv')
FMT <- read_csv('../data/01_FMT_pheno.csv') %>%
mutate(Condition = str_replace(Condition, ' cells','')) %>%
mutate(condition_simple = case_when(
Condition == '1st Collection (2 days) post-CAR T' ~ 'Week1 post-CAR',
Condition == '2nd Week post-CAR T' ~ 'Week2 post-CAR',
Condition == '3rd Week post-CAR T' ~ 'Week3 post-CAR',
Condition == '4th Week post-CAR T' ~ 'Week4 post-CAR',
Condition == '5th Week post-CAR T' ~ 'Week5 post-CAR',
TRUE ~ Condition
))
taxa <- read_csv('../data/01_all_metaphlan.csv') %>%
filter(sampleid %in% FMT$sampleid)
taxa <- read_csv('../data/01_all_metaphlan.csv') %>%
filter(sampleid %in% FMT$sampleid)
taxa <- read_csv('../data/01_all_metaphlan.csv')
View(taxa)
taxa <- read_csv('../data/01_all_metaphlan.csv')
taxa <- read_csv('../data/01_all_metaphlan.csv') %>%
filter(sampleid %in% FMT$sampleid)
