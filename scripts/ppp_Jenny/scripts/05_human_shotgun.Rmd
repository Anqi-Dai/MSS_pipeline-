---
title: "human shotgun data"
author: "Angel"
date: "2022-09-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('shotgun_lookup_ad')
```

```{r}
samp <- readxl::read_excel('../data/fiberstudy_patientsamples_shotgun.xlsx')

sampleids <- samp %>% 
  select(ends_with('id')) %>% 
  gather() %>% 
  filter(value != 'NA')

length(intersect(shotgun_lookup_ad$sampleid, sampleids$value))
setdiff(sampleids$value, shotgun_lookup_ad$sampleid)

# more mouse samples 6% fiber  and 0%
# nadir stands for the low point with the lowest neutrophil
```

```{r}
# find if I have already got the metaphlan results for all of those
location <- shotgun_lookup_ad %>% 
  mutate(sampleid = if_else(sampleid == '1574E_2', '1574E.2', sampleid)) %>% 
  filter(sampleid %in% sampleids$value) %>% 
  distinct(sampleid, .keep_all = T)

#   FMT.0215A FMT.0215C  FMT.0215H
missing3 <- c('FMT.0215A','FMT.0215C','FMT.0215H')

# generate sripts to download those results
dl <- location %>% 
  filter(!sampleid %in% missing3) %>% 
  mutate(cmd = str_glue('scp daia1@lilac.mskcc.org:/home/daia1/my_workdir/samples/metaphlan/{str_extract(directory, "Sample_.+$")}_metaphlan3_profile.txt .')) %>% 
  select(cmd) %>% 
  write_csv('../data/dl58.sh', col_names = F)

# now gather the dl metaphlan results
fns <- list.files('../data/', pattern = '_metaphlan3_profile.txt$', full.names = T)
 
human <- fns %>% 
  set_names(fns) %>% 
  map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>% 
          rename(clade_name = names(.)[1]) %>% 
          select(clade_name, relative_abundance) %>% 
          filter(str_detect(clade_name, 's__')) %>% 
  mutate(relative_abundance = relative_abundance/100)) %>% 
  bind_rows(.id = 'fid') %>% 
  mutate(fid = str_replace(fid, '../data//Sample_',''),
         fid = str_replace(fid, '_IGO_.+$',''))  %>% 
  left_join(location %>% select(fid, sampleid)) %>% 
  select(-fid)

human %>% write_csv('../data/human_metaphlan_61samples.csv')
```

```{r}
# get the previous two days nutrition data for those samples
# the below table just had more samples that were filtered out in june
meta_all_old <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')

# the ones that  had valid complete p2d diet data
valid <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')

p2d <- meta_all_old %>% 
  filter(sampleid %in% location$sampleid & sampleid %in% valid$sampleid) %>% 
  select(sampleid:ave_carb) %>% 
  select(-EN, -TPN, -timebin)

p2d %>% 
  write_csv('../data/human_samples_p2d_diet_data.csv')
```

