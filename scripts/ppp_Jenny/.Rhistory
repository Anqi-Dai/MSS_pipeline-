group_by(mrn) %>%
summarise(ave_div = mean(simpson_reciprocal),
mean_fiber = mean(ave_fiber)) %>%
mutate(mean_fiber = mean_fiber * 100) %>%
inner_join( allpt_gvhd_all %>% distinct(mrn, source, grp ))
meta  %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',color = 'grp',facet.by = 'grp',
xlab = 'Prior 2 day fiber intake averaged by patient', ylab = 'microbiome alpha diversity averaged by patient',
add = "reg.line",  # Add regressin line
add.params = list(color = "grp", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n")) +
theme(aspect.ratio=1)
#median_now <- median(meta$mean_fiber)
meta <- read_csv('~/pipeline/scripts/food_tree/data/090_all_samples_meta_p2d_fg9_dietall_genera90.csv') %>%
filter(sdrt %in% -10:30)%>%
group_by(mrn) %>%
summarise(ave_div = mean(simpson_reciprocal),
mean_fiber = mean(ave_fiber)) %>%
mutate(mean_fiber = mean_fiber * 100) %>%
inner_join( allpt_gvhd_all %>% distinct(mrn, source, grp ))
meta  %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',color = 'grp',facet.by = 'grp',
xlab = 'Prior 2 day fiber intake averaged by patient', ylab = 'microbiome alpha diversity averaged by patient',
add = "reg.line",  # Add regressin line
add.params = list(color = "grp", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n")) +
theme(aspect.ratio=1)
ggsave('../data/11_alpha_and_fiber_grp3.pdf', width = 10, height = 5)
View(onsetdays)
onsetdays
onsetdays %>%
ggboxplot(y = 'onsetday')
onsetdays %>%
ggboxplot(y = 'onsetday', add = 'jitter')
meta  %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',color = 'grp',facet.by = 'grp',
xlab = 'Prior 2 day fiber intake averaged by patient', ylab = 'microbiome alpha diversity averaged by patient',
add = "reg.line",  # Add regressin line
add.params = list(color = "grp", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n")) +
theme(aspect.ratio=1)
onsetdays <-  allpt %>% distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(!is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = as.numeric(d100_a_gvhd_onset - hct))
onsetdays <-  allpt %>% distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(!is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = as.numeric(d100_a_gvhd_onset - hct))
?sample_n
# randomly draw one onset day from the above with replacement
pseudodays <- allpt %>% distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = sample_n(onsetdays$onsetday,size = nrow(.), replace = T ))
?slice_sample
# randomly draw one onset day from the above with replacement
pseudodays <- allpt %>% distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays$onsetday,n = nrow(.), replace = T ))
# randomly draw one onset day from the above with replacement
pseudodays <- allpt %>%
distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays %>% select(onsetday),n = nrow(.), replace = T ))
View(pseudodays)
pseudodays
pseudodays <- allpt %>%
distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays %>% select(onsetday),n = nrow(.), replace = T ) %>% select(onsetday))
pseudodays
allpt %>%
distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays %>% select(onsetday),n = nrow(.), replace = T ) %>% pull(onsetday))
# randomly draw one onset day from the above with replacement
pseudodays <- allpt %>%
distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays %>% select(onsetday),n = nrow(.), replace = T ) %>% pull(onsetday)) %>%
select(mrn, hct, onsetday)
set.seed(1)
# randomly draw one onset day from the above with replacement
pseudodays <- allpt %>%
distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays %>% select(onsetday),n = nrow(.), replace = T ) %>% pull(onsetday)) %>%
select(mrn, hct, onsetday)
View(all_types_o)
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset))
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset))
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset))
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset))
onsetdays
allonset <- bind_rows(pseudodays, onsetdays %>% select(-d100_a_gvhd_onset))
View(allonset)
# all types but day relative to onset
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset)
all_types_o
# all types but day relative to onset
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset)
all_types_o
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(d100_a_gvhd_onset = hct + onsetday)
all_types_o
all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset))
all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(hct = ymd(hct),
d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset))
# all types but day relative to onset
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(hct = ymd(hct),
d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset),
fdrO = f_date - d100_a_gvhd_onset,
fdrO = as.numeric(fdrO))
all_types_o
# all types but day relative to onset
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(hct = ymd(hct),
d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset),
fdrO = f_date - d100_a_gvhd_onset,
fdrO = as.numeric(fdrO))
all_types_o
# all types but day relative to onset
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(hct = ymd(hct),
d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset),
fdrO = f_date - d100_a_gvhd_onset,
fdrO = as.numeric(fdrO))
all_types_o
# Same analysis as previous slide, only including all non-TCD patients joined into one group – relative to onset)
all_types_o %>%
filter(fdrt %in% -10:30 ) %>%
ggscatter(x = 'fdrO', y = 'gram', alpha = 0.05, shape = 16,xlab = 'day relative to onset',
add = "loess", conf.int = TRUE,
add.params = list(color = 'forestgreen', size = 1)) +
facet_grid(~ fiber_type) +
scale_y_sqrt()
ggsave('../data/11_fiber_all_type_daily_intake_onset.pdf', width = 10, height = 3)
# Same analysis as previous slide, but only including the No GVHD and LGI joined into one group – relative to onset)
all_types_o %>%
filter(fdrt %in% -10:30  & grp != 'Non_LGI') %>%
ggscatter(x = 'fdrO', y = 'gram', alpha = 0.05, shape = 16,xlab = 'day relative to onset',
add = "loess", conf.int = TRUE,
add.params = list(color = 'forestgreen', size = 1)) +
facet_grid(~ fiber_type) +
scale_y_sqrt()
ggsave('../data/11_fiber_all_type_daily_intake_onset_2.pdf', width = 10, height = 3)
all_types_o %>%
filter(fdrt %in% -10:30  ) %>%
mutate(gvhd = if_else(grp == 'no_gvhd', 'No', 'Yes'),
gvhd = factor(gvhd, levels = c('Yes','No'))) %>%
ggscatter(x = 'fdrO', y = 'gram', alpha = 0.05, shape = 16,xlab = 'day relative to onset',
add = "loess", conf.int = TRUE,
add.params = list(color = 'gvhd', size = 1)) +
facet_grid(~ fiber_type) +
scale_y_sqrt()
ggsave('../data/11_fiber_all_type_daily_intake_onset_gvhd.pdf', width = 10, height = 3)
all_types_o %>%
filter(fdrt %in% -10:30  ) %>%
ggscatter(x = 'fdrO', y = 'gram', alpha = 0.05, shape = 16,xlab = 'day relative to onset',
add = "loess", conf.int = TRUE,
add.params = list(color = 'grp', size = 1)) +
facet_grid(~ fiber_type) +
scale_colour_manual(values = cols, breaks = c("LGI", "no_gvhd", "Non_LGI")) +
scale_fill_manual(values = cols, breaks = c("LGI", "no_gvhd", "Non_LGI")) +
scale_y_sqrt()
ggsave('../data/11_fiber_all_type_daily_intake_onset_grp3.pdf', width = 10, height = 3)
all_types_o %>%
filter(fdrt %in% -10:30 & grp != 'Non_LGI' ) %>%
ggscatter(x = 'fdrO', y = 'gram', alpha = 0.05, shape = 16,xlab = 'day relative to onset',
add = "loess", conf.int = TRUE,
add.params = list(color = 'grp', size = 1)) +
facet_grid(~ fiber_type) +
scale_colour_manual(values = cols, breaks = c("LGI", "no_gvhd", "Non_LGI")) +
scale_fill_manual(values = cols, breaks = c("LGI", "no_gvhd", "Non_LGI")) +
scale_y_sqrt()
ggsave('../data/11_fiber_all_type_daily_intake_onset_grp2.pdf', width = 10, height = 3)
meta %>%
ggboxplot(x = 'grp', y = 'ave_div', add = 'jitter') +
stat_compare_means(comparisons= list(c('high', 'low')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
meta  %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',color = 'grp',facet.by = 'grp',
xlab = 'Prior 2 day fiber intake averaged by patient', ylab = 'microbiome alpha diversity averaged by patient',
add = "reg.line",  # Add regressin line
add.params = list(color = "grp", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "spearman",  label.sep = "\n")) +
theme(aspect.ratio=1)
View(meta)
View(meta)
View(DTB)
unit <- read_csv('../../food_tree/data/148_both_batches_UNIT_table_EN_exclu.csv')
View(unit)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(vdbR)
connect_database()
list_table_from_database('fmt')
get_table_from_database('fmt_arm_ag')
type <- read_csv('../data/10_patients_foods_fiber_type_all.csv')
DTB <- read_csv('../../food_tree/data/152_combined_DTB.csv')
# join with gvhd info of the patients
allpt <- read_csv('../../food_tree/data/156_transplant_data.csv')
allpt %>% count(source)
allpt_gvhd <- allpt %>%
mutate(d100_a_gvhd = if_else(d100_a_gvhd == 'NE', 'N/E', d100_a_gvhd),
d100_a_gvhd = if_else(d100_a_gvhd == 'N', 'No', d100_a_gvhd),
d100_a_gvhd = if_else(d100_a_gvhd == 'Y', 'Yes', d100_a_gvhd)) %>%
filter(d100_a_gvhd %in% c('Yes','No'))
tcd_pt <- allpt %>%
filter(source == 'TCD') %>%
pull(mrn)
meta <- read_csv('../../food_tree/data/153_combined_META.csv')
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
)) %>%
select(mrn, source, grp, hct) %>%
inner_join(meta %>% select(mrn, sampleid, sdrt)) %>%
left_join(fmt_arm_ag %>% select(mrn, fmt_procedure_date)) %>%
mutate(hct = ymd(hct),
fmtday = as.numeric(fmt_procedure_date - hct)) %>%
mutate(grp = if_else(grp %in% c('non_gi','upper_gi'), 'Non_LGI', grp)) %>%
# since there are no samples that are after FMT we can ignore those columns
select(-hct, -fmtday, -fmt_procedure_date)
#allpt_gvhd_all %>% write_csv('../data/11_samples_from_groups.csv')
# the below are counting stool samples
allpt_gvhd_all %>% count(grp)
#allpt_gvhd_all %>% write_csv('../data/11_samples_from_groups.csv')
# the below are counting stool samples
allpt_gvhd_all %>% count(grp)
View(allpt_gvhd)
View(allpt_gvhd)
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
))
View(allpt_gvhd_all)
173-101
173-95
#allpt_gvhd_all %>% write_csv('../data/11_samples_from_groups.csv')
# the below are counting stool samples
allpt_gvhd_all %>% count(grp)
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD')
allpt_gvhd
allpt_gvhd
View(allpt_gvhd)
allpt_gvhd %>%
filter(source == 'TCD')
tcd_pt <- allpt %>%
filter(source == 'TCD') %>%
pull(mrn)
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
))
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
))
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
))
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
))
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
))
#allpt_gvhd_all %>% write_csv('../data/11_samples_from_groups.csv')
# the below are counting stool samples
allpt_gvhd_all %>% count(grp)
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
)) %>%
select(mrn, source, grp, hct) %>%
inner_join(meta %>% select(mrn, sampleid, sdrt)) %>%
left_join(fmt_arm_ag %>% select(mrn, fmt_procedure_date)) %>%
mutate(hct = ymd(hct),
fmtday = as.numeric(fmt_procedure_date - hct)) %>%
mutate(grp = if_else(grp %in% c('non_gi','upper_gi'), 'Non_LGI', grp)) %>%
# since there are no samples that are after FMT we can ignore those columns
select(-hct, -fmtday, -fmt_procedure_date)
#allpt_gvhd_all %>% write_csv('../data/11_samples_from_groups.csv')
# the below are counting stool samples
allpt_gvhd_all %>% count(grp)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
DTB <- read_csv('../../food_tree/data/152_combined_DTB.csv')
View(DTB)
knitr::opts_chunk$set(echo = TRUE)
newest <- readxl::read_excel('../data/Sucrose_All Experiments Consolidated .xlsx')
View(newest)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggpubr)
library(vdbR)
connect_database()
list_table_from_database('fmt')
get_table_from_database('fmt_arm_ag')
type <- read_csv('../data/10_patients_foods_fiber_type_all.csv')
DTB <- read_csv('../../food_tree/data/152_combined_DTB.csv')
# join with gvhd info of the patients
allpt <- read_csv('../../food_tree/data/156_transplant_data.csv')
allpt %>% count(source)
allpt_gvhd <- allpt %>%
mutate(d100_a_gvhd = if_else(d100_a_gvhd == 'NE', 'N/E', d100_a_gvhd),
d100_a_gvhd = if_else(d100_a_gvhd == 'N', 'No', d100_a_gvhd),
d100_a_gvhd = if_else(d100_a_gvhd == 'Y', 'Yes', d100_a_gvhd)) %>%
filter(d100_a_gvhd %in% c('Yes','No'))
tcd_pt <- allpt %>%
filter(source == 'TCD') %>%
pull(mrn)
meta <- read_csv('../../food_tree/data/153_combined_META.csv')
allpt_gvhd_all <- allpt_gvhd %>%
filter(source != 'TCD') %>%
mutate(grp = case_when(
d100_a_gvhd == 'No' ~ "no_gvhd",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage == 0 & d100_lower_gi_stage == 0 ~ "non_gi",
d100_a_gvhd == 'Yes' & d100_upper_gi_stage != 0 & d100_lower_gi_stage == 0  ~ "upper_gi",
d100_a_gvhd == 'Yes' &  d100_lower_gi_stage != 0  ~ "LGI",
.default = NA
)) %>%
select(mrn, source, grp, hct) %>%
inner_join(meta %>% select(mrn, sampleid, sdrt)) %>%
left_join(fmt_arm_ag %>% select(mrn, fmt_procedure_date)) %>%
mutate(hct = ymd(hct),
fmtday = as.numeric(fmt_procedure_date - hct)) %>%
mutate(grp = if_else(grp %in% c('non_gi','upper_gi'), 'Non_LGI', grp)) %>%
# since there are no samples that are after FMT we can ignore those columns
select(-hct, -fmtday, -fmt_procedure_date)
#allpt_gvhd_all %>% write_csv('../data/11_samples_from_groups.csv')
# the below are counting stool samples
allpt_gvhd_all %>% count(grp)
# calculate daily intake of each food code
# remove the TCD patients here!!!
dailycode <- DTB %>%
group_by(mrn, fdrt, Food_code) %>%
summarise(dcodefiber = sum(Fibers_g)) %>%
janitor::clean_names() %>%
#filter(dcodefiber > 0) %>%
left_join(type, by = "food_code") %>%
ungroup() %>%
relocate(description, .after = 'soluble') %>%
inner_join(allpt_gvhd_all %>% distinct(mrn, source , grp))
View(dailycode)
dailycode %>% write_csv('../data/11_dailycode.csv')
# the type of the different fibers
# remove the tcd patients here!!!!!
all_types <- dailycode %>%
group_by(mrn, fdrt, fiber_type) %>%
summarise(gram = sum(dcodefiber)) %>%
ungroup() %>%
filter(!is.na(fiber_type)) %>%
spread('fiber_type','gram', fill = 0) %>%
gather('fiber_type','gram', names(.)[3]:names(.)[ncol(.)]) %>%
inner_join(allpt_gvhd_all %>% distinct(mrn, source, grp))
View(all_types)
all_types %>% write_csv('../data/11_all_types.csv')
# calculat the onset day for the gvhd patients
onsetdays <-  allpt %>% distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(!is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = as.numeric(d100_a_gvhd_onset - hct))
set.seed(1)
# randomly draw one onset day from the above with replacement
pseudodays <- allpt %>%
distinct(mrn, hct, d100_a_gvhd_onset) %>%
filter(is.na(d100_a_gvhd_onset)) %>%
mutate(onsetday = slice_sample(onsetdays %>% select(onsetday),n = nrow(.), replace = T ) %>% pull(onsetday)) %>%
select(mrn, hct, onsetday)
allonset <- bind_rows(pseudodays, onsetdays %>% select(-d100_a_gvhd_onset))
# all types but day relative to onset
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(hct = ymd(hct),
d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset),
fdrO = f_date - d100_a_gvhd_onset,
fdrO = as.numeric(fdrO))
all_types_o <- all_types %>%
inner_join(allpt %>% distinct(mrn, hct, d100_a_gvhd_onset)) %>%
mutate(hct = ymd(hct),
f_date = hct + fdrt,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset)) %>%
inner_join(allonset) %>%
mutate(hct = ymd(hct),
d100_a_gvhd_onset = hct + onsetday,
d100_a_gvhd_onset = ymd(d100_a_gvhd_onset),
fdrO = f_date - d100_a_gvhd_onset,
fdrO = as.numeric(fdrO))
all_types_o %>% write_csv('../data/11_all_types_onset.csv')
