knitr::opts_chunk$set(echo = TRUE)
# organize the meta table
# AVOID ALL SPACES. replace the space with underscores
meta <- read_csv('../data/Stool_mice_Fiber_Days1.7.14_JP_VDB_1.26.22.csv') %>%
rename(sampleid = `Tube ID`) %>%
separate(`Mice group`, into = c('grp','fiber'), sep = ' \\+ ') %>%
rename_all(~ gsub(" ", "_", .)) %>%
mutate(fiber = str_replace(fiber, ' fiber',''),
grp = str_replace(grp, ' ','_'))
library(tidyverse)
# organize the meta table
# AVOID ALL SPACES. replace the space with underscores
meta <- read_csv('../data/Stool_mice_Fiber_Days1.7.14_JP_VDB_1.26.22.csv') %>%
rename(sampleid = `Tube ID`) %>%
separate(`Mice group`, into = c('grp','fiber'), sep = ' \\+ ') %>%
rename_all(~ gsub(" ", "_", .)) %>%
mutate(fiber = str_replace(fiber, ' fiber',''),
grp = str_replace(grp, ' ','_'))
View(meta)
# grab the metaphlan results for this project
fns <- list.files('../data/shotgun_output/', pattern = '12898', full.names = T)
# organize the meta table
# AVOID ALL SPACES. replace the space with underscores
meta <- read_csv('../data/Stool_mice_Fiber_Days1.7.14_JP_VDB_1.26.22.csv') %>%
rename(sampleid = `Tube ID`) %>%
separate(`Mice group`, into = c('grp','fiber'), sep = ' \\+ ') %>%
rename_all(~ gsub(" ", "_", .)) %>%
mutate(fiber = str_replace(fiber, ' fiber',''),
grp = str_replace(grp, ' ','_'))
taxa <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'sampleid') %>%
mutate(sampleid = str_replace(sampleid, '../data/shotgun_output//Sample_',''),
sampleid = str_replace(sampleid, '_IGO_12898.+$',''))
cts <- taxa %>%
spread(key = 'clade_name', value = 'relative_abundance', fill = 0) %>%
column_to_rownames('sampleid')
meta_mouse <- diversity(cts, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv') %>%
inner_join(meta)  %>%
mutate(fiber = factor(fiber, levels = c('0%','12%','40%')))
library(vegan)
meta_mouse <- diversity(cts, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv') %>%
inner_join(meta)  %>%
mutate(fiber = factor(fiber, levels = c('0%','12%','40%')))
meta_mouse %>%
write_csv(file.path(dir, '../data/pheno_with_alpha_diversity.csv'))
meta_mouse %>%
write_csv('../data/pheno_with_alpha_diversity.csv')
View(meta_mouse)
# grab the metaphlan results for this project
fns <- list.files('../data/shotgun_output/', pattern = '12898', full.names = T)
taxa <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'sampleid') %>%
mutate(sampleid = str_replace(sampleid, '../data/shotgun_output//Sample_',''),
sampleid = str_replace(sampleid, '_IGO_12898.+$',''))
cts <- taxa %>%
spread(key = 'clade_name', value = 'relative_abundance', fill = 0) %>%
column_to_rownames('sampleid')
View(meta_mouse)
meta_mouse %>%
write_csv('../data/pheno_with_alpha_diversity.csv')
View(meta_mouse)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('shotgun_lookup_ad')
samp <- readxl::read_excel('../data/fiberstudy_patientsamples_shotgun.xlsx')
sampleids <- samp %>%
select(ends_with('id')) %>%
gather()
length(intersect(shotgun_lookup_ad$sampleid, sampleids$value))
setdiff(sampleids$value, shotgun_lookup_ad$sampleid)
View(sampleids)
samp <- readxl::read_excel('../data/fiberstudy_patientsamples_shotgun.xlsx')
View(sampleids)
View(samp)
samp <- readxl::read_excel('../data/fiberstudy_patientsamples_shotgun.xlsx')
sampleids <- samp %>%
select(ends_with('id')) %>%
gather()
length(intersect(shotgun_lookup_ad$sampleid, sampleids$value))
setdiff(sampleids$value, shotgun_lookup_ad$sampleid)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
mapper <- read_csv('~/Downloads/bai_mapper.csv')
quant <- read_csv('~/Downloads/bai_vdb_20220807.csv')
View(mapper)
mapper
quant
length(intersect(mapper$id, quant$sseqid))
length(intersect(mapper$id, bai_vdb_20220807$sseqid))
mapper <- read_csv('~/Downloads/bai_mapper.csv')
bai_vdb_20220807 <- read_csv('~/Downloads/bai_vdb_20220807.csv')
length(intersect(mapper$id, bai_vdb_20220807$sseqid))
length(intersect(mapper$id, bai_vdb_20220807$sseqid))
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vdbR)
connect_database()
get_table_from_database('shotgun_lookup_ad')
samp <- readxl::read_excel('../data/fiberstudy_patientsamples_shotgun.xlsx')
sampleids <- samp %>%
select(ends_with('id')) %>%
gather()
length(intersect(shotgun_lookup_ad$sampleid, sampleids$value))
setdiff(sampleids$value, shotgun_lookup_ad$sampleid)
# more mouse samples 6% fiber  and 0%
# nadir stands for the low point with the lowest neutrophil
View(sampleids)
View(shotgun_lookup_ad)
View(sampleids)
# find if I have already got the metaphlan results for all of those
location <- shotgun_lookup_ad %>%
filter(sampleid %in% sampleids$value)
View(location)
View(location)
View(sampleids)
# find if I have already got the metaphlan results for all of those
location <- shotgun_lookup_ad %>%
filter(sampleid %in% sampleids$value) %>%
distinct(sampleid, .keep_all = T)
View(location)
sampleids
sampleids <- samp %>%
select(ends_with('id')) %>%
gather() %>%
filter(value != 'NA')
View(shotgun_lookup_ad)
# find if I have already got the metaphlan results for all of those
location <- shotgun_lookup_ad %>%
mutate(sampleid = if_else(sampleid == '1574E_2', '1574E.2', sampleid))
# find if I have already got the metaphlan results for all of those
location <- shotgun_lookup_ad %>%
mutate(sampleid = if_else(sampleid == '1574E_2', '1574E.2', sampleid)) %>%
filter(sampleid %in% sampleids$value) %>%
distinct(sampleid, .keep_all = T)
View(location)
View(shotgun_lookup_ad)
# generate sripts to download those results
dl <- location %>%
filter(!sampleid %in% missing3)
#   FMT.0215A FMT.0215C  FMT.0215H
missing3 <- c('FMT.0215A','FMT.0215C','FMT.0215H')
# generate sripts to download those results
dl <- location %>%
filter(!sampleid %in% missing3)
View(dl)
location
# generate sripts to download those results
dl <- location %>%
filter(!sampleid %in% missing3) %>%
mutate(filep = str_glue('/home/daia1/my_workdir/samples/metaphlan/{str_extract(directory, "Sample_.+$")}'))
# generate sripts to download those results
dl <- location %>%
filter(!sampleid %in% missing3) %>%
mutate(filep = str_glue('/home/daia1/my_workdir/samples/metaphlan/{str_extract(directory, "Sample_.+$")}_metaphlan3_profile.txt'))
# generate sripts to download those results
dl <- location %>%
filter(!sampleid %in% missing3) %>%
mutate(cmd = str_glue('scp daia1@lilac.mskcc.org:/home/daia1/my_workdir/samples/metaphlan/{str_extract(directory, "Sample_.+$")}_metaphlan3_profile.txt .')) %>%
select(cmd)
# generate sripts to download those results
dl <- location %>%
filter(!sampleid %in% missing3) %>%
mutate(cmd = str_glue('scp daia1@lilac.mskcc.org:/home/daia1/my_workdir/samples/metaphlan/{str_extract(directory, "Sample_.+$")}_metaphlan3_profile.txt .')) %>%
select(cmd) %>%
write_csv('../data/dl58.sh', col_names = F)
# get the previous two days nutrition data for those samples
# the below table just had more samples that were filtered out in june
meta_all_old <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
p2d <- meta_all_old %>%
filter(sampleid %in% location$sampleid)
View(p2d)
# the ones that  had valid complete p2d diet data
valid <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
View(valid)
p2d <- meta_all_old %>%
filter(sampleid %in% location$sampleid & sampleid %in% valid$sampleid)
View(p2d)
# get the previous two days nutrition data for those samples
# the below table just had more samples that were filtered out in june
meta_all_old <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
# the ones that  had valid complete p2d diet data
valid <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_updated.csv')
p2d <- meta_all_old %>%
filter(sampleid %in% location$sampleid & sampleid %in% valid$sampleid)
View(p2d)
p2d
p2d <- meta_all_old %>%
filter(sampleid %in% location$sampleid & sampleid %in% valid$sampleid) %>%
select(sampleid:ave_carb)
p2d
View(p2d)
p2d <- meta_all_old %>%
filter(sampleid %in% location$sampleid & sampleid %in% valid$sampleid) %>%
select(sampleid:ave_carb) %>%
select(-EN, -TPN, -timebin)
p2d %>%
write_csv('../data/human_samples_p2d_diet_data.csv')
View(location)
# now gather the dl metaphlan results
fns <- list.files('../data/', pattern = '_metaphlan3_profile.txt$')
# now gather the dl metaphlan results
fns <- list.files('../data/', pattern = '_metaphlan3_profile.txt$', full.names = T)
View(location)
View(location)
# now gather the dl metaphlan results
fns <- list.files('../data/', pattern = '_metaphlan3_profile.txt$', full.names = T)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'sampleid')
View(human)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'sampleid') %>%
mutate(sampleid = str_replace(sampleid, '../data/shotgun_output//Sample_',''),
sampleid = str_replace(sampleid, '_IGO_.+$',''))
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'sampleid') %>%
mutate(sampleid = str_replace(sampleid, '../data//Sample_',''),
sampleid = str_replace(sampleid, '_IGO_.+$',''))
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))  %>%
left_join(location %>% select(fid, sampleid))
human %>% distinct(sampleid)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))  %>%
left_join(location %>% select(fid, sampleid)) %>%
select(-fid)
View(psql_con)
View(p2d)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))  %>%
left_join(location %>% select(fid, sampleid)) %>%
select(-fid) %>%
filter(sampleid %in% p2d$sampleid)
View(human)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))  %>%
left_join(location %>% select(fid, sampleid)) %>%
select(-fid)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))  %>%
left_join(location %>% select(fid, sampleid)) %>%
select(-fid) %>%
filter(sampleid %in% p2d$sampleid)
View(human)
human <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'fid') %>%
mutate(fid = str_replace(fid, '../data//Sample_',''),
fid = str_replace(fid, '_IGO_.+$',''))  %>%
left_join(location %>% select(fid, sampleid)) %>%
select(-fid)
human %>% write_csv('../data/human_metaphlan_61samples.csv')
knitr::opts_chunk$set(echo = TRUE)
# grab the metaphlan results for this project
second <- list.files('../data/shotgun_output/', pattern = 'JSP', full.names = T)
library(tidyverse)
library(ggpubr)
library(vegan)
dir <- '/Volumes/vandenBrinkLab/Diet-Microbiome Projects/Dietary Fiber/Shotgun Data/'
# grab the metaphlan results for this project
second <- list.files('../data/shotgun_output/', pattern = 'JSP', full.names = T)
# grab the metaphlan results for this project
second <- list.files('../data/shotgun_output/', pattern = 'JPS', full.names = T)
total <- c(fns, second)
fns <- list.files('../data/shotgun_output/', pattern = '12898', full.names = T)
total <- c(fns, second)
total <- c(fns, second)
total <- c(fns, second)
meta <- read_csv('../data/Stool_mice_Fiber_Days1.7.14_JP_VDB_1.26.22.csv')
View(meta)
View(meta)
knitr::opts_chunk$set(echo = TRUE)
# now gather the dl metaphlan results
fns <- list.files('../data/', pattern = '_metaphlan3_profile.txt$', full.names = T)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
# get the previous two days nutrition data for those samples
# the below table just had more samples that were filtered out in june
meta_all_old <- read_csv('../../food_tree/data/cleaned_stool/all_samples_meta_p2d_fg9_dietall_genera36.csv')
View(meta_all_old)
knitr::opts_chunk$set(echo = TRUE)
fns <- list.files('../data/shotgun_output/', pattern = '12898', full.names = T)
library(tidyverse)
View(meta_all_old)
fns <- list.files('../data/shotgun_output/', pattern = '12898', full.names = T)
taxa <- fns %>%
set_names(fns) %>%
map(~ read_tsv(., skip = 4, col_types = 'ccddd') %>%
rename(clade_name = names(.)[1]) %>%
select(clade_name, relative_abundance) %>%
filter(str_detect(clade_name, 's__')) %>%
mutate(relative_abundance = relative_abundance/100)) %>%
bind_rows(.id = 'sampleid') %>%
mutate(sampleid = str_replace(sampleid, '../data/shotgun_output//Sample_',''),
sampleid = str_replace(sampleid, '_IGO_12898.+$',''))
cts <- taxa %>%
spread(key = 'clade_name', value = 'relative_abundance', fill = 0) %>%
column_to_rownames('sampleid')
meta_mouse <- diversity(cts, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv') %>%
inner_join(meta)  %>%
mutate(fiber = factor(fiber, levels = c('0%','12%','40%')))
library(vegan)
meta_mouse <- diversity(cts, index = 'inv') %>%
enframe(name = 'sampleid', value = 'inv') %>%
inner_join(meta)  %>%
mutate(fiber = factor(fiber, levels = c('0%','12%','40%')))
# organize the meta table
# AVOID ALL SPACES. replace the space with underscores
meta <- read_csv('../data/Stool_mice_Fiber_Days1.7.14_JP_VDB_1.26.22.csv') %>%
rename(sampleid = `Tube ID`) %>%
separate(`Mice group`, into = c('grp','fiber'), sep = ' \\+ ') %>%
rename_all(~ gsub(" ", "_", .)) %>%
mutate(fiber = str_replace(fiber, ' fiber',''),
grp = str_replace(grp, ' ','_'))
View(meta)
View(taxa)
taxa
taxa %>% distinct(sampleid)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
meta <- read_csv('~/pipeline/scripts/food_tree/data/090_all_samples_meta_p2d_fg9_dietall_genera34.csv')
View(meta)
meta
meta <- read_csv('~/pipeline/scripts/food_tree/data/090_all_samples_meta_p2d_fg9_dietall_genera34.csv') %>%
select(mrn, sdrt, simpson_reciprocal, ave_fiber) %>%
mutate(ave_fiber = ave_fiber*100)
View(meta)
library(ggpubt)
library(ggpubr)
meta
meta <- read_csv('~/pipeline/scripts/food_tree/data/090_all_samples_meta_p2d_fg9_dietall_genera34.csv') %>%
select(mrn, sdrt, simpson_reciprocal, ave_fiber) %>%
mutate(ave_fiber = ave_fiber*100) %>%
filter(sdrt %in% 7:21)
meta
meta %>%
group_by(mrn) %>%
summarise(ave_div = mean(simpson_reciprocal),
mean_fiber = mean(ave_fiber))
meta %>%
group_by(mrn) %>%
summarise(ave_div = mean(simpson_reciprocal),
mean_fiber = mean(ave_fiber)) %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "pearson",  label.sep = "\n"))
meta %>%
group_by(mrn) %>%
summarise(ave_div = mean(simpson_reciprocal),
mean_fiber = mean(ave_fiber)) %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "pearson",  label.sep = "\n")) +
theme(aspect.ratio=1)
meta %>%
group_by(mrn) %>%
summarise(ave_div = mean(simpson_reciprocal),
mean_fiber = mean(ave_fiber)) %>%
ggscatter(x = 'mean_fiber', y = 'ave_div',
xlab = 'Prior 2 day fiber intake averaged by patient', ylab = 'microbiome alpha diversity averaged by patient',
add = "reg.line",  # Add regressin line
add.params = list(color = "blue", fill = "lightgray"), # Customize line
conf.int = TRUE, # Add confidence interval
cor.coef = TRUE, # Add correlation coefficient.
cor.coeff.args = list(method = "pearson",  label.sep = "\n")) +
theme(aspect.ratio=1)
meta %>% distinct(mrn)
meta <- read_csv('~/pipeline/scripts/food_tree/data/090_all_samples_meta_p2d_fg9_dietall_genera34.csv') %>%
select(mrn, sdrt, simpson_reciprocal, ave_fiber) %>%
mutate(ave_fiber = ave_fiber*100) %>%
filter(sdrt %in% 7:21)
meta %>% distinct(mrn)
meta
# a box plot
mean_fiber_intake <- mean(meta$ave_fiber)
grps <- meta %>%
mutate(grp = if_else(ave_fiber > mean_fiber_intake, 'high', 'low'))
View(grps)
grps
grps %>%
ggboxplot(x = 'grp', y = 'simpson_reciprocal')
grps
grps %>%
ggboxplot(x = 'grp', y = 'simpson_reciprocal') +
stat_compare_means(comparisons= list(c('high', 'low')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
grps %>%
ggboxplot(x = 'grp', y = 'simpson_reciprocal', xlab = 'Compared to average prior 2 day fiber intake',
ylab = 'Microbiome alpha diversity') +
stat_compare_means(comparisons= list(c('high', 'low')),
label= "p.format",
method= 'wilcox.test',
correct=FALSE)
